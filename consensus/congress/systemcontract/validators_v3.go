package systemcontract

import (
	"math"
	"math/big"

	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/consensus/congress/vmcaller"
	"github.com/ethereum/go-ethereum/core"
	"github.com/ethereum/go-ethereum/core/state"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/log"
	"github.com/ethereum/go-ethereum/params"
)

const (
	validatorV3Code = "0x6080604052600436106200022e5760003560e01c806380d2dde1116200012f578063c1d7dd7811620000ad578063c967f90f1162000078578063c967f90f14620006a6578063d6eb3de114620006d1578063e8363f6c14620006e9578063ea10f8ad146200071a578063feebbc93146200073f57600080fd5b8063c1d7dd78146200062c578063c253c3841462000644578063c2a672e0146200065c578063c4e2f07a146200068157600080fd5b80639de7025811620000fa5780639de70258146200056e578063a224cee71462000595578063afeea11514620005ba578063bbe4f6db14620005d2578063be645692146200060c57600080fd5b806380d2dde114620004d55780638a11d7c914620004fa5780638b0e9f3f146200053157806398e3b626146200054957600080fd5b806340550a1c11620001bd57806363fc5e71116200018857806363fc5e7114620003f15780636846992a146200042b5780636969a25c14620004505780637ad229da14620004755780637f4f95fa14620004b057600080fd5b806340550a1c146200035b57806340a141ff146200038057806348cd4cb114620003a55780634b3d500b14620003cc57600080fd5b80632647620411620001fe5780632647620414620002ee57806330fcb67c146200030557806338b67b8b146200031e5780633a061bd3146200034357600080fd5b8062362a771462000233578063158ef93e146200026d578063189740d114620002895780631b5e358c14620002bd575b600080fd5b3480156200024057600080fd5b50620002586200025236600462003b3a565b62000774565b60405190151581526020015b60405180910390f35b3480156200027a57600080fd5b50600054620002589060ff1681565b3480156200029657600080fd5b50620002ae620002a836600462003ba0565b6200091b565b60405162000264919062003c23565b348015620002ca57600080fd5b50620002d561f20081565b6040516001600160a01b03909116815260200162000264565b62000258620002ff36600462003b3a565b62000a0f565b6200031c6200031636600462003b3a565b62000e98565b005b3480156200032b57600080fd5b50620002ae6200033d36600462003ba0565b620010c8565b3480156200035057600080fd5b50620002d561f10081565b3480156200036857600080fd5b50620002586200037a36600462003b3a565b62001269565b3480156200038d57600080fd5b506200031c6200039f36600462003b3a565b620012db565b348015620003b257600080fd5b50620003bd60015481565b60405190815260200162000264565b348015620003d957600080fd5b50620002d5620003eb36600462003c38565b6200133c565b348015620003fe57600080fd5b50620003bd6200041036600462003b3a565b6001600160a01b03166000908152600f602052604090205490565b3480156200043857600080fd5b506200031c6200044a36600462003c68565b62001367565b3480156200045d57600080fd5b50620002d56200046f36600462003c38565b620015e2565b3480156200048257600080fd5b506200049a6200049436600462003d41565b620015f3565b6040805192835260208301919091520162000264565b348015620004bd57600080fd5b506200049a620004cf36600462003d6e565b620016db565b348015620004e257600080fd5b506200031c620004f436600462003d41565b62001710565b3480156200050757600080fd5b506200051f6200051936600462003b3a565b62001aac565b60405162000264949392919062003df7565b3480156200053e57600080fd5b50620003bd60075481565b3480156200055657600080fd5b50620002586200056836600462003b3a565b62001ba8565b3480156200057b57600080fd5b506200058662001c11565b60405162000264919062003e3b565b348015620005a257600080fd5b506200031c620005b436600462003ba0565b62001c75565b348015620005c757600080fd5b5062000586620021e4565b348015620005df57600080fd5b50620002d5620005f136600462003b3a565b600b602052600090815260409020546001600160a01b031681565b3480156200061957600080fd5b50620003bd69021e19e0c9bab240000081565b3480156200063957600080fd5b50620003bd60085481565b3480156200065157600080fd5b506200049a62002246565b3480156200066957600080fd5b50620002586200067b36600462003d41565b6200225d565b3480156200068e57600080fd5b50620003bd620006a036600462003d6e565b6200267e565b348015620006b357600080fd5b50620006bd601581565b60405161ffff909116815260200162000264565b348015620006de57600080fd5b50620002d561f30081565b348015620006f657600080fd5b50620003bd6200070836600462003b3a565b60046020526000908152604090205481565b3480156200072757600080fd5b50620002ae6200073936600462003e50565b62002750565b3480156200074c57600080fd5b50620007646200075e36600462003ba0565b620028d2565b6040516200026492919062003ea9565b336000818152600460205260408120805490829055909190801562000827576001600160a01b0382166108fc620007b483670de0b6b3a764000062002aeb565b6040518115909202916000818181858888f19350505050158015620007dd573d6000803e3d6000fd5b50604080518281524260208201526001600160a01b0380871692908516917f51a69b4502f660774c9339825c7b5adbf0b8622289134647e29728ec5d9b3bb9910160405180910390a35b6001600160a01b038481166000908152600b6020526040808220549051630c00007b60e41b81528584166004820152921691829063c00007b090602401602060405180830381600087803b1580156200087f57600080fd5b505af115801562000894573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620008ba919062003ed2565b905080156200090f576001600160a01b0384166108fc620008e483670de0b6b3a764000062002aeb565b6040518115909202916000818181858888f193505050501580156200090d573d6000803e3d6000fd5b505b50600195945050505050565b6060818067ffffffffffffffff8111156200093a576200093a62003c52565b60405190808252806020026020018201604052801562000964578160200160208202803683370190505b50915060005b8181101562000a075760008585838181106200098a576200098a62003eec565b9050602002016020810190620009a1919062003b3a565b6001600160a01b038116600090815260106020526040902054909150620009d190670de0b6b3a764000062002aeb565b848381518110620009e657620009e662003eec565b60209081029190910101525080620009fe8162003f18565b9150506200096a565b505092915050565b6000805460ff1662000a3e5760405162461bcd60e51b815260040162000a359062003f36565b60405180910390fd5b336000818152600c6020526040902054349062000a5c908262002b36565b6001600160a01b038084166000908152600c602052604080822093909355600a5483516325dff9d160e01b815284519294859492909216926325dff9d192600480840193919291829003018186803b15801562000ab857600080fd5b505afa15801562000acd573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019062000af3919062003f5c565b915091508143101562000b365760405162461bcd60e51b815260206004820152600a6024820152697374617274426c6f636b60b01b604482015260640162000a35565b8043111562000b735760405162461bcd60e51b8152602060048201526008602482015267656e64426c6f636b60c01b604482015260640162000a35565b6001600160a01b03808716600081815260026020526040902091861614801562000bcd575060016001600160a01b03881660009081526002602052604090205460ff16600381111562000bca5762000bca62003da6565b14155b1562000c4057600181015469021e19e0c9bab24000009062000bf0908662002b36565b101562000c405760405162461bcd60e51b815260206004820152601860248201527f5374616b696e6720636f696e73206e6f7420656e6f7567680000000000000000604482015260640162000a35565b6001600160a01b038086166000908152600360209081526040808320938b168352929052205462000cbf57600380820180546001600160a01b03808916600081815260209586526040808220938e1682529286529182206001908101849055830184559281529290922090910180546001600160a01b03191690911790555b600181015462000d0e57866001600160a01b03167fbc822c457926e0706c445f2b613394c8a2bf34b3b4335915e3865b90829ce38b600160405162000d05919062003f81565b60405180910390a25b600181015462000d1f908562002b36565b600180830191909155815460ff16600381111562000d415762000d4162003da6565b1462000d5357805460ff191660011781555b62000d6387826001015462002b99565b6001600160a01b038086166000908152600360209081526040808320938b168352929052205462000d95908562002b36565b6001600160a01b038087166000908152600360209081526040808320938c168352929052205560075462000dca908562002b36565b6007556001600160a01b038781166000908152600b602052604090819020549051630991d88160e21b81528783166004820152911690819063264762049087906024016000604051808303818588803b15801562000e2757600080fd5b505af115801562000e3c573d6000803e3d6000fd5b5050604080518981524260208201526001600160a01b03808e1695508b1693507fb9ba725934532316cffe10975da6eb25ad49c2d1c294d982c46c9f8d684ee07592500160405180910390a3600196505050505050505b919050565b33411462000ed65760405162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b604482015260640162000a35565b436000908152600d6020908152604080832083805290915290205460ff161562000f435760405162461bcd60e51b815260206004820152601960248201527f426c6f636b20697320616c726561647920726577617264656400000000000000604482015260640162000a35565b60005460ff1662000f685760405162461bcd60e51b815260040162000a359062003f36565b436000818152600d602090815260408083208380529091529020805460ff191660019081179091555433913491101562001029576001600160a01b0382166000908152600f6020526040812080549162000fc28362003f18565b9091555050600954604051631e88772760e01b81526001600160a01b03848116600483015290911690631e88772790602401600060405180830381600087803b1580156200100f57600080fd5b505af115801562001024573d6000803e3d6000fd5b505050505b600081116200103757505050565b6001600160a01b03821660009081526002602052604081205460ff16600381111562001067576200106762003da6565b14156200107357505050565b6200107f818462002fae565b604080518281524260208201526001600160a01b038416917f7dc4e5df59513708dca355b8706273a5df7b810a4cec8019f2a4b9bb166a1a04910160405180910390a250505b50565b6060818067ffffffffffffffff811115620010e757620010e762003c52565b60405190808252806020026020018201604052801562001111578160200160208202803683370190505b50915060005b8181101562000a0757600085858381811062001137576200113762003eec565b90506020020160208101906200114e919062003b3a565b6001600160a01b038082166000908152600b60205260408120549293509116908115620011f3576040516246613160e11b81526001600160a01b038481166004830152831690628cc2629060240160206040518083038186803b158015620011b557600080fd5b505afa158015620011ca573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620011f0919062003ed2565b90505b6001600160a01b0383166000908152600460205260409020546200122f90670de0b6b3a7640000906200122890849062002b36565b9062002aeb565b86858151811062001244576200124462003eec565b6020026020010181815250505050508080620012609062003f18565b91505062001117565b6000805b600554811015620012d257826001600160a01b03166005828154811062001298576200129862003eec565b6000918252602090912001546001600160a01b03161415620012bd5750600192915050565b80620012c98162003f18565b9150506200126d565b50600092915050565b3361f20014620013255760405162461bcd60e51b815260206004820152601460248201527350756e69736820636f6e7472616374206f6e6c7960601b604482015260640162000a35565b60065460011015620010c557620010c581620036b7565b600681815481106200134d57600080fd5b6000918252602090912001546001600160a01b0316905081565b334114620013a55760405162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b604482015260640162000a35565b436000908152600d602090815260408083206001845290915290205460ff1615620014135760405162461bcd60e51b815260206004820152601a60248201527f56616c696461746f727320616c72656164792075706461746564000000000000604482015260640162000a35565b60005460ff16620014385760405162461bcd60e51b815260040162000a359062003f36565b8062001445814362003fb4565b15620014875760405162461bcd60e51b815260206004820152601060248201526f426c6f636b2065706f6368206f6e6c7960801b604482015260640162000a35565b436000908152600d6020908152604080832060018085529252909120805460ff191690911790558251620014f55760405162461bcd60e51b815260206004820152601460248201527356616c696461746f722073657420656d7074792160601b604482015260640162000a35565b600a54604080516325dff9d160e01b815281516000936001600160a01b0316926325dff9d19260048082019391829003018186803b1580156200153757600080fd5b505afa1580156200154c573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019062001572919062003f5c565b915050600081118015620015865750804310155b15620015dc578351620015a190600590602087019062003a93565b507feacea8f3c22f06c0b18306bdb04d0a967255129e8ce0094debb0a0ff89d006b584604051620015d3919062003e3b565b60405180910390a15b50505050565b600581815481106200134d57600080fd5b6001600160a01b038281166000908152600b602052604080822054905163fa9ada5b60e01b815260048101859052919283929116906200169690670de0b6b3a764000090839063fa9ada5b9060240160206040518083038186803b1580156200165b57600080fd5b505afa15801562001670573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019062001228919062003ed2565b6001600160a01b0386166000908152600e60209081526040808320888452909152902054909350620016d190670de0b6b3a764000062002aeb565b9150509250929050565b6001600160a01b03828116600090815260036020908152604080832093851683529290522080546001909101545b9250929050565b3361f200146200175a5760405162461bcd60e51b815260206004820152601460248201527350756e69736820636f6e7472616374206f6e6c7960601b604482015260640162000a35565b8160006001600160a01b03841660009081526002602052604090205460ff1660038111156200178d576200178d62003da6565b1415620017d35760405162461bcd60e51b815260206004820152601360248201527215985b1a59185d1bdc881b9bdd08195e1a5cdd606a1b604482015260640162000a35565b6001600160a01b0380821660009081526003602090815260408083209387168352928152828220600290915291902081548085111562001811578094505b846200181f57505050505050565b84811415620019745760038201546200183b9060019062003fcb565b83600101541462001933576003820180546200185a9060019062003fcb565b815481106200186d576200186d62003eec565b9060005260206000200160009054906101000a90046001600160a01b031682600301846001015481548110620018a757620018a762003eec565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b0316021790555082600101546003600084600301866001015481548110620018fa57620018fa62003eec565b60009182526020808320909101546001600160a01b0390811684528382019490945260409283018220938b168252929092529020600101555b8160030180548062001949576200194962003fe5565b600082815260208120820160001990810180546001600160a01b031916905590910190915560018401555b8254620019829086620036fc565b83556001820154620019959086620036fc565b6001830155600754620019a99086620036fc565b6007556001600160a01b0384166000908152600c6020526040902054620019d19086620036fc565b6001600160a01b038581166000818152600c60209081526040808320959095558a84168252600b905283902054925163f3fef3a360e01b8152600481019190915260248101889052911690819063f3fef3a390604401600060405180830381600087803b15801562001a4257600080fd5b505af115801562001a57573d6000803e3d6000fd5b5050604080518981524260208201526001600160a01b03808c169450891692507f449002ae18e748d69a55f38514400d64f966492e593e32d6e9b8b24db98a0bc1910160405180910390a350505050505b5050565b6001600160a01b03811660009081526002602052604080822081516080810190925280548392839260609284929190829060ff16600381111562001af45762001af462003da6565b600381111562001b085762001b0862003da6565b815260200160018201548152602001600282015481526020016003820180548060200260200160405190810160405280929190818152602001828054801562001b7b57602002820191906000526020600020905b81546001600160a01b0316815260019091019060200180831162001b5c575b505050919092525050815160208301516040840151606090940151919a9099509297509550909350505050565b6000805b600654811015620012d257826001600160a01b03166006828154811062001bd75762001bd762003eec565b6000918252602090912001546001600160a01b0316141562001bfc5750600192915050565b8062001c088162003f18565b91505062001bac565b6060600580548060200260200160405190810160405280929190818152602001828054801562001c6b57602002820191906000526020600020905b81546001600160a01b0316815260019091019060200180831162001c4c575b5050505050905090565b60005460ff161562001cc05760405162461bcd60e51b8152602060048201526013602482015272105b1c9958591e481a5b9a5d1a585b1a5e9959606a1b604482015260640162000a35565b600980546001600160a01b031990811661f20017909155600a805490911661f30017905560005b818110156200219857600083838381811062001d075762001d0762003eec565b905060200201602081019062001d1e919062003b3a565b6001600160a01b0316141562001d775760405162461bcd60e51b815260206004820152601960248201527f496e76616c69642076616c696461746f72206164647265737300000000000000604482015260640162000a35565b62001da783838381811062001d905762001d9062003eec565b90506020020160208101906200037a919062003b3a565b62001e0d57600583838381811062001dc35762001dc362003eec565b905060200201602081019062001dda919062003b3a565b81546001810183556000928352602090922090910180546001600160a01b0319166001600160a01b039092169190911790555b62001e3d83838381811062001e265762001e2662003eec565b905060200201602081019062000568919062003b3a565b62001ea357600683838381811062001e595762001e5962003eec565b905060200201602081019062001e70919062003b3a565b81546001810183556000928352602090922090910180546001600160a01b0319166001600160a01b039092169190911790555b60006002600085858581811062001ebe5762001ebe62003eec565b905060200201602081019062001ed5919062003b3a565b6001600160a01b0316815260208101919091526040016000205460ff16600381111562001f065762001f0662003da6565b141562001f7b5760016002600085858581811062001f285762001f2862003eec565b905060200201602081019062001f3f919062003b3a565b6001600160a01b031681526020810191909152604001600020805460ff1916600183600381111562001f755762001f7562003da6565b02179055505b6000600b8185858581811062001f955762001f9562003eec565b905060200201602081019062001fac919062003b3a565b6001600160a01b0390811682526020820192909252604001600020541614156200218357600083838381811062001fe75762001fe762003eec565b905060200201602081019062001ffe919062003b3a565b60405160200162002022919060609190911b6001600160601b031916815260140190565b60405160208183030381529060405280519060200120905060008185858581811062002052576200205262003eec565b905060200201602081019062002069919062003b3a565b604051620020779062003afd565b6001600160a01b0390911681526020018190604051809103906000f5905080158015620020a8573d6000803e3d6000fd5b50905080600b6000878787818110620020c557620020c562003eec565b9050602002016020810190620020dc919062003b3a565b6001600160a01b039081168252602082019290925260400160002080546001600160a01b0319169290911691909117905584848481811062002122576200212262003eec565b905060200201602081019062002139919062003b3a565b604080516001600160a01b03848116825242602083015292909216917f5e5b474625449a92e2b1a6f9f183435f09402d6897ae7f8779c72142ed11170b910160405180910390a250505b806200218f8162003f18565b91505062001ce7565b507feacea8f3c22f06c0b18306bdb04d0a967255129e8ce0094debb0a0ff89d006b56005604051620021cb919062003ffb565b60405180910390a150506000805460ff19166001179055565b6060600680548060200260200160405190810160405280929190818152602001828054801562001c6b576020028201919060005260206000209081546001600160a01b0316815260019091019060200180831162001c4c575050505050905090565b60008062002255600062003740565b915091509091565b6000805460ff16620022835760405162461bcd60e51b815260040162000a359062003f36565b3360006001600160a01b03851660009081526002602052604090205460ff166003811115620022b657620022b662003da6565b1415620022fc5760405162461bcd60e51b815260206004820152601360248201527215985b1a59185d1bdc881b9bdd08195e1a5cdd606a1b604482015260640162000a35565b6001600160a01b038082166000908152600360209081526040808320938816835292815282822060029091529190208154808611156200237f5760405162461bcd60e51b815260206004820152601860248201527f596f7520646f6e2774206861766520616e79207374616b650000000000000000604482015260640162000a35565b85811415620024d45760038201546200239b9060019062003fcb565b8360010154146200249357600382018054620023ba9060019062003fcb565b81548110620023cd57620023cd62003eec565b9060005260206000200160009054906101000a90046001600160a01b03168260030184600101548154811062002407576200240762003eec565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b03160217905550826001015460036000846003018660010154815481106200245a576200245a62003eec565b60009182526020808320909101546001600160a01b0390811684528382019490945260409283018220938c168252929092529020600101555b81600301805480620024a957620024a962003fe5565b600082815260208120820160001990810180546001600160a01b031916905590910190915560018401555b8254620024e29087620036fc565b83556001820154620024f59087620036fc565b6001830155600754620025099087620036fc565b6007556001600160a01b0384166000908152600c6020526040902054620025319087620036fc565b6001600160a01b038086166000818152600c602052604090209290925588161415620025ae57620025628762001ba8565b15620025ae57825469021e19e0c9bab24000001115620025ae5760405162461bcd60e51b815260040162000a35906020808252600490820152630333030360e41b604082015260600190565b6001600160a01b038781166000908152600b60205260409081902054905163f3fef3a360e01b8152868316600482015260248101899052911690819063f3fef3a390604401600060405180830381600087803b1580156200260e57600080fd5b505af115801562002623573d6000803e3d6000fd5b5050604080518a81524260208201526001600160a01b03808d169450891692507f449002ae18e748d69a55f38514400d64f966492e593e32d6e9b8b24db98a0bc1910160405180910390a36001955050505050505b92915050565b6001600160a01b038181166000908152600b60205260408082205490516246613160e11b815285841660048201529192169082908290628cc2629060240160206040518083038186803b158015620026d557600080fd5b505afa158015620026ea573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019062002710919062003ed2565b6001600160a01b0386166000908152600460205260409020549091506200274790670de0b6b3a76400009062001228908462002b36565b95945050505050565b6060818067ffffffffffffffff8111156200276f576200276f62003c52565b60405190808252806020026020018201604052801562002799578160200160208202803683370190505b50915060005b83811015620028c9576000858583818110620027bf57620027bf62003eec565b9050602002016020810190620027d6919062003b3a565b6001600160a01b038082166000908152600b602052604081205492935091169081156200287b576040516246613160e11b81526001600160a01b038a81166004830152831690628cc2629060240160206040518083038186803b1580156200283d57600080fd5b505afa15801562002852573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019062002878919062003ed2565b90505b6200288f81670de0b6b3a764000062002aeb565b868581518110620028a457620028a462003eec565b6020026020010181815250505050508080620028c09062003f18565b9150506200279f565b50509392505050565b606080828067ffffffffffffffff811115620028f257620028f262003c52565b6040519080825280602002602001820160405280156200291c578160200160208202803683370190505b5092508067ffffffffffffffff8111156200293b576200293b62003c52565b60405190808252806020026020018201604052801562002965578160200160208202803683370190505b50915060005b8181101562002ae25760008686838181106200298b576200298b62003eec565b9050602002016020810190620029a2919062003b3a565b6001600160a01b038082166000908152600b6020526040812054929350911690811562002a47576040516246613160e11b81526001600160a01b038481166004830152831690628cc2629060240160206040518083038186803b15801562002a0957600080fd5b505afa15801562002a1e573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019062002a44919062003ed2565b90505b6001600160a01b03831660009081526004602052604090205462002a7490670de0b6b3a764000062002aeb565b87858151811062002a895762002a8962003eec565b602090810291909101015262002aa881670de0b6b3a764000062002aeb565b86858151811062002abd5762002abd62003eec565b602002602001018181525050505050808062002ad99062003f18565b9150506200296b565b50509250929050565b600062002b2f83836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f00000000000081525062003866565b9392505050565b60008062002b4583856200404d565b90508381101562002b2f5760405162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f770000000000604482015260640162000a35565b60005b60065481101562002bfd57826001600160a01b03166006828154811062002bc75762002bc762003eec565b6000918252602090912001546001600160a01b0316141562002be857505050565b8062002bf48162003f18565b91505062002b9c565b506006546015111562002d525760068054600181019091557ff652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d3f0180546001600160a01b0319166001600160a01b038481169182179092556000908152600b60205260409020541662001aa8576040516001600160601b0319606084901b1660208201526000906034016040516020818303038152906040528051906020012090506000818460405162002cb09062003afd565b6001600160a01b0390911681526020018190604051809103906000f590508015801562002ce1573d6000803e3d6000fd5b506001600160a01b038581166000818152600b602090815260409182902080546001600160a01b031916948616948517905581519384524290840152929350917f5e5b474625449a92e2b1a6f9f183435f09402d6897ae7f8779c72142ed11170b910160405180910390a250505050565b600060026000600660008154811062002d6f5762002d6f62003eec565b60009182526020808320909101546001600160a01b03168352820192909252604001812060019081015492505b60065481101562002e4e5782600260006006848154811062002dc25762002dc262003eec565b60009182526020808320909101546001600160a01b03168352820192909252604001902060010154101562002e3957600260006006838154811062002e0b5762002e0b62003eec565b60009182526020808320909101546001600160a01b0316835282019290925260400190206001015492509050805b8062002e458162003f18565b91505062002d9c565b5081831162002e5d5750505050565b6001600160a01b038481166000908152600b60205260409020541662002f63576040516001600160601b0319606086901b1660208201526000906034016040516020818303038152906040528051906020012090506000818660405162002ec49062003afd565b6001600160a01b0390911681526020018190604051809103906000f590508015801562002ef5573d6000803e3d6000fd5b506001600160a01b038781166000818152600b602090815260409182902080546001600160a01b031916948616948517905581519384524290840152929350917f5e5b474625449a92e2b1a6f9f183435f09402d6897ae7f8779c72142ed11170b910160405180910390a250505b836006828154811062002f7a5762002f7a62003eec565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b0316021790555050505050565b8162002fb8575050565b60008062002fc68362003740565b90925090508062002fd75750505050565b60008062002fee86670de0b6b3a764000062003899565b955083620032c057600062003004878562002aeb565b90506200301e62003016828662003899565b8890620036fc565b925060005b600554811015620031b45760006005828154811062003046576200304662003eec565b6000918252602090912001546001600160a01b0316905060036001600160a01b03821660009081526002602052604090205460ff1660038111156200308f576200308f62003da6565b14158015620030b05750876001600160a01b0316816001600160a01b031614155b156200319e576001600160a01b038116600090815260046020526040902054620030db908462002b36565b6001600160a01b038216600090815260046020908152604080832093909355600e815282822043835290522054909350839062003119908462002b36565b6001600160a01b0382166000818152600e602090815260408083204384528252808320949094559181526010909152205462003156908462002b36565b6001600160a01b038216600081815260106020526040908190209290925590516000805160206200508f83398151915290620031959086815260200190565b60405180910390a25b5080620031ab8162003f18565b91505062003023565b50600083118015620031ce57506001600160a01b03821615155b15620032b7576001600160a01b038216600090815260046020526040902054620031f9908462002b36565b6001600160a01b038316600090815260046020908152604080832093909355600e81528282204383529052205462003232908462002b36565b6001600160a01b0383166000818152600e60209081526040808320438452825280832094909455918152601090915220546200326f908462002b36565b6001600160a01b038316600081815260106020526040908190209290925590516000805160206200508f83398151915290620032ae9086815260200190565b60405180910390a25b50505050505050565b6000805b6005548110156200352a57600060058281548110620032e757620032e762003eec565b6000918252602090912001546001600160a01b0316905060036001600160a01b03821660009081526002602052604090205460ff16600381111562003330576200333062003da6565b14158015620033515750876001600160a01b0316816001600160a01b031614155b1562003514576001600160a01b0381166000908152600260205260408120600101546200338790899062001228908d9062003899565b91945084919050620033bf6200339f82600262002aeb565b6001600160a01b0384166000908152600460205260409020549062002b36565b6001600160a01b03808416600090815260046020908152604080832094909455600b9052919091205416806390ca796b620033fc84600262002aeb565b6040518263ffffffff1660e01b81526004016200341b91815260200190565b600060405180830381600087803b1580156200343657600080fd5b505af11580156200344b573d6000803e3d6000fd5b5050506001600160a01b0384166000908152600e602090815260408083204384529091529020546200347f91508362002b36565b6001600160a01b0384166000818152600e6020908152604080832043845282528083209490945591815260109091522054620034bc908362002b36565b6001600160a01b038416600081815260106020526040908190209290925590516000805160206200508f83398151915290620034fb9085815260200190565b60405180910390a26200350f858362002b36565b945050505b5080620035218162003f18565b915050620032c4565b50620035378782620036fc565b92506000831180156200355257506001600160a01b03821615155b15620032b757620035696200339f84600262002aeb565b6001600160a01b03808416600090815260046020908152604080832094909455600b9052919091205416806390ca796b620035a686600262002aeb565b6040518263ffffffff1660e01b8152600401620035c591815260200190565b600060405180830381600087803b158015620035e057600080fd5b505af1158015620035f5573d6000803e3d6000fd5b5050506001600160a01b0384166000908152600e602090815260408083204384529091529020546200362991508562002b36565b6001600160a01b0384166000818152600e602090815260408083204384528252808320949094559181526010909152205462003666908562002b36565b6001600160a01b038416600081815260106020526040908190209290925590516000805160206200508f83398151915290620036a59087815260200190565b60405180910390a25050505050505050565b6001600160a01b03811660009081526002602052604081205460ff166003811115620036e757620036e762003da6565b1415620036f15750565b620010c58162003920565b600062002b2f83836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f77000081525062003a5d565b60008060005b6005548110156200386057600360026000600584815481106200376d576200376d62003eec565b60009182526020808320909101546001600160a01b0316835282019290925260400190205460ff166003811115620037a957620037a962003da6565b14158015620037e5575060058181548110620037c957620037c962003eec565b6000918252602090912001546001600160a01b03858116911614155b156200384b5762003839600260006005848154811062003809576200380962003eec565b60009182526020808320909101546001600160a01b03168352820192909252604001902060010154849062002b36565b925081620038478162003f18565b9250505b80620038578162003f18565b91505062003746565b50915091565b600081836200388a5760405162461bcd60e51b815260040162000a35919062004068565b506000620027478486620040c0565b600082620038aa5750600062002678565b6000620038b88385620040d7565b905082620038c78583620040c0565b1462002b2f5760405162461bcd60e51b815260206004820152602160248201527f536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f6044820152607760f81b606482015260840162000a35565b60005b600654811080156200393757506006546001105b1562001aa8576006818154811062003953576200395362003eec565b6000918252602090912001546001600160a01b038381169116141562003a4857600654620039849060019062003fcb565b811462003a0e57600680546200399d9060019062003fcb565b81548110620039b057620039b062003eec565b600091825260209091200154600680546001600160a01b039092169183908110620039df57620039df62003eec565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b031602179055505b600680548062003a225762003a2262003fe5565b600082815260209020810160001990810180546001600160a01b03191690550190555050565b8062003a548162003f18565b91505062003923565b6000818484111562003a845760405162461bcd60e51b815260040162000a35919062004068565b50600062002747848662003fcb565b82805482825590600052602060002090810192821562003aeb579160200282015b8281111562003aeb57825182546001600160a01b0319166001600160a01b0390911617825560209092019160019091019062003ab4565b5062003af992915062003b0b565b5090565b610f9580620040fa83390190565b5b8082111562003af9576000815560010162003b0c565b80356001600160a01b038116811462000e9357600080fd5b60006020828403121562003b4d57600080fd5b62002b2f8262003b22565b60008083601f84011262003b6b57600080fd5b50813567ffffffffffffffff81111562003b8457600080fd5b6020830191508360208260051b85010111156200170957600080fd5b6000806020838503121562003bb457600080fd5b823567ffffffffffffffff81111562003bcc57600080fd5b62003bda8582860162003b58565b90969095509350505050565b600081518084526020808501945080840160005b8381101562003c185781518752958201959082019060010162003bfa565b509495945050505050565b60208152600062002b2f602083018462003be6565b60006020828403121562003c4b57600080fd5b5035919050565b634e487b7160e01b600052604160045260246000fd5b6000806040838503121562003c7c57600080fd5b823567ffffffffffffffff8082111562003c9557600080fd5b818501915085601f83011262003caa57600080fd5b813560208282111562003cc15762003cc162003c52565b8160051b604051601f19603f8301168101818110868211171562003ce95762003ce962003c52565b60405292835281830193508481018201928984111562003d0857600080fd5b948201945b8386101562003d315762003d218662003b22565b8552948201949382019362003d0d565b9997909101359750505050505050565b6000806040838503121562003d5557600080fd5b62003d608362003b22565b946020939093013593505050565b6000806040838503121562003d8257600080fd5b62003d8d8362003b22565b915062003d9d6020840162003b22565b90509250929050565b634e487b7160e01b600052602160045260246000fd5b600081518084526020808501945080840160005b8381101562003c185781516001600160a01b03168752958201959082019060010162003dd0565b60006004861062003e0c5762003e0c62003da6565b8582528460208301528360408301526080606083015262003e31608083018462003dbc565b9695505050505050565b60208152600062002b2f602083018462003dbc565b60008060006040848603121562003e6657600080fd5b62003e718462003b22565b9250602084013567ffffffffffffffff81111562003e8e57600080fd5b62003e9c8682870162003b58565b9497909650939450505050565b60408152600062003ebe604083018562003be6565b828103602084015262002747818562003be6565b60006020828403121562003ee557600080fd5b5051919050565b634e487b7160e01b600052603260045260246000fd5b634e487b7160e01b600052601160045260246000fd5b600060001982141562003f2f5762003f2f62003f02565b5060010190565b6020808252600c908201526b139bdd081a5b9a5d081e595d60a21b604082015260600190565b6000806040838503121562003f7057600080fd5b505080516020909101519092909150565b602081016003831062003f985762003f9862003da6565b91905290565b634e487b7160e01b600052601260045260246000fd5b60008262003fc65762003fc662003f9e565b500690565b60008282101562003fe05762003fe062003f02565b500390565b634e487b7160e01b600052603160045260246000fd5b6020808252825482820181905260008481528281209092916040850190845b81811015620040415783546001600160a01b0316835260019384019392850192016200401a565b50909695505050505050565b6000821982111562004063576200406362003f02565b500190565b600060208083528351808285015260005b81811015620040975785810183015185820160400152820162004079565b81811115620040aa576000604083870101525b50601f01601f1916929092016040019392505050565b600082620040d257620040d262003f9e565b500490565b6000816000190483118215151615620040f457620040f462003f02565b50029056fe608060405234801561001057600080fd5b50604051610f95380380610f9583398101604081905261002f91610102565b60028054336001600160a01b031991821617909155600580549091166001600160a01b03929092169190911790556040805160608101825243815260006020820181815292820181815260048054600181018255925291517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b60039092029182015591517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19c830155517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19d90910155610132565b60006020828403121561011457600080fd5b81516001600160a01b038116811461012b57600080fd5b9392505050565b610e54806101416000396000f3fe6080604052600436106100c15760003560e01c806370a082311161007f578063c00007b011610059578063c00007b014610211578063e673df8a14610231578063f3fef3a314610251578063fa9ada5b1461027157600080fd5b806370a0823114610185578063714b4658146101bb57806390ca796b146101f157600080fd5b80628cc262146100c657806318160ddd146100f9578063264762041461010e5780633a5381b5146101235780633f9e3f041461015b578063446a2ec814610170575b600080fd5b3480156100d257600080fd5b506100e66100e1366004610c94565b6102b4565b6040519081526020015b60405180910390f35b34801561010557600080fd5b506000546100e6565b61012161011c366004610c94565b610345565b005b34801561012f57600080fd5b50600554610143906001600160a01b031681565b6040516001600160a01b0390911681526020016100f0565b34801561016757600080fd5b506100e661048a565b34801561017c57600080fd5b506100e66104a0565b34801561019157600080fd5b506100e66101a0366004610c94565b6001600160a01b031660009081526001602052604090205490565b3480156101c757600080fd5b506100e66101d6366004610c94565b6001600160a01b031660009081526003602052604090205490565b3480156101fd57600080fd5b5061012161020c366004610cb1565b6104b3565b34801561021d57600080fd5b506100e661022c366004610c94565b61056f565b34801561023d57600080fd5b50600254610143906001600160a01b031681565b34801561025d57600080fd5b5061012161026c366004610cca565b6106b1565b34801561027d57600080fd5b506100e661028c366004610cb1565b6005546001600160a01b03166000908152600660209081526040808320938352929052205490565b6000806102bf6107e5565b60400151905060006102d08461085f565b6040908101516001600160a01b038616600090815260036020529182206001015490925061033c90610336670de0b6b3a764000061033061031188886108f2565b6001600160a01b038b166000908152600160205260409020549061093d565b906109bc565b906109fe565b95945050505050565b6002546001600160a01b031633146103785760405162461bcd60e51b815260040161036f90610cf6565b60405180910390fd5b806001600160a01b038116156103f9576001600160a01b03811660009081526003602090815260409182902082518084019093528054835260010154908201526103c1826102b4565b60208201526103ce61048a565b81526001600160a01b0382166000908152600360209081526040909120825181559101516001909101555b34806104385760405162461bcd60e51b815260206004820152600e60248201526d043616e6e6f74207374616b6520360941b604482015260640161036f565b6104428382610a5d565b826001600160a01b03167f9e71bc8eea02a63969f509818f2dafb9254532904319f9dbda79b67bd34a5f3d8260405161047d91815260200190565b60405180910390a2505050565b60045460009061049b9060016108f2565b905090565b60006104aa6107e5565b60400151905090565b6002546001600160a01b031633146104dd5760405162461bcd60e51b815260040161036f90610cf6565b806104e55750565b6005546001600160a01b031660009081526006602090815260408083204384529091528120805483929061051a908490610d43565b90915550610529905081610aaf565b6005546040518281526001600160a01b03909116907f7d8f3d9291db7e540ea10a43e300f1330c3e9148157349babe42ac2601a2a3e99060200160405180910390a25b50565b6002546000906001600160a01b0316331461059c5760405162461bcd60e51b815260040161036f90610cf6565b816001600160a01b0381161561061d576001600160a01b03811660009081526003602090815260409182902082518084019093528054835260010154908201526105e5826102b4565b60208201526105f261048a565b81526001600160a01b0382166000908152600360209081526040909120825181559101516001909101555b6001600160a01b038316600090815260036020526040902060010154915081156106ab576001600160a01b038084166000818152600360205260408082206001019190915560055490519216917f51a69b4502f660774c9339825c7b5adbf0b8622289134647e29728ec5d9b3bb9906106a29086904290918252602082015260400190565b60405180910390a35b50919050565b6002546001600160a01b031633146106db5760405162461bcd60e51b815260040161036f90610cf6565b816001600160a01b0381161561075c576001600160a01b0381166000908152600360209081526040918290208251808401909352805483526001015490820152610724826102b4565b602082015261073161048a565b81526001600160a01b0382166000908152600360209081526040909120825181559101516001909101555b600082116107a05760405162461bcd60e51b8152602060048201526011602482015270043616e6e6f74207769746864726177203607c1b604482015260640161036f565b6107aa8383610ba2565b826001600160a01b03167f7084f5476618d8e60b11ef0d7d3f06914655adb8793e28ff7f018d4c76d505d58360405161047d91815260200190565b61080960405180606001604052806000815260200160008152602001600081525090565b600461081361048a565b8154811061082357610823610d5b565b90600052602060002090600302016040518060600160405290816000820154815260200160018201548152602001600282015481525050905090565b61088360405180606001604052806000815260200160008152602001600081525090565b60046108a4836001600160a01b031660009081526003602052604090205490565b815481106108b4576108b4610d5b565b906000526020600020906003020160405180606001604052908160008201548152602001600182015481526020016002820154815250509050919050565b600061093483836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f770000815250610c20565b90505b92915050565b60008261094c57506000610937565b60006109588385610d71565b9050826109658583610d90565b146109345760405162461bcd60e51b815260206004820152602160248201527f536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f6044820152607760f81b606482015260840161036f565b600061093483836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f000000000000815250610c51565b600080610a0b8385610d43565b9050838110156109345760405162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f770000000000604482015260640161036f565b600054610a6a90826109fe565b60009081556001600160a01b038316815260016020526040902054610a8f90826109fe565b6001600160a01b0390921660009081526001602052604090209190915550565b6000610ab96107e5565b6040015190506000610aca60005490565b905080610ad657505050565b6000610af8610af18361033087670de0b6b3a764000061093d565b84906109fe565b60408051606081018252438152602081019687529081019182526004805460018101825560009190915290517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b60039092029182015594517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19c860155517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19d90940193909355505050565b600054610baf90826108f2565b60009081556001600160a01b038316815260016020526040902054610bd490826108f2565b6001600160a01b038316600081815260016020526040808220939093559151909183156108fc02918491818181858888f19350505050158015610c1b573d6000803e3d6000fd5b505050565b60008184841115610c445760405162461bcd60e51b815260040161036f9190610db2565b50600061033c8486610e07565b60008183610c725760405162461bcd60e51b815260040161036f9190610db2565b50600061033c8486610d90565b6001600160a01b038116811461056c57600080fd5b600060208284031215610ca657600080fd5b813561093481610c7f565b600060208284031215610cc357600080fd5b5035919050565b60008060408385031215610cdd57600080fd5b8235610ce881610c7f565b946020939093013593505050565b6020808252601a908201527f43616c6c6572206973206e6f7420746865206f70657261746f72000000000000604082015260600190565b634e487b7160e01b600052601160045260246000fd5b60008219821115610d5657610d56610d2d565b500190565b634e487b7160e01b600052603260045260246000fd5b6000816000190483118215151615610d8b57610d8b610d2d565b500290565b600082610dad57634e487b7160e01b600052601260045260246000fd5b500490565b600060208083528351808285015260005b81811015610ddf57858101830151858201604001528201610dc3565b81811115610df1576000604083870101525b50601f01601f1916929092016040019392505050565b600082821015610e1957610e19610d2d565b50039056fea2646970667358221220d1e59c54ff7d8c6292d20b5adf2b51fa7f464c45a97aaa68207edda55b1df74564736f6c634300080800337d8f3d9291db7e540ea10a43e300f1330c3e9148157349babe42ac2601a2a3e9a26469706673582212200ac12c3e3ddea41acd40119f4b782634027abe2b87559825bfdc0bceec4d957064736f6c63430008080033"
)

type hardForkValidatorsV3 struct {
}

func (s *hardForkValidatorsV3) GetName() string {
	return ValidatorsV2ContractName
}

func (s *hardForkValidatorsV3) Update(config *params.ChainConfig, height *big.Int, state *state.StateDB) (err error) {
	contractCode := common.FromHex(validatorV3Code)

	//write code to sys contract
	state.SetCode(ValidatorsV2ContractAddr, contractCode)
	log.Debug("Write code to system contract account", "addr", ValidatorsV2ContractAddr.String(), "code", validatorV3Code)

	return
}

func (s *hardForkValidatorsV3) Execute(state *state.StateDB, header *types.Header, chainContext core.ChainContext, config *params.ChainConfig) (err error) {
	//First, get top validators from the old contract
	v0 := NewValidatorV0()
	topVals, err := v0.GetTopValidators(state, header, chainContext, config)
	if err != nil {
		log.Error("getTopValidators from V0 failed", "err", err)
		return err
	}

	// initialize v1 contract
	method := "initialize"
	data, err := GetInteractiveABI()[ValidatorsV2ContractName].Pack(method, topVals)
	if err != nil {
		log.Error("Can't pack data for initialize", "error", err)
		return err
	}

	msg := vmcaller.NewLegacyMessage(header.Coinbase, &ValidatorsV2ContractAddr, 0, new(big.Int), math.MaxUint64, new(big.Int), data, false)
	_, err = vmcaller.ExecuteMsg(msg, state, header, chainContext, config)

	return
}
