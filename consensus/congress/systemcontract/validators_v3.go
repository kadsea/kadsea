package systemcontract

import (
	"math"
	"math/big"

	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/consensus/congress/vmcaller"
	"github.com/ethereum/go-ethereum/core"
	"github.com/ethereum/go-ethereum/core/state"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/log"
	"github.com/ethereum/go-ethereum/params"
)

const (
	validatorV3Code = "0x6080604052600436106200022e5760003560e01c80638a11d7c9116200012f578063be64569211620000ad578063c4e2f07a1162000078578063c4e2f07a14620006fa578063c967f90f146200071f578063d6eb3de1146200074a578063e7c9d4b51462000762578063e8363f6c146200078757600080fd5b8063be6456921462000685578063c1d7dd7814620006a5578063c253c38414620006bd578063c2a672e014620006d557600080fd5b80639de7025811620000fa5780639de7025814620005b3578063a097724214620005cb578063a224cee71462000601578063a22b0f6e1462000626578063bbe4f6db146200064b57600080fd5b80638a11d7c9146200050b5780638b0e9f3f146200054257806393a5b1b6146200055a57806398e3b626146200058e57600080fd5b806340550a1c11620001bd57806363fc5e71116200018857806363fc5e7114620004065780636969a25c14620004405780637ad229da14620004655780637f4f95fa14620004ab57806380d2dde114620004e657600080fd5b806340550a1c146200037f57806340a141ff14620003a457806348cd4cb114620003c95780634b3d500b14620003e157600080fd5b806330fcb67c11620001fe57806330fcb67c14620002d15780633438174914620002ea57806338b67b8b14620003335780633a061bd3146200036757600080fd5b8062362a771462000233578063158ef93e146200026d5780631b5e358c14620002895780632647620414620002ba575b600080fd5b3480156200024057600080fd5b50620002586200025236600462003a86565b620007b8565b60405190151581526020015b60405180910390f35b3480156200027a57600080fd5b50600054620002589060ff1681565b3480156200029657600080fd5b50620002a161f20081565b6040516001600160a01b03909116815260200162000264565b62000258620002cb36600462003a86565b620008e3565b620002e8620002e236600462003a86565b62000d6c565b005b348015620002f757600080fd5b50620003246200030936600462003a86565b6001600160a01b031660009081526013602052604090205490565b60405190815260200162000264565b3480156200034057600080fd5b50620003586200035236600462003aec565b62000fda565b60405162000264919062003b6f565b3480156200037457600080fd5b50620002a161f10081565b3480156200038c57600080fd5b50620002586200039e36600462003a86565b6200116c565b348015620003b157600080fd5b50620002e8620003c336600462003a86565b620011de565b348015620003d657600080fd5b506200032460015481565b348015620003ee57600080fd5b50620002a16200040036600462003b84565b6200123f565b3480156200041357600080fd5b50620003246200042536600462003a86565b6001600160a01b03166000908152600f602052604090205490565b3480156200044d57600080fd5b50620002a16200045f36600462003b84565b6200126a565b3480156200047257600080fd5b50620003246200048436600462003b9e565b6001600160a01b039091166000908152601060209081526040808320938352929052205490565b348015620004b857600080fd5b50620004d0620004ca36600462003bcb565b6200127b565b6040805192835260208301919091520162000264565b348015620004f357600080fd5b50620002e86200050536600462003b9e565b620012b0565b3480156200051857600080fd5b50620005306200052a36600462003a86565b6200164c565b60405162000264949392919062003c54565b3480156200054f57600080fd5b506200032460085481565b3480156200056757600080fd5b506200057f6200057936600462003b84565b62001748565b60405162000264919062003c98565b3480156200059b57600080fd5b5062000258620005ad36600462003a86565b620018ac565b348015620005c057600080fd5b506200057f62001915565b348015620005d857600080fd5b50620005f0620005ea36600462003cad565b62001979565b604051620002649392919062003cfd565b3480156200060e57600080fd5b50620002e86200062036600462003aec565b62001b8a565b3480156200063357600080fd5b50620002a16200064536600462003b84565b62002159565b3480156200065857600080fd5b50620002a16200066a36600462003a86565b600c602052600090815260409020546001600160a01b031681565b3480156200069257600080fd5b506200032469021e19e0c9bab240000081565b348015620006b257600080fd5b506200032460095481565b348015620006ca57600080fd5b50620004d06200216a565b348015620006e257600080fd5b5062000258620006f436600462003b9e565b62002181565b3480156200070757600080fd5b50620003246200071936600462003bcb565b620025a2565b3480156200072c57600080fd5b5062000736601581565b60405161ffff909116815260200162000264565b3480156200075757600080fd5b50620002a161f30081565b3480156200076f57600080fd5b50620002e86200078136600462003d52565b62002665565b3480156200079457600080fd5b5062000324620007a636600462003a86565b60046020526000908152604090205481565b336000818152600460205260408120805490829055909190801562000858576040516001600160a01b0383169082156108fc029083906000818181858888f193505050501580156200080e573d6000803e3d6000fd5b50604080518281524260208201526001600160a01b0380871692908516917f51a69b4502f660774c9339825c7b5adbf0b8622289134647e29728ec5d9b3bb9910160405180910390a35b6001600160a01b038085166000908152600c6020526040902054168015620008d857604051630c00007b60e41b81526001600160a01b03848116600483015282169063c00007b090602401600060405180830381600087803b158015620008be57600080fd5b505af1158015620008d3573d6000803e3d6000fd5b505050505b506001949350505050565b6000805460ff16620009125760405162461bcd60e51b8152600401620009099062003e35565b60405180910390fd5b336000818152600d60205260409020543490620009309082620028f3565b6001600160a01b038084166000908152600d602052604080822093909355600b5483516325dff9d160e01b815284519294859492909216926325dff9d192600480840193919291829003018186803b1580156200098c57600080fd5b505afa158015620009a1573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620009c7919062003e5b565b915091508143101562000a0a5760405162461bcd60e51b815260206004820152600a6024820152697374617274426c6f636b60b01b604482015260640162000909565b8043111562000a475760405162461bcd60e51b8152602060048201526008602482015267656e64426c6f636b60c01b604482015260640162000909565b6001600160a01b03808716600081815260026020526040902091861614801562000aa1575060016001600160a01b03881660009081526002602052604090205460ff16600381111562000a9e5762000a9e62003c03565b14155b1562000b1457600181015469021e19e0c9bab24000009062000ac49086620028f3565b101562000b145760405162461bcd60e51b815260206004820152601860248201527f5374616b696e6720636f696e73206e6f7420656e6f7567680000000000000000604482015260640162000909565b6001600160a01b038086166000908152600360209081526040808320938b168352929052205462000b9357600380820180546001600160a01b03808916600081815260209586526040808220938e1682529286529182206001908101849055830184559281529290922090910180546001600160a01b03191690911790555b600181015462000be257866001600160a01b03167fbc822c457926e0706c445f2b613394c8a2bf34b3b4335915e3865b90829ce38b600160405162000bd9919062003e80565b60405180910390a25b600181015462000bf39085620028f3565b600180830191909155815460ff16600381111562000c155762000c1562003c03565b1462000c2757805460ff191660011781555b62000c378782600101546200295d565b6001600160a01b038086166000908152600360209081526040808320938b168352929052205462000c699085620028f3565b6001600160a01b038087166000908152600360209081526040808320938c168352929052205560085462000c9e9085620028f3565b6008556001600160a01b038781166000908152600c602052604090819020549051630991d88160e21b81528783166004820152911690819063264762049087906024016000604051808303818588803b15801562000cfb57600080fd5b505af115801562000d10573d6000803e3d6000fd5b5050604080518981524260208201526001600160a01b03808e1695508b1693507fb9ba725934532316cffe10975da6eb25ad49c2d1c294d982c46c9f8d684ee07592500160405180910390a3600196505050505050505b919050565b33411462000daa5760405162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b604482015260640162000909565b436000908152600e6020908152604080832083805290915290205460ff161562000e175760405162461bcd60e51b815260206004820152601960248201527f426c6f636b20697320616c726561647920726577617264656400000000000000604482015260640162000909565b60005460ff1662000e3c5760405162461bcd60e51b8152600401620009099062003e35565b436000818152600e602090815260408083208380529091529020805460ff191660019081179091555433913491101562000efd576001600160a01b0382166000908152600f6020526040812080549162000e968362003eb3565b9091555050600a54604051631e88772760e01b81526001600160a01b03848116600483015290911690631e88772790602401600060405180830381600087803b15801562000ee357600080fd5b505af115801562000ef8573d6000803e3d6000fd5b505050505b6000811162000f0b57505050565b6001600160a01b03821660009081526002602052604081205460ff16600381111562000f3b5762000f3b62003c03565b141562000f4757505050565b6001600160a01b03821660009081526013602052604090205462000f6c9082620028f3565b6001600160a01b03831660009081526013602052604090205562000f91818462002d72565b604080518281524260208201526001600160a01b038416917f7dc4e5df59513708dca355b8706273a5df7b810a4cec8019f2a4b9bb166a1a04910160405180910390a250505b50565b6060818067ffffffffffffffff81111562000ff95762000ff962003d3c565b60405190808252806020026020018201604052801562001023578160200160208202803683370190505b50915060005b818110156200116457600085858381811062001049576200104962003ed1565b905060200201602081019062001060919062003a86565b6001600160a01b038082166000908152600c6020526040812054929350911690811562001105576040516246613160e11b81526001600160a01b038481166004830152831690628cc2629060240160206040518083038186803b158015620010c757600080fd5b505afa158015620010dc573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019062001102919062003ee7565b90505b6001600160a01b0383166000908152600460205260409020546200112a908262003f01565b8685815181106200113f576200113f62003ed1565b60200260200101818152505050505080806200115b9062003eb3565b91505062001029565b505092915050565b6000805b600554811015620011d557826001600160a01b0316600582815481106200119b576200119b62003ed1565b6000918252602090912001546001600160a01b03161415620011c05750600192915050565b80620011cc8162003eb3565b91505062001170565b50600092915050565b3361f20014620012285760405162461bcd60e51b815260206004820152601460248201527350756e69736820636f6e7472616374206f6e6c7960601b604482015260640162000909565b6006546001101562000fd75762000fd7816200357c565b600681815481106200125057600080fd5b6000918252602090912001546001600160a01b0316905081565b600581815481106200125057600080fd5b6001600160a01b03828116600090815260036020908152604080832093851683529290522080546001909101545b9250929050565b3361f20014620012fa5760405162461bcd60e51b815260206004820152601460248201527350756e69736820636f6e7472616374206f6e6c7960601b604482015260640162000909565b8160006001600160a01b03841660009081526002602052604090205460ff1660038111156200132d576200132d62003c03565b1415620013735760405162461bcd60e51b815260206004820152601360248201527215985b1a59185d1bdc881b9bdd08195e1a5cdd606a1b604482015260640162000909565b6001600160a01b03808216600090815260036020908152604080832093871683529281528282206002909152919020815480851115620013b1578094505b84620013bf57505050505050565b8481141562001514576003820154620013db9060019062003f1c565b836001015414620014d357600382018054620013fa9060019062003f1c565b815481106200140d576200140d62003ed1565b9060005260206000200160009054906101000a90046001600160a01b03168260030184600101548154811062001447576200144762003ed1565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b03160217905550826001015460036000846003018660010154815481106200149a576200149a62003ed1565b60009182526020808320909101546001600160a01b0390811684528382019490945260409283018220938b168252929092529020600101555b81600301805480620014e957620014e962003f36565b600082815260208120820160001990810180546001600160a01b031916905590910190915560018401555b8254620015229086620035c1565b83556001820154620015359086620035c1565b6001830155600854620015499086620035c1565b6008556001600160a01b0384166000908152600d6020526040902054620015719086620035c1565b6001600160a01b038581166000818152600d60209081526040808320959095558a84168252600c905283902054925163f3fef3a360e01b8152600481019190915260248101889052911690819063f3fef3a390604401600060405180830381600087803b158015620015e257600080fd5b505af1158015620015f7573d6000803e3d6000fd5b5050604080518981524260208201526001600160a01b03808c169450891692507f449002ae18e748d69a55f38514400d64f966492e593e32d6e9b8b24db98a0bc1910160405180910390a350505050505b5050565b6001600160a01b03811660009081526002602052604080822081516080810190925280548392839260609284929190829060ff16600381111562001694576200169462003c03565b6003811115620016a857620016a862003c03565b81526020016001820154815260200160028201548152602001600382018054806020026020016040519081016040528092919081815260200182805480156200171b57602002820191906000526020600020905b81546001600160a01b03168152600190910190602001808311620016fc575b505050919092525050815160208301516040840151606090940151919a9099509297509550909350505050565b600b54604080516325dff9d160e01b815281516060936000936001600160a01b03909116926325dff9d19260048083019392829003018186803b1580156200178f57600080fd5b505afa158015620017a4573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620017ca919062003e5b565b915050600081118015620017de5750808310155b15620018495760068054806020026020016040519081016040528092919081815260200182805480156200183c57602002820191906000526020600020905b81546001600160a01b031681526001909101906020018083116200181d575b5050505050915050919050565b60078054806020026020016040519081016040528092919081815260200182805480156200183c576020028201919060005260206000209081546001600160a01b031681526001909101906020018083116200181d575050505050915050919050565b6000805b600654811015620011d557826001600160a01b031660068281548110620018db57620018db62003ed1565b6000918252602090912001546001600160a01b03161415620019005750600192915050565b806200190c8162003eb3565b915050620018b0565b606060058054806020026020016040519081016040528092919081815260200182805480156200196f57602002820191906000526020600020905b81546001600160a01b0316815260019091019060200180831162001950575b5050505050905090565b60608080848067ffffffffffffffff8111156200199a576200199a62003d3c565b604051908082528060200260200182016040528015620019c4578160200160208202803683370190505b5093508067ffffffffffffffff811115620019e357620019e362003d3c565b60405190808252806020026020018201604052801562001a0d578160200160208202803683370190505b5092508067ffffffffffffffff81111562001a2c5762001a2c62003d3c565b60405190808252806020026020018201604052801562001a56578160200160208202803683370190505b50915060005b8181101562001b7f57600088888381811062001a7c5762001a7c62003ed1565b905060200201602081019062001a93919062003a86565b6001600160a01b03811660009081526010602090815260408083208b845290915290205487519192509087908490811062001ad25762001ad262003ed1565b6020908102919091018101919091526001600160a01b03821660009081526011825260408082208a83529092522054855186908490811062001b185762001b1862003ed1565b6020908102919091018101919091526001600160a01b03821660009081526012825260408082208a83529092522054845185908490811062001b5e5762001b5e62003ed1565b6020908102919091010152508062001b768162003eb3565b91505062001a5c565b505093509350939050565b60005460ff161562001bd55760405162461bcd60e51b8152602060048201526013602482015272105b1c9958591e481a5b9a5d1a585b1a5e9959606a1b604482015260640162000909565b600a80546001600160a01b031990811661f20017909155600b805490911661f30017905560005b818110156200210d57600083838381811062001c1c5762001c1c62003ed1565b905060200201602081019062001c33919062003a86565b6001600160a01b0316141562001c8c5760405162461bcd60e51b815260206004820152601960248201527f496e76616c69642076616c696461746f72206164647265737300000000000000604482015260640162000909565b62001cbc83838381811062001ca55762001ca562003ed1565b90506020020160208101906200039e919062003a86565b62001d2257600583838381811062001cd85762001cd862003ed1565b905060200201602081019062001cef919062003a86565b81546001810183556000928352602090922090910180546001600160a01b0319166001600160a01b039092169190911790555b62001d5283838381811062001d3b5762001d3b62003ed1565b9050602002016020810190620005ad919062003a86565b62001e1857600683838381811062001d6e5762001d6e62003ed1565b905060200201602081019062001d85919062003a86565b81546001810183556000928352602090922090910180546001600160a01b0319166001600160a01b03909216919091179055600783838381811062001dce5762001dce62003ed1565b905060200201602081019062001de5919062003a86565b81546001810183556000928352602090922090910180546001600160a01b0319166001600160a01b039092169190911790555b60006002600085858581811062001e335762001e3362003ed1565b905060200201602081019062001e4a919062003a86565b6001600160a01b0316815260208101919091526040016000205460ff16600381111562001e7b5762001e7b62003c03565b141562001ef05760016002600085858581811062001e9d5762001e9d62003ed1565b905060200201602081019062001eb4919062003a86565b6001600160a01b031681526020810191909152604001600020805460ff1916600183600381111562001eea5762001eea62003c03565b02179055505b6000600c8185858581811062001f0a5762001f0a62003ed1565b905060200201602081019062001f21919062003a86565b6001600160a01b039081168252602082019290925260400160002054161415620020f857600083838381811062001f5c5762001f5c62003ed1565b905060200201602081019062001f73919062003a86565b60405160200162001f97919060609190911b6001600160601b031916815260140190565b60405160208183030381529060405280519060200120905060008185858581811062001fc75762001fc762003ed1565b905060200201602081019062001fde919062003a86565b60405162001fec906200399c565b6001600160a01b0390911681526020018190604051809103906000f59050801580156200201d573d6000803e3d6000fd5b50905080600c60008787878181106200203a576200203a62003ed1565b905060200201602081019062002051919062003a86565b6001600160a01b039081168252602082019290925260400160002080546001600160a01b0319169290911691909117905584848481811062002097576200209762003ed1565b9050602002016020810190620020ae919062003a86565b604080516001600160a01b03848116825242602083015292909216917f5e5b474625449a92e2b1a6f9f183435f09402d6897ae7f8779c72142ed11170b910160405180910390a250505b80620021048162003eb3565b91505062001bfc565b507feacea8f3c22f06c0b18306bdb04d0a967255129e8ce0094debb0a0ff89d006b5600560405162002140919062003f4c565b60405180910390a150506000805460ff19166001179055565b600781815481106200125057600080fd5b60008062002179600062003605565b915091509091565b6000805460ff16620021a75760405162461bcd60e51b8152600401620009099062003e35565b3360006001600160a01b03851660009081526002602052604090205460ff166003811115620021da57620021da62003c03565b1415620022205760405162461bcd60e51b815260206004820152601360248201527215985b1a59185d1bdc881b9bdd08195e1a5cdd606a1b604482015260640162000909565b6001600160a01b03808216600090815260036020908152604080832093881683529281528282206002909152919020815480861115620022a35760405162461bcd60e51b815260206004820152601860248201527f596f7520646f6e2774206861766520616e79207374616b650000000000000000604482015260640162000909565b85811415620023f8576003820154620022bf9060019062003f1c565b836001015414620023b757600382018054620022de9060019062003f1c565b81548110620022f157620022f162003ed1565b9060005260206000200160009054906101000a90046001600160a01b0316826003018460010154815481106200232b576200232b62003ed1565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b03160217905550826001015460036000846003018660010154815481106200237e576200237e62003ed1565b60009182526020808320909101546001600160a01b0390811684528382019490945260409283018220938c168252929092529020600101555b81600301805480620023cd57620023cd62003f36565b600082815260208120820160001990810180546001600160a01b031916905590910190915560018401555b8254620024069087620035c1565b83556001820154620024199087620035c1565b60018301556008546200242d9087620035c1565b6008556001600160a01b0384166000908152600d6020526040902054620024559087620035c1565b6001600160a01b038086166000818152600d602052604090209290925588161415620024d2576200248687620018ac565b15620024d257825469021e19e0c9bab24000001115620024d25760405162461bcd60e51b815260040162000909906020808252600490820152630333030360e41b604082015260600190565b6001600160a01b038781166000908152600c60205260409081902054905163f3fef3a360e01b8152868316600482015260248101899052911690819063f3fef3a390604401600060405180830381600087803b1580156200253257600080fd5b505af115801562002547573d6000803e3d6000fd5b5050604080518a81524260208201526001600160a01b03808d169450891692507f449002ae18e748d69a55f38514400d64f966492e593e32d6e9b8b24db98a0bc1910160405180910390a36001955050505050505b92915050565b6001600160a01b038181166000908152600c60205260408082205490516246613160e11b815285841660048201529192169082908290628cc2629060240160206040518083038186803b158015620025f957600080fd5b505afa1580156200260e573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019062002634919062003ee7565b6001600160a01b0386166000908152600460205260409020549091506200265c9082620028f3565b95945050505050565b334114620026a35760405162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b604482015260640162000909565b436000908152600e602090815260408083206001845290915290205460ff1615620027115760405162461bcd60e51b815260206004820152601a60248201527f56616c696461746f727320616c72656164792075706461746564000000000000604482015260640162000909565b60005460ff16620027365760405162461bcd60e51b8152600401620009099062003e35565b8162002743814362003fb4565b15620027855760405162461bcd60e51b815260206004820152601060248201526f426c6f636b2065706f6368206f6e6c7960801b604482015260640162000909565b6000828152600e6020908152604080832060018085529252909120805460ff191690911790558351620027f25760405162461bcd60e51b815260206004820152601460248201527356616c696461746f722073657420656d7074792160601b604482015260640162000909565b600b54604080516325dff9d160e01b815281516000936001600160a01b0316926325dff9d19260048082019391829003018186803b1580156200283457600080fd5b505afa15801562002849573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906200286f919062003e5b565b915050600081118015620028835750808310155b15620028ec57600580546200289b91600791620039aa565b508451620028b1906005906020880190620039ff565b507feacea8f3c22f06c0b18306bdb04d0a967255129e8ce0094debb0a0ff89d006b585604051620028e3919062003c98565b60405180910390a15b5050505050565b60008062002902838562003f01565b905083811015620029565760405162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f770000000000604482015260640162000909565b9392505050565b60005b600654811015620029c157826001600160a01b0316600682815481106200298b576200298b62003ed1565b6000918252602090912001546001600160a01b03161415620029ac57505050565b80620029b88162003eb3565b91505062002960565b506006546015111562002b165760068054600181019091557ff652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d3f0180546001600160a01b0319166001600160a01b038481169182179092556000908152600c60205260409020541662001648576040516001600160601b0319606084901b1660208201526000906034016040516020818303038152906040528051906020012090506000818460405162002a74906200399c565b6001600160a01b0390911681526020018190604051809103906000f590508015801562002aa5573d6000803e3d6000fd5b506001600160a01b038581166000818152600c602090815260409182902080546001600160a01b031916948616948517905581519384524290840152929350917f5e5b474625449a92e2b1a6f9f183435f09402d6897ae7f8779c72142ed11170b910160405180910390a250505050565b600060026000600660008154811062002b335762002b3362003ed1565b60009182526020808320909101546001600160a01b03168352820192909252604001812060019081015492505b60065481101562002c125782600260006006848154811062002b865762002b8662003ed1565b60009182526020808320909101546001600160a01b03168352820192909252604001902060010154101562002bfd57600260006006838154811062002bcf5762002bcf62003ed1565b60009182526020808320909101546001600160a01b0316835282019290925260400190206001015492509050805b8062002c098162003eb3565b91505062002b60565b5081831162002c215750505050565b6001600160a01b038481166000908152600c60205260409020541662002d27576040516001600160601b0319606086901b1660208201526000906034016040516020818303038152906040528051906020012090506000818660405162002c88906200399c565b6001600160a01b0390911681526020018190604051809103906000f590508015801562002cb9573d6000803e3d6000fd5b506001600160a01b038781166000818152600c602090815260409182902080546001600160a01b031916948616948517905581519384524290840152929350917f5e5b474625449a92e2b1a6f9f183435f09402d6897ae7f8779c72142ed11170b910160405180910390a250505b836006828154811062002d3e5762002d3e62003ed1565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b0316021790555050505050565b8162002d7c575050565b60008062002d8a8362003605565b90925090508062002d9b5750505050565b600080836200308957600062002db287856200372b565b905062002dcc62002dc482866200376f565b8890620035c1565b925060005b60055481101562002f6f5760006005828154811062002df45762002df462003ed1565b6000918252602090912001546001600160a01b0316905060036001600160a01b03821660009081526002602052604090205460ff16600381111562002e3d5762002e3d62003c03565b1415801562002e5e5750876001600160a01b0316816001600160a01b031614155b1562002f59576001600160a01b03811660009081526004602052604090205462002e899084620028f3565b6001600160a01b0382166000908152600460209081526040808320939093556010815282822043835290522054909350839062002ec79084620028f3565b6001600160a01b03821660008181526010602090815260408083204380855290835281842095909555928252601181528282209382529290925290205462002f109084620028f3565b6001600160a01b03821660008181526011602090815260408083204384528252918290209390935551858152909160008051602062004f39833981519152910160405180910390a25b508062002f668162003eb3565b91505062002dd1565b5060008311801562002f8957506001600160a01b03821615155b1562003080576001600160a01b03821660009081526004602052604090205462002fb49084620028f3565b6001600160a01b038316600090815260046020908152604080832093909355601081528282204383529052205462002fed9084620028f3565b6001600160a01b038316600081815260106020908152604080832043808552908352818420959095559282526011815282822093825292909252902054620030369084620028f3565b6001600160a01b03831660008181526011602090815260408083204384528252918290209390935551858152909160008051602062004f3983398151915291015b60405180910390a25b50505050505050565b6000805b6005548110156200347257600060058281548110620030b057620030b062003ed1565b6000918252602090912001546001600160a01b0316905060036001600160a01b03821660009081526002602052604090205460ff166003811115620030f957620030f962003c03565b141580156200311a5750876001600160a01b0316816001600160a01b031614155b156200345b57600062003163620031338960026200376f565b6001600160a01b0384166000908152600260205260409020600101546200315c908d906200376f565b906200372b565b905080620031735750506200345d565b6001600160a01b03821660009081526004602052604090205491945084916200319d9082620028f3565b6001600160a01b0383166000908152600460209081526040808320939093556011815282822043835290522054620031d69082620028f3565b6001600160a01b038381166000818152601160209081526040808320438452825280832095909555828252600c90528381205493516246613160e11b815260048101929092529290911691908290628cc2629060240160206040518083038186803b1580156200324557600080fd5b505afa1580156200325a573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019062003280919062003ee7565b9050816001600160a01b031663abaa9916846040518263ffffffff1660e01b81526004016000604051808303818588803b158015620032be57600080fd5b505af1158015620032d3573d6000803e3d6000fd5b50506040516246613160e11b81526001600160a01b0388811660048301526000945086169250628cc262915060240160206040518083038186803b1580156200331b57600080fd5b505afa15801562003330573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019062003356919062003ee7565b90506200339362003368838362003f1c565b6001600160a01b038716600090815260126020908152604080832043845290915290205490620028f3565b6001600160a01b0386166000908152601260209081526040808320438452909152902055620033f3620033c88560026200376f565b6001600160a01b038716600090815260106020908152604080832043845290915290205490620028f3565b6001600160a01b03861660008181526010602090815260408083204384528252918290209390935551868152909160008051602062004f39833981519152910160405180910390a2620034546200344c8560026200376f565b8890620028f3565b9650505050505b505b80620034698162003eb3565b9150506200308d565b506200347f8782620035c1565b92506000831180156200349a57506001600160a01b03821615155b1562003080576001600160a01b038216600090815260046020526040902054620034c59084620028f3565b6001600160a01b0383166000908152600460209081526040808320939093556011815282822043835290522054620034fe9084620028f3565b6001600160a01b038316600081815260116020908152604080832043808552908352818420959095559282526010815282822093825292909252812080548592906200354c90849062003f01565b90915550506040518381526001600160a01b0383169060008051602062004f398339815191529060200162003077565b6001600160a01b03811660009081526002602052604081205460ff166003811115620035ac57620035ac62003c03565b1415620035b65750565b62000fd781620037f6565b60006200295683836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f77000081525062003933565b60008060005b60055481101562003725576003600260006005848154811062003632576200363262003ed1565b60009182526020808320909101546001600160a01b0316835282019290925260400190205460ff1660038111156200366e576200366e62003c03565b14158015620036aa5750600581815481106200368e576200368e62003ed1565b6000918252602090912001546001600160a01b03858116911614155b156200371057620036fe6002600060058481548110620036ce57620036ce62003ed1565b60009182526020808320909101546001600160a01b031683528201929092526040019020600101548490620028f3565b9250816200370c8162003eb3565b9250505b806200371c8162003eb3565b9150506200360b565b50915091565b60006200295683836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f00000000000081525062003969565b60008262003780575060006200259c565b60006200378e838562003fcb565b9050826200379d858362003fed565b14620029565760405162461bcd60e51b815260206004820152602160248201527f536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f6044820152607760f81b606482015260840162000909565b60005b600654811080156200380d57506006546001105b1562001648576006818154811062003829576200382962003ed1565b6000918252602090912001546001600160a01b03838116911614156200391e576006546200385a9060019062003f1c565b8114620038e45760068054620038739060019062003f1c565b8154811062003886576200388662003ed1565b600091825260209091200154600680546001600160a01b039092169183908110620038b557620038b562003ed1565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b031602179055505b6006805480620038f857620038f862003f36565b600082815260209020810160001990810180546001600160a01b03191690550190555050565b806200392a8162003eb3565b915050620037f9565b600081848411156200395a5760405162461bcd60e51b815260040162000909919062004004565b5060006200265c848662003f1c565b600081836200398d5760405162461bcd60e51b815260040162000909919062004004565b5060006200265c848662003fed565b610edc806200405d83390190565b828054828255906000526020600020908101928215620039ed5760005260206000209182015b82811115620039ed578254825591600101919060010190620039d0565b50620039fb92915062003a57565b5090565b828054828255906000526020600020908101928215620039ed579160200282015b82811115620039ed57825182546001600160a01b0319166001600160a01b0390911617825560209092019160019091019062003a20565b5b80821115620039fb576000815560010162003a58565b80356001600160a01b038116811462000d6757600080fd5b60006020828403121562003a9957600080fd5b620029568262003a6e565b60008083601f84011262003ab757600080fd5b50813567ffffffffffffffff81111562003ad057600080fd5b6020830191508360208260051b8501011115620012a957600080fd5b6000806020838503121562003b0057600080fd5b823567ffffffffffffffff81111562003b1857600080fd5b62003b268582860162003aa4565b90969095509350505050565b600081518084526020808501945080840160005b8381101562003b645781518752958201959082019060010162003b46565b509495945050505050565b60208152600062002956602083018462003b32565b60006020828403121562003b9757600080fd5b5035919050565b6000806040838503121562003bb257600080fd5b62003bbd8362003a6e565b946020939093013593505050565b6000806040838503121562003bdf57600080fd5b62003bea8362003a6e565b915062003bfa6020840162003a6e565b90509250929050565b634e487b7160e01b600052602160045260246000fd5b600081518084526020808501945080840160005b8381101562003b645781516001600160a01b03168752958201959082019060010162003c2d565b60006004861062003c695762003c6962003c03565b8582528460208301528360408301526080606083015262003c8e608083018462003c19565b9695505050505050565b60208152600062002956602083018462003c19565b60008060006040848603121562003cc357600080fd5b833567ffffffffffffffff81111562003cdb57600080fd5b62003ce98682870162003aa4565b909790965060209590950135949350505050565b60608152600062003d12606083018662003b32565b828103602084015262003d26818662003b32565b9050828103604084015262003c8e818562003b32565b634e487b7160e01b600052604160045260246000fd5b60008060006060848603121562003d6857600080fd5b833567ffffffffffffffff8082111562003d8157600080fd5b818601915086601f83011262003d9657600080fd5b813560208282111562003dad5762003dad62003d3c565b8160051b604051601f19603f8301168101818110868211171562003dd55762003dd562003d3c565b60405292835281830193508481018201928a84111562003df457600080fd5b948201945b8386101562003e1d5762003e0d8662003a6e565b8552948201949382019362003df9565b9a918901359950506040909701359695505050505050565b6020808252600c908201526b139bdd081a5b9a5d081e595d60a21b604082015260600190565b6000806040838503121562003e6f57600080fd5b505080516020909101519092909150565b602081016003831062003e975762003e9762003c03565b91905290565b634e487b7160e01b600052601160045260246000fd5b600060001982141562003eca5762003eca62003e9d565b5060010190565b634e487b7160e01b600052603260045260246000fd5b60006020828403121562003efa57600080fd5b5051919050565b6000821982111562003f175762003f1762003e9d565b500190565b60008282101562003f315762003f3162003e9d565b500390565b634e487b7160e01b600052603160045260246000fd5b6020808252825482820181905260008481528281209092916040850190845b8181101562003f925783546001600160a01b03168352600193840193928501920162003f6b565b50909695505050505050565b634e487b7160e01b600052601260045260246000fd5b60008262003fc65762003fc662003f9e565b500690565b600081600019048311821515161562003fe85762003fe862003e9d565b500290565b60008262003fff5762003fff62003f9e565b500490565b600060208083528351808285015260005b81811015620040335785810183015185820160400152820162004015565b8181111562004046576000604083870101525b50601f01601f191692909201604001939250505056fe608060405234801561001057600080fd5b50604051610edc380380610edc83398101604081905261002f91610102565b60028054336001600160a01b031991821617909155600580549091166001600160a01b03929092169190911790556040805160608101825243815260006020820181815292820181815260048054600181018255925291517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b60039092029182015591517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19c830155517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19d90910155610132565b60006020828403121561011457600080fd5b81516001600160a01b038116811461012b57600080fd5b9392505050565b610d9b806101416000396000f3fe6080604052600436106100a65760003560e01c806370a082311161006457806370a082311461016a578063714b4658146101a0578063abaa9916146101d6578063c00007b0146101de578063e673df8a146101fe578063f3fef3a31461021e57600080fd5b80628cc262146100ab57806318160ddd146100de57806326476204146100f35780633a5381b5146101085780633f9e3f0414610140578063446a2ec814610155575b600080fd5b3480156100b757600080fd5b506100cb6100c6366004610bf4565b61023e565b6040519081526020015b60405180910390f35b3480156100ea57600080fd5b506000546100cb565b610106610101366004610bf4565b6102cf565b005b34801561011457600080fd5b50600554610128906001600160a01b031681565b6040516001600160a01b0390911681526020016100d5565b34801561014c57600080fd5b506100cb610414565b34801561016157600080fd5b506100cb61042a565b34801561017657600080fd5b506100cb610185366004610bf4565b6001600160a01b031660009081526001602052604090205490565b3480156101ac57600080fd5b506100cb6101bb366004610bf4565b6001600160a01b031660009081526003602052604090205490565b61010661043d565b3480156101ea57600080fd5b506101066101f9366004610bf4565b6104be565b34801561020a57600080fd5b50600254610128906001600160a01b031681565b34801561022a57600080fd5b50610106610239366004610c11565b610623565b600080610249610757565b604001519050600061025a846107d1565b6040908101516001600160a01b03861660009081526003602052918220600101549092506102c6906102c0670de0b6b3a76400006102ba61029b8888610864565b6001600160a01b038b16600090815260016020526040902054906108af565b9061092e565b90610970565b95945050505050565b6002546001600160a01b031633146103025760405162461bcd60e51b81526004016102f990610c3d565b60405180910390fd5b806001600160a01b03811615610383576001600160a01b038116600090815260036020908152604091829020825180840190935280548352600101549082015261034b8261023e565b6020820152610358610414565b81526001600160a01b0382166000908152600360209081526040909120825181559101516001909101555b34806103c25760405162461bcd60e51b815260206004820152600e60248201526d043616e6e6f74207374616b6520360941b60448201526064016102f9565b6103cc83826109cf565b826001600160a01b03167f9e71bc8eea02a63969f509818f2dafb9254532904319f9dbda79b67bd34a5f3d8260405161040791815260200190565b60405180910390a2505050565b600454600090610425906001610864565b905090565b6000610434610757565b60400151905090565b6002546001600160a01b031633146104675760405162461bcd60e51b81526004016102f990610c3d565b34806104705750565b61047981610a21565b6005546040518281526001600160a01b03909116907f7d8f3d9291db7e540ea10a43e300f1330c3e9148157349babe42ac2601a2a3e99060200160405180910390a250565b6002546001600160a01b031633146104e85760405162461bcd60e51b81526004016102f990610c3d565b806001600160a01b03811615610569576001600160a01b03811660009081526003602090815260409182902082518084019093528054835260010154908201526105318261023e565b602082015261053e610414565b81526001600160a01b0382166000908152600360209081526040909120825181559101516001909101555b6001600160a01b038216600090815260036020526040902060010154801561061e576001600160a01b0383166000818152600360205260408082206001018290555183156108fc0291849190818181858888f193505050501580156105d2573d6000803e3d6000fd5b50600554604080518381524260208201526001600160a01b03928316928616917f51a69b4502f660774c9339825c7b5adbf0b8622289134647e29728ec5d9b3bb9910160405180910390a35b505050565b6002546001600160a01b0316331461064d5760405162461bcd60e51b81526004016102f990610c3d565b816001600160a01b038116156106ce576001600160a01b03811660009081526003602090815260409182902082518084019093528054835260010154908201526106968261023e565b60208201526106a3610414565b81526001600160a01b0382166000908152600360209081526040909120825181559101516001909101555b600082116107125760405162461bcd60e51b8152602060048201526011602482015270043616e6e6f74207769746864726177203607c1b60448201526064016102f9565b61071c8383610b04565b826001600160a01b03167f7084f5476618d8e60b11ef0d7d3f06914655adb8793e28ff7f018d4c76d505d58360405161040791815260200190565b61077b60405180606001604052806000815260200160008152602001600081525090565b6004610785610414565b8154811061079557610795610c74565b90600052602060002090600302016040518060600160405290816000820154815260200160018201548152602001600282015481525050905090565b6107f560405180606001604052806000815260200160008152602001600081525090565b6004610816836001600160a01b031660009081526003602052604090205490565b8154811061082657610826610c74565b906000526020600020906003020160405180606001604052908160008201548152602001600182015481526020016002820154815250509050919050565b60006108a683836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f770000815250610b7d565b90505b92915050565b6000826108be575060006108a9565b60006108ca8385610ca0565b9050826108d78583610cbf565b146108a65760405162461bcd60e51b815260206004820152602160248201527f536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f6044820152607760f81b60648201526084016102f9565b60006108a683836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f000000000000815250610bae565b60008061097d8385610ce1565b9050838110156108a65760405162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f77000000000060448201526064016102f9565b6000546109dc9082610970565b60009081556001600160a01b038316815260016020526040902054610a019082610970565b6001600160a01b0390921660009081526001602052604090209190915550565b6000610a2b610757565b6040015190506000610a5b610a54610a4260005490565b6102ba86670de0b6b3a76400006108af565b8390610970565b60408051606081018252438152602081019586529081019182526004805460018101825560009190915290517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b60039092029182015593517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19c850155517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19d909301929092555050565b600054610b119082610864565b60009081556001600160a01b038316815260016020526040902054610b369082610864565b6001600160a01b038316600081815260016020526040808220939093559151909183156108fc02918491818181858888f1935050505015801561061e573d6000803e3d6000fd5b60008184841115610ba15760405162461bcd60e51b81526004016102f99190610cf9565b5060006102c68486610d4e565b60008183610bcf5760405162461bcd60e51b81526004016102f99190610cf9565b5060006102c68486610cbf565b6001600160a01b0381168114610bf157600080fd5b50565b600060208284031215610c0657600080fd5b81356108a681610bdc565b60008060408385031215610c2457600080fd5b8235610c2f81610bdc565b946020939093013593505050565b6020808252601a908201527f43616c6c6572206973206e6f7420746865206f70657261746f72000000000000604082015260600190565b634e487b7160e01b600052603260045260246000fd5b634e487b7160e01b600052601160045260246000fd5b6000816000190483118215151615610cba57610cba610c8a565b500290565b600082610cdc57634e487b7160e01b600052601260045260246000fd5b500490565b60008219821115610cf457610cf4610c8a565b500190565b600060208083528351808285015260005b81811015610d2657858101830151858201604001528201610d0a565b81811115610d38576000604083870101525b50601f01601f1916929092016040019392505050565b600082821015610d6057610d60610c8a565b50039056fea26469706673582212209d5d1aaddef089e48bab9216a6960641a0f40869b4b9368c7faab70a3add8f8564736f6c634300080800337d8f3d9291db7e540ea10a43e300f1330c3e9148157349babe42ac2601a2a3e9a26469706673582212201cbaf30cfbaf81cac4ad72914725e77d7db92393229a842ab526e9f026358ef864736f6c63430008080033"
)

type hardForkValidatorsV3 struct {
}

func (s *hardForkValidatorsV3) GetName() string {
	return ValidatorsV2ContractName
}

func (s *hardForkValidatorsV3) Update(config *params.ChainConfig, height *big.Int, state *state.StateDB) (err error) {
	contractCode := common.FromHex(validatorV3Code)

	//write code to sys contract
	state.SetCode(ValidatorsV2ContractAddr, contractCode)
	log.Debug("Write code to system contract account", "addr", ValidatorsV2ContractAddr.String(), "code", validatorV3Code)

	return
}

func (s *hardForkValidatorsV3) Execute(state *state.StateDB, header *types.Header, chainContext core.ChainContext, config *params.ChainConfig) (err error) {
	//First, get top validators from the old contract
	v0 := NewValidatorV0()
	topVals, err := v0.GetTopValidators(state, header, chainContext, config)
	if err != nil {
		log.Error("getTopValidators from V0 failed", "err", err)
		return err
	}

	// initialize v1 contract
	method := "initialize"
	data, err := GetInteractiveABI()[ValidatorsV2ContractName].Pack(method, topVals)
	if err != nil {
		log.Error("Can't pack data for initialize", "error", err)
		return err
	}

	msg := vmcaller.NewLegacyMessage(header.Coinbase, &ValidatorsV2ContractAddr, 0, new(big.Int), math.MaxUint64, new(big.Int), data, false)
	_, err = vmcaller.ExecuteMsg(msg, state, header, chainContext, config)

	return
}
