package systemcontract

import (
	"math"
	"math/big"

	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/consensus/congress/vmcaller"
	"github.com/ethereum/go-ethereum/core"
	"github.com/ethereum/go-ethereum/core/state"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/log"
	"github.com/ethereum/go-ethereum/params"
)

const (
	validatorV3Code = "0x6080604052600436106200020a5760003560e01c80638b0e9f3f1162000117578063be64569211620000a1578063c4e2f07a116200006c578063c4e2f07a1462000637578063c967f90f146200065c578063d6eb3de11462000687578063e8363f6c146200069f57600080fd5b8063be64569214620005c2578063c1d7dd7814620005e2578063c253c38414620005fa578063c2a672e0146200061257600080fd5b8063a224cee711620000e2578063a224cee71462000526578063a22b0f6e146200054b578063afeea1151462000570578063bbe4f6db146200058857600080fd5b80638b0e9f3f146200048b57806398e3b62614620004a35780639de7025814620004c8578063a097724214620004ef57600080fd5b806340a141ff11620001995780636969a25c11620001645780636969a25c14620003cf5780637f4f95fa14620003f457806380d2dde1146200042f5780638a11d7c9146200045457600080fd5b806340a141ff146200033957806348cd4cb1146200035e5780634b3d500b14620003855780636846992a14620003aa57600080fd5b806330fcb67c11620001da57806330fcb67c14620002ad57806338b67b8b14620002c65780633a061bd314620002fc57806340550a1c146200031457600080fd5b8062362a77146200020f578063158ef93e14620002495780631b5e358c1462000265578063264762041462000296575b600080fd5b3480156200021c57600080fd5b50620002346200022e36600462003d5d565b620006d0565b60405190151581526020015b60405180910390f35b3480156200025657600080fd5b50600054620002349060ff1681565b3480156200027257600080fd5b506200027d61f20081565b6040516001600160a01b03909116815260200162000240565b62000234620002a736600462003d5d565b620007fb565b620002c4620002be36600462003d5d565b62000c84565b005b348015620002d357600080fd5b50620002eb620002e536600462003dc3565b62000eb4565b604051620002409392919062003e46565b3480156200030957600080fd5b506200027d61f10081565b3480156200032157600080fd5b50620002346200033336600462003d5d565b62001165565b3480156200034657600080fd5b50620002c46200035836600462003d5d565b620011d7565b3480156200036b57600080fd5b506200037660015481565b60405190815260200162000240565b3480156200039257600080fd5b506200027d620003a436600462003e8f565b62001238565b348015620003b757600080fd5b50620002c4620003c936600462003ebf565b62001263565b348015620003dc57600080fd5b506200027d620003ee36600462003e8f565b620014f1565b3480156200040157600080fd5b50620004196200041336600462003f98565b62001502565b6040805192835260208301919091520162000240565b3480156200043c57600080fd5b50620002c46200044e36600462003fd0565b62001537565b3480156200046157600080fd5b50620004796200047336600462003d5d565b620018d3565b6040516200024094939291906200404e565b3480156200049857600080fd5b506200037660085481565b348015620004b057600080fd5b5062000234620004c236600462003d5d565b620019cf565b348015620004d557600080fd5b50620004e062001a38565b60405162000240919062004088565b348015620004fc57600080fd5b50620005146200050e3660046200409d565b62001a9c565b604051620002409493929190620040ed565b3480156200053357600080fd5b50620002c46200054536600462003dc3565b62001dbf565b3480156200055857600080fd5b506200027d6200056a36600462003e8f565b6200238e565b3480156200057d57600080fd5b50620004e06200239f565b3480156200059557600080fd5b506200027d620005a736600462003d5d565b600c602052600090815260409020546001600160a01b031681565b348015620005cf57600080fd5b506200037669021e19e0c9bab240000081565b348015620005ef57600080fd5b506200037660095481565b3480156200060757600080fd5b506200041962002503565b3480156200061f57600080fd5b50620002346200063136600462003fd0565b6200251a565b3480156200064457600080fd5b50620003766200065636600462003f98565b6200293b565b3480156200066957600080fd5b5062000673601581565b60405161ffff909116815260200162000240565b3480156200069457600080fd5b506200027d61f30081565b348015620006ac57600080fd5b5062000376620006be36600462003d5d565b60046020526000908152604090205481565b336000818152600460205260408120805490829055909190801562000770576040516001600160a01b0383169082156108fc029083906000818181858888f1935050505015801562000726573d6000803e3d6000fd5b50604080518281524260208201526001600160a01b0380871692908516917f51a69b4502f660774c9339825c7b5adbf0b8622289134647e29728ec5d9b3bb9910160405180910390a35b6001600160a01b038085166000908152600c6020526040902054168015620007f057604051630c00007b60e41b81526001600160a01b03848116600483015282169063c00007b090602401600060405180830381600087803b158015620007d657600080fd5b505af1158015620007eb573d6000803e3d6000fd5b505050505b506001949350505050565b6000805460ff166200082a5760405162461bcd60e51b815260040162000821906200414d565b60405180910390fd5b336000818152600d60205260409020543490620008489082620029fe565b6001600160a01b038084166000908152600d602052604080822093909355600b5483516325dff9d160e01b815284519294859492909216926325dff9d192600480840193919291829003018186803b158015620008a457600080fd5b505afa158015620008b9573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620008df919062004173565b9150915081431015620009225760405162461bcd60e51b815260206004820152600a6024820152697374617274426c6f636b60b01b604482015260640162000821565b804311156200095f5760405162461bcd60e51b8152602060048201526008602482015267656e64426c6f636b60c01b604482015260640162000821565b6001600160a01b038087166000818152600260205260409020918616148015620009b9575060016001600160a01b03881660009081526002602052604090205460ff166003811115620009b657620009b662003ffd565b14155b1562000a2c57600181015469021e19e0c9bab240000090620009dc9086620029fe565b101562000a2c5760405162461bcd60e51b815260206004820152601860248201527f5374616b696e6720636f696e73206e6f7420656e6f7567680000000000000000604482015260640162000821565b6001600160a01b038086166000908152600360209081526040808320938b168352929052205462000aab57600380820180546001600160a01b03808916600081815260209586526040808220938e1682529286529182206001908101849055830184559281529290922090910180546001600160a01b03191690911790555b600181015462000afa57866001600160a01b03167fbc822c457926e0706c445f2b613394c8a2bf34b3b4335915e3865b90829ce38b600160405162000af1919062004198565b60405180910390a25b600181015462000b0b9085620029fe565b600180830191909155815460ff16600381111562000b2d5762000b2d62003ffd565b1462000b3f57805460ff191660011781555b62000b4f87826001015462002a68565b6001600160a01b038086166000908152600360209081526040808320938b168352929052205462000b819085620029fe565b6001600160a01b038087166000908152600360209081526040808320938c168352929052205560085462000bb69085620029fe565b6008556001600160a01b038781166000908152600c602052604090819020549051630991d88160e21b81528783166004820152911690819063264762049087906024016000604051808303818588803b15801562000c1357600080fd5b505af115801562000c28573d6000803e3d6000fd5b5050604080518981524260208201526001600160a01b03808e1695508b1693507fb9ba725934532316cffe10975da6eb25ad49c2d1c294d982c46c9f8d684ee07592500160405180910390a3600196505050505050505b919050565b33411462000cc25760405162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b604482015260640162000821565b436000908152600e6020908152604080832083805290915290205460ff161562000d2f5760405162461bcd60e51b815260206004820152601960248201527f426c6f636b20697320616c726561647920726577617264656400000000000000604482015260640162000821565b60005460ff1662000d545760405162461bcd60e51b815260040162000821906200414d565b436000818152600e602090815260408083208380529091529020805460ff191660019081179091555433913491101562000e15576001600160a01b0382166000908152600f6020526040812080549162000dae83620041cb565b9091555050600a54604051631e88772760e01b81526001600160a01b03848116600483015290911690631e88772790602401600060405180830381600087803b15801562000dfb57600080fd5b505af115801562000e10573d6000803e3d6000fd5b505050505b6000811162000e2357505050565b6001600160a01b03821660009081526002602052604081205460ff16600381111562000e535762000e5362003ffd565b141562000e5f57505050565b62000e6b818462002e7d565b604080518281524260208201526001600160a01b038416917f7dc4e5df59513708dca355b8706273a5df7b810a4cec8019f2a4b9bb166a1a04910160405180910390a250505b50565b60608080838067ffffffffffffffff81111562000ed55762000ed562003ea9565b60405190808252806020026020018201604052801562000eff578160200160208202803683370190505b5093508067ffffffffffffffff81111562000f1e5762000f1e62003ea9565b60405190808252806020026020018201604052801562000f48578160200160208202803683370190505b5092508067ffffffffffffffff81111562000f675762000f6762003ea9565b60405190808252806020026020018201604052801562000f91578160200160208202803683370190505b50915060005b818110156200115c57600087878381811062000fb75762000fb7620041e9565b905060200201602081019062000fce919062003d5d565b6001600160a01b038082166000908152600c6020526040812054929350911690811562001073576040516246613160e11b81526001600160a01b038481166004830152831690628cc2629060240160206040518083038186803b1580156200103557600080fd5b505afa1580156200104a573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620010709190620041ff565b90505b80868581518110620010895762001089620041e9565b60200260200101818152505060046000846001600160a01b03166001600160a01b0316815260200190815260200160002054878581518110620010d057620010d0620041e9565b602002602001018181525050868481518110620010f157620010f1620041e9565b60200260200101518685815181106200110e576200110e620041e9565b602002602001015162001122919062004219565b888581518110620011375762001137620041e9565b60200260200101818152505050505080806200115390620041cb565b91505062000f97565b50509250925092565b6000805b600554811015620011ce57826001600160a01b031660058281548110620011945762001194620041e9565b6000918252602090912001546001600160a01b03161415620011b95750600192915050565b80620011c581620041cb565b91505062001169565b50600092915050565b3361f20014620012215760405162461bcd60e51b815260206004820152601460248201527350756e69736820636f6e7472616374206f6e6c7960601b604482015260640162000821565b6006546001101562000eb15762000eb18162003857565b600681815481106200124957600080fd5b6000918252602090912001546001600160a01b0316905081565b334114620012a15760405162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b604482015260640162000821565b436000908152600e602090815260408083206001845290915290205460ff16156200130f5760405162461bcd60e51b815260206004820152601a60248201527f56616c696461746f727320616c72656164792075706461746564000000000000604482015260640162000821565b60005460ff16620013345760405162461bcd60e51b815260040162000821906200414d565b806200134181436200424a565b15620013835760405162461bcd60e51b815260206004820152601060248201526f426c6f636b2065706f6368206f6e6c7960801b604482015260640162000821565b436000908152600e6020908152604080832060018085529252909120805460ff191690911790558251620013f15760405162461bcd60e51b815260206004820152601460248201527356616c696461746f722073657420656d7074792160601b604482015260640162000821565b600b54604080516325dff9d160e01b815281516000936001600160a01b0316926325dff9d19260048082019391829003018186803b1580156200143357600080fd5b505afa15801562001448573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906200146e919062004173565b915050600081118015620014825750804310155b15620014eb57600580546200149a9160079162003c77565b508351620014b090600590602087019062003cc8565b507feacea8f3c22f06c0b18306bdb04d0a967255129e8ce0094debb0a0ff89d006b584604051620014e2919062004088565b60405180910390a15b50505050565b600581815481106200124957600080fd5b6001600160a01b03828116600090815260036020908152604080832093851683529290522080546001909101545b9250929050565b3361f20014620015815760405162461bcd60e51b815260206004820152601460248201527350756e69736820636f6e7472616374206f6e6c7960601b604482015260640162000821565b8160006001600160a01b03841660009081526002602052604090205460ff166003811115620015b457620015b462003ffd565b1415620015fa5760405162461bcd60e51b815260206004820152601360248201527215985b1a59185d1bdc881b9bdd08195e1a5cdd606a1b604482015260640162000821565b6001600160a01b0380821660009081526003602090815260408083209387168352928152828220600290915291902081548085111562001638578094505b846200164657505050505050565b848114156200179b576003820154620016629060019062004261565b8360010154146200175a57600382018054620016819060019062004261565b81548110620016945762001694620041e9565b9060005260206000200160009054906101000a90046001600160a01b031682600301846001015481548110620016ce57620016ce620041e9565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b0316021790555082600101546003600084600301866001015481548110620017215762001721620041e9565b60009182526020808320909101546001600160a01b0390811684528382019490945260409283018220938b168252929092529020600101555b816003018054806200177057620017706200427b565b600082815260208120820160001990810180546001600160a01b031916905590910190915560018401555b8254620017a990866200389c565b83556001820154620017bc90866200389c565b6001830155600854620017d090866200389c565b6008556001600160a01b0384166000908152600d6020526040902054620017f890866200389c565b6001600160a01b038581166000818152600d60209081526040808320959095558a84168252600c905283902054925163f3fef3a360e01b8152600481019190915260248101889052911690819063f3fef3a390604401600060405180830381600087803b1580156200186957600080fd5b505af11580156200187e573d6000803e3d6000fd5b5050604080518981524260208201526001600160a01b03808c169450891692507f449002ae18e748d69a55f38514400d64f966492e593e32d6e9b8b24db98a0bc1910160405180910390a350505050505b5050565b6001600160a01b03811660009081526002602052604080822081516080810190925280548392839260609284929190829060ff1660038111156200191b576200191b62003ffd565b60038111156200192f576200192f62003ffd565b8152602001600182015481526020016002820154815260200160038201805480602002602001604051908101604052809291908181526020018280548015620019a257602002820191906000526020600020905b81546001600160a01b0316815260019091019060200180831162001983575b505050919092525050815160208301516040840151606090940151919a9099509297509550909350505050565b6000805b600654811015620011ce57826001600160a01b031660068281548110620019fe57620019fe620041e9565b6000918252602090912001546001600160a01b0316141562001a235750600192915050565b8062001a2f81620041cb565b915050620019d3565b6060600580548060200260200160405190810160405280929190818152602001828054801562001a9257602002820191906000526020600020905b81546001600160a01b0316815260019091019060200180831162001a73575b5050505050905090565b6060808080858067ffffffffffffffff81111562001abe5762001abe62003ea9565b60405190808252806020026020018201604052801562001ae8578160200160208202803683370190505b5094508067ffffffffffffffff81111562001b075762001b0762003ea9565b60405190808252806020026020018201604052801562001b31578160200160208202803683370190505b5093508067ffffffffffffffff81111562001b505762001b5062003ea9565b60405190808252806020026020018201604052801562001b7a578160200160208202803683370190505b5092508067ffffffffffffffff81111562001b995762001b9962003ea9565b60405190808252806020026020018201604052801562001bc3578160200160208202803683370190505b50915060005b8181101562001db457600089898381811062001be95762001be9620041e9565b905060200201602081019062001c00919062003d5d565b6001600160a01b038082166000908152600c6020526040812054929350911690811562001ca65760405163fa9ada5b60e01b8152600481018b90526001600160a01b0383169063fa9ada5b9060240160206040518083038186803b15801562001c6857600080fd5b505afa15801562001c7d573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019062001ca39190620041ff565b90505b6001600160a01b03831660009081526010602090815260408083208d845290915290205489518a908690811062001ce15762001ce1620041e9565b6020908102919091018101919091526001600160a01b03841660009081526011825260408082208d83529092522054885189908690811062001d275762001d27620041e9565b6020908102919091018101919091526001600160a01b03841660009081526012825260408082208d83529092522054875188908690811062001d6d5762001d6d620041e9565b6020026020010181815250508086858151811062001d8f5762001d8f620041e9565b602002602001018181525050505050808062001dab90620041cb565b91505062001bc9565b505093509350935093565b60005460ff161562001e0a5760405162461bcd60e51b8152602060048201526013602482015272105b1c9958591e481a5b9a5d1a585b1a5e9959606a1b604482015260640162000821565b600a80546001600160a01b031990811661f20017909155600b805490911661f30017905560005b818110156200234257600083838381811062001e515762001e51620041e9565b905060200201602081019062001e68919062003d5d565b6001600160a01b0316141562001ec15760405162461bcd60e51b815260206004820152601960248201527f496e76616c69642076616c696461746f72206164647265737300000000000000604482015260640162000821565b62001ef183838381811062001eda5762001eda620041e9565b905060200201602081019062000333919062003d5d565b62001f5757600583838381811062001f0d5762001f0d620041e9565b905060200201602081019062001f24919062003d5d565b81546001810183556000928352602090922090910180546001600160a01b0319166001600160a01b039092169190911790555b62001f8783838381811062001f705762001f70620041e9565b9050602002016020810190620004c2919062003d5d565b6200204d57600683838381811062001fa35762001fa3620041e9565b905060200201602081019062001fba919062003d5d565b81546001810183556000928352602090922090910180546001600160a01b0319166001600160a01b039092169190911790556007838383818110620020035762002003620041e9565b90506020020160208101906200201a919062003d5d565b81546001810183556000928352602090922090910180546001600160a01b0319166001600160a01b039092169190911790555b600060026000858585818110620020685762002068620041e9565b90506020020160208101906200207f919062003d5d565b6001600160a01b0316815260208101919091526040016000205460ff166003811115620020b057620020b062003ffd565b14156200212557600160026000858585818110620020d257620020d2620041e9565b9050602002016020810190620020e9919062003d5d565b6001600160a01b031681526020810191909152604001600020805460ff191660018360038111156200211f576200211f62003ffd565b02179055505b6000600c818585858181106200213f576200213f620041e9565b905060200201602081019062002156919062003d5d565b6001600160a01b0390811682526020820192909252604001600020541614156200232d576000838383818110620021915762002191620041e9565b9050602002016020810190620021a8919062003d5d565b604051602001620021cc919060609190911b6001600160601b031916815260140190565b604051602081830303815290604052805190602001209050600081858585818110620021fc57620021fc620041e9565b905060200201602081019062002213919062003d5d565b604051620022219062003d20565b6001600160a01b0390911681526020018190604051809103906000f590508015801562002252573d6000803e3d6000fd5b50905080600c60008787878181106200226f576200226f620041e9565b905060200201602081019062002286919062003d5d565b6001600160a01b039081168252602082019290925260400160002080546001600160a01b03191692909116919091179055848484818110620022cc57620022cc620041e9565b9050602002016020810190620022e3919062003d5d565b604080516001600160a01b03848116825242602083015292909216917f5e5b474625449a92e2b1a6f9f183435f09402d6897ae7f8779c72142ed11170b910160405180910390a250505b806200233981620041cb565b91505062001e31565b507feacea8f3c22f06c0b18306bdb04d0a967255129e8ce0094debb0a0ff89d006b5600560405162002375919062004291565b60405180910390a150506000805460ff19166001179055565b600781815481106200124957600080fd5b600b54604080516325dff9d160e01b815281516060936000936001600160a01b03909116926325dff9d19260048083019392829003018186803b158015620023e657600080fd5b505afa158015620023fb573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019062002421919062004173565b915050600081118015620024355750804310155b156200249e5760068054806020026020016040519081016040528092919081815260200182805480156200249357602002820191906000526020600020905b81546001600160a01b0316815260019091019060200180831162002474575b505050505091505090565b600780548060200260200160405190810160405280929190818152602001828054801562002493576020028201919060005260206000209081546001600160a01b031681526001909101906020018083116200247457505050505091505090565b5090565b600080620025126000620038e0565b915091509091565b6000805460ff16620025405760405162461bcd60e51b815260040162000821906200414d565b3360006001600160a01b03851660009081526002602052604090205460ff16600381111562002573576200257362003ffd565b1415620025b95760405162461bcd60e51b815260206004820152601360248201527215985b1a59185d1bdc881b9bdd08195e1a5cdd606a1b604482015260640162000821565b6001600160a01b038082166000908152600360209081526040808320938816835292815282822060029091529190208154808611156200263c5760405162461bcd60e51b815260206004820152601860248201527f596f7520646f6e2774206861766520616e79207374616b650000000000000000604482015260640162000821565b8581141562002791576003820154620026589060019062004261565b8360010154146200275057600382018054620026779060019062004261565b815481106200268a576200268a620041e9565b9060005260206000200160009054906101000a90046001600160a01b031682600301846001015481548110620026c457620026c4620041e9565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b0316021790555082600101546003600084600301866001015481548110620027175762002717620041e9565b60009182526020808320909101546001600160a01b0390811684528382019490945260409283018220938c168252929092529020600101555b816003018054806200276657620027666200427b565b600082815260208120820160001990810180546001600160a01b031916905590910190915560018401555b82546200279f90876200389c565b83556001820154620027b290876200389c565b6001830155600854620027c690876200389c565b6008556001600160a01b0384166000908152600d6020526040902054620027ee90876200389c565b6001600160a01b038086166000818152600d6020526040902092909255881614156200286b576200281f87620019cf565b156200286b57825469021e19e0c9bab240000011156200286b5760405162461bcd60e51b815260040162000821906020808252600490820152630333030360e41b604082015260600190565b6001600160a01b038781166000908152600c60205260409081902054905163f3fef3a360e01b8152868316600482015260248101899052911690819063f3fef3a390604401600060405180830381600087803b158015620028cb57600080fd5b505af1158015620028e0573d6000803e3d6000fd5b5050604080518a81524260208201526001600160a01b03808d169450891692507f449002ae18e748d69a55f38514400d64f966492e593e32d6e9b8b24db98a0bc1910160405180910390a36001955050505050505b92915050565b6001600160a01b038181166000908152600c60205260408082205490516246613160e11b815285841660048201529192169082908290628cc2629060240160206040518083038186803b1580156200299257600080fd5b505afa158015620029a7573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620029cd9190620041ff565b6001600160a01b038616600090815260046020526040902054909150620029f59082620029fe565b95945050505050565b60008062002a0d838562004219565b90508381101562002a615760405162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f770000000000604482015260640162000821565b9392505050565b60005b60065481101562002acc57826001600160a01b03166006828154811062002a965762002a96620041e9565b6000918252602090912001546001600160a01b0316141562002ab757505050565b8062002ac381620041cb565b91505062002a6b565b506006546015111562002c215760068054600181019091557ff652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d3f0180546001600160a01b0319166001600160a01b038481169182179092556000908152600c602052604090205416620018cf576040516001600160601b0319606084901b1660208201526000906034016040516020818303038152906040528051906020012090506000818460405162002b7f9062003d20565b6001600160a01b0390911681526020018190604051809103906000f590508015801562002bb0573d6000803e3d6000fd5b506001600160a01b038581166000818152600c602090815260409182902080546001600160a01b031916948616948517905581519384524290840152929350917f5e5b474625449a92e2b1a6f9f183435f09402d6897ae7f8779c72142ed11170b910160405180910390a250505050565b600060026000600660008154811062002c3e5762002c3e620041e9565b60009182526020808320909101546001600160a01b03168352820192909252604001812060019081015492505b60065481101562002d1d5782600260006006848154811062002c915762002c91620041e9565b60009182526020808320909101546001600160a01b03168352820192909252604001902060010154101562002d0857600260006006838154811062002cda5762002cda620041e9565b60009182526020808320909101546001600160a01b0316835282019290925260400190206001015492509050805b8062002d1481620041cb565b91505062002c6b565b5081831162002d2c5750505050565b6001600160a01b038481166000908152600c60205260409020541662002e32576040516001600160601b0319606086901b1660208201526000906034016040516020818303038152906040528051906020012090506000818660405162002d939062003d20565b6001600160a01b0390911681526020018190604051809103906000f590508015801562002dc4573d6000803e3d6000fd5b506001600160a01b038781166000818152600c602090815260409182902080546001600160a01b031916948616948517905581519384524290840152929350917f5e5b474625449a92e2b1a6f9f183435f09402d6897ae7f8779c72142ed11170b910160405180910390a250505b836006828154811062002e495762002e49620041e9565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b0316021790555050505050565b8162002e87575050565b60008062002e9583620038e0565b90925090508062002ea65750505050565b600080836200319357600062002ebd878562003a06565b905062002ed762002ecf828662003a4a565b88906200389c565b925060005b6005548110156200307a5760006005828154811062002eff5762002eff620041e9565b6000918252602090912001546001600160a01b0316905060036001600160a01b03821660009081526002602052604090205460ff16600381111562002f485762002f4862003ffd565b1415801562002f695750876001600160a01b0316816001600160a01b031614155b1562003064576001600160a01b03811660009081526004602052604090205462002f949084620029fe565b6001600160a01b0382166000908152600460209081526040808320939093556010815282822043835290522054909350839062002fd29084620029fe565b6001600160a01b0382166000818152601060209081526040808320438085529083528184209590955592825260118152828220938252929092529020546200301b9084620029fe565b6001600160a01b038216600081815260116020908152604080832043845282529182902093909355518581529091600080516020620052c8833981519152910160405180910390a25b50806200307181620041cb565b91505062002edc565b506000831180156200309457506001600160a01b03821615155b156200318a576001600160a01b038216600090815260046020526040902054620030bf9084620029fe565b6001600160a01b0383166000908152600460209081526040808320939093556010815282822043835290522054620030f89084620029fe565b6001600160a01b038316600081815260106020908152604080832043808552908352818420959095559282526011815282822093825292909252902054620031419084620029fe565b6001600160a01b038316600081815260116020908152604080832043845282529182902093909355518581529091600080516020620052c8833981519152910160405180910390a25b50505050505050565b6000805b6005548110156200357c57600060058281548110620031ba57620031ba620041e9565b6000918252602090912001546001600160a01b0316905060036001600160a01b03821660009081526002602052604090205460ff16600381111562003203576200320362003ffd565b14158015620032245750876001600160a01b0316816001600160a01b031614155b15620035655760006200326d6200323d89600262003a4a565b6001600160a01b03841660009081526002602052604090206001015462003266908d9062003a4a565b9062003a06565b9050806200327d57505062003567565b6001600160a01b0382166000908152600460205260409020549194508491620032a79082620029fe565b6001600160a01b0383166000908152600460209081526040808320939093556011815282822043835290522054620032e09082620029fe565b6001600160a01b038381166000818152601160209081526040808320438452825280832095909555828252600c90528381205493516246613160e11b815260048101929092529290911691908290628cc2629060240160206040518083038186803b1580156200334f57600080fd5b505afa15801562003364573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906200338a9190620041ff565b9050816001600160a01b031663abaa9916846040518263ffffffff1660e01b81526004016000604051808303818588803b158015620033c857600080fd5b505af1158015620033dd573d6000803e3d6000fd5b50506040516246613160e11b81526001600160a01b0388811660048301526000945086169250628cc262915060240160206040518083038186803b1580156200342557600080fd5b505afa1580156200343a573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620034609190620041ff565b90506200349d62003472838362004261565b6001600160a01b038716600090815260126020908152604080832043845290915290205490620029fe565b6001600160a01b0386166000908152601260209081526040808320438452909152902055620034fd620034d285600262003a4a565b6001600160a01b038716600090815260106020908152604080832043845290915290205490620029fe565b6001600160a01b038616600081815260106020908152604080832043845282529182902093909355518681529091600080516020620052c8833981519152910160405180910390a26200355e6200355685600262003a4a565b8890620029fe565b9650505050505b505b806200357381620041cb565b91505062003197565b506200358987826200389c565b9250600083118015620035a457506001600160a01b03821615155b156200318a576000620035b984600262003a06565b6001600160a01b038416600090815260046020526040902054909150620035e19082620029fe565b6001600160a01b03841660009081526004602090815260408083209390935560118152828220438352905290812080548392906200362190849062004219565b90915550506001600160a01b038381166000818152600c60205260408082205490516246613160e11b8152600481019390935290921691908290628cc2629060240160206040518083038186803b1580156200367c57600080fd5b505afa15801562003691573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620036b79190620041ff565b9050816001600160a01b031663abaa9916846040518263ffffffff1660e01b81526004016000604051808303818588803b158015620036f557600080fd5b505af11580156200370a573d6000803e3d6000fd5b50506040516246613160e11b81526001600160a01b0389811660048301526000945086169250628cc262915060240160206040518083038186803b1580156200375257600080fd5b505afa15801562003767573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906200378d9190620041ff565b9050620037ca6200379f838362004261565b6001600160a01b038816600090815260126020908152604080832043845290915290205490620029fe565b6001600160a01b038716600081815260126020908152604080832043808552908352818420959095559282526010815282822093825292909252812080548992906200381890849062004219565b90915550506040518781526001600160a01b03871690600080516020620052c88339815191529060200160405180910390a25050505050505050505050565b6001600160a01b03811660009081526002602052604081205460ff16600381111562003887576200388762003ffd565b1415620038915750565b62000eb18162003ad1565b600062002a6183836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f77000081525062003c0e565b60008060005b60055481101562003a0057600360026000600584815481106200390d576200390d620041e9565b60009182526020808320909101546001600160a01b0316835282019290925260400190205460ff16600381111562003949576200394962003ffd565b1415801562003985575060058181548110620039695762003969620041e9565b6000918252602090912001546001600160a01b03858116911614155b15620039eb57620039d96002600060058481548110620039a957620039a9620041e9565b60009182526020808320909101546001600160a01b031683528201929092526040019020600101548490620029fe565b925081620039e781620041cb565b9250505b80620039f781620041cb565b915050620038e6565b50915091565b600062002a6183836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f00000000000081525062003c44565b60008262003a5b5750600062002935565b600062003a698385620042e3565b90508262003a78858362004305565b1462002a615760405162461bcd60e51b815260206004820152602160248201527f536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f6044820152607760f81b606482015260840162000821565b60005b6006548110801562003ae857506006546001105b15620018cf576006818154811062003b045762003b04620041e9565b6000918252602090912001546001600160a01b038381169116141562003bf95760065462003b359060019062004261565b811462003bbf576006805462003b4e9060019062004261565b8154811062003b615762003b61620041e9565b600091825260209091200154600680546001600160a01b03909216918390811062003b905762003b90620041e9565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b031602179055505b600680548062003bd35762003bd36200427b565b600082815260209020810160001990810180546001600160a01b03191690550190555050565b8062003c0581620041cb565b91505062003ad4565b6000818484111562003c355760405162461bcd60e51b81526004016200082191906200431c565b506000620029f5848662004261565b6000818362003c685760405162461bcd60e51b81526004016200082191906200431c565b506000620029f5848662004305565b82805482825590600052602060002090810192821562003cba5760005260206000209182015b8281111562003cba57825482559160010191906001019062003c9d565b50620024ff92915062003d2e565b82805482825590600052602060002090810192821562003cba579160200282015b8281111562003cba57825182546001600160a01b0319166001600160a01b0390911617825560209092019160019091019062003ce9565b610f53806200437583390190565b5b80821115620024ff576000815560010162003d2f565b80356001600160a01b038116811462000c7f57600080fd5b60006020828403121562003d7057600080fd5b62002a618262003d45565b60008083601f84011262003d8e57600080fd5b50813567ffffffffffffffff81111562003da757600080fd5b6020830191508360208260051b85010111156200153057600080fd5b6000806020838503121562003dd757600080fd5b823567ffffffffffffffff81111562003def57600080fd5b62003dfd8582860162003d7b565b90969095509350505050565b600081518084526020808501945080840160005b8381101562003e3b5781518752958201959082019060010162003e1d565b509495945050505050565b60608152600062003e5b606083018662003e09565b828103602084015262003e6f818662003e09565b9050828103604084015262003e85818562003e09565b9695505050505050565b60006020828403121562003ea257600080fd5b5035919050565b634e487b7160e01b600052604160045260246000fd5b6000806040838503121562003ed357600080fd5b823567ffffffffffffffff8082111562003eec57600080fd5b818501915085601f83011262003f0157600080fd5b813560208282111562003f185762003f1862003ea9565b8160051b604051601f19603f8301168101818110868211171562003f405762003f4062003ea9565b60405292835281830193508481018201928984111562003f5f57600080fd5b948201945b8386101562003f885762003f788662003d45565b8552948201949382019362003f64565b9997909101359750505050505050565b6000806040838503121562003fac57600080fd5b62003fb78362003d45565b915062003fc76020840162003d45565b90509250929050565b6000806040838503121562003fe457600080fd5b62003fef8362003d45565b946020939093013593505050565b634e487b7160e01b600052602160045260246000fd5b600081518084526020808501945080840160005b8381101562003e3b5781516001600160a01b03168752958201959082019060010162004027565b60006004861062004063576200406362003ffd565b8582528460208301528360408301526080606083015262003e85608083018462004013565b60208152600062002a61602083018462004013565b600080600060408486031215620040b357600080fd5b833567ffffffffffffffff811115620040cb57600080fd5b620040d98682870162003d7b565b909790965060209590950135949350505050565b60808152600062004102608083018762003e09565b828103602084015262004116818762003e09565b905082810360408401526200412c818662003e09565b9050828103606084015262004142818562003e09565b979650505050505050565b6020808252600c908201526b139bdd081a5b9a5d081e595d60a21b604082015260600190565b600080604083850312156200418757600080fd5b505080516020909101519092909150565b6020810160038310620041af57620041af62003ffd565b91905290565b634e487b7160e01b600052601160045260246000fd5b6000600019821415620041e257620041e2620041b5565b5060010190565b634e487b7160e01b600052603260045260246000fd5b6000602082840312156200421257600080fd5b5051919050565b600082198211156200422f576200422f620041b5565b500190565b634e487b7160e01b600052601260045260246000fd5b6000826200425c576200425c62004234565b500690565b600082821015620042765762004276620041b5565b500390565b634e487b7160e01b600052603160045260246000fd5b6020808252825482820181905260008481528281209092916040850190845b81811015620042d75783546001600160a01b031683526001938401939285019201620042b0565b50909695505050505050565b6000816000190483118215151615620043005762004300620041b5565b500290565b60008262004317576200431762004234565b500490565b600060208083528351808285015260005b818110156200434b578581018301518582016040015282016200432d565b818111156200435e576000604083870101525b50601f01601f191692909201604001939250505056fe608060405234801561001057600080fd5b50604051610f53380380610f5383398101604081905261002f91610102565b60028054336001600160a01b031991821617909155600580549091166001600160a01b03929092169190911790556040805160608101825243815260006020820181815292820181815260048054600181018255925291517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b60039092029182015591517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19c830155517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19d90910155610132565b60006020828403121561011457600080fd5b81516001600160a01b038116811461012b57600080fd5b9392505050565b610e12806101416000396000f3fe6080604052600436106100c15760003560e01c806370a082311161007f578063c00007b011610059578063c00007b0146101f9578063e673df8a14610219578063f3fef3a314610239578063fa9ada5b1461025957600080fd5b806370a0823114610185578063714b4658146101bb578063abaa9916146101f157600080fd5b80628cc262146100c657806318160ddd146100f9578063264762041461010e5780633a5381b5146101235780633f9e3f041461015b578063446a2ec814610170575b600080fd5b3480156100d257600080fd5b506100e66100e1366004610c52565b61029c565b6040519081526020015b60405180910390f35b34801561010557600080fd5b506000546100e6565b61012161011c366004610c52565b61032d565b005b34801561012f57600080fd5b50600554610143906001600160a01b031681565b6040516001600160a01b0390911681526020016100f0565b34801561016757600080fd5b506100e6610472565b34801561017c57600080fd5b506100e6610488565b34801561019157600080fd5b506100e66101a0366004610c52565b6001600160a01b031660009081526001602052604090205490565b3480156101c757600080fd5b506100e66101d6366004610c52565b6001600160a01b031660009081526003602052604090205490565b61012161049b565b34801561020557600080fd5b50610121610214366004610c52565b61051c565b34801561022557600080fd5b50600254610143906001600160a01b031681565b34801561024557600080fd5b50610121610254366004610c6f565b610681565b34801561026557600080fd5b506100e6610274366004610c9b565b6005546001600160a01b03166000908152600660209081526040808320938352929052205490565b6000806102a76107b5565b60400151905060006102b88461082f565b6040908101516001600160a01b03861660009081526003602052918220600101549092506103249061031e670de0b6b3a76400006103186102f988886108c2565b6001600160a01b038b166000908152600160205260409020549061090d565b9061098c565b906109ce565b95945050505050565b6002546001600160a01b031633146103605760405162461bcd60e51b815260040161035790610cb4565b60405180910390fd5b806001600160a01b038116156103e1576001600160a01b03811660009081526003602090815260409182902082518084019093528054835260010154908201526103a98261029c565b60208201526103b6610472565b81526001600160a01b0382166000908152600360209081526040909120825181559101516001909101555b34806104205760405162461bcd60e51b815260206004820152600e60248201526d043616e6e6f74207374616b6520360941b6044820152606401610357565b61042a8382610a2d565b826001600160a01b03167f9e71bc8eea02a63969f509818f2dafb9254532904319f9dbda79b67bd34a5f3d8260405161046591815260200190565b60405180910390a2505050565b6004546000906104839060016108c2565b905090565b60006104926107b5565b60400151905090565b6002546001600160a01b031633146104c55760405162461bcd60e51b815260040161035790610cb4565b34806104ce5750565b6104d781610a7f565b6005546040518281526001600160a01b03909116907f7d8f3d9291db7e540ea10a43e300f1330c3e9148157349babe42ac2601a2a3e99060200160405180910390a250565b6002546001600160a01b031633146105465760405162461bcd60e51b815260040161035790610cb4565b806001600160a01b038116156105c7576001600160a01b038116600090815260036020908152604091829020825180840190935280548352600101549082015261058f8261029c565b602082015261059c610472565b81526001600160a01b0382166000908152600360209081526040909120825181559101516001909101555b6001600160a01b038216600090815260036020526040902060010154801561067c576001600160a01b0383166000818152600360205260408082206001018290555183156108fc0291849190818181858888f19350505050158015610630573d6000803e3d6000fd5b50600554604080518381524260208201526001600160a01b03928316928616917f51a69b4502f660774c9339825c7b5adbf0b8622289134647e29728ec5d9b3bb9910160405180910390a35b505050565b6002546001600160a01b031633146106ab5760405162461bcd60e51b815260040161035790610cb4565b816001600160a01b0381161561072c576001600160a01b03811660009081526003602090815260409182902082518084019093528054835260010154908201526106f48261029c565b6020820152610701610472565b81526001600160a01b0382166000908152600360209081526040909120825181559101516001909101555b600082116107705760405162461bcd60e51b8152602060048201526011602482015270043616e6e6f74207769746864726177203607c1b6044820152606401610357565b61077a8383610b62565b826001600160a01b03167f7084f5476618d8e60b11ef0d7d3f06914655adb8793e28ff7f018d4c76d505d58360405161046591815260200190565b6107d960405180606001604052806000815260200160008152602001600081525090565b60046107e3610472565b815481106107f3576107f3610ceb565b90600052602060002090600302016040518060600160405290816000820154815260200160018201548152602001600282015481525050905090565b61085360405180606001604052806000815260200160008152602001600081525090565b6004610874836001600160a01b031660009081526003602052604090205490565b8154811061088457610884610ceb565b906000526020600020906003020160405180606001604052908160008201548152602001600182015481526020016002820154815250509050919050565b600061090483836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f770000815250610bdb565b90505b92915050565b60008261091c57506000610907565b60006109288385610d17565b9050826109358583610d36565b146109045760405162461bcd60e51b815260206004820152602160248201527f536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f6044820152607760f81b6064820152608401610357565b600061090483836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f000000000000815250610c0c565b6000806109db8385610d58565b9050838110156109045760405162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f7700000000006044820152606401610357565b600054610a3a90826109ce565b60009081556001600160a01b038316815260016020526040902054610a5f90826109ce565b6001600160a01b0390921660009081526001602052604090209190915550565b6000610a896107b5565b6040015190506000610ab9610ab2610aa060005490565b61031886670de0b6b3a764000061090d565b83906109ce565b60408051606081018252438152602081019586529081019182526004805460018101825560009190915290517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b60039092029182015593517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19c850155517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19d909301929092555050565b600054610b6f90826108c2565b60009081556001600160a01b038316815260016020526040902054610b9490826108c2565b6001600160a01b038316600081815260016020526040808220939093559151909183156108fc02918491818181858888f1935050505015801561067c573d6000803e3d6000fd5b60008184841115610bff5760405162461bcd60e51b81526004016103579190610d70565b5060006103248486610dc5565b60008183610c2d5760405162461bcd60e51b81526004016103579190610d70565b5060006103248486610d36565b6001600160a01b0381168114610c4f57600080fd5b50565b600060208284031215610c6457600080fd5b813561090481610c3a565b60008060408385031215610c8257600080fd5b8235610c8d81610c3a565b946020939093013593505050565b600060208284031215610cad57600080fd5b5035919050565b6020808252601a908201527f43616c6c6572206973206e6f7420746865206f70657261746f72000000000000604082015260600190565b634e487b7160e01b600052603260045260246000fd5b634e487b7160e01b600052601160045260246000fd5b6000816000190483118215151615610d3157610d31610d01565b500290565b600082610d5357634e487b7160e01b600052601260045260246000fd5b500490565b60008219821115610d6b57610d6b610d01565b500190565b600060208083528351808285015260005b81811015610d9d57858101830151858201604001528201610d81565b81811115610daf576000604083870101525b50601f01601f1916929092016040019392505050565b600082821015610dd757610dd7610d01565b50039056fea264697066735822122087d510370fde5b1538b269ea2935c7508a993ddfbcdffda60c0cedb77f4ceb8164736f6c634300080800337d8f3d9291db7e540ea10a43e300f1330c3e9148157349babe42ac2601a2a3e9a26469706673582212207785f392337597f3c350eea500f0249ddc770c0fd9f26eb2f9f3b4450077d03964736f6c63430008080033"
)

type hardForkValidatorsV3 struct {
}

func (s *hardForkValidatorsV3) GetName() string {
	return ValidatorsV2ContractName
}

func (s *hardForkValidatorsV3) Update(config *params.ChainConfig, height *big.Int, state *state.StateDB) (err error) {
	contractCode := common.FromHex(validatorV3Code)

	//write code to sys contract
	state.SetCode(ValidatorsV2ContractAddr, contractCode)
	log.Debug("Write code to system contract account", "addr", ValidatorsV2ContractAddr.String(), "code", validatorV3Code)

	return
}

func (s *hardForkValidatorsV3) Execute(state *state.StateDB, header *types.Header, chainContext core.ChainContext, config *params.ChainConfig) (err error) {
	//First, get top validators from the old contract
	v0 := NewValidatorV0()
	topVals, err := v0.GetTopValidators(state, header, chainContext, config)
	if err != nil {
		log.Error("getTopValidators from V0 failed", "err", err)
		return err
	}

	// initialize v1 contract
	method := "initialize"
	data, err := GetInteractiveABI()[ValidatorsV2ContractName].Pack(method, topVals)
	if err != nil {
		log.Error("Can't pack data for initialize", "error", err)
		return err
	}

	msg := vmcaller.NewLegacyMessage(header.Coinbase, &ValidatorsV2ContractAddr, 0, new(big.Int), math.MaxUint64, new(big.Int), data, false)
	_, err = vmcaller.ExecuteMsg(msg, state, header, chainContext, config)

	return
}
