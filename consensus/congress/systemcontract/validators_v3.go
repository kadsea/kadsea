package systemcontract

import (
	"math"
	"math/big"

	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/consensus/congress/vmcaller"
	"github.com/ethereum/go-ethereum/core"
	"github.com/ethereum/go-ethereum/core/state"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/log"
	"github.com/ethereum/go-ethereum/params"
)

const (
	validatorV3Code = "0x608060405260043610620002225760003560e01c80638233fbcb1162000123578063be64569211620000ad578063c4e2f07a1162000078578063c4e2f07a146200068a578063c967f90f14620006af578063d6eb3de114620006da578063e8363f6c14620006f2578063ea10f8ad146200072357600080fd5b8063be6456921462000615578063c1d7dd781462000635578063c253c384146200064d578063c2a672e0146200066557600080fd5b80639de7025811620000ee5780639de702581462000577578063a224cee7146200059e578063afeea11514620005c3578063bbe4f6db14620005db57600080fd5b80638233fbcb14620004c95780638a11d7c914620005035780638b0e9f3f146200053a57806398e3b626146200055257600080fd5b806340a141ff11620001b15780636846992a116200017c5780636846992a14620003fa5780636969a25c146200041f5780637ad229da14620004445780637f4f95fa146200046957806380d2dde114620004a457600080fd5b806340a141ff146200034f57806348cd4cb114620003745780634b3d500b146200039b57806363fc5e7114620003c057600080fd5b806330fcb67c11620001f257806330fcb67c14620002c557806338b67b8b14620002de5780633a061bd3146200031257806340550a1c146200032a57600080fd5b8062362a771462000227578063158ef93e14620002615780631b5e358c146200027d5780632647620414620002ae575b600080fd5b3480156200023457600080fd5b506200024c6200024636600462003728565b62000748565b60405190151581526020015b60405180910390f35b3480156200026e57600080fd5b506000546200024c9060ff1681565b3480156200028a57600080fd5b506200029561f20081565b6040516001600160a01b03909116815260200162000258565b6200024c620002bf36600462003728565b62000865565b620002dc620002d636600462003728565b62000cee565b005b348015620002eb57600080fd5b5062000303620002fd3660046200378e565b62000f1e565b604051620002589190620037d4565b3480156200031f57600080fd5b506200029561f10081565b3480156200033757600080fd5b506200024c6200034936600462003728565b620010b0565b3480156200035c57600080fd5b50620002dc6200036e36600462003728565b62001122565b3480156200038157600080fd5b506200038c60015481565b60405190815260200162000258565b348015620003a857600080fd5b5062000295620003ba3660046200381a565b62001183565b348015620003cd57600080fd5b506200038c620003df36600462003728565b6001600160a01b03166000908152600f602052604090205490565b3480156200040757600080fd5b50620002dc620004193660046200384a565b620011ae565b3480156200042c57600080fd5b50620002956200043e3660046200381a565b62001429565b3480156200045157600080fd5b506200038c6200046336600462003923565b6200143a565b3480156200047657600080fd5b506200048e6200048836600462003950565b6200150c565b6040805192835260208301919091520162000258565b348015620004b157600080fd5b50620002dc620004c336600462003923565b62001541565b348015620004d657600080fd5b506200038c620004e836600462003728565b6001600160a01b031660009081526010602052604090205490565b3480156200051057600080fd5b50620005286200052236600462003728565b620018dd565b604051620002589493929190620039e4565b3480156200054757600080fd5b506200038c60075481565b3480156200055f57600080fd5b506200024c6200057136600462003728565b620019d9565b3480156200058457600080fd5b506200058f62001a42565b60405162000258919062003a28565b348015620005ab57600080fd5b50620002dc620005bd3660046200378e565b62001aa6565b348015620005d057600080fd5b506200058f62002015565b348015620005e857600080fd5b5062000295620005fa36600462003728565b600b602052600090815260409020546001600160a01b031681565b3480156200062257600080fd5b506200038c69021e19e0c9bab240000081565b3480156200064257600080fd5b506200038c60085481565b3480156200065a57600080fd5b506200048e62002077565b3480156200067257600080fd5b506200024c6200068436600462003923565b6200208e565b3480156200069757600080fd5b506200038c620006a936600462003950565b620024ad565b348015620006bc57600080fd5b50620006c6601581565b60405161ffff909116815260200162000258565b348015620006e757600080fd5b506200029561f30081565b348015620006ff57600080fd5b506200038c6200071136600462003728565b60046020526000908152604090205481565b3480156200073057600080fd5b50620003036200074236600462003a3d565b62002568565b3360008181526004602052604081208054908290559091908015620007e8576040516001600160a01b0383169082156108fc029083906000818181858888f193505050501580156200079e573d6000803e3d6000fd5b50604080518281524260208201526001600160a01b0380871692908516917f51a69b4502f660774c9339825c7b5adbf0b8622289134647e29728ec5d9b3bb9910160405180910390a35b6001600160a01b038481166000908152600b602052604090819020549051630c00007b60e41b81528483166004820152911690819063c00007b090602401600060405180830381600087803b1580156200084157600080fd5b505af115801562000856573d6000803e3d6000fd5b50600198975050505050505050565b6000805460ff16620008945760405162461bcd60e51b81526004016200088b9062003a96565b60405180910390fd5b336000818152600c60205260409020543490620008b29082620026d7565b6001600160a01b038084166000908152600c602052604080822093909355600a5483516325dff9d160e01b815284519294859492909216926325dff9d192600480840193919291829003018186803b1580156200090e57600080fd5b505afa15801562000923573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019062000949919062003abc565b91509150814310156200098c5760405162461bcd60e51b815260206004820152600a6024820152697374617274426c6f636b60b01b60448201526064016200088b565b80431115620009c95760405162461bcd60e51b8152602060048201526008602482015267656e64426c6f636b60c01b60448201526064016200088b565b6001600160a01b03808716600081815260026020526040902091861614801562000a23575060016001600160a01b03881660009081526002602052604090205460ff16600381111562000a205762000a2062003988565b14155b1562000a9657600181015469021e19e0c9bab24000009062000a469086620026d7565b101562000a965760405162461bcd60e51b815260206004820152601860248201527f5374616b696e6720636f696e73206e6f7420656e6f756768000000000000000060448201526064016200088b565b6001600160a01b038086166000908152600360209081526040808320938b168352929052205462000b1557600380820180546001600160a01b03808916600081815260209586526040808220938e1682529286529182206001908101849055830184559281529290922090910180546001600160a01b03191690911790555b600181015462000b6457866001600160a01b03167fbc822c457926e0706c445f2b613394c8a2bf34b3b4335915e3865b90829ce38b600160405162000b5b919062003ae1565b60405180910390a25b600181015462000b759085620026d7565b600180830191909155815460ff16600381111562000b975762000b9762003988565b1462000ba957805460ff191660011781555b62000bb987826001015462002741565b6001600160a01b038086166000908152600360209081526040808320938b168352929052205462000beb9085620026d7565b6001600160a01b038087166000908152600360209081526040808320938c168352929052205560075462000c209085620026d7565b6007556001600160a01b038781166000908152600b602052604090819020549051630991d88160e21b81528783166004820152911690819063264762049087906024016000604051808303818588803b15801562000c7d57600080fd5b505af115801562000c92573d6000803e3d6000fd5b5050604080518981524260208201526001600160a01b03808e1695508b1693507fb9ba725934532316cffe10975da6eb25ad49c2d1c294d982c46c9f8d684ee07592500160405180910390a3600196505050505050505b919050565b33411462000d2c5760405162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b60448201526064016200088b565b436000908152600d6020908152604080832083805290915290205460ff161562000d995760405162461bcd60e51b815260206004820152601960248201527f426c6f636b20697320616c72656164792072657761726465640000000000000060448201526064016200088b565b60005460ff1662000dbe5760405162461bcd60e51b81526004016200088b9062003a96565b436000818152600d602090815260408083208380529091529020805460ff191660019081179091555433913491101562000e7f576001600160a01b0382166000908152600f6020526040812080549162000e188362003b14565b9091555050600954604051631e88772760e01b81526001600160a01b03848116600483015290911690631e88772790602401600060405180830381600087803b15801562000e6557600080fd5b505af115801562000e7a573d6000803e3d6000fd5b505050505b6000811162000e8d57505050565b6001600160a01b03821660009081526002602052604081205460ff16600381111562000ebd5762000ebd62003988565b141562000ec957505050565b62000ed5818462002b56565b604080518281524260208201526001600160a01b038416917f7dc4e5df59513708dca355b8706273a5df7b810a4cec8019f2a4b9bb166a1a04910160405180910390a250505b50565b6060818067ffffffffffffffff81111562000f3d5762000f3d62003834565b60405190808252806020026020018201604052801562000f67578160200160208202803683370190505b50915060005b81811015620010a857600085858381811062000f8d5762000f8d62003b32565b905060200201602081019062000fa4919062003728565b6001600160a01b038082166000908152600b6020526040812054929350911690811562001049576040516246613160e11b81526001600160a01b038481166004830152831690628cc2629060240160206040518083038186803b1580156200100b57600080fd5b505afa15801562001020573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019062001046919062003b48565b90505b6001600160a01b0383166000908152600460205260409020546200106e908262003b62565b86858151811062001083576200108362003b32565b60200260200101818152505050505080806200109f9062003b14565b91505062000f6d565b505092915050565b6000805b6005548110156200111957826001600160a01b031660058281548110620010df57620010df62003b32565b6000918252602090912001546001600160a01b03161415620011045750600192915050565b80620011108162003b14565b915050620010b4565b50600092915050565b3361f200146200116c5760405162461bcd60e51b815260206004820152601460248201527350756e69736820636f6e7472616374206f6e6c7960601b60448201526064016200088b565b6006546001101562000f1b5762000f1b8162003258565b600681815481106200119457600080fd5b6000918252602090912001546001600160a01b0316905081565b334114620011ec5760405162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b60448201526064016200088b565b436000908152600d602090815260408083206001845290915290205460ff16156200125a5760405162461bcd60e51b815260206004820152601a60248201527f56616c696461746f727320616c7265616479207570646174656400000000000060448201526064016200088b565b60005460ff166200127f5760405162461bcd60e51b81526004016200088b9062003a96565b806200128c814362003b93565b15620012ce5760405162461bcd60e51b815260206004820152601060248201526f426c6f636b2065706f6368206f6e6c7960801b60448201526064016200088b565b436000908152600d6020908152604080832060018085529252909120805460ff1916909117905582516200133c5760405162461bcd60e51b815260206004820152601460248201527356616c696461746f722073657420656d7074792160601b60448201526064016200088b565b600a54604080516325dff9d160e01b815281516000936001600160a01b0316926325dff9d19260048082019391829003018186803b1580156200137e57600080fd5b505afa15801562001393573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620013b9919062003abc565b915050600081118015620013cd5750804310155b1562001423578351620013e890600590602087019062003681565b507feacea8f3c22f06c0b18306bdb04d0a967255129e8ce0094debb0a0ff89d006b5846040516200141a919062003a28565b60405180910390a15b50505050565b600581815481106200119457600080fd5b6001600160a01b038281166000908152600b602052604080822054905163fa9ada5b60e01b815260048101859052919216908290829063fa9ada5b9060240160206040518083038186803b1580156200149257600080fd5b505afa158015620014a7573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620014cd919062003b48565b6001600160a01b0386166000908152600e602090815260408083208884529091529020549091506200150190829062003b62565b925050505b92915050565b6001600160a01b03828116600090815260036020908152604080832093851683529290522080546001909101545b9250929050565b3361f200146200158b5760405162461bcd60e51b815260206004820152601460248201527350756e69736820636f6e7472616374206f6e6c7960601b60448201526064016200088b565b8160006001600160a01b03841660009081526002602052604090205460ff166003811115620015be57620015be62003988565b1415620016045760405162461bcd60e51b815260206004820152601360248201527215985b1a59185d1bdc881b9bdd08195e1a5cdd606a1b60448201526064016200088b565b6001600160a01b0380821660009081526003602090815260408083209387168352928152828220600290915291902081548085111562001642578094505b846200165057505050505050565b84811415620017a55760038201546200166c9060019062003baa565b83600101541462001764576003820180546200168b9060019062003baa565b815481106200169e576200169e62003b32565b9060005260206000200160009054906101000a90046001600160a01b031682600301846001015481548110620016d857620016d862003b32565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b03160217905550826001015460036000846003018660010154815481106200172b576200172b62003b32565b60009182526020808320909101546001600160a01b0390811684528382019490945260409283018220938b168252929092529020600101555b816003018054806200177a576200177a62003bc4565b600082815260208120820160001990810180546001600160a01b031916905590910190915560018401555b8254620017b390866200329d565b83556001820154620017c690866200329d565b6001830155600754620017da90866200329d565b6007556001600160a01b0384166000908152600c60205260409020546200180290866200329d565b6001600160a01b038581166000818152600c60209081526040808320959095558a84168252600b905283902054925163f3fef3a360e01b8152600481019190915260248101889052911690819063f3fef3a390604401600060405180830381600087803b1580156200187357600080fd5b505af115801562001888573d6000803e3d6000fd5b5050604080518981524260208201526001600160a01b03808c169450891692507f449002ae18e748d69a55f38514400d64f966492e593e32d6e9b8b24db98a0bc1910160405180910390a350505050505b5050565b6001600160a01b03811660009081526002602052604080822081516080810190925280548392839260609284929190829060ff16600381111562001925576200192562003988565b600381111562001939576200193962003988565b8152602001600182015481526020016002820154815260200160038201805480602002602001604051908101604052809291908181526020018280548015620019ac57602002820191906000526020600020905b81546001600160a01b031681526001909101906020018083116200198d575b505050919092525050815160208301516040840151606090940151919a9099509297509550909350505050565b6000805b6006548110156200111957826001600160a01b03166006828154811062001a085762001a0862003b32565b6000918252602090912001546001600160a01b0316141562001a2d5750600192915050565b8062001a398162003b14565b915050620019dd565b6060600580548060200260200160405190810160405280929190818152602001828054801562001a9c57602002820191906000526020600020905b81546001600160a01b0316815260019091019060200180831162001a7d575b5050505050905090565b60005460ff161562001af15760405162461bcd60e51b8152602060048201526013602482015272105b1c9958591e481a5b9a5d1a585b1a5e9959606a1b60448201526064016200088b565b600980546001600160a01b031990811661f20017909155600a805490911661f30017905560005b8181101562001fc957600083838381811062001b385762001b3862003b32565b905060200201602081019062001b4f919062003728565b6001600160a01b0316141562001ba85760405162461bcd60e51b815260206004820152601960248201527f496e76616c69642076616c696461746f7220616464726573730000000000000060448201526064016200088b565b62001bd883838381811062001bc15762001bc162003b32565b905060200201602081019062000349919062003728565b62001c3e57600583838381811062001bf45762001bf462003b32565b905060200201602081019062001c0b919062003728565b81546001810183556000928352602090922090910180546001600160a01b0319166001600160a01b039092169190911790555b62001c6e83838381811062001c575762001c5762003b32565b905060200201602081019062000571919062003728565b62001cd457600683838381811062001c8a5762001c8a62003b32565b905060200201602081019062001ca1919062003728565b81546001810183556000928352602090922090910180546001600160a01b0319166001600160a01b039092169190911790555b60006002600085858581811062001cef5762001cef62003b32565b905060200201602081019062001d06919062003728565b6001600160a01b0316815260208101919091526040016000205460ff16600381111562001d375762001d3762003988565b141562001dac5760016002600085858581811062001d595762001d5962003b32565b905060200201602081019062001d70919062003728565b6001600160a01b031681526020810191909152604001600020805460ff1916600183600381111562001da65762001da662003988565b02179055505b6000600b8185858581811062001dc65762001dc662003b32565b905060200201602081019062001ddd919062003728565b6001600160a01b03908116825260208201929092526040016000205416141562001fb457600083838381811062001e185762001e1862003b32565b905060200201602081019062001e2f919062003728565b60405160200162001e53919060609190911b6001600160601b031916815260140190565b60405160208183030381529060405280519060200120905060008185858581811062001e835762001e8362003b32565b905060200201602081019062001e9a919062003728565b60405162001ea890620036eb565b6001600160a01b0390911681526020018190604051809103906000f590508015801562001ed9573d6000803e3d6000fd5b50905080600b600087878781811062001ef65762001ef662003b32565b905060200201602081019062001f0d919062003728565b6001600160a01b039081168252602082019290925260400160002080546001600160a01b0319169290911691909117905584848481811062001f535762001f5362003b32565b905060200201602081019062001f6a919062003728565b604080516001600160a01b03848116825242602083015292909216917f5e5b474625449a92e2b1a6f9f183435f09402d6897ae7f8779c72142ed11170b910160405180910390a250505b8062001fc08162003b14565b91505062001b18565b507feacea8f3c22f06c0b18306bdb04d0a967255129e8ce0094debb0a0ff89d006b5600560405162001ffc919062003bda565b60405180910390a150506000805460ff19166001179055565b6060600680548060200260200160405190810160405280929190818152602001828054801562001a9c576020028201919060005260206000209081546001600160a01b0316815260019091019060200180831162001a7d575050505050905090565b600080620020866000620032e1565b915091509091565b6000805460ff16620020b45760405162461bcd60e51b81526004016200088b9062003a96565b3360006001600160a01b03851660009081526002602052604090205460ff166003811115620020e757620020e762003988565b14156200212d5760405162461bcd60e51b815260206004820152601360248201527215985b1a59185d1bdc881b9bdd08195e1a5cdd606a1b60448201526064016200088b565b6001600160a01b03808216600090815260036020908152604080832093881683529281528282206002909152919020815480861115620021b05760405162461bcd60e51b815260206004820152601860248201527f596f7520646f6e2774206861766520616e79207374616b65000000000000000060448201526064016200088b565b8581141562002305576003820154620021cc9060019062003baa565b836001015414620022c457600382018054620021eb9060019062003baa565b81548110620021fe57620021fe62003b32565b9060005260206000200160009054906101000a90046001600160a01b03168260030184600101548154811062002238576200223862003b32565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b03160217905550826001015460036000846003018660010154815481106200228b576200228b62003b32565b60009182526020808320909101546001600160a01b0390811684528382019490945260409283018220938c168252929092529020600101555b81600301805480620022da57620022da62003bc4565b600082815260208120820160001990810180546001600160a01b031916905590910190915560018401555b82546200231390876200329d565b835560018201546200232690876200329d565b60018301556007546200233a90876200329d565b6007556001600160a01b0384166000908152600c60205260409020546200236290876200329d565b6001600160a01b038086166000818152600c602052604090209290925588161415620023df576200239387620019d9565b15620023df57825469021e19e0c9bab24000001115620023df5760405162461bcd60e51b81526004016200088b906020808252600490820152630333030360e41b604082015260600190565b6001600160a01b038781166000908152600b60205260409081902054905163f3fef3a360e01b8152868316600482015260248101899052911690819063f3fef3a390604401600060405180830381600087803b1580156200243f57600080fd5b505af115801562002454573d6000803e3d6000fd5b5050604080518a81524260208201526001600160a01b03808d169450891692507f449002ae18e748d69a55f38514400d64f966492e593e32d6e9b8b24db98a0bc1910160405180910390a3506001979650505050505050565b6001600160a01b038181166000908152600b60205260408082205490516246613160e11b815285841660048201529192169082908290628cc2629060240160206040518083038186803b1580156200250457600080fd5b505afa15801562002519573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906200253f919062003b48565b6001600160a01b0386166000908152600460205260409020549091506200150190829062003b62565b6060818067ffffffffffffffff81111562002587576200258762003834565b604051908082528060200260200182016040528015620025b1578160200160208202803683370190505b50915060005b83811015620026ce576000858583818110620025d757620025d762003b32565b9050602002016020810190620025ee919062003728565b6001600160a01b038082166000908152600b6020526040812054929350911690811562002693576040516246613160e11b81526001600160a01b038a81166004830152831690628cc2629060240160206040518083038186803b1580156200265557600080fd5b505afa1580156200266a573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019062002690919062003b48565b90505b80868581518110620026a957620026a962003b32565b6020026020010181815250505050508080620026c59062003b14565b915050620025b7565b50509392505050565b600080620026e6838562003b62565b9050838110156200273a5760405162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f77000000000060448201526064016200088b565b9392505050565b60005b600654811015620027a557826001600160a01b0316600682815481106200276f576200276f62003b32565b6000918252602090912001546001600160a01b031614156200279057505050565b806200279c8162003b14565b91505062002744565b5060065460151115620028fa5760068054600181019091557ff652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d3f0180546001600160a01b0319166001600160a01b038481169182179092556000908152600b602052604090205416620018d9576040516001600160601b0319606084901b166020820152600090603401604051602081830303815290604052805190602001209050600081846040516200285890620036eb565b6001600160a01b0390911681526020018190604051809103906000f590508015801562002889573d6000803e3d6000fd5b506001600160a01b038581166000818152600b602090815260409182902080546001600160a01b031916948616948517905581519384524290840152929350917f5e5b474625449a92e2b1a6f9f183435f09402d6897ae7f8779c72142ed11170b910160405180910390a250505050565b600060026000600660008154811062002917576200291762003b32565b60009182526020808320909101546001600160a01b03168352820192909252604001812060019081015492505b600654811015620029f6578260026000600684815481106200296a576200296a62003b32565b60009182526020808320909101546001600160a01b031683528201929092526040019020600101541015620029e1576002600060068381548110620029b357620029b362003b32565b60009182526020808320909101546001600160a01b0316835282019290925260400190206001015492509050805b80620029ed8162003b14565b91505062002944565b5081831162002a055750505050565b6001600160a01b038481166000908152600b60205260409020541662002b0b576040516001600160601b0319606086901b1660208201526000906034016040516020818303038152906040528051906020012090506000818660405162002a6c90620036eb565b6001600160a01b0390911681526020018190604051809103906000f590508015801562002a9d573d6000803e3d6000fd5b506001600160a01b038781166000818152600b602090815260409182902080546001600160a01b031916948616948517905581519384524290840152929350917f5e5b474625449a92e2b1a6f9f183435f09402d6897ae7f8779c72142ed11170b910160405180910390a250505b836006828154811062002b225762002b2262003b32565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b0316021790555050505050565b8162002b60575050565b60008062002b6e83620032e1565b90925090508062002b7f5750505050565b6000808362002e1a57600062002b96878562003407565b905062002bb062002ba882866200344b565b88906200329d565b925060005b60055481101562002d2a5760006005828154811062002bd85762002bd862003b32565b6000918252602090912001546001600160a01b0316905060036001600160a01b03821660009081526002602052604090205460ff16600381111562002c215762002c2162003988565b1415801562002c425750876001600160a01b0316816001600160a01b031614155b1562002d14576001600160a01b03811660009081526004602052604090205462002c6d9084620026d7565b6001600160a01b038216600090815260046020908152604080832093909355600e815282822043835290529081208054929550859285929062002cb290849062003b62565b90915550506001600160a01b0381166000908152601060205260408120805485929062002ce190849062003b62565b90915550506040518381526001600160a01b0382169060008051602062004c508339815191529060200160405180910390a25b508062002d218162003b14565b91505062002bb5565b5060008311801562002d4457506001600160a01b03821615155b1562002e11576001600160a01b03821660009081526004602052604090205462002d6f9084620026d7565b6001600160a01b038316600090815260046020908152604080832093909355600e81528282204383529052908120805485929062002daf90849062003b62565b90915550506001600160a01b0382166000908152601060205260408120805485929062002dde90849062003b62565b90915550506040518381526001600160a01b0383169060008051602062004c508339815191529060200160405180910390a25b50505050505050565b600062002e2d8764e8d4a510006200344b565b965060005b600554811015620030c45760006005828154811062002e555762002e5562003b32565b6000918252602090912001546001600160a01b0316905060036001600160a01b03821660009081526002602052604090205460ff16600381111562002e9e5762002e9e62003988565b1415801562002ebf5750876001600160a01b0316816001600160a01b031614155b15620030ae576001600160a01b038116600090815260026020819052604082206001015462002f01918a9162002efa919082908f906200344b565b9062003407565b9050600062002f168264e8d4a5100062003407565b6001600160a01b038416600090815260046020526040902054939650869390915062002f439082620026d7565b6001600160a01b03808516600090815260046020818152604080842095909555600b90528382205484516355d54c8b60e11b81529451931693849363abaa99169387938381019391929182900301818588803b15801562002fa357600080fd5b505af115801562002fb8573d6000803e3d6000fd5b50505050506200300262002fd76002846200344b90919063ffffffff16565b6001600160a01b0386166000908152600e6020908152604080832043845290915290205490620026d7565b6001600160a01b0385166000908152600e60209081526040808320438452909152902055620030338260026200344b565b6001600160a01b038516600090815260106020526040812080549091906200305d90849062003b62565b90915550506040518281526001600160a01b0385169060008051602062004c508339815191529060200160405180910390a2620030a8620030a08360026200344b565b8790620026d7565b95505050505b5080620030bb8162003b14565b91505062002e32565b50620030e281620030db8964e8d4a5100062003407565b906200329d565b9250600083118015620030fd57506001600160a01b03821615155b1562002e1157620031346200311484600262003407565b6001600160a01b03841660009081526004602052604090205490620026d7565b6001600160a01b03808416600090815260046020908152604080832094909455600b90529190912054168063abaa99166200317186600262003407565b6040518263ffffffff1660e01b81526004016000604051808303818588803b1580156200319d57600080fd5b505af1158015620031b2573d6000803e3d6000fd5b5050506001600160a01b0385166000908152600e6020908152604080832043845290915281208054889450909250620031ed90849062003b62565b90915550506001600160a01b038316600090815260106020526040812080548692906200321c90849062003b62565b90915550506040518481526001600160a01b0384169060008051602062004c508339815191529060200160405180910390a25050505050505050565b6001600160a01b03811660009081526002602052604081205460ff16600381111562003288576200328862003988565b1415620032925750565b62000f1b81620034d2565b60006200273a83836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f7700008152506200360f565b60008060005b6005548110156200340157600360026000600584815481106200330e576200330e62003b32565b60009182526020808320909101546001600160a01b0316835282019290925260400190205460ff1660038111156200334a576200334a62003988565b14158015620033865750600581815481106200336a576200336a62003b32565b6000918252602090912001546001600160a01b03858116911614155b15620033ec57620033da6002600060058481548110620033aa57620033aa62003b32565b60009182526020808320909101546001600160a01b031683528201929092526040019020600101548490620026d7565b925081620033e88162003b14565b9250505b80620033f88162003b14565b915050620032e7565b50915091565b60006200273a83836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f0000000000008152506200364e565b6000826200345c5750600062001506565b60006200346a838562003c20565b90508262003479858362003c42565b146200273a5760405162461bcd60e51b815260206004820152602160248201527f536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f6044820152607760f81b60648201526084016200088b565b60005b60065481108015620034e957506006546001105b15620018d9576006818154811062003505576200350562003b32565b6000918252602090912001546001600160a01b0383811691161415620035fa57600654620035369060019062003baa565b8114620035c057600680546200354f9060019062003baa565b8154811062003562576200356262003b32565b600091825260209091200154600680546001600160a01b03909216918390811062003591576200359162003b32565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b031602179055505b6006805480620035d457620035d462003bc4565b600082815260209020810160001990810180546001600160a01b03191690550190555050565b80620036068162003b14565b915050620034d5565b60008184841115620036365760405162461bcd60e51b81526004016200088b919062003c59565b50600062003645848662003baa565b95945050505050565b60008183620036725760405162461bcd60e51b81526004016200088b919062003c59565b50600062003645848662003c42565b828054828255906000526020600020908101928215620036d9579160200282015b82811115620036d957825182546001600160a01b0319166001600160a01b03909116178255602090920191600190910190620036a2565b50620036e7929150620036f9565b5090565b610f9e8062003cb283390190565b5b80821115620036e75760008155600101620036fa565b80356001600160a01b038116811462000ce957600080fd5b6000602082840312156200373b57600080fd5b6200273a8262003710565b60008083601f8401126200375957600080fd5b50813567ffffffffffffffff8111156200377257600080fd5b6020830191508360208260051b85010111156200153a57600080fd5b60008060208385031215620037a257600080fd5b823567ffffffffffffffff811115620037ba57600080fd5b620037c88582860162003746565b90969095509350505050565b6020808252825182820181905260009190848201906040850190845b818110156200380e57835183529284019291840191600101620037f0565b50909695505050505050565b6000602082840312156200382d57600080fd5b5035919050565b634e487b7160e01b600052604160045260246000fd5b600080604083850312156200385e57600080fd5b823567ffffffffffffffff808211156200387757600080fd5b818501915085601f8301126200388c57600080fd5b8135602082821115620038a357620038a362003834565b8160051b604051601f19603f83011681018181108682111715620038cb57620038cb62003834565b604052928352818301935084810182019289841115620038ea57600080fd5b948201945b838610156200391357620039038662003710565b85529482019493820193620038ef565b9997909101359750505050505050565b600080604083850312156200393757600080fd5b620039428362003710565b946020939093013593505050565b600080604083850312156200396457600080fd5b6200396f8362003710565b91506200397f6020840162003710565b90509250929050565b634e487b7160e01b600052602160045260246000fd5b600081518084526020808501945080840160005b83811015620039d95781516001600160a01b031687529582019590820190600101620039b2565b509495945050505050565b600060048610620039f957620039f962003988565b8582528460208301528360408301526080606083015262003a1e60808301846200399e565b9695505050505050565b6020815260006200273a60208301846200399e565b60008060006040848603121562003a5357600080fd5b62003a5e8462003710565b9250602084013567ffffffffffffffff81111562003a7b57600080fd5b62003a898682870162003746565b9497909650939450505050565b6020808252600c908201526b139bdd081a5b9a5d081e595d60a21b604082015260600190565b6000806040838503121562003ad057600080fd5b505080516020909101519092909150565b602081016003831062003af85762003af862003988565b91905290565b634e487b7160e01b600052601160045260246000fd5b600060001982141562003b2b5762003b2b62003afe565b5060010190565b634e487b7160e01b600052603260045260246000fd5b60006020828403121562003b5b57600080fd5b5051919050565b6000821982111562003b785762003b7862003afe565b500190565b634e487b7160e01b600052601260045260246000fd5b60008262003ba55762003ba562003b7d565b500690565b60008282101562003bbf5762003bbf62003afe565b500390565b634e487b7160e01b600052603160045260246000fd5b6020808252825482820181905260008481528281209092916040850190845b818110156200380e5783546001600160a01b03168352600193840193928501920162003bf9565b600081600019048311821515161562003c3d5762003c3d62003afe565b500290565b60008262003c545762003c5462003b7d565b500490565b600060208083528351808285015260005b8181101562003c885785810183015185820160400152820162003c6a565b8181111562003c9b576000604083870101525b50601f01601f191692909201604001939250505056fe608060405234801561001057600080fd5b50604051610f9e380380610f9e83398101604081905261002f91610102565b60028054336001600160a01b031991821617909155600580549091166001600160a01b03929092169190911790556040805160608101825243815260006020820181815292820181815260048054600181018255925291517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b60039092029182015591517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19c830155517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19d90910155610132565b60006020828403121561011457600080fd5b81516001600160a01b038116811461012b57600080fd5b9392505050565b610e5d806101416000396000f3fe6080604052600436106100c15760003560e01c806370a082311161007f578063c00007b011610059578063c00007b0146101f9578063e673df8a14610219578063f3fef3a314610239578063fa9ada5b1461025957600080fd5b806370a0823114610185578063714b4658146101bb578063abaa9916146101f157600080fd5b80628cc262146100c657806318160ddd146100f9578063264762041461010e5780633a5381b5146101235780633f9e3f041461015b578063446a2ec814610170575b600080fd5b3480156100d257600080fd5b506100e66100e1366004610c9d565b61029c565b6040519081526020015b60405180910390f35b34801561010557600080fd5b506000546100e6565b61012161011c366004610c9d565b61032d565b005b34801561012f57600080fd5b50600554610143906001600160a01b031681565b6040516001600160a01b0390911681526020016100f0565b34801561016757600080fd5b506100e6610472565b34801561017c57600080fd5b506100e6610488565b34801561019157600080fd5b506100e66101a0366004610c9d565b6001600160a01b031660009081526001602052604090205490565b3480156101c757600080fd5b506100e66101d6366004610c9d565b6001600160a01b031660009081526003602052604090205490565b61012161049b565b34801561020557600080fd5b50610121610214366004610c9d565b610557565b34801561022557600080fd5b50600254610143906001600160a01b031681565b34801561024557600080fd5b50610121610254366004610cba565b6106bc565b34801561026557600080fd5b506100e6610274366004610ce6565b6005546001600160a01b03166000908152600660209081526040808320938352929052205490565b6000806102a76107f0565b60400151905060006102b88461086a565b6040908101516001600160a01b03861660009081526003602052918220600101549092506103249061031e670de0b6b3a76400006103186102f988886108fd565b6001600160a01b038b1660009081526001602052604090205490610948565b906109c7565b90610a09565b95945050505050565b6002546001600160a01b031633146103605760405162461bcd60e51b815260040161035790610cff565b60405180910390fd5b806001600160a01b038116156103e1576001600160a01b03811660009081526003602090815260409182902082518084019093528054835260010154908201526103a98261029c565b60208201526103b6610472565b81526001600160a01b0382166000908152600360209081526040909120825181559101516001909101555b34806104205760405162461bcd60e51b815260206004820152600e60248201526d043616e6e6f74207374616b6520360941b6044820152606401610357565b61042a8382610a68565b826001600160a01b03167f9e71bc8eea02a63969f509818f2dafb9254532904319f9dbda79b67bd34a5f3d8260405161046591815260200190565b60405180910390a2505050565b6004546000906104839060016108fd565b905090565b60006104926107f0565b60400151905090565b6002546001600160a01b031633146104c55760405162461bcd60e51b815260040161035790610cff565b34806104ce5750565b6005546001600160a01b0316600090815260066020908152604080832043845290915281208054839290610503908490610d4c565b90915550610512905081610aba565b6005546040518281526001600160a01b03909116907f7d8f3d9291db7e540ea10a43e300f1330c3e9148157349babe42ac2601a2a3e99060200160405180910390a250565b6002546001600160a01b031633146105815760405162461bcd60e51b815260040161035790610cff565b806001600160a01b03811615610602576001600160a01b03811660009081526003602090815260409182902082518084019093528054835260010154908201526105ca8261029c565b60208201526105d7610472565b81526001600160a01b0382166000908152600360209081526040909120825181559101516001909101555b6001600160a01b03821660009081526003602052604090206001015480156106b7576001600160a01b0383166000818152600360205260408082206001018290555183156108fc0291849190818181858888f1935050505015801561066b573d6000803e3d6000fd5b50600554604080518381524260208201526001600160a01b03928316928616917f51a69b4502f660774c9339825c7b5adbf0b8622289134647e29728ec5d9b3bb9910160405180910390a35b505050565b6002546001600160a01b031633146106e65760405162461bcd60e51b815260040161035790610cff565b816001600160a01b03811615610767576001600160a01b038116600090815260036020908152604091829020825180840190935280548352600101549082015261072f8261029c565b602082015261073c610472565b81526001600160a01b0382166000908152600360209081526040909120825181559101516001909101555b600082116107ab5760405162461bcd60e51b8152602060048201526011602482015270043616e6e6f74207769746864726177203607c1b6044820152606401610357565b6107b58383610bad565b826001600160a01b03167f7084f5476618d8e60b11ef0d7d3f06914655adb8793e28ff7f018d4c76d505d58360405161046591815260200190565b61081460405180606001604052806000815260200160008152602001600081525090565b600461081e610472565b8154811061082e5761082e610d64565b90600052602060002090600302016040518060600160405290816000820154815260200160018201548152602001600282015481525050905090565b61088e60405180606001604052806000815260200160008152602001600081525090565b60046108af836001600160a01b031660009081526003602052604090205490565b815481106108bf576108bf610d64565b906000526020600020906003020160405180606001604052908160008201548152602001600182015481526020016002820154815250509050919050565b600061093f83836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f770000815250610c26565b90505b92915050565b60008261095757506000610942565b60006109638385610d7a565b9050826109708583610d99565b1461093f5760405162461bcd60e51b815260206004820152602160248201527f536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f6044820152607760f81b6064820152608401610357565b600061093f83836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f000000000000815250610c57565b600080610a168385610d4c565b90508381101561093f5760405162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f7700000000006044820152606401610357565b600054610a759082610a09565b60009081556001600160a01b038316815260016020526040902054610a9a9082610a09565b6001600160a01b0390921660009081526001602052604090209190915550565b6000610ac46107f0565b6040015190506000610ad560005490565b905080610ae157505050565b6000610b03610afc8361031887670de0b6b3a7640000610948565b8490610a09565b60408051606081018252438152602081019687529081019182526004805460018101825560009190915290517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b60039092029182015594517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19c860155517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19d90940193909355505050565b600054610bba90826108fd565b60009081556001600160a01b038316815260016020526040902054610bdf90826108fd565b6001600160a01b038316600081815260016020526040808220939093559151909183156108fc02918491818181858888f193505050501580156106b7573d6000803e3d6000fd5b60008184841115610c4a5760405162461bcd60e51b81526004016103579190610dbb565b5060006103248486610e10565b60008183610c785760405162461bcd60e51b81526004016103579190610dbb565b5060006103248486610d99565b6001600160a01b0381168114610c9a57600080fd5b50565b600060208284031215610caf57600080fd5b813561093f81610c85565b60008060408385031215610ccd57600080fd5b8235610cd881610c85565b946020939093013593505050565b600060208284031215610cf857600080fd5b5035919050565b6020808252601a908201527f43616c6c6572206973206e6f7420746865206f70657261746f72000000000000604082015260600190565b634e487b7160e01b600052601160045260246000fd5b60008219821115610d5f57610d5f610d36565b500190565b634e487b7160e01b600052603260045260246000fd5b6000816000190483118215151615610d9457610d94610d36565b500290565b600082610db657634e487b7160e01b600052601260045260246000fd5b500490565b600060208083528351808285015260005b81811015610de857858101830151858201604001528201610dcc565b81811115610dfa576000604083870101525b50601f01601f1916929092016040019392505050565b600082821015610e2257610e22610d36565b50039056fea2646970667358221220092ff02654aefd0a4e804c1722e86dc3109bc72cf5430ed579fa0cf60e40626064736f6c634300080800337d8f3d9291db7e540ea10a43e300f1330c3e9148157349babe42ac2601a2a3e9a2646970667358221220b992071c2b1abe26ede18efdc6a0717993acd18ba6c0ed5afe086869024fa97c64736f6c63430008080033"
)

type hardForkValidatorsV3 struct {
}

func (s *hardForkValidatorsV3) GetName() string {
	return ValidatorsV2ContractName
}

func (s *hardForkValidatorsV3) Update(config *params.ChainConfig, height *big.Int, state *state.StateDB) (err error) {
	contractCode := common.FromHex(validatorV3Code)

	//write code to sys contract
	state.SetCode(ValidatorsV2ContractAddr, contractCode)
	log.Debug("Write code to system contract account", "addr", ValidatorsV2ContractAddr.String(), "code", validatorV3Code)

	return
}

func (s *hardForkValidatorsV3) Execute(state *state.StateDB, header *types.Header, chainContext core.ChainContext, config *params.ChainConfig) (err error) {
	//First, get top validators from the old contract
	v0 := NewValidatorV0()
	topVals, err := v0.GetTopValidators(state, header, chainContext, config)
	if err != nil {
		log.Error("getTopValidators from V0 failed", "err", err)
		return err
	}

	// initialize v1 contract
	method := "initialize"
	data, err := GetInteractiveABI()[ValidatorsV2ContractName].Pack(method, topVals)
	if err != nil {
		log.Error("Can't pack data for initialize", "error", err)
		return err
	}

	msg := vmcaller.NewLegacyMessage(header.Coinbase, &ValidatorsV2ContractAddr, 0, new(big.Int), math.MaxUint64, new(big.Int), data, false)
	_, err = vmcaller.ExecuteMsg(msg, state, header, chainContext, config)

	return
}
