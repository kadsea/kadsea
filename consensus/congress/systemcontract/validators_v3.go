package systemcontract

import (
	"math"
	"math/big"

	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/consensus/congress/vmcaller"
	"github.com/ethereum/go-ethereum/core"
	"github.com/ethereum/go-ethereum/core/state"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/log"
	"github.com/ethereum/go-ethereum/params"
)

const (
	validatorV3Code = "0x608060405260043610620001fe5760003560e01c80638a11d7c91162000117578063be64569211620000a1578063c4e2f07a116200006c578063c4e2f07a1462000606578063c967f90f146200062b578063d6eb3de11462000656578063e8363f6c146200066e57600080fd5b8063be6456921462000591578063c1d7dd7814620005b1578063c253c38414620005c9578063c2a672e014620005e157600080fd5b8063a097724211620000e2578063a097724214620004e3578063a224cee7146200051a578063afeea115146200053f578063bbe4f6db146200055757600080fd5b80638a11d7c914620004485780638b0e9f3f146200047f57806398e3b62614620004975780639de7025814620004bc57600080fd5b806340550a1c11620001995780636846992a11620001645780636846992a146200039e5780636969a25c14620003c35780637f4f95fa14620003e857806380d2dde1146200042357600080fd5b806340550a1c146200030857806340a141ff146200032d57806348cd4cb114620003525780634b3d500b146200037957600080fd5b80632647620411620001da57806326476204146200028a57806330fcb67c14620002a157806338b67b8b14620002ba5780633a061bd314620002f057600080fd5b8062362a771462000203578063158ef93e146200023d5780631b5e358c1462000259575b600080fd5b3480156200021057600080fd5b50620002286200022236600462003b67565b6200069f565b60405190151581526020015b60405180910390f35b3480156200024a57600080fd5b50600054620002289060ff1681565b3480156200026657600080fd5b506200027161f20081565b6040516001600160a01b03909116815260200162000234565b620002286200029b36600462003b67565b620007ca565b620002b8620002b236600462003b67565b62000c53565b005b348015620002c757600080fd5b50620002df620002d936600462003bcd565b62000e83565b604051620002349392919062003c50565b348015620002fd57600080fd5b506200027161f10081565b3480156200031557600080fd5b50620002286200032736600462003b67565b62001134565b3480156200033a57600080fd5b50620002b86200034c36600462003b67565b620011a6565b3480156200035f57600080fd5b506200036a60015481565b60405190815260200162000234565b3480156200038657600080fd5b50620002716200039836600462003c99565b62001207565b348015620003ab57600080fd5b50620002b8620003bd36600462003cc9565b62001232565b348015620003d057600080fd5b5062000271620003e236600462003c99565b620014ad565b348015620003f557600080fd5b506200040d6200040736600462003da2565b620014be565b6040805192835260208301919091520162000234565b3480156200043057600080fd5b50620002b86200044236600462003dda565b620014f3565b3480156200045557600080fd5b506200046d6200046736600462003b67565b6200188f565b60405162000234949392919062003e58565b3480156200048c57600080fd5b506200036a60075481565b348015620004a457600080fd5b5062000228620004b636600462003b67565b6200198b565b348015620004c957600080fd5b50620004d4620019f4565b60405162000234919062003e92565b348015620004f057600080fd5b50620005086200050236600462003ea7565b62001a58565b60405162000234949392919062003ef7565b3480156200052757600080fd5b50620002b86200053936600462003bcd565b62001d7b565b3480156200054c57600080fd5b50620004d4620022ea565b3480156200056457600080fd5b50620002716200057636600462003b67565b600b602052600090815260409020546001600160a01b031681565b3480156200059e57600080fd5b506200036a69021e19e0c9bab240000081565b348015620005be57600080fd5b506200036a60085481565b348015620005d657600080fd5b506200040d6200234c565b348015620005ee57600080fd5b50620002286200060036600462003dda565b62002363565b3480156200061357600080fd5b506200036a6200062536600462003da2565b62002784565b3480156200063857600080fd5b5062000642601581565b60405161ffff909116815260200162000234565b3480156200066357600080fd5b506200027161f30081565b3480156200067b57600080fd5b506200036a6200068d36600462003b67565b60046020526000908152604090205481565b33600081815260046020526040812080549082905590919080156200073f576040516001600160a01b0383169082156108fc029083906000818181858888f19350505050158015620006f5573d6000803e3d6000fd5b50604080518281524260208201526001600160a01b0380871692908516917f51a69b4502f660774c9339825c7b5adbf0b8622289134647e29728ec5d9b3bb9910160405180910390a35b6001600160a01b038085166000908152600b6020526040902054168015620007bf57604051630c00007b60e41b81526001600160a01b03848116600483015282169063c00007b090602401600060405180830381600087803b158015620007a557600080fd5b505af1158015620007ba573d6000803e3d6000fd5b505050505b506001949350505050565b6000805460ff16620007f95760405162461bcd60e51b8152600401620007f09062003f57565b60405180910390fd5b336000818152600c6020526040902054349062000817908262002847565b6001600160a01b038084166000908152600c602052604080822093909355600a5483516325dff9d160e01b815284519294859492909216926325dff9d192600480840193919291829003018186803b1580156200087357600080fd5b505afa15801562000888573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620008ae919062003f7d565b9150915081431015620008f15760405162461bcd60e51b815260206004820152600a6024820152697374617274426c6f636b60b01b6044820152606401620007f0565b804311156200092e5760405162461bcd60e51b8152602060048201526008602482015267656e64426c6f636b60c01b6044820152606401620007f0565b6001600160a01b03808716600081815260026020526040902091861614801562000988575060016001600160a01b03881660009081526002602052604090205460ff16600381111562000985576200098562003e07565b14155b15620009fb57600181015469021e19e0c9bab240000090620009ab908662002847565b1015620009fb5760405162461bcd60e51b815260206004820152601860248201527f5374616b696e6720636f696e73206e6f7420656e6f75676800000000000000006044820152606401620007f0565b6001600160a01b038086166000908152600360209081526040808320938b168352929052205462000a7a57600380820180546001600160a01b03808916600081815260209586526040808220938e1682529286529182206001908101849055830184559281529290922090910180546001600160a01b03191690911790555b600181015462000ac957866001600160a01b03167fbc822c457926e0706c445f2b613394c8a2bf34b3b4335915e3865b90829ce38b600160405162000ac0919062003fa2565b60405180910390a25b600181015462000ada908562002847565b600180830191909155815460ff16600381111562000afc5762000afc62003e07565b1462000b0e57805460ff191660011781555b62000b1e878260010154620028b1565b6001600160a01b038086166000908152600360209081526040808320938b168352929052205462000b50908562002847565b6001600160a01b038087166000908152600360209081526040808320938c168352929052205560075462000b85908562002847565b6007556001600160a01b038781166000908152600b602052604090819020549051630991d88160e21b81528783166004820152911690819063264762049087906024016000604051808303818588803b15801562000be257600080fd5b505af115801562000bf7573d6000803e3d6000fd5b5050604080518981524260208201526001600160a01b03808e1695508b1693507fb9ba725934532316cffe10975da6eb25ad49c2d1c294d982c46c9f8d684ee07592500160405180910390a3600196505050505050505b919050565b33411462000c915760405162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b6044820152606401620007f0565b436000908152600d6020908152604080832083805290915290205460ff161562000cfe5760405162461bcd60e51b815260206004820152601960248201527f426c6f636b20697320616c7265616479207265776172646564000000000000006044820152606401620007f0565b60005460ff1662000d235760405162461bcd60e51b8152600401620007f09062003f57565b436000818152600d602090815260408083208380529091529020805460ff191660019081179091555433913491101562000de4576001600160a01b0382166000908152600e6020526040812080549162000d7d8362003fd5565b9091555050600954604051631e88772760e01b81526001600160a01b03848116600483015290911690631e88772790602401600060405180830381600087803b15801562000dca57600080fd5b505af115801562000ddf573d6000803e3d6000fd5b505050505b6000811162000df257505050565b6001600160a01b03821660009081526002602052604081205460ff16600381111562000e225762000e2262003e07565b141562000e2e57505050565b62000e3a818462002cc6565b604080518281524260208201526001600160a01b038416917f7dc4e5df59513708dca355b8706273a5df7b810a4cec8019f2a4b9bb166a1a04910160405180910390a250505b50565b60608080838067ffffffffffffffff81111562000ea45762000ea462003cb3565b60405190808252806020026020018201604052801562000ece578160200160208202803683370190505b5093508067ffffffffffffffff81111562000eed5762000eed62003cb3565b60405190808252806020026020018201604052801562000f17578160200160208202803683370190505b5092508067ffffffffffffffff81111562000f365762000f3662003cb3565b60405190808252806020026020018201604052801562000f60578160200160208202803683370190505b50915060005b818110156200112b57600087878381811062000f865762000f8662003ff3565b905060200201602081019062000f9d919062003b67565b6001600160a01b038082166000908152600b6020526040812054929350911690811562001042576040516246613160e11b81526001600160a01b038481166004830152831690628cc2629060240160206040518083038186803b1580156200100457600080fd5b505afa15801562001019573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906200103f919062004009565b90505b8086858151811062001058576200105862003ff3565b60200260200101818152505060046000846001600160a01b03166001600160a01b03168152602001908152602001600020548785815181106200109f576200109f62003ff3565b602002602001018181525050868481518110620010c057620010c062003ff3565b6020026020010151868581518110620010dd57620010dd62003ff3565b6020026020010151620010f1919062004023565b88858151811062001106576200110662003ff3565b6020026020010181815250505050508080620011229062003fd5565b91505062000f66565b50509250925092565b6000805b6005548110156200119d57826001600160a01b03166005828154811062001163576200116362003ff3565b6000918252602090912001546001600160a01b03161415620011885750600192915050565b80620011948162003fd5565b91505062001138565b50600092915050565b3361f20014620011f05760405162461bcd60e51b815260206004820152601460248201527350756e69736820636f6e7472616374206f6e6c7960601b6044820152606401620007f0565b6006546001101562000e805762000e8081620036a0565b600681815481106200121857600080fd5b6000918252602090912001546001600160a01b0316905081565b334114620012705760405162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b6044820152606401620007f0565b436000908152600d602090815260408083206001845290915290205460ff1615620012de5760405162461bcd60e51b815260206004820152601a60248201527f56616c696461746f727320616c726561647920757064617465640000000000006044820152606401620007f0565b60005460ff16620013035760405162461bcd60e51b8152600401620007f09062003f57565b8062001310814362004054565b15620013525760405162461bcd60e51b815260206004820152601060248201526f426c6f636b2065706f6368206f6e6c7960801b6044820152606401620007f0565b436000908152600d6020908152604080832060018085529252909120805460ff191690911790558251620013c05760405162461bcd60e51b815260206004820152601460248201527356616c696461746f722073657420656d7074792160601b6044820152606401620007f0565b600a54604080516325dff9d160e01b815281516000936001600160a01b0316926325dff9d19260048082019391829003018186803b1580156200140257600080fd5b505afa15801562001417573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906200143d919062003f7d565b915050600081118015620014515750804310155b15620014a75783516200146c90600590602087019062003ac0565b507feacea8f3c22f06c0b18306bdb04d0a967255129e8ce0094debb0a0ff89d006b5846040516200149e919062003e92565b60405180910390a15b50505050565b600581815481106200121857600080fd5b6001600160a01b03828116600090815260036020908152604080832093851683529290522080546001909101545b9250929050565b3361f200146200153d5760405162461bcd60e51b815260206004820152601460248201527350756e69736820636f6e7472616374206f6e6c7960601b6044820152606401620007f0565b8160006001600160a01b03841660009081526002602052604090205460ff16600381111562001570576200157062003e07565b1415620015b65760405162461bcd60e51b815260206004820152601360248201527215985b1a59185d1bdc881b9bdd08195e1a5cdd606a1b6044820152606401620007f0565b6001600160a01b03808216600090815260036020908152604080832093871683529281528282206002909152919020815480851115620015f4578094505b846200160257505050505050565b84811415620017575760038201546200161e906001906200406b565b83600101541462001716576003820180546200163d906001906200406b565b8154811062001650576200165062003ff3565b9060005260206000200160009054906101000a90046001600160a01b0316826003018460010154815481106200168a576200168a62003ff3565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b0316021790555082600101546003600084600301866001015481548110620016dd57620016dd62003ff3565b60009182526020808320909101546001600160a01b0390811684528382019490945260409283018220938b168252929092529020600101555b816003018054806200172c576200172c62004085565b600082815260208120820160001990810180546001600160a01b031916905590910190915560018401555b8254620017659086620036e5565b83556001820154620017789086620036e5565b60018301556007546200178c9086620036e5565b6007556001600160a01b0384166000908152600c6020526040902054620017b49086620036e5565b6001600160a01b038581166000818152600c60209081526040808320959095558a84168252600b905283902054925163f3fef3a360e01b8152600481019190915260248101889052911690819063f3fef3a390604401600060405180830381600087803b1580156200182557600080fd5b505af11580156200183a573d6000803e3d6000fd5b5050604080518981524260208201526001600160a01b03808c169450891692507f449002ae18e748d69a55f38514400d64f966492e593e32d6e9b8b24db98a0bc1910160405180910390a350505050505b5050565b6001600160a01b03811660009081526002602052604080822081516080810190925280548392839260609284929190829060ff166003811115620018d757620018d762003e07565b6003811115620018eb57620018eb62003e07565b81526020016001820154815260200160028201548152602001600382018054806020026020016040519081016040528092919081815260200182805480156200195e57602002820191906000526020600020905b81546001600160a01b031681526001909101906020018083116200193f575b505050919092525050815160208301516040840151606090940151919a9099509297509550909350505050565b6000805b6006548110156200119d57826001600160a01b031660068281548110620019ba57620019ba62003ff3565b6000918252602090912001546001600160a01b03161415620019df5750600192915050565b80620019eb8162003fd5565b9150506200198f565b6060600580548060200260200160405190810160405280929190818152602001828054801562001a4e57602002820191906000526020600020905b81546001600160a01b0316815260019091019060200180831162001a2f575b5050505050905090565b6060808080858067ffffffffffffffff81111562001a7a5762001a7a62003cb3565b60405190808252806020026020018201604052801562001aa4578160200160208202803683370190505b5094508067ffffffffffffffff81111562001ac35762001ac362003cb3565b60405190808252806020026020018201604052801562001aed578160200160208202803683370190505b5093508067ffffffffffffffff81111562001b0c5762001b0c62003cb3565b60405190808252806020026020018201604052801562001b36578160200160208202803683370190505b5092508067ffffffffffffffff81111562001b555762001b5562003cb3565b60405190808252806020026020018201604052801562001b7f578160200160208202803683370190505b50915060005b8181101562001d7057600089898381811062001ba55762001ba562003ff3565b905060200201602081019062001bbc919062003b67565b6001600160a01b038082166000908152600b6020526040812054929350911690811562001c625760405163fa9ada5b60e01b8152600481018b90526001600160a01b0383169063fa9ada5b9060240160206040518083038186803b15801562001c2457600080fd5b505afa15801562001c39573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019062001c5f919062004009565b90505b6001600160a01b0383166000908152600f602090815260408083208d845290915290205489518a908690811062001c9d5762001c9d62003ff3565b6020908102919091018101919091526001600160a01b03841660009081526010825260408082208d83529092522054885189908690811062001ce35762001ce362003ff3565b6020908102919091018101919091526001600160a01b03841660009081526011825260408082208d83529092522054875188908690811062001d295762001d2962003ff3565b6020026020010181815250508086858151811062001d4b5762001d4b62003ff3565b602002602001018181525050505050808062001d679062003fd5565b91505062001b85565b505093509350935093565b60005460ff161562001dc65760405162461bcd60e51b8152602060048201526013602482015272105b1c9958591e481a5b9a5d1a585b1a5e9959606a1b6044820152606401620007f0565b600980546001600160a01b031990811661f20017909155600a805490911661f30017905560005b818110156200229e57600083838381811062001e0d5762001e0d62003ff3565b905060200201602081019062001e24919062003b67565b6001600160a01b0316141562001e7d5760405162461bcd60e51b815260206004820152601960248201527f496e76616c69642076616c696461746f722061646472657373000000000000006044820152606401620007f0565b62001ead83838381811062001e965762001e9662003ff3565b905060200201602081019062000327919062003b67565b62001f1357600583838381811062001ec95762001ec962003ff3565b905060200201602081019062001ee0919062003b67565b81546001810183556000928352602090922090910180546001600160a01b0319166001600160a01b039092169190911790555b62001f4383838381811062001f2c5762001f2c62003ff3565b9050602002016020810190620004b6919062003b67565b62001fa957600683838381811062001f5f5762001f5f62003ff3565b905060200201602081019062001f76919062003b67565b81546001810183556000928352602090922090910180546001600160a01b0319166001600160a01b039092169190911790555b60006002600085858581811062001fc45762001fc462003ff3565b905060200201602081019062001fdb919062003b67565b6001600160a01b0316815260208101919091526040016000205460ff1660038111156200200c576200200c62003e07565b141562002081576001600260008585858181106200202e576200202e62003ff3565b905060200201602081019062002045919062003b67565b6001600160a01b031681526020810191909152604001600020805460ff191660018360038111156200207b576200207b62003e07565b02179055505b6000600b818585858181106200209b576200209b62003ff3565b9050602002016020810190620020b2919062003b67565b6001600160a01b03908116825260208201929092526040016000205416141562002289576000838383818110620020ed57620020ed62003ff3565b905060200201602081019062002104919062003b67565b60405160200162002128919060609190911b6001600160601b031916815260140190565b60405160208183030381529060405280519060200120905060008185858581811062002158576200215862003ff3565b90506020020160208101906200216f919062003b67565b6040516200217d9062003b2a565b6001600160a01b0390911681526020018190604051809103906000f5905080158015620021ae573d6000803e3d6000fd5b50905080600b6000878787818110620021cb57620021cb62003ff3565b9050602002016020810190620021e2919062003b67565b6001600160a01b039081168252602082019290925260400160002080546001600160a01b0319169290911691909117905584848481811062002228576200222862003ff3565b90506020020160208101906200223f919062003b67565b604080516001600160a01b03848116825242602083015292909216917f5e5b474625449a92e2b1a6f9f183435f09402d6897ae7f8779c72142ed11170b910160405180910390a250505b80620022958162003fd5565b91505062001ded565b507feacea8f3c22f06c0b18306bdb04d0a967255129e8ce0094debb0a0ff89d006b56005604051620022d191906200409b565b60405180910390a150506000805460ff19166001179055565b6060600680548060200260200160405190810160405280929190818152602001828054801562001a4e576020028201919060005260206000209081546001600160a01b0316815260019091019060200180831162001a2f575050505050905090565b6000806200235b600062003729565b915091509091565b6000805460ff16620023895760405162461bcd60e51b8152600401620007f09062003f57565b3360006001600160a01b03851660009081526002602052604090205460ff166003811115620023bc57620023bc62003e07565b1415620024025760405162461bcd60e51b815260206004820152601360248201527215985b1a59185d1bdc881b9bdd08195e1a5cdd606a1b6044820152606401620007f0565b6001600160a01b03808216600090815260036020908152604080832093881683529281528282206002909152919020815480861115620024855760405162461bcd60e51b815260206004820152601860248201527f596f7520646f6e2774206861766520616e79207374616b6500000000000000006044820152606401620007f0565b85811415620025da576003820154620024a1906001906200406b565b8360010154146200259957600382018054620024c0906001906200406b565b81548110620024d357620024d362003ff3565b9060005260206000200160009054906101000a90046001600160a01b0316826003018460010154815481106200250d576200250d62003ff3565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b031602179055508260010154600360008460030186600101548154811062002560576200256062003ff3565b60009182526020808320909101546001600160a01b0390811684528382019490945260409283018220938c168252929092529020600101555b81600301805480620025af57620025af62004085565b600082815260208120820160001990810180546001600160a01b031916905590910190915560018401555b8254620025e89087620036e5565b83556001820154620025fb9087620036e5565b60018301556007546200260f9087620036e5565b6007556001600160a01b0384166000908152600c6020526040902054620026379087620036e5565b6001600160a01b038086166000818152600c602052604090209290925588161415620026b45762002668876200198b565b15620026b457825469021e19e0c9bab24000001115620026b45760405162461bcd60e51b8152600401620007f0906020808252600490820152630333030360e41b604082015260600190565b6001600160a01b038781166000908152600b60205260409081902054905163f3fef3a360e01b8152868316600482015260248101899052911690819063f3fef3a390604401600060405180830381600087803b1580156200271457600080fd5b505af115801562002729573d6000803e3d6000fd5b5050604080518a81524260208201526001600160a01b03808d169450891692507f449002ae18e748d69a55f38514400d64f966492e593e32d6e9b8b24db98a0bc1910160405180910390a36001955050505050505b92915050565b6001600160a01b038181166000908152600b60205260408082205490516246613160e11b815285841660048201529192169082908290628cc2629060240160206040518083038186803b158015620027db57600080fd5b505afa158015620027f0573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019062002816919062004009565b6001600160a01b0386166000908152600460205260409020549091506200283e908262002847565b95945050505050565b60008062002856838562004023565b905083811015620028aa5760405162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f7700000000006044820152606401620007f0565b9392505050565b60005b6006548110156200291557826001600160a01b031660068281548110620028df57620028df62003ff3565b6000918252602090912001546001600160a01b031614156200290057505050565b806200290c8162003fd5565b915050620028b4565b506006546015111562002a6a5760068054600181019091557ff652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d3f0180546001600160a01b0319166001600160a01b038481169182179092556000908152600b6020526040902054166200188b576040516001600160601b0319606084901b16602082015260009060340160405160208183030381529060405280519060200120905060008184604051620029c89062003b2a565b6001600160a01b0390911681526020018190604051809103906000f5905080158015620029f9573d6000803e3d6000fd5b506001600160a01b038581166000818152600b602090815260409182902080546001600160a01b031916948616948517905581519384524290840152929350917f5e5b474625449a92e2b1a6f9f183435f09402d6897ae7f8779c72142ed11170b910160405180910390a250505050565b600060026000600660008154811062002a875762002a8762003ff3565b60009182526020808320909101546001600160a01b03168352820192909252604001812060019081015492505b60065481101562002b665782600260006006848154811062002ada5762002ada62003ff3565b60009182526020808320909101546001600160a01b03168352820192909252604001902060010154101562002b5157600260006006838154811062002b235762002b2362003ff3565b60009182526020808320909101546001600160a01b0316835282019290925260400190206001015492509050805b8062002b5d8162003fd5565b91505062002ab4565b5081831162002b755750505050565b6001600160a01b038481166000908152600b60205260409020541662002c7b576040516001600160601b0319606086901b1660208201526000906034016040516020818303038152906040528051906020012090506000818660405162002bdc9062003b2a565b6001600160a01b0390911681526020018190604051809103906000f590508015801562002c0d573d6000803e3d6000fd5b506001600160a01b038781166000818152600b602090815260409182902080546001600160a01b031916948616948517905581519384524290840152929350917f5e5b474625449a92e2b1a6f9f183435f09402d6897ae7f8779c72142ed11170b910160405180910390a250505b836006828154811062002c925762002c9262003ff3565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b0316021790555050505050565b8162002cd0575050565b60008062002cde8362003729565b90925090508062002cef5750505050565b6000808362002fdc57600062002d0687856200384f565b905062002d2062002d18828662003893565b8890620036e5565b925060005b60055481101562002ec35760006005828154811062002d485762002d4862003ff3565b6000918252602090912001546001600160a01b0316905060036001600160a01b03821660009081526002602052604090205460ff16600381111562002d915762002d9162003e07565b1415801562002db25750876001600160a01b0316816001600160a01b031614155b1562002ead576001600160a01b03811660009081526004602052604090205462002ddd908462002847565b6001600160a01b038216600090815260046020908152604080832093909355600f815282822043835290522054909350839062002e1b908462002847565b6001600160a01b0382166000818152600f602090815260408083204380855290835281842095909555928252601081528282209382529290925290205462002e64908462002847565b6001600160a01b038216600081815260106020908152604080832043845282529182902093909355518581529091600080516020620050d2833981519152910160405180910390a25b508062002eba8162003fd5565b91505062002d25565b5060008311801562002edd57506001600160a01b03821615155b1562002fd3576001600160a01b03821660009081526004602052604090205462002f08908462002847565b6001600160a01b038316600090815260046020908152604080832093909355600f81528282204383529052205462002f41908462002847565b6001600160a01b0383166000818152600f602090815260408083204380855290835281842095909555928252601081528282209382529290925290205462002f8a908462002847565b6001600160a01b038316600081815260106020908152604080832043845282529182902093909355518581529091600080516020620050d2833981519152910160405180910390a25b50505050505050565b6000805b600554811015620033c55760006005828154811062003003576200300362003ff3565b6000918252602090912001546001600160a01b0316905060036001600160a01b03821660009081526002602052604090205460ff1660038111156200304c576200304c62003e07565b141580156200306d5750876001600160a01b0316816001600160a01b031614155b15620033ae576000620030b66200308689600262003893565b6001600160a01b038416600090815260026020526040902060010154620030af908d9062003893565b906200384f565b905080620030c6575050620033b0565b6001600160a01b0382166000908152600460205260409020549194508491620030f0908262002847565b6001600160a01b038316600090815260046020908152604080832093909355601081528282204383529052205462003129908262002847565b6001600160a01b038381166000818152601060209081526040808320438452825280832095909555828252600b90528381205493516246613160e11b815260048101929092529290911691908290628cc2629060240160206040518083038186803b1580156200319857600080fd5b505afa158015620031ad573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620031d3919062004009565b9050816001600160a01b031663abaa9916846040518263ffffffff1660e01b81526004016000604051808303818588803b1580156200321157600080fd5b505af115801562003226573d6000803e3d6000fd5b50506040516246613160e11b81526001600160a01b0388811660048301526000945086169250628cc262915060240160206040518083038186803b1580156200326e57600080fd5b505afa15801562003283573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620032a9919062004009565b9050620032e6620032bb83836200406b565b6001600160a01b03871660009081526011602090815260408083204384529091529020549062002847565b6001600160a01b0386166000908152601160209081526040808320438452909152902055620033466200331b85600262003893565b6001600160a01b0387166000908152600f602090815260408083204384529091529020549062002847565b6001600160a01b0386166000818152600f6020908152604080832043845282529182902093909355518681529091600080516020620050d2833981519152910160405180910390a2620033a76200339f85600262003893565b889062002847565b9650505050505b505b80620033bc8162003fd5565b91505062002fe0565b50620033d28782620036e5565b9250600083118015620033ed57506001600160a01b03821615155b1562002fd3576000620034028460026200384f565b6001600160a01b0384166000908152600460205260409020549091506200342a908262002847565b6001600160a01b03841660009081526004602090815260408083209390935560108152828220438352905290812080548392906200346a90849062004023565b90915550506001600160a01b038381166000818152600b60205260408082205490516246613160e11b8152600481019390935290921691908290628cc2629060240160206040518083038186803b158015620034c557600080fd5b505afa158015620034da573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019062003500919062004009565b9050816001600160a01b031663abaa9916846040518263ffffffff1660e01b81526004016000604051808303818588803b1580156200353e57600080fd5b505af115801562003553573d6000803e3d6000fd5b50506040516246613160e11b81526001600160a01b0389811660048301526000945086169250628cc262915060240160206040518083038186803b1580156200359b57600080fd5b505afa158015620035b0573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620035d6919062004009565b905062003613620035e883836200406b565b6001600160a01b03881660009081526011602090815260408083204384529091529020549062002847565b6001600160a01b03871660008181526011602090815260408083204380855290835281842095909555928252600f815282822093825292909252812080548992906200366190849062004023565b90915550506040518781526001600160a01b03871690600080516020620050d28339815191529060200160405180910390a25050505050505050505050565b6001600160a01b03811660009081526002602052604081205460ff166003811115620036d057620036d062003e07565b1415620036da5750565b62000e80816200391a565b6000620028aa83836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f77000081525062003a57565b60008060005b60055481101562003849576003600260006005848154811062003756576200375662003ff3565b60009182526020808320909101546001600160a01b0316835282019290925260400190205460ff16600381111562003792576200379262003e07565b14158015620037ce575060058181548110620037b257620037b262003ff3565b6000918252602090912001546001600160a01b03858116911614155b156200383457620038226002600060058481548110620037f257620037f262003ff3565b60009182526020808320909101546001600160a01b03168352820192909252604001902060010154849062002847565b925081620038308162003fd5565b9250505b80620038408162003fd5565b9150506200372f565b50915091565b6000620028aa83836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f00000000000081525062003a8d565b600082620038a4575060006200277e565b6000620038b28385620040ed565b905082620038c185836200410f565b14620028aa5760405162461bcd60e51b815260206004820152602160248201527f536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f6044820152607760f81b6064820152608401620007f0565b60005b600654811080156200393157506006546001105b156200188b57600681815481106200394d576200394d62003ff3565b6000918252602090912001546001600160a01b038381169116141562003a42576006546200397e906001906200406b565b811462003a08576006805462003997906001906200406b565b81548110620039aa57620039aa62003ff3565b600091825260209091200154600680546001600160a01b039092169183908110620039d957620039d962003ff3565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b031602179055505b600680548062003a1c5762003a1c62004085565b600082815260209020810160001990810180546001600160a01b03191690550190555050565b8062003a4e8162003fd5565b9150506200391d565b6000818484111562003a7e5760405162461bcd60e51b8152600401620007f0919062004126565b5060006200283e84866200406b565b6000818362003ab15760405162461bcd60e51b8152600401620007f0919062004126565b5060006200283e84866200410f565b82805482825590600052602060002090810192821562003b18579160200282015b8281111562003b1857825182546001600160a01b0319166001600160a01b0390911617825560209092019160019091019062003ae1565b5062003b2692915062003b38565b5090565b610f53806200417f83390190565b5b8082111562003b26576000815560010162003b39565b80356001600160a01b038116811462000c4e57600080fd5b60006020828403121562003b7a57600080fd5b620028aa8262003b4f565b60008083601f84011262003b9857600080fd5b50813567ffffffffffffffff81111562003bb157600080fd5b6020830191508360208260051b8501011115620014ec57600080fd5b6000806020838503121562003be157600080fd5b823567ffffffffffffffff81111562003bf957600080fd5b62003c078582860162003b85565b90969095509350505050565b600081518084526020808501945080840160005b8381101562003c455781518752958201959082019060010162003c27565b509495945050505050565b60608152600062003c65606083018662003c13565b828103602084015262003c79818662003c13565b9050828103604084015262003c8f818562003c13565b9695505050505050565b60006020828403121562003cac57600080fd5b5035919050565b634e487b7160e01b600052604160045260246000fd5b6000806040838503121562003cdd57600080fd5b823567ffffffffffffffff8082111562003cf657600080fd5b818501915085601f83011262003d0b57600080fd5b813560208282111562003d225762003d2262003cb3565b8160051b604051601f19603f8301168101818110868211171562003d4a5762003d4a62003cb3565b60405292835281830193508481018201928984111562003d6957600080fd5b948201945b8386101562003d925762003d828662003b4f565b8552948201949382019362003d6e565b9997909101359750505050505050565b6000806040838503121562003db657600080fd5b62003dc18362003b4f565b915062003dd16020840162003b4f565b90509250929050565b6000806040838503121562003dee57600080fd5b62003df98362003b4f565b946020939093013593505050565b634e487b7160e01b600052602160045260246000fd5b600081518084526020808501945080840160005b8381101562003c455781516001600160a01b03168752958201959082019060010162003e31565b60006004861062003e6d5762003e6d62003e07565b8582528460208301528360408301526080606083015262003c8f608083018462003e1d565b602081526000620028aa602083018462003e1d565b60008060006040848603121562003ebd57600080fd5b833567ffffffffffffffff81111562003ed557600080fd5b62003ee38682870162003b85565b909790965060209590950135949350505050565b60808152600062003f0c608083018762003c13565b828103602084015262003f20818762003c13565b9050828103604084015262003f36818662003c13565b9050828103606084015262003f4c818562003c13565b979650505050505050565b6020808252600c908201526b139bdd081a5b9a5d081e595d60a21b604082015260600190565b6000806040838503121562003f9157600080fd5b505080516020909101519092909150565b602081016003831062003fb95762003fb962003e07565b91905290565b634e487b7160e01b600052601160045260246000fd5b600060001982141562003fec5762003fec62003fbf565b5060010190565b634e487b7160e01b600052603260045260246000fd5b6000602082840312156200401c57600080fd5b5051919050565b6000821982111562004039576200403962003fbf565b500190565b634e487b7160e01b600052601260045260246000fd5b6000826200406657620040666200403e565b500690565b60008282101562004080576200408062003fbf565b500390565b634e487b7160e01b600052603160045260246000fd5b6020808252825482820181905260008481528281209092916040850190845b81811015620040e15783546001600160a01b031683526001938401939285019201620040ba565b50909695505050505050565b60008160001904831182151516156200410a576200410a62003fbf565b500290565b6000826200412157620041216200403e565b500490565b600060208083528351808285015260005b81811015620041555785810183015185820160400152820162004137565b8181111562004168576000604083870101525b50601f01601f191692909201604001939250505056fe608060405234801561001057600080fd5b50604051610f53380380610f5383398101604081905261002f91610102565b60028054336001600160a01b031991821617909155600580549091166001600160a01b03929092169190911790556040805160608101825243815260006020820181815292820181815260048054600181018255925291517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b60039092029182015591517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19c830155517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19d90910155610132565b60006020828403121561011457600080fd5b81516001600160a01b038116811461012b57600080fd5b9392505050565b610e12806101416000396000f3fe6080604052600436106100c15760003560e01c806370a082311161007f578063c00007b011610059578063c00007b0146101f9578063e673df8a14610219578063f3fef3a314610239578063fa9ada5b1461025957600080fd5b806370a0823114610185578063714b4658146101bb578063abaa9916146101f157600080fd5b80628cc262146100c657806318160ddd146100f9578063264762041461010e5780633a5381b5146101235780633f9e3f041461015b578063446a2ec814610170575b600080fd5b3480156100d257600080fd5b506100e66100e1366004610c52565b61029c565b6040519081526020015b60405180910390f35b34801561010557600080fd5b506000546100e6565b61012161011c366004610c52565b61032d565b005b34801561012f57600080fd5b50600554610143906001600160a01b031681565b6040516001600160a01b0390911681526020016100f0565b34801561016757600080fd5b506100e6610472565b34801561017c57600080fd5b506100e6610488565b34801561019157600080fd5b506100e66101a0366004610c52565b6001600160a01b031660009081526001602052604090205490565b3480156101c757600080fd5b506100e66101d6366004610c52565b6001600160a01b031660009081526003602052604090205490565b61012161049b565b34801561020557600080fd5b50610121610214366004610c52565b61051c565b34801561022557600080fd5b50600254610143906001600160a01b031681565b34801561024557600080fd5b50610121610254366004610c6f565b610681565b34801561026557600080fd5b506100e6610274366004610c9b565b6005546001600160a01b03166000908152600660209081526040808320938352929052205490565b6000806102a76107b5565b60400151905060006102b88461082f565b6040908101516001600160a01b03861660009081526003602052918220600101549092506103249061031e670de0b6b3a76400006103186102f988886108c2565b6001600160a01b038b166000908152600160205260409020549061090d565b9061098c565b906109ce565b95945050505050565b6002546001600160a01b031633146103605760405162461bcd60e51b815260040161035790610cb4565b60405180910390fd5b806001600160a01b038116156103e1576001600160a01b03811660009081526003602090815260409182902082518084019093528054835260010154908201526103a98261029c565b60208201526103b6610472565b81526001600160a01b0382166000908152600360209081526040909120825181559101516001909101555b34806104205760405162461bcd60e51b815260206004820152600e60248201526d043616e6e6f74207374616b6520360941b6044820152606401610357565b61042a8382610a2d565b826001600160a01b03167f9e71bc8eea02a63969f509818f2dafb9254532904319f9dbda79b67bd34a5f3d8260405161046591815260200190565b60405180910390a2505050565b6004546000906104839060016108c2565b905090565b60006104926107b5565b60400151905090565b6002546001600160a01b031633146104c55760405162461bcd60e51b815260040161035790610cb4565b34806104ce5750565b6104d781610a7f565b6005546040518281526001600160a01b03909116907f7d8f3d9291db7e540ea10a43e300f1330c3e9148157349babe42ac2601a2a3e99060200160405180910390a250565b6002546001600160a01b031633146105465760405162461bcd60e51b815260040161035790610cb4565b806001600160a01b038116156105c7576001600160a01b038116600090815260036020908152604091829020825180840190935280548352600101549082015261058f8261029c565b602082015261059c610472565b81526001600160a01b0382166000908152600360209081526040909120825181559101516001909101555b6001600160a01b038216600090815260036020526040902060010154801561067c576001600160a01b0383166000818152600360205260408082206001018290555183156108fc0291849190818181858888f19350505050158015610630573d6000803e3d6000fd5b50600554604080518381524260208201526001600160a01b03928316928616917f51a69b4502f660774c9339825c7b5adbf0b8622289134647e29728ec5d9b3bb9910160405180910390a35b505050565b6002546001600160a01b031633146106ab5760405162461bcd60e51b815260040161035790610cb4565b816001600160a01b0381161561072c576001600160a01b03811660009081526003602090815260409182902082518084019093528054835260010154908201526106f48261029c565b6020820152610701610472565b81526001600160a01b0382166000908152600360209081526040909120825181559101516001909101555b600082116107705760405162461bcd60e51b8152602060048201526011602482015270043616e6e6f74207769746864726177203607c1b6044820152606401610357565b61077a8383610b62565b826001600160a01b03167f7084f5476618d8e60b11ef0d7d3f06914655adb8793e28ff7f018d4c76d505d58360405161046591815260200190565b6107d960405180606001604052806000815260200160008152602001600081525090565b60046107e3610472565b815481106107f3576107f3610ceb565b90600052602060002090600302016040518060600160405290816000820154815260200160018201548152602001600282015481525050905090565b61085360405180606001604052806000815260200160008152602001600081525090565b6004610874836001600160a01b031660009081526003602052604090205490565b8154811061088457610884610ceb565b906000526020600020906003020160405180606001604052908160008201548152602001600182015481526020016002820154815250509050919050565b600061090483836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f770000815250610bdb565b90505b92915050565b60008261091c57506000610907565b60006109288385610d17565b9050826109358583610d36565b146109045760405162461bcd60e51b815260206004820152602160248201527f536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f6044820152607760f81b6064820152608401610357565b600061090483836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f000000000000815250610c0c565b6000806109db8385610d58565b9050838110156109045760405162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f7700000000006044820152606401610357565b600054610a3a90826109ce565b60009081556001600160a01b038316815260016020526040902054610a5f90826109ce565b6001600160a01b0390921660009081526001602052604090209190915550565b6000610a896107b5565b6040015190506000610ab9610ab2610aa060005490565b61031886670de0b6b3a764000061090d565b83906109ce565b60408051606081018252438152602081019586529081019182526004805460018101825560009190915290517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b60039092029182015593517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19c850155517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19d909301929092555050565b600054610b6f90826108c2565b60009081556001600160a01b038316815260016020526040902054610b9490826108c2565b6001600160a01b038316600081815260016020526040808220939093559151909183156108fc02918491818181858888f1935050505015801561067c573d6000803e3d6000fd5b60008184841115610bff5760405162461bcd60e51b81526004016103579190610d70565b5060006103248486610dc5565b60008183610c2d5760405162461bcd60e51b81526004016103579190610d70565b5060006103248486610d36565b6001600160a01b0381168114610c4f57600080fd5b50565b600060208284031215610c6457600080fd5b813561090481610c3a565b60008060408385031215610c8257600080fd5b8235610c8d81610c3a565b946020939093013593505050565b600060208284031215610cad57600080fd5b5035919050565b6020808252601a908201527f43616c6c6572206973206e6f7420746865206f70657261746f72000000000000604082015260600190565b634e487b7160e01b600052603260045260246000fd5b634e487b7160e01b600052601160045260246000fd5b6000816000190483118215151615610d3157610d31610d01565b500290565b600082610d5357634e487b7160e01b600052601260045260246000fd5b500490565b60008219821115610d6b57610d6b610d01565b500190565b600060208083528351808285015260005b81811015610d9d57858101830151858201604001528201610d81565b81811115610daf576000604083870101525b50601f01601f1916929092016040019392505050565b600082821015610dd757610dd7610d01565b50039056fea264697066735822122087d510370fde5b1538b269ea2935c7508a993ddfbcdffda60c0cedb77f4ceb8164736f6c634300080800337d8f3d9291db7e540ea10a43e300f1330c3e9148157349babe42ac2601a2a3e9a2646970667358221220e228627c15c5bc3615aefb8f7221de17c6dd07c97f05848542c146170544050664736f6c63430008080033"
)

type hardForkValidatorsV3 struct {
}

func (s *hardForkValidatorsV3) GetName() string {
	return ValidatorsV2ContractName
}

func (s *hardForkValidatorsV3) Update(config *params.ChainConfig, height *big.Int, state *state.StateDB) (err error) {
	contractCode := common.FromHex(validatorV3Code)

	//write code to sys contract
	state.SetCode(ValidatorsV2ContractAddr, contractCode)
	log.Debug("Write code to system contract account", "addr", ValidatorsV2ContractAddr.String(), "code", validatorV3Code)

	return
}

func (s *hardForkValidatorsV3) Execute(state *state.StateDB, header *types.Header, chainContext core.ChainContext, config *params.ChainConfig) (err error) {
	//First, get top validators from the old contract
	v0 := NewValidatorV0()
	topVals, err := v0.GetTopValidators(state, header, chainContext, config)
	if err != nil {
		log.Error("getTopValidators from V0 failed", "err", err)
		return err
	}

	// initialize v1 contract
	method := "initialize"
	data, err := GetInteractiveABI()[ValidatorsV2ContractName].Pack(method, topVals)
	if err != nil {
		log.Error("Can't pack data for initialize", "error", err)
		return err
	}

	msg := vmcaller.NewLegacyMessage(header.Coinbase, &ValidatorsV2ContractAddr, 0, new(big.Int), math.MaxUint64, new(big.Int), data, false)
	_, err = vmcaller.ExecuteMsg(msg, state, header, chainContext, config)

	return
}
