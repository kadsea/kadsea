package systemcontract

import (
	"math"
	"math/big"

	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/consensus/congress/vmcaller"
	"github.com/ethereum/go-ethereum/core"
	"github.com/ethereum/go-ethereum/core/state"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/log"
	"github.com/ethereum/go-ethereum/params"
)

const (
	validatorV3Code = "0x6080604052600436106200022e5760003560e01c80638a11d7c9116200012f578063be64569211620000ad578063c4e2f07a1162000078578063c4e2f07a14620006fa578063c967f90f146200071f578063d6eb3de1146200074a578063e7c9d4b51462000762578063e8363f6c146200078757600080fd5b8063be6456921462000685578063c1d7dd7814620006a5578063c253c38414620006bd578063c2a672e014620006d557600080fd5b80639de7025811620000fa5780639de7025814620005b3578063a097724214620005cb578063a224cee71462000601578063a22b0f6e1462000626578063bbe4f6db146200064b57600080fd5b80638a11d7c9146200050b5780638b0e9f3f146200054257806393a5b1b6146200055a57806398e3b626146200058e57600080fd5b806340550a1c11620001bd57806363fc5e71116200018857806363fc5e7114620004065780636969a25c14620004405780637ad229da14620004655780637f4f95fa14620004ab57806380d2dde114620004e657600080fd5b806340550a1c146200037f57806340a141ff14620003a457806348cd4cb114620003c95780634b3d500b14620003e157600080fd5b806330fcb67c11620001fe57806330fcb67c14620002d15780633438174914620002ea57806338b67b8b14620003335780633a061bd3146200036757600080fd5b8062362a771462000233578063158ef93e146200026d5780631b5e358c14620002895780632647620414620002ba575b600080fd5b3480156200024057600080fd5b50620002586200025236600462003b31565b620007b8565b60405190151581526020015b60405180910390f35b3480156200027a57600080fd5b50600054620002589060ff1681565b3480156200029657600080fd5b50620002a161f20081565b6040516001600160a01b03909116815260200162000264565b62000258620002cb36600462003b31565b620008e3565b620002e8620002e236600462003b31565b62000d6c565b005b348015620002f757600080fd5b50620003246200030936600462003b31565b6001600160a01b031660009081526013602052604090205490565b60405190815260200162000264565b3480156200034057600080fd5b50620003586200035236600462003b97565b62000f9c565b60405162000264919062003c1a565b3480156200037457600080fd5b50620002a161f10081565b3480156200038c57600080fd5b50620002586200039e36600462003b31565b6200112e565b348015620003b157600080fd5b50620002e8620003c336600462003b31565b620011a0565b348015620003d657600080fd5b506200032460015481565b348015620003ee57600080fd5b50620002a16200040036600462003c2f565b62001201565b3480156200041357600080fd5b50620003246200042536600462003b31565b6001600160a01b03166000908152600f602052604090205490565b3480156200044d57600080fd5b50620002a16200045f36600462003c2f565b6200122c565b3480156200047257600080fd5b50620003246200048436600462003c49565b6001600160a01b039091166000908152601060209081526040808320938352929052205490565b348015620004b857600080fd5b50620004d0620004ca36600462003c76565b6200123d565b6040805192835260208301919091520162000264565b348015620004f357600080fd5b50620002e86200050536600462003c49565b62001272565b3480156200051857600080fd5b50620005306200052a36600462003b31565b6200160e565b60405162000264949392919062003cff565b3480156200054f57600080fd5b506200032460085481565b3480156200056757600080fd5b506200057f6200057936600462003c2f565b6200170a565b60405162000264919062003d43565b3480156200059b57600080fd5b5062000258620005ad36600462003b31565b6200186e565b348015620005c057600080fd5b506200057f620018d7565b348015620005d857600080fd5b50620005f0620005ea36600462003d58565b6200193b565b604051620002649392919062003da8565b3480156200060e57600080fd5b50620002e86200062036600462003b97565b62001b4c565b3480156200063357600080fd5b50620002a16200064536600462003c2f565b6200211b565b3480156200065857600080fd5b50620002a16200066a36600462003b31565b600c602052600090815260409020546001600160a01b031681565b3480156200069257600080fd5b506200032469021e19e0c9bab240000081565b348015620006b257600080fd5b506200032460095481565b348015620006ca57600080fd5b50620004d06200212c565b348015620006e257600080fd5b5062000258620006f436600462003c49565b62002143565b3480156200070757600080fd5b50620003246200071936600462003c76565b62002564565b3480156200072c57600080fd5b5062000736601581565b60405161ffff909116815260200162000264565b3480156200075757600080fd5b50620002a161f30081565b3480156200076f57600080fd5b50620002e86200078136600462003dfd565b62002627565b3480156200079457600080fd5b5062000324620007a636600462003b31565b60046020526000908152604090205481565b336000818152600460205260408120805490829055909190801562000858576040516001600160a01b0383169082156108fc029083906000818181858888f193505050501580156200080e573d6000803e3d6000fd5b50604080518281524260208201526001600160a01b0380871692908516917f51a69b4502f660774c9339825c7b5adbf0b8622289134647e29728ec5d9b3bb9910160405180910390a35b6001600160a01b038085166000908152600c6020526040902054168015620008d857604051630c00007b60e41b81526001600160a01b03848116600483015282169063c00007b090602401600060405180830381600087803b158015620008be57600080fd5b505af1158015620008d3573d6000803e3d6000fd5b505050505b506001949350505050565b6000805460ff16620009125760405162461bcd60e51b8152600401620009099062003ee0565b60405180910390fd5b336000818152600d60205260409020543490620009309082620028b5565b6001600160a01b038084166000908152600d602052604080822093909355600b5483516325dff9d160e01b815284519294859492909216926325dff9d192600480840193919291829003018186803b1580156200098c57600080fd5b505afa158015620009a1573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620009c7919062003f06565b915091508143101562000a0a5760405162461bcd60e51b815260206004820152600a6024820152697374617274426c6f636b60b01b604482015260640162000909565b8043111562000a475760405162461bcd60e51b8152602060048201526008602482015267656e64426c6f636b60c01b604482015260640162000909565b6001600160a01b03808716600081815260026020526040902091861614801562000aa1575060016001600160a01b03881660009081526002602052604090205460ff16600381111562000a9e5762000a9e62003cae565b14155b1562000b1457600181015469021e19e0c9bab24000009062000ac49086620028b5565b101562000b145760405162461bcd60e51b815260206004820152601860248201527f5374616b696e6720636f696e73206e6f7420656e6f7567680000000000000000604482015260640162000909565b6001600160a01b038086166000908152600360209081526040808320938b168352929052205462000b9357600380820180546001600160a01b03808916600081815260209586526040808220938e1682529286529182206001908101849055830184559281529290922090910180546001600160a01b03191690911790555b600181015462000be257866001600160a01b03167fbc822c457926e0706c445f2b613394c8a2bf34b3b4335915e3865b90829ce38b600160405162000bd9919062003f2b565b60405180910390a25b600181015462000bf39085620028b5565b600180830191909155815460ff16600381111562000c155762000c1562003cae565b1462000c2757805460ff191660011781555b62000c378782600101546200291f565b6001600160a01b038086166000908152600360209081526040808320938b168352929052205462000c699085620028b5565b6001600160a01b038087166000908152600360209081526040808320938c168352929052205560085462000c9e9085620028b5565b6008556001600160a01b038781166000908152600c602052604090819020549051630991d88160e21b81528783166004820152911690819063264762049087906024016000604051808303818588803b15801562000cfb57600080fd5b505af115801562000d10573d6000803e3d6000fd5b5050604080518981524260208201526001600160a01b03808e1695508b1693507fb9ba725934532316cffe10975da6eb25ad49c2d1c294d982c46c9f8d684ee07592500160405180910390a3600196505050505050505b919050565b33411462000daa5760405162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b604482015260640162000909565b436000908152600e6020908152604080832083805290915290205460ff161562000e175760405162461bcd60e51b815260206004820152601960248201527f426c6f636b20697320616c726561647920726577617264656400000000000000604482015260640162000909565b60005460ff1662000e3c5760405162461bcd60e51b8152600401620009099062003ee0565b436000818152600e602090815260408083208380529091529020805460ff191660019081179091555433913491101562000efd576001600160a01b0382166000908152600f6020526040812080549162000e968362003f5e565b9091555050600a54604051631e88772760e01b81526001600160a01b03848116600483015290911690631e88772790602401600060405180830381600087803b15801562000ee357600080fd5b505af115801562000ef8573d6000803e3d6000fd5b505050505b6000811162000f0b57505050565b6001600160a01b03821660009081526002602052604081205460ff16600381111562000f3b5762000f3b62003cae565b141562000f4757505050565b62000f53818462002d34565b604080518281524260208201526001600160a01b038416917f7dc4e5df59513708dca355b8706273a5df7b810a4cec8019f2a4b9bb166a1a04910160405180910390a250505b50565b6060818067ffffffffffffffff81111562000fbb5762000fbb62003de7565b60405190808252806020026020018201604052801562000fe5578160200160208202803683370190505b50915060005b81811015620011265760008585838181106200100b576200100b62003f7c565b905060200201602081019062001022919062003b31565b6001600160a01b038082166000908152600c60205260408120549293509116908115620010c7576040516246613160e11b81526001600160a01b038481166004830152831690628cc2629060240160206040518083038186803b1580156200108957600080fd5b505afa1580156200109e573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620010c4919062003f92565b90505b6001600160a01b038316600090815260046020526040902054620010ec908262003fac565b86858151811062001101576200110162003f7c565b60200260200101818152505050505080806200111d9062003f5e565b91505062000feb565b505092915050565b6000805b6005548110156200119757826001600160a01b0316600582815481106200115d576200115d62003f7c565b6000918252602090912001546001600160a01b03161415620011825750600192915050565b806200118e8162003f5e565b91505062001132565b50600092915050565b3361f20014620011ea5760405162461bcd60e51b815260206004820152601460248201527350756e69736820636f6e7472616374206f6e6c7960601b604482015260640162000909565b6006546001101562000f995762000f998162003627565b600681815481106200121257600080fd5b6000918252602090912001546001600160a01b0316905081565b600581815481106200121257600080fd5b6001600160a01b03828116600090815260036020908152604080832093851683529290522080546001909101545b9250929050565b3361f20014620012bc5760405162461bcd60e51b815260206004820152601460248201527350756e69736820636f6e7472616374206f6e6c7960601b604482015260640162000909565b8160006001600160a01b03841660009081526002602052604090205460ff166003811115620012ef57620012ef62003cae565b1415620013355760405162461bcd60e51b815260206004820152601360248201527215985b1a59185d1bdc881b9bdd08195e1a5cdd606a1b604482015260640162000909565b6001600160a01b0380821660009081526003602090815260408083209387168352928152828220600290915291902081548085111562001373578094505b846200138157505050505050565b84811415620014d65760038201546200139d9060019062003fc7565b8360010154146200149557600382018054620013bc9060019062003fc7565b81548110620013cf57620013cf62003f7c565b9060005260206000200160009054906101000a90046001600160a01b03168260030184600101548154811062001409576200140962003f7c565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b03160217905550826001015460036000846003018660010154815481106200145c576200145c62003f7c565b60009182526020808320909101546001600160a01b0390811684528382019490945260409283018220938b168252929092529020600101555b81600301805480620014ab57620014ab62003fe1565b600082815260208120820160001990810180546001600160a01b031916905590910190915560018401555b8254620014e490866200366c565b83556001820154620014f790866200366c565b60018301556008546200150b90866200366c565b6008556001600160a01b0384166000908152600d60205260409020546200153390866200366c565b6001600160a01b038581166000818152600d60209081526040808320959095558a84168252600c905283902054925163f3fef3a360e01b8152600481019190915260248101889052911690819063f3fef3a390604401600060405180830381600087803b158015620015a457600080fd5b505af1158015620015b9573d6000803e3d6000fd5b5050604080518981524260208201526001600160a01b03808c169450891692507f449002ae18e748d69a55f38514400d64f966492e593e32d6e9b8b24db98a0bc1910160405180910390a350505050505b5050565b6001600160a01b03811660009081526002602052604080822081516080810190925280548392839260609284929190829060ff16600381111562001656576200165662003cae565b60038111156200166a576200166a62003cae565b8152602001600182015481526020016002820154815260200160038201805480602002602001604051908101604052809291908181526020018280548015620016dd57602002820191906000526020600020905b81546001600160a01b03168152600190910190602001808311620016be575b505050919092525050815160208301516040840151606090940151919a9099509297509550909350505050565b600b54604080516325dff9d160e01b815281516060936000936001600160a01b03909116926325dff9d19260048083019392829003018186803b1580156200175157600080fd5b505afa15801562001766573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906200178c919062003f06565b915050600081118015620017a05750808310155b156200180b576006805480602002602001604051908101604052809291908181526020018280548015620017fe57602002820191906000526020600020905b81546001600160a01b03168152600190910190602001808311620017df575b5050505050915050919050565b6007805480602002602001604051908101604052809291908181526020018280548015620017fe576020028201919060005260206000209081546001600160a01b03168152600190910190602001808311620017df575050505050915050919050565b6000805b6006548110156200119757826001600160a01b0316600682815481106200189d576200189d62003f7c565b6000918252602090912001546001600160a01b03161415620018c25750600192915050565b80620018ce8162003f5e565b91505062001872565b606060058054806020026020016040519081016040528092919081815260200182805480156200193157602002820191906000526020600020905b81546001600160a01b0316815260019091019060200180831162001912575b5050505050905090565b60608080848067ffffffffffffffff8111156200195c576200195c62003de7565b60405190808252806020026020018201604052801562001986578160200160208202803683370190505b5093508067ffffffffffffffff811115620019a557620019a562003de7565b604051908082528060200260200182016040528015620019cf578160200160208202803683370190505b5092508067ffffffffffffffff811115620019ee57620019ee62003de7565b60405190808252806020026020018201604052801562001a18578160200160208202803683370190505b50915060005b8181101562001b4157600088888381811062001a3e5762001a3e62003f7c565b905060200201602081019062001a55919062003b31565b6001600160a01b03811660009081526010602090815260408083208b845290915290205487519192509087908490811062001a945762001a9462003f7c565b6020908102919091018101919091526001600160a01b03821660009081526011825260408082208a83529092522054855186908490811062001ada5762001ada62003f7c565b6020908102919091018101919091526001600160a01b03821660009081526012825260408082208a83529092522054845185908490811062001b205762001b2062003f7c565b6020908102919091010152508062001b388162003f5e565b91505062001a1e565b505093509350939050565b60005460ff161562001b975760405162461bcd60e51b8152602060048201526013602482015272105b1c9958591e481a5b9a5d1a585b1a5e9959606a1b604482015260640162000909565b600a80546001600160a01b031990811661f20017909155600b805490911661f30017905560005b81811015620020cf57600083838381811062001bde5762001bde62003f7c565b905060200201602081019062001bf5919062003b31565b6001600160a01b0316141562001c4e5760405162461bcd60e51b815260206004820152601960248201527f496e76616c69642076616c696461746f72206164647265737300000000000000604482015260640162000909565b62001c7e83838381811062001c675762001c6762003f7c565b90506020020160208101906200039e919062003b31565b62001ce457600583838381811062001c9a5762001c9a62003f7c565b905060200201602081019062001cb1919062003b31565b81546001810183556000928352602090922090910180546001600160a01b0319166001600160a01b039092169190911790555b62001d1483838381811062001cfd5762001cfd62003f7c565b9050602002016020810190620005ad919062003b31565b62001dda57600683838381811062001d305762001d3062003f7c565b905060200201602081019062001d47919062003b31565b81546001810183556000928352602090922090910180546001600160a01b0319166001600160a01b03909216919091179055600783838381811062001d905762001d9062003f7c565b905060200201602081019062001da7919062003b31565b81546001810183556000928352602090922090910180546001600160a01b0319166001600160a01b039092169190911790555b60006002600085858581811062001df55762001df562003f7c565b905060200201602081019062001e0c919062003b31565b6001600160a01b0316815260208101919091526040016000205460ff16600381111562001e3d5762001e3d62003cae565b141562001eb25760016002600085858581811062001e5f5762001e5f62003f7c565b905060200201602081019062001e76919062003b31565b6001600160a01b031681526020810191909152604001600020805460ff1916600183600381111562001eac5762001eac62003cae565b02179055505b6000600c8185858581811062001ecc5762001ecc62003f7c565b905060200201602081019062001ee3919062003b31565b6001600160a01b039081168252602082019290925260400160002054161415620020ba57600083838381811062001f1e5762001f1e62003f7c565b905060200201602081019062001f35919062003b31565b60405160200162001f59919060609190911b6001600160601b031916815260140190565b60405160208183030381529060405280519060200120905060008185858581811062001f895762001f8962003f7c565b905060200201602081019062001fa0919062003b31565b60405162001fae9062003a47565b6001600160a01b0390911681526020018190604051809103906000f590508015801562001fdf573d6000803e3d6000fd5b50905080600c600087878781811062001ffc5762001ffc62003f7c565b905060200201602081019062002013919062003b31565b6001600160a01b039081168252602082019290925260400160002080546001600160a01b0319169290911691909117905584848481811062002059576200205962003f7c565b905060200201602081019062002070919062003b31565b604080516001600160a01b03848116825242602083015292909216917f5e5b474625449a92e2b1a6f9f183435f09402d6897ae7f8779c72142ed11170b910160405180910390a250505b80620020c68162003f5e565b91505062001bbe565b507feacea8f3c22f06c0b18306bdb04d0a967255129e8ce0094debb0a0ff89d006b5600560405162002102919062003ff7565b60405180910390a150506000805460ff19166001179055565b600781815481106200121257600080fd5b6000806200213b6000620036b0565b915091509091565b6000805460ff16620021695760405162461bcd60e51b8152600401620009099062003ee0565b3360006001600160a01b03851660009081526002602052604090205460ff1660038111156200219c576200219c62003cae565b1415620021e25760405162461bcd60e51b815260206004820152601360248201527215985b1a59185d1bdc881b9bdd08195e1a5cdd606a1b604482015260640162000909565b6001600160a01b03808216600090815260036020908152604080832093881683529281528282206002909152919020815480861115620022655760405162461bcd60e51b815260206004820152601860248201527f596f7520646f6e2774206861766520616e79207374616b650000000000000000604482015260640162000909565b85811415620023ba576003820154620022819060019062003fc7565b8360010154146200237957600382018054620022a09060019062003fc7565b81548110620022b357620022b362003f7c565b9060005260206000200160009054906101000a90046001600160a01b031682600301846001015481548110620022ed57620022ed62003f7c565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b031602179055508260010154600360008460030186600101548154811062002340576200234062003f7c565b60009182526020808320909101546001600160a01b0390811684528382019490945260409283018220938c168252929092529020600101555b816003018054806200238f576200238f62003fe1565b600082815260208120820160001990810180546001600160a01b031916905590910190915560018401555b8254620023c890876200366c565b83556001820154620023db90876200366c565b6001830155600854620023ef90876200366c565b6008556001600160a01b0384166000908152600d60205260409020546200241790876200366c565b6001600160a01b038086166000818152600d602052604090209290925588161415620024945762002448876200186e565b156200249457825469021e19e0c9bab24000001115620024945760405162461bcd60e51b815260040162000909906020808252600490820152630333030360e41b604082015260600190565b6001600160a01b038781166000908152600c60205260409081902054905163f3fef3a360e01b8152868316600482015260248101899052911690819063f3fef3a390604401600060405180830381600087803b158015620024f457600080fd5b505af115801562002509573d6000803e3d6000fd5b5050604080518a81524260208201526001600160a01b03808d169450891692507f449002ae18e748d69a55f38514400d64f966492e593e32d6e9b8b24db98a0bc1910160405180910390a36001955050505050505b92915050565b6001600160a01b038181166000908152600c60205260408082205490516246613160e11b815285841660048201529192169082908290628cc2629060240160206040518083038186803b158015620025bb57600080fd5b505afa158015620025d0573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620025f6919062003f92565b6001600160a01b0386166000908152600460205260409020549091506200261e9082620028b5565b95945050505050565b334114620026655760405162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b604482015260640162000909565b436000908152600e602090815260408083206001845290915290205460ff1615620026d35760405162461bcd60e51b815260206004820152601a60248201527f56616c696461746f727320616c72656164792075706461746564000000000000604482015260640162000909565b60005460ff16620026f85760405162461bcd60e51b8152600401620009099062003ee0565b816200270581436200405f565b15620027475760405162461bcd60e51b815260206004820152601060248201526f426c6f636b2065706f6368206f6e6c7960801b604482015260640162000909565b6000828152600e6020908152604080832060018085529252909120805460ff191690911790558351620027b45760405162461bcd60e51b815260206004820152601460248201527356616c696461746f722073657420656d7074792160601b604482015260640162000909565b600b54604080516325dff9d160e01b815281516000936001600160a01b0316926325dff9d19260048082019391829003018186803b158015620027f657600080fd5b505afa1580156200280b573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019062002831919062003f06565b915050600081118015620028455750808310155b15620028ae57600580546200285d9160079162003a55565b5084516200287390600590602088019062003aaa565b507feacea8f3c22f06c0b18306bdb04d0a967255129e8ce0094debb0a0ff89d006b585604051620028a5919062003d43565b60405180910390a15b5050505050565b600080620028c4838562003fac565b905083811015620029185760405162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f770000000000604482015260640162000909565b9392505050565b60005b6006548110156200298357826001600160a01b0316600682815481106200294d576200294d62003f7c565b6000918252602090912001546001600160a01b031614156200296e57505050565b806200297a8162003f5e565b91505062002922565b506006546015111562002ad85760068054600181019091557ff652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d3f0180546001600160a01b0319166001600160a01b038481169182179092556000908152600c6020526040902054166200160a576040516001600160601b0319606084901b1660208201526000906034016040516020818303038152906040528051906020012090506000818460405162002a369062003a47565b6001600160a01b0390911681526020018190604051809103906000f590508015801562002a67573d6000803e3d6000fd5b506001600160a01b038581166000818152600c602090815260409182902080546001600160a01b031916948616948517905581519384524290840152929350917f5e5b474625449a92e2b1a6f9f183435f09402d6897ae7f8779c72142ed11170b910160405180910390a250505050565b600060026000600660008154811062002af55762002af562003f7c565b60009182526020808320909101546001600160a01b03168352820192909252604001812060019081015492505b60065481101562002bd45782600260006006848154811062002b485762002b4862003f7c565b60009182526020808320909101546001600160a01b03168352820192909252604001902060010154101562002bbf57600260006006838154811062002b915762002b9162003f7c565b60009182526020808320909101546001600160a01b0316835282019290925260400190206001015492509050805b8062002bcb8162003f5e565b91505062002b22565b5081831162002be35750505050565b6001600160a01b038481166000908152600c60205260409020541662002ce9576040516001600160601b0319606086901b1660208201526000906034016040516020818303038152906040528051906020012090506000818660405162002c4a9062003a47565b6001600160a01b0390911681526020018190604051809103906000f590508015801562002c7b573d6000803e3d6000fd5b506001600160a01b038781166000818152600c602090815260409182902080546001600160a01b031916948616948517905581519384524290840152929350917f5e5b474625449a92e2b1a6f9f183435f09402d6897ae7f8779c72142ed11170b910160405180910390a250505b836006828154811062002d005762002d0062003f7c565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b0316021790555050505050565b8162002d3e575050565b60008062002d4c83620036b0565b90925090508062002d5d5750505050565b60008083620030d957600062002d748785620037d6565b905062002d8e62002d8682866200381a565b88906200366c565b925060005b60055481101562002f735760006005828154811062002db65762002db662003f7c565b6000918252602090912001546001600160a01b0316905060036001600160a01b03821660009081526002602052604090205460ff16600381111562002dff5762002dff62003cae565b1415801562002e205750876001600160a01b0316816001600160a01b031614155b1562002f5d576001600160a01b03811660009081526004602052604090205462002e4b9084620028b5565b6001600160a01b03821660009081526004602090815260408083209390935560139052205462002e7c9084620028b5565b6001600160a01b0382166000908152601360209081526040808320939093556010815282822043835290522054909350839062002eba9084620028b5565b6001600160a01b03821660008181526010602090815260408083204380855290835281842095909555928252601181528282209382529290925290205462002f039084620028b5565b6001600160a01b0382166000818152601160209081526040808320438452825291829020939093555185815290917f7d8f3d9291db7e540ea10a43e300f1330c3e9148157349babe42ac2601a2a3e9910160405180910390a25b508062002f6a8162003f5e565b91505062002d93565b5060008311801562002f8d57506001600160a01b03821615155b15620030d0576001600160a01b03821660009081526004602052604090205462002fb89084620028b5565b6001600160a01b038316600090815260046020908152604080832093909355601081528282204383529052205462002ff19084620028b5565b6001600160a01b0383166000818152601060209081526040808320438085529083528184209590955592825260118152828220938252929092529020546200303a9084620028b5565b6001600160a01b038316600081815260116020908152604080832043845282528083209490945591815260139091522054620030779084620028b5565b6001600160a01b038316600081815260136020526040908190209290925590517f7d8f3d9291db7e540ea10a43e300f1330c3e9148157349babe42ac2601a2a3e990620030c79086815260200190565b60405180910390a25b50505050505050565b6000805b600554811015620035235760006005828154811062003100576200310062003f7c565b6000918252602090912001546001600160a01b0316905060036001600160a01b03821660009081526002602052604090205460ff16600381111562003149576200314962003cae565b141580156200316a5750876001600160a01b0316816001600160a01b031614155b156200350c576000620031b3620031838960026200381a565b6001600160a01b038416600090815260026020526040902060010154620031ac908d906200381a565b90620037d6565b905080620031c35750506200350e565b6001600160a01b0382166000908152600460205260409020549194508491620031ed9082620028b5565b6001600160a01b0383166000908152600460209081526040808320939093556011815282822043835290522054620032269082620028b5565b6001600160a01b038381166000818152601160209081526040808320438452825280832095909555828252600c90528381205493516246613160e11b815260048101929092529290911691908290628cc2629060240160206040518083038186803b1580156200329557600080fd5b505afa158015620032aa573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620032d0919062003f92565b9050816001600160a01b031663abaa9916846040518263ffffffff1660e01b81526004016000604051808303818588803b1580156200330e57600080fd5b505af115801562003323573d6000803e3d6000fd5b50506040516246613160e11b81526001600160a01b0388811660048301526000945086169250628cc262915060240160206040518083038186803b1580156200336b57600080fd5b505afa15801562003380573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620033a6919062003f92565b9050620033e3620033b8838362003fc7565b6001600160a01b038716600090815260126020908152604080832043845290915290205490620028b5565b6001600160a01b038616600090815260126020908152604080832043845290915290205562003443620034188560026200381a565b6001600160a01b038716600090815260106020908152604080832043845290915290205490620028b5565b6001600160a01b038616600090815260106020908152604080832043845290915290205562003498620034788560026200381a565b6001600160a01b038a1660009081526013602052604090205490620028b5565b6001600160a01b03808a166000908152601360209081526040918290209390935551868152908716917f7d8f3d9291db7e540ea10a43e300f1330c3e9148157349babe42ac2601a2a3e9910160405180910390a262003505620034fd8560026200381a565b8890620028b5565b9650505050505b505b806200351a8162003f5e565b915050620030dd565b506200353087826200366c565b92506000831180156200354b57506001600160a01b03821615155b15620030d0576001600160a01b038216600090815260046020526040902054620035769084620028b5565b6001600160a01b0383166000908152600460209081526040808320939093556011815282822043835290522054620035af9084620028b5565b6001600160a01b03831660008181526011602090815260408083204380855290835281842095909555928252601081528282209382529290925281208054859290620035fd90849062003fac565b90915550506001600160a01b038216600090815260136020526040902054620030779084620028b5565b6001600160a01b03811660009081526002602052604081205460ff16600381111562003657576200365762003cae565b1415620036615750565b62000f9981620038a1565b60006200291883836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f770000815250620039de565b60008060005b600554811015620037d05760036002600060058481548110620036dd57620036dd62003f7c565b60009182526020808320909101546001600160a01b0316835282019290925260400190205460ff16600381111562003719576200371962003cae565b141580156200375557506005818154811062003739576200373962003f7c565b6000918252602090912001546001600160a01b03858116911614155b15620037bb57620037a9600260006005848154811062003779576200377962003f7c565b60009182526020808320909101546001600160a01b031683528201929092526040019020600101548490620028b5565b925081620037b78162003f5e565b9250505b80620037c78162003f5e565b915050620036b6565b50915091565b60006200291883836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f00000000000081525062003a14565b6000826200382b575060006200255e565b600062003839838562004076565b90508262003848858362004098565b14620029185760405162461bcd60e51b815260206004820152602160248201527f536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f6044820152607760f81b606482015260840162000909565b60005b60065481108015620038b857506006546001105b156200160a5760068181548110620038d457620038d462003f7c565b6000918252602090912001546001600160a01b0383811691161415620039c957600654620039059060019062003fc7565b81146200398f57600680546200391e9060019062003fc7565b8154811062003931576200393162003f7c565b600091825260209091200154600680546001600160a01b03909216918390811062003960576200396062003f7c565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b031602179055505b6006805480620039a357620039a362003fe1565b600082815260209020810160001990810180546001600160a01b03191690550190555050565b80620039d58162003f5e565b915050620038a4565b6000818484111562003a055760405162461bcd60e51b8152600401620009099190620040af565b5060006200261e848662003fc7565b6000818362003a385760405162461bcd60e51b8152600401620009099190620040af565b5060006200261e848662004098565b610edc806200410883390190565b82805482825590600052602060002090810192821562003a985760005260206000209182015b8281111562003a9857825482559160010191906001019062003a7b565b5062003aa692915062003b02565b5090565b82805482825590600052602060002090810192821562003a98579160200282015b8281111562003a9857825182546001600160a01b0319166001600160a01b0390911617825560209092019160019091019062003acb565b5b8082111562003aa6576000815560010162003b03565b80356001600160a01b038116811462000d6757600080fd5b60006020828403121562003b4457600080fd5b620029188262003b19565b60008083601f84011262003b6257600080fd5b50813567ffffffffffffffff81111562003b7b57600080fd5b6020830191508360208260051b85010111156200126b57600080fd5b6000806020838503121562003bab57600080fd5b823567ffffffffffffffff81111562003bc357600080fd5b62003bd18582860162003b4f565b90969095509350505050565b600081518084526020808501945080840160005b8381101562003c0f5781518752958201959082019060010162003bf1565b509495945050505050565b60208152600062002918602083018462003bdd565b60006020828403121562003c4257600080fd5b5035919050565b6000806040838503121562003c5d57600080fd5b62003c688362003b19565b946020939093013593505050565b6000806040838503121562003c8a57600080fd5b62003c958362003b19565b915062003ca56020840162003b19565b90509250929050565b634e487b7160e01b600052602160045260246000fd5b600081518084526020808501945080840160005b8381101562003c0f5781516001600160a01b03168752958201959082019060010162003cd8565b60006004861062003d145762003d1462003cae565b8582528460208301528360408301526080606083015262003d39608083018462003cc4565b9695505050505050565b60208152600062002918602083018462003cc4565b60008060006040848603121562003d6e57600080fd5b833567ffffffffffffffff81111562003d8657600080fd5b62003d948682870162003b4f565b909790965060209590950135949350505050565b60608152600062003dbd606083018662003bdd565b828103602084015262003dd1818662003bdd565b9050828103604084015262003d39818562003bdd565b634e487b7160e01b600052604160045260246000fd5b60008060006060848603121562003e1357600080fd5b833567ffffffffffffffff8082111562003e2c57600080fd5b818601915086601f83011262003e4157600080fd5b813560208282111562003e585762003e5862003de7565b8160051b604051601f19603f8301168101818110868211171562003e805762003e8062003de7565b60405292835281830193508481018201928a84111562003e9f57600080fd5b948201945b8386101562003ec85762003eb88662003b19565b8552948201949382019362003ea4565b9a918901359950506040909701359695505050505050565b6020808252600c908201526b139bdd081a5b9a5d081e595d60a21b604082015260600190565b6000806040838503121562003f1a57600080fd5b505080516020909101519092909150565b602081016003831062003f425762003f4262003cae565b91905290565b634e487b7160e01b600052601160045260246000fd5b600060001982141562003f755762003f7562003f48565b5060010190565b634e487b7160e01b600052603260045260246000fd5b60006020828403121562003fa557600080fd5b5051919050565b6000821982111562003fc25762003fc262003f48565b500190565b60008282101562003fdc5762003fdc62003f48565b500390565b634e487b7160e01b600052603160045260246000fd5b6020808252825482820181905260008481528281209092916040850190845b818110156200403d5783546001600160a01b03168352600193840193928501920162004016565b50909695505050505050565b634e487b7160e01b600052601260045260246000fd5b60008262004071576200407162004049565b500690565b600081600019048311821515161562004093576200409362003f48565b500290565b600082620040aa57620040aa62004049565b500490565b600060208083528351808285015260005b81811015620040de57858101830151858201604001528201620040c0565b81811115620040f1576000604083870101525b50601f01601f191692909201604001939250505056fe608060405234801561001057600080fd5b50604051610edc380380610edc83398101604081905261002f91610102565b60028054336001600160a01b031991821617909155600580549091166001600160a01b03929092169190911790556040805160608101825243815260006020820181815292820181815260048054600181018255925291517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b60039092029182015591517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19c830155517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19d90910155610132565b60006020828403121561011457600080fd5b81516001600160a01b038116811461012b57600080fd5b9392505050565b610d9b806101416000396000f3fe6080604052600436106100a65760003560e01c806370a082311161006457806370a082311461016a578063714b4658146101a0578063abaa9916146101d6578063c00007b0146101de578063e673df8a146101fe578063f3fef3a31461021e57600080fd5b80628cc262146100ab57806318160ddd146100de57806326476204146100f35780633a5381b5146101085780633f9e3f0414610140578063446a2ec814610155575b600080fd5b3480156100b757600080fd5b506100cb6100c6366004610bf4565b61023e565b6040519081526020015b60405180910390f35b3480156100ea57600080fd5b506000546100cb565b610106610101366004610bf4565b6102cf565b005b34801561011457600080fd5b50600554610128906001600160a01b031681565b6040516001600160a01b0390911681526020016100d5565b34801561014c57600080fd5b506100cb610414565b34801561016157600080fd5b506100cb61042a565b34801561017657600080fd5b506100cb610185366004610bf4565b6001600160a01b031660009081526001602052604090205490565b3480156101ac57600080fd5b506100cb6101bb366004610bf4565b6001600160a01b031660009081526003602052604090205490565b61010661043d565b3480156101ea57600080fd5b506101066101f9366004610bf4565b6104be565b34801561020a57600080fd5b50600254610128906001600160a01b031681565b34801561022a57600080fd5b50610106610239366004610c11565b610623565b600080610249610757565b604001519050600061025a846107d1565b6040908101516001600160a01b03861660009081526003602052918220600101549092506102c6906102c0670de0b6b3a76400006102ba61029b8888610864565b6001600160a01b038b16600090815260016020526040902054906108af565b9061092e565b90610970565b95945050505050565b6002546001600160a01b031633146103025760405162461bcd60e51b81526004016102f990610c3d565b60405180910390fd5b806001600160a01b03811615610383576001600160a01b038116600090815260036020908152604091829020825180840190935280548352600101549082015261034b8261023e565b6020820152610358610414565b81526001600160a01b0382166000908152600360209081526040909120825181559101516001909101555b34806103c25760405162461bcd60e51b815260206004820152600e60248201526d043616e6e6f74207374616b6520360941b60448201526064016102f9565b6103cc83826109cf565b826001600160a01b03167f9e71bc8eea02a63969f509818f2dafb9254532904319f9dbda79b67bd34a5f3d8260405161040791815260200190565b60405180910390a2505050565b600454600090610425906001610864565b905090565b6000610434610757565b60400151905090565b6002546001600160a01b031633146104675760405162461bcd60e51b81526004016102f990610c3d565b34806104705750565b61047981610a21565b6005546040518281526001600160a01b03909116907f7d8f3d9291db7e540ea10a43e300f1330c3e9148157349babe42ac2601a2a3e99060200160405180910390a250565b6002546001600160a01b031633146104e85760405162461bcd60e51b81526004016102f990610c3d565b806001600160a01b03811615610569576001600160a01b03811660009081526003602090815260409182902082518084019093528054835260010154908201526105318261023e565b602082015261053e610414565b81526001600160a01b0382166000908152600360209081526040909120825181559101516001909101555b6001600160a01b038216600090815260036020526040902060010154801561061e576001600160a01b0383166000818152600360205260408082206001018290555183156108fc0291849190818181858888f193505050501580156105d2573d6000803e3d6000fd5b50600554604080518381524260208201526001600160a01b03928316928616917f51a69b4502f660774c9339825c7b5adbf0b8622289134647e29728ec5d9b3bb9910160405180910390a35b505050565b6002546001600160a01b0316331461064d5760405162461bcd60e51b81526004016102f990610c3d565b816001600160a01b038116156106ce576001600160a01b03811660009081526003602090815260409182902082518084019093528054835260010154908201526106968261023e565b60208201526106a3610414565b81526001600160a01b0382166000908152600360209081526040909120825181559101516001909101555b600082116107125760405162461bcd60e51b8152602060048201526011602482015270043616e6e6f74207769746864726177203607c1b60448201526064016102f9565b61071c8383610b04565b826001600160a01b03167f7084f5476618d8e60b11ef0d7d3f06914655adb8793e28ff7f018d4c76d505d58360405161040791815260200190565b61077b60405180606001604052806000815260200160008152602001600081525090565b6004610785610414565b8154811061079557610795610c74565b90600052602060002090600302016040518060600160405290816000820154815260200160018201548152602001600282015481525050905090565b6107f560405180606001604052806000815260200160008152602001600081525090565b6004610816836001600160a01b031660009081526003602052604090205490565b8154811061082657610826610c74565b906000526020600020906003020160405180606001604052908160008201548152602001600182015481526020016002820154815250509050919050565b60006108a683836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f770000815250610b7d565b90505b92915050565b6000826108be575060006108a9565b60006108ca8385610ca0565b9050826108d78583610cbf565b146108a65760405162461bcd60e51b815260206004820152602160248201527f536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f6044820152607760f81b60648201526084016102f9565b60006108a683836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f000000000000815250610bae565b60008061097d8385610ce1565b9050838110156108a65760405162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f77000000000060448201526064016102f9565b6000546109dc9082610970565b60009081556001600160a01b038316815260016020526040902054610a019082610970565b6001600160a01b0390921660009081526001602052604090209190915550565b6000610a2b610757565b6040015190506000610a5b610a54610a4260005490565b6102ba86670de0b6b3a76400006108af565b8390610970565b60408051606081018252438152602081019586529081019182526004805460018101825560009190915290517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b60039092029182015593517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19c850155517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19d909301929092555050565b600054610b119082610864565b60009081556001600160a01b038316815260016020526040902054610b369082610864565b6001600160a01b038316600081815260016020526040808220939093559151909183156108fc02918491818181858888f1935050505015801561061e573d6000803e3d6000fd5b60008184841115610ba15760405162461bcd60e51b81526004016102f99190610cf9565b5060006102c68486610d4e565b60008183610bcf5760405162461bcd60e51b81526004016102f99190610cf9565b5060006102c68486610cbf565b6001600160a01b0381168114610bf157600080fd5b50565b600060208284031215610c0657600080fd5b81356108a681610bdc565b60008060408385031215610c2457600080fd5b8235610c2f81610bdc565b946020939093013593505050565b6020808252601a908201527f43616c6c6572206973206e6f7420746865206f70657261746f72000000000000604082015260600190565b634e487b7160e01b600052603260045260246000fd5b634e487b7160e01b600052601160045260246000fd5b6000816000190483118215151615610cba57610cba610c8a565b500290565b600082610cdc57634e487b7160e01b600052601260045260246000fd5b500490565b60008219821115610cf457610cf4610c8a565b500190565b600060208083528351808285015260005b81811015610d2657858101830151858201604001528201610d0a565b81811115610d38576000604083870101525b50601f01601f1916929092016040019392505050565b600082821015610d6057610d60610c8a565b50039056fea26469706673582212209d5d1aaddef089e48bab9216a6960641a0f40869b4b9368c7faab70a3add8f8564736f6c63430008080033a2646970667358221220382687417dd2ac5fc95acc63051dee29a1787fd8c75a6fb61342e247d4ee941464736f6c63430008080033"
)

type hardForkValidatorsV3 struct {
}

func (s *hardForkValidatorsV3) GetName() string {
	return ValidatorsV2ContractName
}

func (s *hardForkValidatorsV3) Update(config *params.ChainConfig, height *big.Int, state *state.StateDB) (err error) {
	contractCode := common.FromHex(validatorV3Code)

	//write code to sys contract
	state.SetCode(ValidatorsV2ContractAddr, contractCode)
	log.Debug("Write code to system contract account", "addr", ValidatorsV2ContractAddr.String(), "code", validatorV3Code)

	return
}

func (s *hardForkValidatorsV3) Execute(state *state.StateDB, header *types.Header, chainContext core.ChainContext, config *params.ChainConfig) (err error) {
	//First, get top validators from the old contract
	v0 := NewValidatorV0()
	topVals, err := v0.GetTopValidators(state, header, chainContext, config)
	if err != nil {
		log.Error("getTopValidators from V0 failed", "err", err)
		return err
	}

	// initialize v1 contract
	method := "initialize"
	data, err := GetInteractiveABI()[ValidatorsV2ContractName].Pack(method, topVals)
	if err != nil {
		log.Error("Can't pack data for initialize", "error", err)
		return err
	}

	msg := vmcaller.NewLegacyMessage(header.Coinbase, &ValidatorsV2ContractAddr, 0, new(big.Int), math.MaxUint64, new(big.Int), data, false)
	_, err = vmcaller.ExecuteMsg(msg, state, header, chainContext, config)

	return
}
