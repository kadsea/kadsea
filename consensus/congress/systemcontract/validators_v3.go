package systemcontract

import (
	"math"
	"math/big"

	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/consensus/congress/vmcaller"
	"github.com/ethereum/go-ethereum/core"
	"github.com/ethereum/go-ethereum/core/state"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/log"
	"github.com/ethereum/go-ethereum/params"
)

const (
	validatorV3Code = "0x608060405260043610620002225760003560e01c80638233fbcb1162000123578063be64569211620000ad578063c4e2f07a1162000078578063c4e2f07a1462000675578063c967f90f146200069a578063d6eb3de114620006c5578063e8363f6c14620006dd578063ea10f8ad146200070e57600080fd5b8063be6456921462000600578063c1d7dd781462000620578063c253c3841462000638578063c2a672e0146200065057600080fd5b80639de7025811620000ee5780639de702581462000562578063a224cee71462000589578063afeea11514620005ae578063bbe4f6db14620005c657600080fd5b80638233fbcb14620004c95780638a11d7c914620004ee5780638b0e9f3f146200052557806398e3b626146200053d57600080fd5b806340a141ff11620001b15780636846992a116200017c5780636846992a14620003fa5780636969a25c146200041f5780637ad229da14620004445780637f4f95fa146200046957806380d2dde114620004a457600080fd5b806340a141ff146200034f57806348cd4cb114620003745780634b3d500b146200039b57806363fc5e7114620003c057600080fd5b806330fcb67c11620001f257806330fcb67c14620002c557806338b67b8b14620002de5780633a061bd3146200031257806340550a1c146200032a57600080fd5b8062362a771462000227578063158ef93e14620002615780631b5e358c146200027d5780632647620414620002ae575b600080fd5b3480156200023457600080fd5b506200024c6200024636600462003840565b62000733565b60405190151581526020015b60405180910390f35b3480156200026e57600080fd5b506000546200024c9060ff1681565b3480156200028a57600080fd5b506200029561f20081565b6040516001600160a01b03909116815260200162000258565b6200024c620002bf36600462003840565b620008d4565b620002dc620002d636600462003840565b62000d5d565b005b348015620002eb57600080fd5b5062000303620002fd366004620038a6565b62000f8d565b604051620002589190620038ec565b3480156200031f57600080fd5b506200029561f10081565b3480156200033757600080fd5b506200024c6200034936600462003840565b62001133565b3480156200035c57600080fd5b50620002dc6200036e36600462003840565b620011a5565b3480156200038157600080fd5b506200038c60015481565b60405190815260200162000258565b348015620003a857600080fd5b5062000295620003ba36600462003932565b62001206565b348015620003cd57600080fd5b506200038c620003df36600462003840565b6001600160a01b03166000908152600f602052604090205490565b3480156200040757600080fd5b50620002dc6200041936600462003962565b62001231565b3480156200042c57600080fd5b50620002956200043e36600462003932565b620014ac565b3480156200045157600080fd5b506200038c6200046336600462003a3b565b620014bd565b3480156200047657600080fd5b506200048e6200048836600462003a68565b6200159a565b6040805192835260208301919091520162000258565b348015620004b157600080fd5b50620002dc620004c336600462003a3b565b620015cf565b348015620004d657600080fd5b506200038c620004e836600462003840565b6200196b565b348015620004fb57600080fd5b50620005136200050d36600462003840565b62001995565b60405162000258949392919062003afc565b3480156200053257600080fd5b506200038c60075481565b3480156200054a57600080fd5b506200024c6200055c36600462003840565b62001a91565b3480156200056f57600080fd5b506200057a62001afa565b60405162000258919062003b40565b3480156200059657600080fd5b50620002dc620005a8366004620038a6565b62001b5e565b348015620005bb57600080fd5b506200057a620020cd565b348015620005d357600080fd5b5062000295620005e536600462003840565b600b602052600090815260409020546001600160a01b031681565b3480156200060d57600080fd5b506200038c69021e19e0c9bab240000081565b3480156200062d57600080fd5b506200038c60085481565b3480156200064557600080fd5b506200048e6200212f565b3480156200065d57600080fd5b506200024c6200066f36600462003a3b565b62002146565b3480156200068257600080fd5b506200038c6200069436600462003a68565b62002565565b348015620006a757600080fd5b50620006b1601581565b60405161ffff909116815260200162000258565b348015620006d257600080fd5b506200029561f30081565b348015620006ea57600080fd5b506200038c620006fc36600462003840565b60046020526000908152604090205481565b3480156200071b57600080fd5b50620003036200072d36600462003b55565b6200262b565b3360008181526004602052604081208054908290559091908015620007e3576001600160a01b0382166108fc620007708364e8d4a51000620027aa565b6040518115909202916000818181858888f1935050505015801562000799573d6000803e3d6000fd5b50604080518281524260208201526001600160a01b0380871692908516917f51a69b4502f660774c9339825c7b5adbf0b8622289134647e29728ec5d9b3bb9910160405180910390a35b6001600160a01b038481166000908152600b6020526040808220549051630c00007b60e41b81528584166004820152921691829063c00007b090602401602060405180830381600087803b1580156200083b57600080fd5b505af115801562000850573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019062000876919062003bae565b90508015620008c8576001600160a01b0384166108fc6200089d8364e8d4a51000620027aa565b6040518115909202916000818181858888f19350505050158015620008c6573d6000803e3d6000fd5b505b50600195945050505050565b6000805460ff16620009035760405162461bcd60e51b8152600401620008fa9062003bc8565b60405180910390fd5b336000818152600c60205260409020543490620009219082620027f5565b6001600160a01b038084166000908152600c602052604080822093909355600a5483516325dff9d160e01b815284519294859492909216926325dff9d192600480840193919291829003018186803b1580156200097d57600080fd5b505afa15801562000992573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620009b8919062003bee565b9150915081431015620009fb5760405162461bcd60e51b815260206004820152600a6024820152697374617274426c6f636b60b01b6044820152606401620008fa565b8043111562000a385760405162461bcd60e51b8152602060048201526008602482015267656e64426c6f636b60c01b6044820152606401620008fa565b6001600160a01b03808716600081815260026020526040902091861614801562000a92575060016001600160a01b03881660009081526002602052604090205460ff16600381111562000a8f5762000a8f62003aa0565b14155b1562000b0557600181015469021e19e0c9bab24000009062000ab59086620027f5565b101562000b055760405162461bcd60e51b815260206004820152601860248201527f5374616b696e6720636f696e73206e6f7420656e6f75676800000000000000006044820152606401620008fa565b6001600160a01b038086166000908152600360209081526040808320938b168352929052205462000b8457600380820180546001600160a01b03808916600081815260209586526040808220938e1682529286529182206001908101849055830184559281529290922090910180546001600160a01b03191690911790555b600181015462000bd357866001600160a01b03167fbc822c457926e0706c445f2b613394c8a2bf34b3b4335915e3865b90829ce38b600160405162000bca919062003c13565b60405180910390a25b600181015462000be49085620027f5565b600180830191909155815460ff16600381111562000c065762000c0662003aa0565b1462000c1857805460ff191660011781555b62000c2887826001015462002858565b6001600160a01b038086166000908152600360209081526040808320938b168352929052205462000c5a9085620027f5565b6001600160a01b038087166000908152600360209081526040808320938c168352929052205560075462000c8f9085620027f5565b6007556001600160a01b038781166000908152600b602052604090819020549051630991d88160e21b81528783166004820152911690819063264762049087906024016000604051808303818588803b15801562000cec57600080fd5b505af115801562000d01573d6000803e3d6000fd5b5050604080518981524260208201526001600160a01b03808e1695508b1693507fb9ba725934532316cffe10975da6eb25ad49c2d1c294d982c46c9f8d684ee07592500160405180910390a3600196505050505050505b919050565b33411462000d9b5760405162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b6044820152606401620008fa565b436000908152600d6020908152604080832083805290915290205460ff161562000e085760405162461bcd60e51b815260206004820152601960248201527f426c6f636b20697320616c7265616479207265776172646564000000000000006044820152606401620008fa565b60005460ff1662000e2d5760405162461bcd60e51b8152600401620008fa9062003bc8565b436000818152600d602090815260408083208380529091529020805460ff191660019081179091555433913491101562000eee576001600160a01b0382166000908152600f6020526040812080549162000e878362003c46565b9091555050600954604051631e88772760e01b81526001600160a01b03848116600483015290911690631e88772790602401600060405180830381600087803b15801562000ed457600080fd5b505af115801562000ee9573d6000803e3d6000fd5b505050505b6000811162000efc57505050565b6001600160a01b03821660009081526002602052604081205460ff16600381111562000f2c5762000f2c62003aa0565b141562000f3857505050565b62000f44818462002c6d565b604080518281524260208201526001600160a01b038416917f7dc4e5df59513708dca355b8706273a5df7b810a4cec8019f2a4b9bb166a1a04910160405180910390a250505b50565b6060818067ffffffffffffffff81111562000fac5762000fac6200394c565b60405190808252806020026020018201604052801562000fd6578160200160208202803683370190505b50915060005b818110156200112b57600085858381811062000ffc5762000ffc62003c64565b905060200201602081019062001013919062003840565b6001600160a01b038082166000908152600b60205260408120549293509116908115620010b8576040516246613160e11b81526001600160a01b038481166004830152831690628cc2629060240160206040518083038186803b1580156200107a57600080fd5b505afa1580156200108f573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620010b5919062003bae565b90505b6001600160a01b038316600090815260046020526040902054620010f19064e8d4a5100090620010ea908490620027f5565b90620027aa565b86858151811062001106576200110662003c64565b6020026020010181815250505050508080620011229062003c46565b91505062000fdc565b505092915050565b6000805b6005548110156200119c57826001600160a01b03166005828154811062001162576200116262003c64565b6000918252602090912001546001600160a01b03161415620011875750600192915050565b80620011938162003c46565b91505062001137565b50600092915050565b3361f20014620011ef5760405162461bcd60e51b815260206004820152601460248201527350756e69736820636f6e7472616374206f6e6c7960601b6044820152606401620008fa565b6006546001101562000f8a5762000f8a81620033b4565b600681815481106200121757600080fd5b6000918252602090912001546001600160a01b0316905081565b3341146200126f5760405162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b6044820152606401620008fa565b436000908152600d602090815260408083206001845290915290205460ff1615620012dd5760405162461bcd60e51b815260206004820152601a60248201527f56616c696461746f727320616c726561647920757064617465640000000000006044820152606401620008fa565b60005460ff16620013025760405162461bcd60e51b8152600401620008fa9062003bc8565b806200130f814362003c90565b15620013515760405162461bcd60e51b815260206004820152601060248201526f426c6f636b2065706f6368206f6e6c7960801b6044820152606401620008fa565b436000908152600d6020908152604080832060018085529252909120805460ff191690911790558251620013bf5760405162461bcd60e51b815260206004820152601460248201527356616c696461746f722073657420656d7074792160601b6044820152606401620008fa565b600a54604080516325dff9d160e01b815281516000936001600160a01b0316926325dff9d19260048082019391829003018186803b1580156200140157600080fd5b505afa15801562001416573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906200143c919062003bee565b915050600081118015620014505750804310155b15620014a65783516200146b90600590602087019062003799565b507feacea8f3c22f06c0b18306bdb04d0a967255129e8ce0094debb0a0ff89d006b5846040516200149d919062003b40565b60405180910390a15b50505050565b600581815481106200121757600080fd5b6001600160a01b038281166000908152600b602052604080822054905163fa9ada5b60e01b815260048101859052919216908290829063fa9ada5b9060240160206040518083038186803b1580156200151557600080fd5b505afa1580156200152a573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019062001550919062003bae565b6001600160a01b0386166000908152600e602090815260408083208884529091529020549091506200158f9064e8d4a5100090620010ea9084620027f5565b925050505b92915050565b6001600160a01b03828116600090815260036020908152604080832093851683529290522080546001909101545b9250929050565b3361f20014620016195760405162461bcd60e51b815260206004820152601460248201527350756e69736820636f6e7472616374206f6e6c7960601b6044820152606401620008fa565b8160006001600160a01b03841660009081526002602052604090205460ff1660038111156200164c576200164c62003aa0565b1415620016925760405162461bcd60e51b815260206004820152601360248201527215985b1a59185d1bdc881b9bdd08195e1a5cdd606a1b6044820152606401620008fa565b6001600160a01b03808216600090815260036020908152604080832093871683529281528282206002909152919020815480851115620016d0578094505b84620016de57505050505050565b8481141562001833576003820154620016fa9060019062003ca7565b836001015414620017f257600382018054620017199060019062003ca7565b815481106200172c576200172c62003c64565b9060005260206000200160009054906101000a90046001600160a01b03168260030184600101548154811062001766576200176662003c64565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b0316021790555082600101546003600084600301866001015481548110620017b957620017b962003c64565b60009182526020808320909101546001600160a01b0390811684528382019490945260409283018220938b168252929092529020600101555b8160030180548062001808576200180862003cc1565b600082815260208120820160001990810180546001600160a01b031916905590910190915560018401555b8254620018419086620033f9565b83556001820154620018549086620033f9565b6001830155600754620018689086620033f9565b6007556001600160a01b0384166000908152600c6020526040902054620018909086620033f9565b6001600160a01b038581166000818152600c60209081526040808320959095558a84168252600b905283902054925163f3fef3a360e01b8152600481019190915260248101889052911690819063f3fef3a390604401600060405180830381600087803b1580156200190157600080fd5b505af115801562001916573d6000803e3d6000fd5b5050604080518981524260208201526001600160a01b03808c169450891692507f449002ae18e748d69a55f38514400d64f966492e593e32d6e9b8b24db98a0bc1910160405180910390a350505050505b5050565b6001600160a01b038116600090815260106020526040812054620015949064e8d4a51000620027aa565b6001600160a01b03811660009081526002602052604080822081516080810190925280548392839260609284929190829060ff166003811115620019dd57620019dd62003aa0565b6003811115620019f157620019f162003aa0565b815260200160018201548152602001600282015481526020016003820180548060200260200160405190810160405280929190818152602001828054801562001a6457602002820191906000526020600020905b81546001600160a01b0316815260019091019060200180831162001a45575b505050919092525050815160208301516040840151606090940151919a9099509297509550909350505050565b6000805b6006548110156200119c57826001600160a01b03166006828154811062001ac05762001ac062003c64565b6000918252602090912001546001600160a01b0316141562001ae55750600192915050565b8062001af18162003c46565b91505062001a95565b6060600580548060200260200160405190810160405280929190818152602001828054801562001b5457602002820191906000526020600020905b81546001600160a01b0316815260019091019060200180831162001b35575b5050505050905090565b60005460ff161562001ba95760405162461bcd60e51b8152602060048201526013602482015272105b1c9958591e481a5b9a5d1a585b1a5e9959606a1b6044820152606401620008fa565b600980546001600160a01b031990811661f20017909155600a805490911661f30017905560005b818110156200208157600083838381811062001bf05762001bf062003c64565b905060200201602081019062001c07919062003840565b6001600160a01b0316141562001c605760405162461bcd60e51b815260206004820152601960248201527f496e76616c69642076616c696461746f722061646472657373000000000000006044820152606401620008fa565b62001c9083838381811062001c795762001c7962003c64565b905060200201602081019062000349919062003840565b62001cf657600583838381811062001cac5762001cac62003c64565b905060200201602081019062001cc3919062003840565b81546001810183556000928352602090922090910180546001600160a01b0319166001600160a01b039092169190911790555b62001d2683838381811062001d0f5762001d0f62003c64565b90506020020160208101906200055c919062003840565b62001d8c57600683838381811062001d425762001d4262003c64565b905060200201602081019062001d59919062003840565b81546001810183556000928352602090922090910180546001600160a01b0319166001600160a01b039092169190911790555b60006002600085858581811062001da75762001da762003c64565b905060200201602081019062001dbe919062003840565b6001600160a01b0316815260208101919091526040016000205460ff16600381111562001def5762001def62003aa0565b141562001e645760016002600085858581811062001e115762001e1162003c64565b905060200201602081019062001e28919062003840565b6001600160a01b031681526020810191909152604001600020805460ff1916600183600381111562001e5e5762001e5e62003aa0565b02179055505b6000600b8185858581811062001e7e5762001e7e62003c64565b905060200201602081019062001e95919062003840565b6001600160a01b0390811682526020820192909252604001600020541614156200206c57600083838381811062001ed05762001ed062003c64565b905060200201602081019062001ee7919062003840565b60405160200162001f0b919060609190911b6001600160601b031916815260140190565b60405160208183030381529060405280519060200120905060008185858581811062001f3b5762001f3b62003c64565b905060200201602081019062001f52919062003840565b60405162001f609062003803565b6001600160a01b0390911681526020018190604051809103906000f590508015801562001f91573d6000803e3d6000fd5b50905080600b600087878781811062001fae5762001fae62003c64565b905060200201602081019062001fc5919062003840565b6001600160a01b039081168252602082019290925260400160002080546001600160a01b031916929091169190911790558484848181106200200b576200200b62003c64565b905060200201602081019062002022919062003840565b604080516001600160a01b03848116825242602083015292909216917f5e5b474625449a92e2b1a6f9f183435f09402d6897ae7f8779c72142ed11170b910160405180910390a250505b80620020788162003c46565b91505062001bd0565b507feacea8f3c22f06c0b18306bdb04d0a967255129e8ce0094debb0a0ff89d006b56005604051620020b4919062003cd7565b60405180910390a150506000805460ff19166001179055565b6060600680548060200260200160405190810160405280929190818152602001828054801562001b54576020028201919060005260206000209081546001600160a01b0316815260019091019060200180831162001b35575050505050905090565b6000806200213e60006200343d565b915091509091565b6000805460ff166200216c5760405162461bcd60e51b8152600401620008fa9062003bc8565b3360006001600160a01b03851660009081526002602052604090205460ff1660038111156200219f576200219f62003aa0565b1415620021e55760405162461bcd60e51b815260206004820152601360248201527215985b1a59185d1bdc881b9bdd08195e1a5cdd606a1b6044820152606401620008fa565b6001600160a01b03808216600090815260036020908152604080832093881683529281528282206002909152919020815480861115620022685760405162461bcd60e51b815260206004820152601860248201527f596f7520646f6e2774206861766520616e79207374616b6500000000000000006044820152606401620008fa565b85811415620023bd576003820154620022849060019062003ca7565b8360010154146200237c57600382018054620022a39060019062003ca7565b81548110620022b657620022b662003c64565b9060005260206000200160009054906101000a90046001600160a01b031682600301846001015481548110620022f057620022f062003c64565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b031602179055508260010154600360008460030186600101548154811062002343576200234362003c64565b60009182526020808320909101546001600160a01b0390811684528382019490945260409283018220938c168252929092529020600101555b8160030180548062002392576200239262003cc1565b600082815260208120820160001990810180546001600160a01b031916905590910190915560018401555b8254620023cb9087620033f9565b83556001820154620023de9087620033f9565b6001830155600754620023f29087620033f9565b6007556001600160a01b0384166000908152600c60205260409020546200241a9087620033f9565b6001600160a01b038086166000818152600c60205260409020929092558816141562002497576200244b8762001a91565b156200249757825469021e19e0c9bab24000001115620024975760405162461bcd60e51b8152600401620008fa906020808252600490820152630333030360e41b604082015260600190565b6001600160a01b038781166000908152600b60205260409081902054905163f3fef3a360e01b8152868316600482015260248101899052911690819063f3fef3a390604401600060405180830381600087803b158015620024f757600080fd5b505af11580156200250c573d6000803e3d6000fd5b5050604080518a81524260208201526001600160a01b03808d169450891692507f449002ae18e748d69a55f38514400d64f966492e593e32d6e9b8b24db98a0bc1910160405180910390a3506001979650505050505050565b6001600160a01b038181166000908152600b60205260408082205490516246613160e11b815285841660048201529192169082908290628cc2629060240160206040518083038186803b158015620025bc57600080fd5b505afa158015620025d1573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620025f7919062003bae565b6001600160a01b0386166000908152600460205260409020549091506200158f9064e8d4a5100090620010ea9084620027f5565b6060818067ffffffffffffffff8111156200264a576200264a6200394c565b60405190808252806020026020018201604052801562002674578160200160208202803683370190505b50915060005b83811015620027a15760008585838181106200269a576200269a62003c64565b9050602002016020810190620026b1919062003840565b6001600160a01b038082166000908152600b6020526040812054929350911690811562002756576040516246613160e11b81526001600160a01b038a81166004830152831690628cc2629060240160206040518083038186803b1580156200271857600080fd5b505afa1580156200272d573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019062002753919062003bae565b90505b620027678164e8d4a51000620027aa565b8685815181106200277c576200277c62003c64565b6020026020010181815250505050508080620027989062003c46565b9150506200267a565b50509392505050565b6000620027ee83836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f00000000000081525062003563565b9392505050565b60008062002804838562003d1d565b905083811015620027ee5760405162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f7700000000006044820152606401620008fa565b60005b600654811015620028bc57826001600160a01b03166006828154811062002886576200288662003c64565b6000918252602090912001546001600160a01b03161415620028a757505050565b80620028b38162003c46565b9150506200285b565b506006546015111562002a115760068054600181019091557ff652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d3f0180546001600160a01b0319166001600160a01b038481169182179092556000908152600b60205260409020541662001967576040516001600160601b0319606084901b166020820152600090603401604051602081830303815290604052805190602001209050600081846040516200296f9062003803565b6001600160a01b0390911681526020018190604051809103906000f5905080158015620029a0573d6000803e3d6000fd5b506001600160a01b038581166000818152600b602090815260409182902080546001600160a01b031916948616948517905581519384524290840152929350917f5e5b474625449a92e2b1a6f9f183435f09402d6897ae7f8779c72142ed11170b910160405180910390a250505050565b600060026000600660008154811062002a2e5762002a2e62003c64565b60009182526020808320909101546001600160a01b03168352820192909252604001812060019081015492505b60065481101562002b0d5782600260006006848154811062002a815762002a8162003c64565b60009182526020808320909101546001600160a01b03168352820192909252604001902060010154101562002af857600260006006838154811062002aca5762002aca62003c64565b60009182526020808320909101546001600160a01b0316835282019290925260400190206001015492509050805b8062002b048162003c46565b91505062002a5b565b5081831162002b1c5750505050565b6001600160a01b038481166000908152600b60205260409020541662002c22576040516001600160601b0319606086901b1660208201526000906034016040516020818303038152906040528051906020012090506000818660405162002b839062003803565b6001600160a01b0390911681526020018190604051809103906000f590508015801562002bb4573d6000803e3d6000fd5b506001600160a01b038781166000818152600b602090815260409182902080546001600160a01b031916948616948517905581519384524290840152929350917f5e5b474625449a92e2b1a6f9f183435f09402d6897ae7f8779c72142ed11170b910160405180910390a250505b836006828154811062002c395762002c3962003c64565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b0316021790555050505050565b8162002c77575050565b60008062002c85836200343d565b90925090508062002c965750505050565b60008062002caa8664e8d4a510006200359f565b95508362002f7c57600062002cc08785620027aa565b905062002cda62002cd282866200359f565b8890620033f9565b925060005b60055481101562002e705760006005828154811062002d025762002d0262003c64565b6000918252602090912001546001600160a01b0316905060036001600160a01b03821660009081526002602052604090205460ff16600381111562002d4b5762002d4b62003aa0565b1415801562002d6c5750876001600160a01b0316816001600160a01b031614155b1562002e5a576001600160a01b03811660009081526004602052604090205462002d979084620027f5565b6001600160a01b038216600090815260046020908152604080832093909355600e815282822043835290522054909350839062002dd59084620027f5565b6001600160a01b0382166000818152600e602090815260408083204384528252808320949094559181526010909152205462002e129084620027f5565b6001600160a01b0382166000818152601060205260409081902092909255905160008051602062004d5f8339815191529062002e519086815260200190565b60405180910390a25b508062002e678162003c46565b91505062002cdf565b5060008311801562002e8a57506001600160a01b03821615155b1562002f73576001600160a01b03821660009081526004602052604090205462002eb59084620027f5565b6001600160a01b038316600090815260046020908152604080832093909355600e81528282204383529052205462002eee9084620027f5565b6001600160a01b0383166000818152600e602090815260408083204384528252808320949094559181526010909152205462002f2b9084620027f5565b6001600160a01b0383166000818152601060205260409081902092909255905160008051602062004d5f8339815191529062002f6a9086815260200190565b60405180910390a25b50505050505050565b6000805b600554811015620032075760006005828154811062002fa35762002fa362003c64565b6000918252602090912001546001600160a01b0316905060036001600160a01b03821660009081526002602052604090205460ff16600381111562002fec5762002fec62003aa0565b141580156200300d5750876001600160a01b0316816001600160a01b031614155b15620031f1576001600160a01b038116600090815260026020819052604082206001015462003048918a91620010ea919082908f906200359f565b6001600160a01b0383166000908152600460205260409020549295508592909150620030759082620027f5565b6001600160a01b03838116600090815260046020818152604080842095909555600b9052908390205492516390ca796b60e01b815290810184905291169081906390ca796b90602401600060405180830381600087803b158015620030d957600080fd5b505af1158015620030ee573d6000803e3d6000fd5b50505050620031376200310c6002846200359f90919063ffffffff16565b6001600160a01b0385166000908152600e6020908152604080832043845290915290205490620027f5565b6001600160a01b0384166000908152600e602090815260408083204384529091529020556200318c6200316c8360026200359f565b6001600160a01b03851660009081526010602052604090205490620027f5565b6001600160a01b0384166000818152601060205260409081902092909255905160008051602062004d5f83398151915290620031cb9085815260200190565b60405180910390a2620031ec620031e48360026200359f565b8690620027f5565b945050505b5080620031fe8162003c46565b91505062002f80565b50620032148782620033f9565b92506000831180156200322f57506001600160a01b03821615155b1562002f73576200326662003246846002620027aa565b6001600160a01b03841660009081526004602052604090205490620027f5565b6001600160a01b03808416600090815260046020908152604080832094909455600b9052919091205416806390ca796b620032a3866002620027aa565b6040518263ffffffff1660e01b8152600401620032c291815260200190565b600060405180830381600087803b158015620032dd57600080fd5b505af1158015620032f2573d6000803e3d6000fd5b5050506001600160a01b0384166000908152600e6020908152604080832043845290915290205462003326915085620027f5565b6001600160a01b0384166000818152600e6020908152604080832043845282528083209490945591815260109091522054620033639085620027f5565b6001600160a01b0384166000818152601060205260409081902092909255905160008051602062004d5f83398151915290620033a29087815260200190565b60405180910390a25050505050505050565b6001600160a01b03811660009081526002602052604081205460ff166003811115620033e457620033e462003aa0565b1415620033ee5750565b62000f8a8162003626565b6000620027ee83836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f77000081525062003763565b60008060005b6005548110156200355d57600360026000600584815481106200346a576200346a62003c64565b60009182526020808320909101546001600160a01b0316835282019290925260400190205460ff166003811115620034a657620034a662003aa0565b14158015620034e2575060058181548110620034c657620034c662003c64565b6000918252602090912001546001600160a01b03858116911614155b15620035485762003536600260006005848154811062003506576200350662003c64565b60009182526020808320909101546001600160a01b031683528201929092526040019020600101548490620027f5565b925081620035448162003c46565b9250505b80620035548162003c46565b91505062003443565b50915091565b60008183620035875760405162461bcd60e51b8152600401620008fa919062003d38565b50600062003596848662003d90565b95945050505050565b600082620035b05750600062001594565b6000620035be838562003da7565b905082620035cd858362003d90565b14620027ee5760405162461bcd60e51b815260206004820152602160248201527f536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f6044820152607760f81b6064820152608401620008fa565b60005b600654811080156200363d57506006546001105b1562001967576006818154811062003659576200365962003c64565b6000918252602090912001546001600160a01b03838116911614156200374e576006546200368a9060019062003ca7565b8114620037145760068054620036a39060019062003ca7565b81548110620036b657620036b662003c64565b600091825260209091200154600680546001600160a01b039092169183908110620036e557620036e562003c64565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b031602179055505b600680548062003728576200372862003cc1565b600082815260209020810160001990810180546001600160a01b03191690550190555050565b806200375a8162003c46565b91505062003629565b600081848411156200378a5760405162461bcd60e51b8152600401620008fa919062003d38565b50600062003596848662003ca7565b828054828255906000526020600020908101928215620037f1579160200282015b82811115620037f157825182546001600160a01b0319166001600160a01b03909116178255602090920191600190910190620037ba565b50620037ff92915062003811565b5090565b610f958062003dca83390190565b5b80821115620037ff576000815560010162003812565b80356001600160a01b038116811462000d5857600080fd5b6000602082840312156200385357600080fd5b620027ee8262003828565b60008083601f8401126200387157600080fd5b50813567ffffffffffffffff8111156200388a57600080fd5b6020830191508360208260051b8501011115620015c857600080fd5b60008060208385031215620038ba57600080fd5b823567ffffffffffffffff811115620038d257600080fd5b620038e0858286016200385e565b90969095509350505050565b6020808252825182820181905260009190848201906040850190845b81811015620039265783518352928401929184019160010162003908565b50909695505050505050565b6000602082840312156200394557600080fd5b5035919050565b634e487b7160e01b600052604160045260246000fd5b600080604083850312156200397657600080fd5b823567ffffffffffffffff808211156200398f57600080fd5b818501915085601f830112620039a457600080fd5b8135602082821115620039bb57620039bb6200394c565b8160051b604051601f19603f83011681018181108682111715620039e357620039e36200394c565b60405292835281830193508481018201928984111562003a0257600080fd5b948201945b8386101562003a2b5762003a1b8662003828565b8552948201949382019362003a07565b9997909101359750505050505050565b6000806040838503121562003a4f57600080fd5b62003a5a8362003828565b946020939093013593505050565b6000806040838503121562003a7c57600080fd5b62003a878362003828565b915062003a976020840162003828565b90509250929050565b634e487b7160e01b600052602160045260246000fd5b600081518084526020808501945080840160005b8381101562003af15781516001600160a01b03168752958201959082019060010162003aca565b509495945050505050565b60006004861062003b115762003b1162003aa0565b8582528460208301528360408301526080606083015262003b36608083018462003ab6565b9695505050505050565b602081526000620027ee602083018462003ab6565b60008060006040848603121562003b6b57600080fd5b62003b768462003828565b9250602084013567ffffffffffffffff81111562003b9357600080fd5b62003ba1868287016200385e565b9497909650939450505050565b60006020828403121562003bc157600080fd5b5051919050565b6020808252600c908201526b139bdd081a5b9a5d081e595d60a21b604082015260600190565b6000806040838503121562003c0257600080fd5b505080516020909101519092909150565b602081016003831062003c2a5762003c2a62003aa0565b91905290565b634e487b7160e01b600052601160045260246000fd5b600060001982141562003c5d5762003c5d62003c30565b5060010190565b634e487b7160e01b600052603260045260246000fd5b634e487b7160e01b600052601260045260246000fd5b60008262003ca25762003ca262003c7a565b500690565b60008282101562003cbc5762003cbc62003c30565b500390565b634e487b7160e01b600052603160045260246000fd5b6020808252825482820181905260008481528281209092916040850190845b81811015620039265783546001600160a01b03168352600193840193928501920162003cf6565b6000821982111562003d335762003d3362003c30565b500190565b600060208083528351808285015260005b8181101562003d675785810183015185820160400152820162003d49565b8181111562003d7a576000604083870101525b50601f01601f1916929092016040019392505050565b60008262003da25762003da262003c7a565b500490565b600081600019048311821515161562003dc45762003dc462003c30565b50029056fe608060405234801561001057600080fd5b50604051610f95380380610f9583398101604081905261002f91610102565b60028054336001600160a01b031991821617909155600580549091166001600160a01b03929092169190911790556040805160608101825243815260006020820181815292820181815260048054600181018255925291517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b60039092029182015591517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19c830155517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19d90910155610132565b60006020828403121561011457600080fd5b81516001600160a01b038116811461012b57600080fd5b9392505050565b610e54806101416000396000f3fe6080604052600436106100c15760003560e01c806370a082311161007f578063c00007b011610059578063c00007b014610211578063e673df8a14610231578063f3fef3a314610251578063fa9ada5b1461027157600080fd5b806370a0823114610185578063714b4658146101bb57806390ca796b146101f157600080fd5b80628cc262146100c657806318160ddd146100f9578063264762041461010e5780633a5381b5146101235780633f9e3f041461015b578063446a2ec814610170575b600080fd5b3480156100d257600080fd5b506100e66100e1366004610c94565b6102b4565b6040519081526020015b60405180910390f35b34801561010557600080fd5b506000546100e6565b61012161011c366004610c94565b610345565b005b34801561012f57600080fd5b50600554610143906001600160a01b031681565b6040516001600160a01b0390911681526020016100f0565b34801561016757600080fd5b506100e661048a565b34801561017c57600080fd5b506100e66104a0565b34801561019157600080fd5b506100e66101a0366004610c94565b6001600160a01b031660009081526001602052604090205490565b3480156101c757600080fd5b506100e66101d6366004610c94565b6001600160a01b031660009081526003602052604090205490565b3480156101fd57600080fd5b5061012161020c366004610cb1565b6104b3565b34801561021d57600080fd5b506100e661022c366004610c94565b61056f565b34801561023d57600080fd5b50600254610143906001600160a01b031681565b34801561025d57600080fd5b5061012161026c366004610cca565b6106b1565b34801561027d57600080fd5b506100e661028c366004610cb1565b6005546001600160a01b03166000908152600660209081526040808320938352929052205490565b6000806102bf6107e5565b60400151905060006102d08461085f565b6040908101516001600160a01b038616600090815260036020529182206001015490925061033c90610336670de0b6b3a764000061033061031188886108f2565b6001600160a01b038b166000908152600160205260409020549061093d565b906109bc565b906109fe565b95945050505050565b6002546001600160a01b031633146103785760405162461bcd60e51b815260040161036f90610cf6565b60405180910390fd5b806001600160a01b038116156103f9576001600160a01b03811660009081526003602090815260409182902082518084019093528054835260010154908201526103c1826102b4565b60208201526103ce61048a565b81526001600160a01b0382166000908152600360209081526040909120825181559101516001909101555b34806104385760405162461bcd60e51b815260206004820152600e60248201526d043616e6e6f74207374616b6520360941b604482015260640161036f565b6104428382610a5d565b826001600160a01b03167f9e71bc8eea02a63969f509818f2dafb9254532904319f9dbda79b67bd34a5f3d8260405161047d91815260200190565b60405180910390a2505050565b60045460009061049b9060016108f2565b905090565b60006104aa6107e5565b60400151905090565b6002546001600160a01b031633146104dd5760405162461bcd60e51b815260040161036f90610cf6565b806104e55750565b6005546001600160a01b031660009081526006602090815260408083204384529091528120805483929061051a908490610d43565b90915550610529905081610aaf565b6005546040518281526001600160a01b03909116907f7d8f3d9291db7e540ea10a43e300f1330c3e9148157349babe42ac2601a2a3e99060200160405180910390a25b50565b6002546000906001600160a01b0316331461059c5760405162461bcd60e51b815260040161036f90610cf6565b816001600160a01b0381161561061d576001600160a01b03811660009081526003602090815260409182902082518084019093528054835260010154908201526105e5826102b4565b60208201526105f261048a565b81526001600160a01b0382166000908152600360209081526040909120825181559101516001909101555b6001600160a01b038316600090815260036020526040902060010154915081156106ab576001600160a01b038084166000818152600360205260408082206001019190915560055490519216917f51a69b4502f660774c9339825c7b5adbf0b8622289134647e29728ec5d9b3bb9906106a29086904290918252602082015260400190565b60405180910390a35b50919050565b6002546001600160a01b031633146106db5760405162461bcd60e51b815260040161036f90610cf6565b816001600160a01b0381161561075c576001600160a01b0381166000908152600360209081526040918290208251808401909352805483526001015490820152610724826102b4565b602082015261073161048a565b81526001600160a01b0382166000908152600360209081526040909120825181559101516001909101555b600082116107a05760405162461bcd60e51b8152602060048201526011602482015270043616e6e6f74207769746864726177203607c1b604482015260640161036f565b6107aa8383610ba2565b826001600160a01b03167f7084f5476618d8e60b11ef0d7d3f06914655adb8793e28ff7f018d4c76d505d58360405161047d91815260200190565b61080960405180606001604052806000815260200160008152602001600081525090565b600461081361048a565b8154811061082357610823610d5b565b90600052602060002090600302016040518060600160405290816000820154815260200160018201548152602001600282015481525050905090565b61088360405180606001604052806000815260200160008152602001600081525090565b60046108a4836001600160a01b031660009081526003602052604090205490565b815481106108b4576108b4610d5b565b906000526020600020906003020160405180606001604052908160008201548152602001600182015481526020016002820154815250509050919050565b600061093483836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f770000815250610c20565b90505b92915050565b60008261094c57506000610937565b60006109588385610d71565b9050826109658583610d90565b146109345760405162461bcd60e51b815260206004820152602160248201527f536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f6044820152607760f81b606482015260840161036f565b600061093483836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f000000000000815250610c51565b600080610a0b8385610d43565b9050838110156109345760405162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f770000000000604482015260640161036f565b600054610a6a90826109fe565b60009081556001600160a01b038316815260016020526040902054610a8f90826109fe565b6001600160a01b0390921660009081526001602052604090209190915550565b6000610ab96107e5565b6040015190506000610aca60005490565b905080610ad657505050565b6000610af8610af18361033087670de0b6b3a764000061093d565b84906109fe565b60408051606081018252438152602081019687529081019182526004805460018101825560009190915290517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b60039092029182015594517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19c860155517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19d90940193909355505050565b600054610baf90826108f2565b60009081556001600160a01b038316815260016020526040902054610bd490826108f2565b6001600160a01b038316600081815260016020526040808220939093559151909183156108fc02918491818181858888f19350505050158015610c1b573d6000803e3d6000fd5b505050565b60008184841115610c445760405162461bcd60e51b815260040161036f9190610db2565b50600061033c8486610e07565b60008183610c725760405162461bcd60e51b815260040161036f9190610db2565b50600061033c8486610d90565b6001600160a01b038116811461056c57600080fd5b600060208284031215610ca657600080fd5b813561093481610c7f565b600060208284031215610cc357600080fd5b5035919050565b60008060408385031215610cdd57600080fd5b8235610ce881610c7f565b946020939093013593505050565b6020808252601a908201527f43616c6c6572206973206e6f7420746865206f70657261746f72000000000000604082015260600190565b634e487b7160e01b600052601160045260246000fd5b60008219821115610d5657610d56610d2d565b500190565b634e487b7160e01b600052603260045260246000fd5b6000816000190483118215151615610d8b57610d8b610d2d565b500290565b600082610dad57634e487b7160e01b600052601260045260246000fd5b500490565b600060208083528351808285015260005b81811015610ddf57858101830151858201604001528201610dc3565b81811115610df1576000604083870101525b50601f01601f1916929092016040019392505050565b600082821015610e1957610e19610d2d565b50039056fea2646970667358221220c3832a007f746534b88e2040c0b91f601dd8f6f6e86bd8616b43228157da383c64736f6c634300080800337d8f3d9291db7e540ea10a43e300f1330c3e9148157349babe42ac2601a2a3e9a2646970667358221220a3542f106e1bd8410e7f3f1ecfd523bac8589cba2233843a57d19d858774e80c64736f6c63430008080033"
)

type hardForkValidatorsV3 struct {
}

func (s *hardForkValidatorsV3) GetName() string {
	return ValidatorsV2ContractName
}

func (s *hardForkValidatorsV3) Update(config *params.ChainConfig, height *big.Int, state *state.StateDB) (err error) {
	contractCode := common.FromHex(validatorV3Code)

	//write code to sys contract
	state.SetCode(ValidatorsV2ContractAddr, contractCode)
	log.Debug("Write code to system contract account", "addr", ValidatorsV2ContractAddr.String(), "code", validatorV3Code)

	return
}

func (s *hardForkValidatorsV3) Execute(state *state.StateDB, header *types.Header, chainContext core.ChainContext, config *params.ChainConfig) (err error) {
	//First, get top validators from the old contract
	v0 := NewValidatorV0()
	topVals, err := v0.GetTopValidators(state, header, chainContext, config)
	if err != nil {
		log.Error("getTopValidators from V0 failed", "err", err)
		return err
	}

	// initialize v1 contract
	method := "initialize"
	data, err := GetInteractiveABI()[ValidatorsV2ContractName].Pack(method, topVals)
	if err != nil {
		log.Error("Can't pack data for initialize", "error", err)
		return err
	}

	msg := vmcaller.NewLegacyMessage(header.Coinbase, &ValidatorsV2ContractAddr, 0, new(big.Int), math.MaxUint64, new(big.Int), data, false)
	_, err = vmcaller.ExecuteMsg(msg, state, header, chainContext, config)

	return
}
