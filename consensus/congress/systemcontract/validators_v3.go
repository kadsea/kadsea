package systemcontract

import (
	"math"
	"math/big"

	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/consensus/congress/vmcaller"
	"github.com/ethereum/go-ethereum/core"
	"github.com/ethereum/go-ethereum/core/state"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/log"
	"github.com/ethereum/go-ethereum/params"
)

const (
	validatorV3Code = "0x6080604052600436106200022e5760003560e01c80638a11d7c9116200012f578063be64569211620000ad578063c4e2f07a1162000078578063c4e2f07a14620006eb578063c967f90f1462000710578063d6eb3de1146200073b578063e7c9d4b51462000753578063e8363f6c146200077857600080fd5b8063be6456921462000676578063c1d7dd781462000696578063c253c38414620006ae578063c2a672e014620006c657600080fd5b80639de7025811620000fa5780639de7025814620005b5578063a097724214620005cd578063a224cee714620005f2578063a22b0f6e1462000617578063bbe4f6db146200063c57600080fd5b80638a11d7c9146200050d5780638b0e9f3f146200054457806393a5b1b6146200055c57806398e3b626146200059057600080fd5b806340550a1c11620001bd57806363fc5e71116200018857806363fc5e7114620004085780636969a25c14620004425780637ad229da14620004675780637f4f95fa14620004ad57806380d2dde114620004e857600080fd5b806340550a1c146200038157806340a141ff14620003a657806348cd4cb114620003cb5780634b3d500b14620003e357600080fd5b806330fcb67c11620001fe57806330fcb67c14620002d15780633438174914620002ea57806338b67b8b14620003335780633a061bd3146200036957600080fd5b8062362a771462000233578063158ef93e146200026d5780631b5e358c14620002895780632647620414620002ba575b600080fd5b3480156200024057600080fd5b50620002586200025236600462003c41565b620007a9565b60405190151581526020015b60405180910390f35b3480156200027a57600080fd5b50600054620002589060ff1681565b3480156200029657600080fd5b50620002a161f20081565b6040516001600160a01b03909116815260200162000264565b62000258620002cb36600462003c41565b620008d4565b620002e8620002e236600462003c41565b62000d5d565b005b348015620002f757600080fd5b50620003246200030936600462003c41565b6001600160a01b031660009081526013602052604090205490565b60405190815260200162000264565b3480156200034057600080fd5b50620003586200035236600462003ca7565b62000f8d565b604051620002649392919062003d2a565b3480156200037657600080fd5b50620002a161f10081565b3480156200038e57600080fd5b5062000258620003a036600462003c41565b6200123e565b348015620003b357600080fd5b50620002e8620003c536600462003c41565b620012b0565b348015620003d857600080fd5b506200032460015481565b348015620003f057600080fd5b50620002a16200040236600462003d73565b62001311565b3480156200041557600080fd5b50620003246200042736600462003c41565b6001600160a01b03166000908152600f602052604090205490565b3480156200044f57600080fd5b50620002a16200046136600462003d73565b6200133c565b3480156200047457600080fd5b50620003246200048636600462003d8d565b6001600160a01b039091166000908152601060209081526040808320938352929052205490565b348015620004ba57600080fd5b50620004d2620004cc36600462003dba565b6200134d565b6040805192835260208301919091520162000264565b348015620004f557600080fd5b50620002e86200050736600462003d8d565b62001382565b3480156200051a57600080fd5b50620005326200052c36600462003c41565b6200171e565b60405162000264949392919062003e43565b3480156200055157600080fd5b506200032460085481565b3480156200056957600080fd5b50620005816200057b36600462003d73565b6200181a565b60405162000264919062003e7d565b3480156200059d57600080fd5b5062000258620005af36600462003c41565b6200197e565b348015620005c257600080fd5b5062000581620019e7565b348015620005da57600080fd5b5062000358620005ec36600462003e92565b62001a4b565b348015620005ff57600080fd5b50620002e86200061136600462003ca7565b62001c5c565b3480156200062457600080fd5b50620002a16200063636600462003d73565b6200222b565b3480156200064957600080fd5b50620002a16200065b36600462003c41565b600c602052600090815260409020546001600160a01b031681565b3480156200068357600080fd5b506200032469021e19e0c9bab240000081565b348015620006a357600080fd5b506200032460095481565b348015620006bb57600080fd5b50620004d26200223c565b348015620006d357600080fd5b5062000258620006e536600462003d8d565b62002253565b348015620006f857600080fd5b50620003246200070a36600462003dba565b62002674565b3480156200071d57600080fd5b5062000727601581565b60405161ffff909116815260200162000264565b3480156200074857600080fd5b50620002a161f30081565b3480156200076057600080fd5b50620002e86200077236600462003ef8565b62002737565b3480156200078557600080fd5b50620003246200079736600462003c41565b60046020526000908152604090205481565b336000818152600460205260408120805490829055909190801562000849576040516001600160a01b0383169082156108fc029083906000818181858888f19350505050158015620007ff573d6000803e3d6000fd5b50604080518281524260208201526001600160a01b0380871692908516917f51a69b4502f660774c9339825c7b5adbf0b8622289134647e29728ec5d9b3bb9910160405180910390a35b6001600160a01b038085166000908152600c6020526040902054168015620008c957604051630c00007b60e41b81526001600160a01b03848116600483015282169063c00007b090602401600060405180830381600087803b158015620008af57600080fd5b505af1158015620008c4573d6000803e3d6000fd5b505050505b506001949350505050565b6000805460ff16620009035760405162461bcd60e51b8152600401620008fa9062003fdb565b60405180910390fd5b336000818152600d60205260409020543490620009219082620029c5565b6001600160a01b038084166000908152600d602052604080822093909355600b5483516325dff9d160e01b815284519294859492909216926325dff9d192600480840193919291829003018186803b1580156200097d57600080fd5b505afa15801562000992573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620009b8919062004001565b9150915081431015620009fb5760405162461bcd60e51b815260206004820152600a6024820152697374617274426c6f636b60b01b6044820152606401620008fa565b8043111562000a385760405162461bcd60e51b8152602060048201526008602482015267656e64426c6f636b60c01b6044820152606401620008fa565b6001600160a01b03808716600081815260026020526040902091861614801562000a92575060016001600160a01b03881660009081526002602052604090205460ff16600381111562000a8f5762000a8f62003df2565b14155b1562000b0557600181015469021e19e0c9bab24000009062000ab59086620029c5565b101562000b055760405162461bcd60e51b815260206004820152601860248201527f5374616b696e6720636f696e73206e6f7420656e6f75676800000000000000006044820152606401620008fa565b6001600160a01b038086166000908152600360209081526040808320938b168352929052205462000b8457600380820180546001600160a01b03808916600081815260209586526040808220938e1682529286529182206001908101849055830184559281529290922090910180546001600160a01b03191690911790555b600181015462000bd357866001600160a01b03167fbc822c457926e0706c445f2b613394c8a2bf34b3b4335915e3865b90829ce38b600160405162000bca919062004026565b60405180910390a25b600181015462000be49085620029c5565b600180830191909155815460ff16600381111562000c065762000c0662003df2565b1462000c1857805460ff191660011781555b62000c2887826001015462002a2f565b6001600160a01b038086166000908152600360209081526040808320938b168352929052205462000c5a9085620029c5565b6001600160a01b038087166000908152600360209081526040808320938c168352929052205560085462000c8f9085620029c5565b6008556001600160a01b038781166000908152600c602052604090819020549051630991d88160e21b81528783166004820152911690819063264762049087906024016000604051808303818588803b15801562000cec57600080fd5b505af115801562000d01573d6000803e3d6000fd5b5050604080518981524260208201526001600160a01b03808e1695508b1693507fb9ba725934532316cffe10975da6eb25ad49c2d1c294d982c46c9f8d684ee07592500160405180910390a3600196505050505050505b919050565b33411462000d9b5760405162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b6044820152606401620008fa565b436000908152600e6020908152604080832083805290915290205460ff161562000e085760405162461bcd60e51b815260206004820152601960248201527f426c6f636b20697320616c7265616479207265776172646564000000000000006044820152606401620008fa565b60005460ff1662000e2d5760405162461bcd60e51b8152600401620008fa9062003fdb565b436000818152600e602090815260408083208380529091529020805460ff191660019081179091555433913491101562000eee576001600160a01b0382166000908152600f6020526040812080549162000e878362004059565b9091555050600a54604051631e88772760e01b81526001600160a01b03848116600483015290911690631e88772790602401600060405180830381600087803b15801562000ed457600080fd5b505af115801562000ee9573d6000803e3d6000fd5b505050505b6000811162000efc57505050565b6001600160a01b03821660009081526002602052604081205460ff16600381111562000f2c5762000f2c62003df2565b141562000f3857505050565b62000f44818462002e44565b604080518281524260208201526001600160a01b038416917f7dc4e5df59513708dca355b8706273a5df7b810a4cec8019f2a4b9bb166a1a04910160405180910390a250505b50565b60608080838067ffffffffffffffff81111562000fae5762000fae62003ee2565b60405190808252806020026020018201604052801562000fd8578160200160208202803683370190505b5093508067ffffffffffffffff81111562000ff75762000ff762003ee2565b60405190808252806020026020018201604052801562001021578160200160208202803683370190505b5092508067ffffffffffffffff81111562001040576200104062003ee2565b6040519080825280602002602001820160405280156200106a578160200160208202803683370190505b50915060005b818110156200123557600087878381811062001090576200109062004077565b9050602002016020810190620010a7919062003c41565b6001600160a01b038082166000908152600c602052604081205492935091169081156200114c576040516246613160e11b81526001600160a01b038481166004830152831690628cc2629060240160206040518083038186803b1580156200110e57600080fd5b505afa15801562001123573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906200114991906200408d565b90505b8086858151811062001162576200116262004077565b60200260200101818152505060046000846001600160a01b03166001600160a01b0316815260200190815260200160002054878581518110620011a957620011a962004077565b602002602001018181525050868481518110620011ca57620011ca62004077565b6020026020010151868581518110620011e757620011e762004077565b6020026020010151620011fb9190620040a7565b88858151811062001210576200121062004077565b60200260200101818152505050505080806200122c9062004059565b91505062001070565b50509250925092565b6000805b600554811015620012a757826001600160a01b0316600582815481106200126d576200126d62004077565b6000918252602090912001546001600160a01b03161415620012925750600192915050565b806200129e8162004059565b91505062001242565b50600092915050565b3361f20014620012fa5760405162461bcd60e51b815260206004820152601460248201527350756e69736820636f6e7472616374206f6e6c7960601b6044820152606401620008fa565b6006546001101562000f8a5762000f8a8162003737565b600681815481106200132257600080fd5b6000918252602090912001546001600160a01b0316905081565b600581815481106200132257600080fd5b6001600160a01b03828116600090815260036020908152604080832093851683529290522080546001909101545b9250929050565b3361f20014620013cc5760405162461bcd60e51b815260206004820152601460248201527350756e69736820636f6e7472616374206f6e6c7960601b6044820152606401620008fa565b8160006001600160a01b03841660009081526002602052604090205460ff166003811115620013ff57620013ff62003df2565b1415620014455760405162461bcd60e51b815260206004820152601360248201527215985b1a59185d1bdc881b9bdd08195e1a5cdd606a1b6044820152606401620008fa565b6001600160a01b0380821660009081526003602090815260408083209387168352928152828220600290915291902081548085111562001483578094505b846200149157505050505050565b84811415620015e6576003820154620014ad90600190620040c2565b836001015414620015a557600382018054620014cc90600190620040c2565b81548110620014df57620014df62004077565b9060005260206000200160009054906101000a90046001600160a01b03168260030184600101548154811062001519576200151962004077565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b03160217905550826001015460036000846003018660010154815481106200156c576200156c62004077565b60009182526020808320909101546001600160a01b0390811684528382019490945260409283018220938b168252929092529020600101555b81600301805480620015bb57620015bb620040dc565b600082815260208120820160001990810180546001600160a01b031916905590910190915560018401555b8254620015f490866200377c565b835560018201546200160790866200377c565b60018301556008546200161b90866200377c565b6008556001600160a01b0384166000908152600d60205260409020546200164390866200377c565b6001600160a01b038581166000818152600d60209081526040808320959095558a84168252600c905283902054925163f3fef3a360e01b8152600481019190915260248101889052911690819063f3fef3a390604401600060405180830381600087803b158015620016b457600080fd5b505af1158015620016c9573d6000803e3d6000fd5b5050604080518981524260208201526001600160a01b03808c169450891692507f449002ae18e748d69a55f38514400d64f966492e593e32d6e9b8b24db98a0bc1910160405180910390a350505050505b5050565b6001600160a01b03811660009081526002602052604080822081516080810190925280548392839260609284929190829060ff16600381111562001766576200176662003df2565b60038111156200177a576200177a62003df2565b8152602001600182015481526020016002820154815260200160038201805480602002602001604051908101604052809291908181526020018280548015620017ed57602002820191906000526020600020905b81546001600160a01b03168152600190910190602001808311620017ce575b505050919092525050815160208301516040840151606090940151919a9099509297509550909350505050565b600b54604080516325dff9d160e01b815281516060936000936001600160a01b03909116926325dff9d19260048083019392829003018186803b1580156200186157600080fd5b505afa15801562001876573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906200189c919062004001565b915050600081118015620018b05750808310155b156200191b5760068054806020026020016040519081016040528092919081815260200182805480156200190e57602002820191906000526020600020905b81546001600160a01b03168152600190910190602001808311620018ef575b5050505050915050919050565b60078054806020026020016040519081016040528092919081815260200182805480156200190e576020028201919060005260206000209081546001600160a01b03168152600190910190602001808311620018ef575050505050915050919050565b6000805b600654811015620012a757826001600160a01b031660068281548110620019ad57620019ad62004077565b6000918252602090912001546001600160a01b03161415620019d25750600192915050565b80620019de8162004059565b91505062001982565b6060600580548060200260200160405190810160405280929190818152602001828054801562001a4157602002820191906000526020600020905b81546001600160a01b0316815260019091019060200180831162001a22575b5050505050905090565b60608080848067ffffffffffffffff81111562001a6c5762001a6c62003ee2565b60405190808252806020026020018201604052801562001a96578160200160208202803683370190505b5093508067ffffffffffffffff81111562001ab55762001ab562003ee2565b60405190808252806020026020018201604052801562001adf578160200160208202803683370190505b5092508067ffffffffffffffff81111562001afe5762001afe62003ee2565b60405190808252806020026020018201604052801562001b28578160200160208202803683370190505b50915060005b8181101562001c5157600088888381811062001b4e5762001b4e62004077565b905060200201602081019062001b65919062003c41565b6001600160a01b03811660009081526010602090815260408083208b845290915290205487519192509087908490811062001ba45762001ba462004077565b6020908102919091018101919091526001600160a01b03821660009081526011825260408082208a83529092522054855186908490811062001bea5762001bea62004077565b6020908102919091018101919091526001600160a01b03821660009081526012825260408082208a83529092522054845185908490811062001c305762001c3062004077565b6020908102919091010152508062001c488162004059565b91505062001b2e565b505093509350939050565b60005460ff161562001ca75760405162461bcd60e51b8152602060048201526013602482015272105b1c9958591e481a5b9a5d1a585b1a5e9959606a1b6044820152606401620008fa565b600a80546001600160a01b031990811661f20017909155600b805490911661f30017905560005b81811015620021df57600083838381811062001cee5762001cee62004077565b905060200201602081019062001d05919062003c41565b6001600160a01b0316141562001d5e5760405162461bcd60e51b815260206004820152601960248201527f496e76616c69642076616c696461746f722061646472657373000000000000006044820152606401620008fa565b62001d8e83838381811062001d775762001d7762004077565b9050602002016020810190620003a0919062003c41565b62001df457600583838381811062001daa5762001daa62004077565b905060200201602081019062001dc1919062003c41565b81546001810183556000928352602090922090910180546001600160a01b0319166001600160a01b039092169190911790555b62001e2483838381811062001e0d5762001e0d62004077565b9050602002016020810190620005af919062003c41565b62001eea57600683838381811062001e405762001e4062004077565b905060200201602081019062001e57919062003c41565b81546001810183556000928352602090922090910180546001600160a01b0319166001600160a01b03909216919091179055600783838381811062001ea05762001ea062004077565b905060200201602081019062001eb7919062003c41565b81546001810183556000928352602090922090910180546001600160a01b0319166001600160a01b039092169190911790555b60006002600085858581811062001f055762001f0562004077565b905060200201602081019062001f1c919062003c41565b6001600160a01b0316815260208101919091526040016000205460ff16600381111562001f4d5762001f4d62003df2565b141562001fc25760016002600085858581811062001f6f5762001f6f62004077565b905060200201602081019062001f86919062003c41565b6001600160a01b031681526020810191909152604001600020805460ff1916600183600381111562001fbc5762001fbc62003df2565b02179055505b6000600c8185858581811062001fdc5762001fdc62004077565b905060200201602081019062001ff3919062003c41565b6001600160a01b039081168252602082019290925260400160002054161415620021ca5760008383838181106200202e576200202e62004077565b905060200201602081019062002045919062003c41565b60405160200162002069919060609190911b6001600160601b031916815260140190565b60405160208183030381529060405280519060200120905060008185858581811062002099576200209962004077565b9050602002016020810190620020b0919062003c41565b604051620020be9062003b57565b6001600160a01b0390911681526020018190604051809103906000f5905080158015620020ef573d6000803e3d6000fd5b50905080600c60008787878181106200210c576200210c62004077565b905060200201602081019062002123919062003c41565b6001600160a01b039081168252602082019290925260400160002080546001600160a01b0319169290911691909117905584848481811062002169576200216962004077565b905060200201602081019062002180919062003c41565b604080516001600160a01b03848116825242602083015292909216917f5e5b474625449a92e2b1a6f9f183435f09402d6897ae7f8779c72142ed11170b910160405180910390a250505b80620021d68162004059565b91505062001cce565b507feacea8f3c22f06c0b18306bdb04d0a967255129e8ce0094debb0a0ff89d006b56005604051620022129190620040f2565b60405180910390a150506000805460ff19166001179055565b600781815481106200132257600080fd5b6000806200224b6000620037c0565b915091509091565b6000805460ff16620022795760405162461bcd60e51b8152600401620008fa9062003fdb565b3360006001600160a01b03851660009081526002602052604090205460ff166003811115620022ac57620022ac62003df2565b1415620022f25760405162461bcd60e51b815260206004820152601360248201527215985b1a59185d1bdc881b9bdd08195e1a5cdd606a1b6044820152606401620008fa565b6001600160a01b03808216600090815260036020908152604080832093881683529281528282206002909152919020815480861115620023755760405162461bcd60e51b815260206004820152601860248201527f596f7520646f6e2774206861766520616e79207374616b6500000000000000006044820152606401620008fa565b85811415620024ca5760038201546200239190600190620040c2565b8360010154146200248957600382018054620023b090600190620040c2565b81548110620023c357620023c362004077565b9060005260206000200160009054906101000a90046001600160a01b031682600301846001015481548110620023fd57620023fd62004077565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b031602179055508260010154600360008460030186600101548154811062002450576200245062004077565b60009182526020808320909101546001600160a01b0390811684528382019490945260409283018220938c168252929092529020600101555b816003018054806200249f576200249f620040dc565b600082815260208120820160001990810180546001600160a01b031916905590910190915560018401555b8254620024d890876200377c565b83556001820154620024eb90876200377c565b6001830155600854620024ff90876200377c565b6008556001600160a01b0384166000908152600d60205260409020546200252790876200377c565b6001600160a01b038086166000818152600d602052604090209290925588161415620025a45762002558876200197e565b15620025a457825469021e19e0c9bab24000001115620025a45760405162461bcd60e51b8152600401620008fa906020808252600490820152630333030360e41b604082015260600190565b6001600160a01b038781166000908152600c60205260409081902054905163f3fef3a360e01b8152868316600482015260248101899052911690819063f3fef3a390604401600060405180830381600087803b1580156200260457600080fd5b505af115801562002619573d6000803e3d6000fd5b5050604080518a81524260208201526001600160a01b03808d169450891692507f449002ae18e748d69a55f38514400d64f966492e593e32d6e9b8b24db98a0bc1910160405180910390a36001955050505050505b92915050565b6001600160a01b038181166000908152600c60205260408082205490516246613160e11b815285841660048201529192169082908290628cc2629060240160206040518083038186803b158015620026cb57600080fd5b505afa158015620026e0573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906200270691906200408d565b6001600160a01b0386166000908152600460205260409020549091506200272e9082620029c5565b95945050505050565b334114620027755760405162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b6044820152606401620008fa565b436000908152600e602090815260408083206001845290915290205460ff1615620027e35760405162461bcd60e51b815260206004820152601a60248201527f56616c696461746f727320616c726561647920757064617465640000000000006044820152606401620008fa565b60005460ff16620028085760405162461bcd60e51b8152600401620008fa9062003fdb565b816200281581436200415a565b15620028575760405162461bcd60e51b815260206004820152601060248201526f426c6f636b2065706f6368206f6e6c7960801b6044820152606401620008fa565b6000828152600e6020908152604080832060018085529252909120805460ff191690911790558351620028c45760405162461bcd60e51b815260206004820152601460248201527356616c696461746f722073657420656d7074792160601b6044820152606401620008fa565b600b54604080516325dff9d160e01b815281516000936001600160a01b0316926325dff9d19260048082019391829003018186803b1580156200290657600080fd5b505afa1580156200291b573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019062002941919062004001565b915050600081118015620029555750808310155b15620029be57600580546200296d9160079162003b65565b5084516200298390600590602088019062003bba565b507feacea8f3c22f06c0b18306bdb04d0a967255129e8ce0094debb0a0ff89d006b585604051620029b5919062003e7d565b60405180910390a15b5050505050565b600080620029d48385620040a7565b90508381101562002a285760405162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f7700000000006044820152606401620008fa565b9392505050565b60005b60065481101562002a9357826001600160a01b03166006828154811062002a5d5762002a5d62004077565b6000918252602090912001546001600160a01b0316141562002a7e57505050565b8062002a8a8162004059565b91505062002a32565b506006546015111562002be85760068054600181019091557ff652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d3f0180546001600160a01b0319166001600160a01b038481169182179092556000908152600c6020526040902054166200171a576040516001600160601b0319606084901b1660208201526000906034016040516020818303038152906040528051906020012090506000818460405162002b469062003b57565b6001600160a01b0390911681526020018190604051809103906000f590508015801562002b77573d6000803e3d6000fd5b506001600160a01b038581166000818152600c602090815260409182902080546001600160a01b031916948616948517905581519384524290840152929350917f5e5b474625449a92e2b1a6f9f183435f09402d6897ae7f8779c72142ed11170b910160405180910390a250505050565b600060026000600660008154811062002c055762002c0562004077565b60009182526020808320909101546001600160a01b03168352820192909252604001812060019081015492505b60065481101562002ce45782600260006006848154811062002c585762002c5862004077565b60009182526020808320909101546001600160a01b03168352820192909252604001902060010154101562002ccf57600260006006838154811062002ca15762002ca162004077565b60009182526020808320909101546001600160a01b0316835282019290925260400190206001015492509050805b8062002cdb8162004059565b91505062002c32565b5081831162002cf35750505050565b6001600160a01b038481166000908152600c60205260409020541662002df9576040516001600160601b0319606086901b1660208201526000906034016040516020818303038152906040528051906020012090506000818660405162002d5a9062003b57565b6001600160a01b0390911681526020018190604051809103906000f590508015801562002d8b573d6000803e3d6000fd5b506001600160a01b038781166000818152600c602090815260409182902080546001600160a01b031916948616948517905581519384524290840152929350917f5e5b474625449a92e2b1a6f9f183435f09402d6897ae7f8779c72142ed11170b910160405180910390a250505b836006828154811062002e105762002e1062004077565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b0316021790555050505050565b8162002e4e575050565b60008062002e5c83620037c0565b90925090508062002e6d5750505050565b60008083620031e957600062002e848785620038e6565b905062002e9e62002e9682866200392a565b88906200377c565b925060005b600554811015620030835760006005828154811062002ec65762002ec662004077565b6000918252602090912001546001600160a01b0316905060036001600160a01b03821660009081526002602052604090205460ff16600381111562002f0f5762002f0f62003df2565b1415801562002f305750876001600160a01b0316816001600160a01b031614155b156200306d576001600160a01b03811660009081526004602052604090205462002f5b9084620029c5565b6001600160a01b03821660009081526004602090815260408083209390935560139052205462002f8c9084620029c5565b6001600160a01b0382166000908152601360209081526040808320939093556010815282822043835290522054909350839062002fca9084620029c5565b6001600160a01b038216600081815260106020908152604080832043808552908352818420959095559282526011815282822093825292909252902054620030139084620029c5565b6001600160a01b0382166000818152601160209081526040808320438452825291829020939093555185815290917f7d8f3d9291db7e540ea10a43e300f1330c3e9148157349babe42ac2601a2a3e9910160405180910390a25b50806200307a8162004059565b91505062002ea3565b506000831180156200309d57506001600160a01b03821615155b15620031e0576001600160a01b038216600090815260046020526040902054620030c89084620029c5565b6001600160a01b0383166000908152600460209081526040808320939093556010815282822043835290522054620031019084620029c5565b6001600160a01b0383166000818152601060209081526040808320438085529083528184209590955592825260118152828220938252929092529020546200314a9084620029c5565b6001600160a01b038316600081815260116020908152604080832043845282528083209490945591815260139091522054620031879084620029c5565b6001600160a01b038316600081815260136020526040908190209290925590517f7d8f3d9291db7e540ea10a43e300f1330c3e9148157349babe42ac2601a2a3e990620031d79086815260200190565b60405180910390a25b50505050505050565b6000805b600554811015620036335760006005828154811062003210576200321062004077565b6000918252602090912001546001600160a01b0316905060036001600160a01b03821660009081526002602052604090205460ff16600381111562003259576200325962003df2565b141580156200327a5750876001600160a01b0316816001600160a01b031614155b156200361c576000620032c3620032938960026200392a565b6001600160a01b038416600090815260026020526040902060010154620032bc908d906200392a565b90620038e6565b905080620032d35750506200361e565b6001600160a01b0382166000908152600460205260409020549194508491620032fd9082620029c5565b6001600160a01b0383166000908152600460209081526040808320939093556011815282822043835290522054620033369082620029c5565b6001600160a01b038381166000818152601160209081526040808320438452825280832095909555828252600c90528381205493516246613160e11b815260048101929092529290911691908290628cc2629060240160206040518083038186803b158015620033a557600080fd5b505afa158015620033ba573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620033e091906200408d565b9050816001600160a01b031663abaa9916846040518263ffffffff1660e01b81526004016000604051808303818588803b1580156200341e57600080fd5b505af115801562003433573d6000803e3d6000fd5b50506040516246613160e11b81526001600160a01b0388811660048301526000945086169250628cc262915060240160206040518083038186803b1580156200347b57600080fd5b505afa15801562003490573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620034b691906200408d565b9050620034f3620034c88383620040c2565b6001600160a01b038716600090815260126020908152604080832043845290915290205490620029c5565b6001600160a01b038616600090815260126020908152604080832043845290915290205562003553620035288560026200392a565b6001600160a01b038716600090815260106020908152604080832043845290915290205490620029c5565b6001600160a01b0386166000908152601060209081526040808320438452909152902055620035a8620035888560026200392a565b6001600160a01b038a1660009081526013602052604090205490620029c5565b6001600160a01b03808a166000908152601360209081526040918290209390935551868152908716917f7d8f3d9291db7e540ea10a43e300f1330c3e9148157349babe42ac2601a2a3e9910160405180910390a2620036156200360d8560026200392a565b8890620029c5565b9650505050505b505b806200362a8162004059565b915050620031ed565b506200364087826200377c565b92506000831180156200365b57506001600160a01b03821615155b15620031e0576001600160a01b038216600090815260046020526040902054620036869084620029c5565b6001600160a01b0383166000908152600460209081526040808320939093556011815282822043835290522054620036bf9084620029c5565b6001600160a01b038316600081815260116020908152604080832043808552908352818420959095559282526010815282822093825292909252812080548592906200370d908490620040a7565b90915550506001600160a01b038216600090815260136020526040902054620031879084620029c5565b6001600160a01b03811660009081526002602052604081205460ff16600381111562003767576200376762003df2565b1415620037715750565b62000f8a81620039b1565b600062002a2883836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f77000081525062003aee565b60008060005b600554811015620038e05760036002600060058481548110620037ed57620037ed62004077565b60009182526020808320909101546001600160a01b0316835282019290925260400190205460ff16600381111562003829576200382962003df2565b141580156200386557506005818154811062003849576200384962004077565b6000918252602090912001546001600160a01b03858116911614155b15620038cb57620038b9600260006005848154811062003889576200388962004077565b60009182526020808320909101546001600160a01b031683528201929092526040019020600101548490620029c5565b925081620038c78162004059565b9250505b80620038d78162004059565b915050620037c6565b50915091565b600062002a2883836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f00000000000081525062003b24565b6000826200393b575060006200266e565b600062003949838562004171565b90508262003958858362004193565b1462002a285760405162461bcd60e51b815260206004820152602160248201527f536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f6044820152607760f81b6064820152608401620008fa565b60005b60065481108015620039c857506006546001105b156200171a5760068181548110620039e457620039e462004077565b6000918252602090912001546001600160a01b038381169116141562003ad95760065462003a1590600190620040c2565b811462003a9f576006805462003a2e90600190620040c2565b8154811062003a415762003a4162004077565b600091825260209091200154600680546001600160a01b03909216918390811062003a705762003a7062004077565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b031602179055505b600680548062003ab35762003ab3620040dc565b600082815260209020810160001990810180546001600160a01b03191690550190555050565b8062003ae58162004059565b915050620039b4565b6000818484111562003b155760405162461bcd60e51b8152600401620008fa9190620041aa565b5060006200272e8486620040c2565b6000818362003b485760405162461bcd60e51b8152600401620008fa9190620041aa565b5060006200272e848662004193565b610edc806200420383390190565b82805482825590600052602060002090810192821562003ba85760005260206000209182015b8281111562003ba857825482559160010191906001019062003b8b565b5062003bb692915062003c12565b5090565b82805482825590600052602060002090810192821562003ba8579160200282015b8281111562003ba857825182546001600160a01b0319166001600160a01b0390911617825560209092019160019091019062003bdb565b5b8082111562003bb6576000815560010162003c13565b80356001600160a01b038116811462000d5857600080fd5b60006020828403121562003c5457600080fd5b62002a288262003c29565b60008083601f84011262003c7257600080fd5b50813567ffffffffffffffff81111562003c8b57600080fd5b6020830191508360208260051b85010111156200137b57600080fd5b6000806020838503121562003cbb57600080fd5b823567ffffffffffffffff81111562003cd357600080fd5b62003ce18582860162003c5f565b90969095509350505050565b600081518084526020808501945080840160005b8381101562003d1f5781518752958201959082019060010162003d01565b509495945050505050565b60608152600062003d3f606083018662003ced565b828103602084015262003d53818662003ced565b9050828103604084015262003d69818562003ced565b9695505050505050565b60006020828403121562003d8657600080fd5b5035919050565b6000806040838503121562003da157600080fd5b62003dac8362003c29565b946020939093013593505050565b6000806040838503121562003dce57600080fd5b62003dd98362003c29565b915062003de96020840162003c29565b90509250929050565b634e487b7160e01b600052602160045260246000fd5b600081518084526020808501945080840160005b8381101562003d1f5781516001600160a01b03168752958201959082019060010162003e1c565b60006004861062003e585762003e5862003df2565b8582528460208301528360408301526080606083015262003d69608083018462003e08565b60208152600062002a28602083018462003e08565b60008060006040848603121562003ea857600080fd5b833567ffffffffffffffff81111562003ec057600080fd5b62003ece8682870162003c5f565b909790965060209590950135949350505050565b634e487b7160e01b600052604160045260246000fd5b60008060006060848603121562003f0e57600080fd5b833567ffffffffffffffff8082111562003f2757600080fd5b818601915086601f83011262003f3c57600080fd5b813560208282111562003f535762003f5362003ee2565b8160051b604051601f19603f8301168101818110868211171562003f7b5762003f7b62003ee2565b60405292835281830193508481018201928a84111562003f9a57600080fd5b948201945b8386101562003fc35762003fb38662003c29565b8552948201949382019362003f9f565b9a918901359950506040909701359695505050505050565b6020808252600c908201526b139bdd081a5b9a5d081e595d60a21b604082015260600190565b600080604083850312156200401557600080fd5b505080516020909101519092909150565b60208101600383106200403d576200403d62003df2565b91905290565b634e487b7160e01b600052601160045260246000fd5b600060001982141562004070576200407062004043565b5060010190565b634e487b7160e01b600052603260045260246000fd5b600060208284031215620040a057600080fd5b5051919050565b60008219821115620040bd57620040bd62004043565b500190565b600082821015620040d757620040d762004043565b500390565b634e487b7160e01b600052603160045260246000fd5b6020808252825482820181905260008481528281209092916040850190845b81811015620041385783546001600160a01b03168352600193840193928501920162004111565b50909695505050505050565b634e487b7160e01b600052601260045260246000fd5b6000826200416c576200416c62004144565b500690565b60008160001904831182151516156200418e576200418e62004043565b500290565b600082620041a557620041a562004144565b500490565b600060208083528351808285015260005b81811015620041d957858101830151858201604001528201620041bb565b81811115620041ec576000604083870101525b50601f01601f191692909201604001939250505056fe608060405234801561001057600080fd5b50604051610edc380380610edc83398101604081905261002f91610102565b60028054336001600160a01b031991821617909155600580549091166001600160a01b03929092169190911790556040805160608101825243815260006020820181815292820181815260048054600181018255925291517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b60039092029182015591517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19c830155517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19d90910155610132565b60006020828403121561011457600080fd5b81516001600160a01b038116811461012b57600080fd5b9392505050565b610d9b806101416000396000f3fe6080604052600436106100a65760003560e01c806370a082311161006457806370a082311461016a578063714b4658146101a0578063abaa9916146101d6578063c00007b0146101de578063e673df8a146101fe578063f3fef3a31461021e57600080fd5b80628cc262146100ab57806318160ddd146100de57806326476204146100f35780633a5381b5146101085780633f9e3f0414610140578063446a2ec814610155575b600080fd5b3480156100b757600080fd5b506100cb6100c6366004610bf4565b61023e565b6040519081526020015b60405180910390f35b3480156100ea57600080fd5b506000546100cb565b610106610101366004610bf4565b6102cf565b005b34801561011457600080fd5b50600554610128906001600160a01b031681565b6040516001600160a01b0390911681526020016100d5565b34801561014c57600080fd5b506100cb610414565b34801561016157600080fd5b506100cb61042a565b34801561017657600080fd5b506100cb610185366004610bf4565b6001600160a01b031660009081526001602052604090205490565b3480156101ac57600080fd5b506100cb6101bb366004610bf4565b6001600160a01b031660009081526003602052604090205490565b61010661043d565b3480156101ea57600080fd5b506101066101f9366004610bf4565b6104be565b34801561020a57600080fd5b50600254610128906001600160a01b031681565b34801561022a57600080fd5b50610106610239366004610c11565b610623565b600080610249610757565b604001519050600061025a846107d1565b6040908101516001600160a01b03861660009081526003602052918220600101549092506102c6906102c0670de0b6b3a76400006102ba61029b8888610864565b6001600160a01b038b16600090815260016020526040902054906108af565b9061092e565b90610970565b95945050505050565b6002546001600160a01b031633146103025760405162461bcd60e51b81526004016102f990610c3d565b60405180910390fd5b806001600160a01b03811615610383576001600160a01b038116600090815260036020908152604091829020825180840190935280548352600101549082015261034b8261023e565b6020820152610358610414565b81526001600160a01b0382166000908152600360209081526040909120825181559101516001909101555b34806103c25760405162461bcd60e51b815260206004820152600e60248201526d043616e6e6f74207374616b6520360941b60448201526064016102f9565b6103cc83826109cf565b826001600160a01b03167f9e71bc8eea02a63969f509818f2dafb9254532904319f9dbda79b67bd34a5f3d8260405161040791815260200190565b60405180910390a2505050565b600454600090610425906001610864565b905090565b6000610434610757565b60400151905090565b6002546001600160a01b031633146104675760405162461bcd60e51b81526004016102f990610c3d565b34806104705750565b61047981610a21565b6005546040518281526001600160a01b03909116907f7d8f3d9291db7e540ea10a43e300f1330c3e9148157349babe42ac2601a2a3e99060200160405180910390a250565b6002546001600160a01b031633146104e85760405162461bcd60e51b81526004016102f990610c3d565b806001600160a01b03811615610569576001600160a01b03811660009081526003602090815260409182902082518084019093528054835260010154908201526105318261023e565b602082015261053e610414565b81526001600160a01b0382166000908152600360209081526040909120825181559101516001909101555b6001600160a01b038216600090815260036020526040902060010154801561061e576001600160a01b0383166000818152600360205260408082206001018290555183156108fc0291849190818181858888f193505050501580156105d2573d6000803e3d6000fd5b50600554604080518381524260208201526001600160a01b03928316928616917f51a69b4502f660774c9339825c7b5adbf0b8622289134647e29728ec5d9b3bb9910160405180910390a35b505050565b6002546001600160a01b0316331461064d5760405162461bcd60e51b81526004016102f990610c3d565b816001600160a01b038116156106ce576001600160a01b03811660009081526003602090815260409182902082518084019093528054835260010154908201526106968261023e565b60208201526106a3610414565b81526001600160a01b0382166000908152600360209081526040909120825181559101516001909101555b600082116107125760405162461bcd60e51b8152602060048201526011602482015270043616e6e6f74207769746864726177203607c1b60448201526064016102f9565b61071c8383610b04565b826001600160a01b03167f7084f5476618d8e60b11ef0d7d3f06914655adb8793e28ff7f018d4c76d505d58360405161040791815260200190565b61077b60405180606001604052806000815260200160008152602001600081525090565b6004610785610414565b8154811061079557610795610c74565b90600052602060002090600302016040518060600160405290816000820154815260200160018201548152602001600282015481525050905090565b6107f560405180606001604052806000815260200160008152602001600081525090565b6004610816836001600160a01b031660009081526003602052604090205490565b8154811061082657610826610c74565b906000526020600020906003020160405180606001604052908160008201548152602001600182015481526020016002820154815250509050919050565b60006108a683836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f770000815250610b7d565b90505b92915050565b6000826108be575060006108a9565b60006108ca8385610ca0565b9050826108d78583610cbf565b146108a65760405162461bcd60e51b815260206004820152602160248201527f536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f6044820152607760f81b60648201526084016102f9565b60006108a683836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f000000000000815250610bae565b60008061097d8385610ce1565b9050838110156108a65760405162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f77000000000060448201526064016102f9565b6000546109dc9082610970565b60009081556001600160a01b038316815260016020526040902054610a019082610970565b6001600160a01b0390921660009081526001602052604090209190915550565b6000610a2b610757565b6040015190506000610a5b610a54610a4260005490565b6102ba86670de0b6b3a76400006108af565b8390610970565b60408051606081018252438152602081019586529081019182526004805460018101825560009190915290517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b60039092029182015593517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19c850155517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19d909301929092555050565b600054610b119082610864565b60009081556001600160a01b038316815260016020526040902054610b369082610864565b6001600160a01b038316600081815260016020526040808220939093559151909183156108fc02918491818181858888f1935050505015801561061e573d6000803e3d6000fd5b60008184841115610ba15760405162461bcd60e51b81526004016102f99190610cf9565b5060006102c68486610d4e565b60008183610bcf5760405162461bcd60e51b81526004016102f99190610cf9565b5060006102c68486610cbf565b6001600160a01b0381168114610bf157600080fd5b50565b600060208284031215610c0657600080fd5b81356108a681610bdc565b60008060408385031215610c2457600080fd5b8235610c2f81610bdc565b946020939093013593505050565b6020808252601a908201527f43616c6c6572206973206e6f7420746865206f70657261746f72000000000000604082015260600190565b634e487b7160e01b600052603260045260246000fd5b634e487b7160e01b600052601160045260246000fd5b6000816000190483118215151615610cba57610cba610c8a565b500290565b600082610cdc57634e487b7160e01b600052601260045260246000fd5b500490565b60008219821115610cf457610cf4610c8a565b500190565b600060208083528351808285015260005b81811015610d2657858101830151858201604001528201610d0a565b81811115610d38576000604083870101525b50601f01601f1916929092016040019392505050565b600082821015610d6057610d60610c8a565b50039056fea26469706673582212209d5d1aaddef089e48bab9216a6960641a0f40869b4b9368c7faab70a3add8f8564736f6c63430008080033a26469706673582212204396d951922e3b8d45de41765ecaf4060794b8132f739789da9540cc1fa494a364736f6c63430008080033"
)

type hardForkValidatorsV3 struct {
}

func (s *hardForkValidatorsV3) GetName() string {
	return ValidatorsV2ContractName
}

func (s *hardForkValidatorsV3) Update(config *params.ChainConfig, height *big.Int, state *state.StateDB) (err error) {
	contractCode := common.FromHex(validatorV3Code)

	//write code to sys contract
	state.SetCode(ValidatorsV2ContractAddr, contractCode)
	log.Debug("Write code to system contract account", "addr", ValidatorsV2ContractAddr.String(), "code", validatorV3Code)

	return
}

func (s *hardForkValidatorsV3) Execute(state *state.StateDB, header *types.Header, chainContext core.ChainContext, config *params.ChainConfig) (err error) {
	//First, get top validators from the old contract
	v0 := NewValidatorV0()
	topVals, err := v0.GetTopValidators(state, header, chainContext, config)
	if err != nil {
		log.Error("getTopValidators from V0 failed", "err", err)
		return err
	}

	// initialize v1 contract
	method := "initialize"
	data, err := GetInteractiveABI()[ValidatorsV2ContractName].Pack(method, topVals)
	if err != nil {
		log.Error("Can't pack data for initialize", "error", err)
		return err
	}

	msg := vmcaller.NewLegacyMessage(header.Coinbase, &ValidatorsV2ContractAddr, 0, new(big.Int), math.MaxUint64, new(big.Int), data, false)
	_, err = vmcaller.ExecuteMsg(msg, state, header, chainContext, config)

	return
}
