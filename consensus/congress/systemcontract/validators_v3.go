package systemcontract

import (
	"math"
	"math/big"

	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/consensus/congress/vmcaller"
	"github.com/ethereum/go-ethereum/core"
	"github.com/ethereum/go-ethereum/core/state"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/log"
	"github.com/ethereum/go-ethereum/params"
)

const (
	validatorV3Code = "0x608060405260043610620001fe5760003560e01c80638a11d7c91162000117578063c1d7dd7811620000a1578063c967f90f116200006c578063c967f90f14620005ff578063d6eb3de1146200062a578063e8363f6c1462000642578063ea10f8ad146200067357600080fd5b8063c1d7dd781462000585578063c253c384146200059d578063c2a672e014620005b5578063c4e2f07a14620005da57600080fd5b8063a224cee711620000e2578063a224cee714620004ee578063afeea1151462000513578063bbe4f6db146200052b578063be645692146200056557600080fd5b80638a11d7c914620004535780638b0e9f3f146200048a57806398e3b62614620004a25780639de7025814620004c757600080fd5b806340550a1c11620001995780636969a25c11620001645780636969a25c146200039a5780637ad229da14620003bf5780637f4f95fa14620003f357806380d2dde1146200042e57600080fd5b806340550a1c146200030657806340a141ff146200032b5780634b3d500b14620003505780636846992a146200037557600080fd5b80632647620411620001da57806326476204146200028a57806330fcb67c14620002a157806338b67b8b14620002ba5780633a061bd314620002ee57600080fd5b8062362a771462000203578063158ef93e146200023d5780631b5e358c1462000259575b600080fd5b3480156200021057600080fd5b506200022862000222366004620034f3565b62000698565b60405190151581526020015b60405180910390f35b3480156200024a57600080fd5b50600054620002289060ff1681565b3480156200026657600080fd5b506200027161f20081565b6040516001600160a01b03909116815260200162000234565b620002286200029b366004620034f3565b620007b5565b620002b8620002b2366004620034f3565b62000c3b565b005b348015620002c757600080fd5b50620002df620002d936600462003559565b62000e35565b6040516200023491906200359f565b348015620002fb57600080fd5b506200027161f10081565b3480156200031357600080fd5b506200022862000325366004620034f3565b62000fc7565b3480156200033857600080fd5b50620002b86200034a366004620034f3565b62001039565b3480156200035d57600080fd5b50620002716200036f366004620035e5565b6200109a565b3480156200038257600080fd5b50620002b86200039436600462003615565b620010c5565b348015620003a757600080fd5b5062000271620003b9366004620035e5565b62001340565b348015620003cc57600080fd5b50620003e4620003de366004620036ee565b62001351565b60405190815260200162000234565b3480156200040057600080fd5b5062000418620004123660046200371b565b62001423565b6040805192835260208301919091520162000234565b3480156200043b57600080fd5b50620002b86200044d366004620036ee565b62001458565b3480156200046057600080fd5b506200047862000472366004620034f3565b620017f4565b604051620002349493929190620037af565b3480156200049757600080fd5b50620003e460065481565b348015620004af57600080fd5b5062000228620004c1366004620034f3565b620018f0565b348015620004d457600080fd5b50620004df62001959565b604051620002349190620037f3565b348015620004fb57600080fd5b50620002b86200050d36600462003559565b620019bd565b3480156200052057600080fd5b50620004df62001f2b565b3480156200053857600080fd5b50620002716200054a366004620034f3565b600a602052600090815260409020546001600160a01b031681565b3480156200057257600080fd5b50620003e469021e19e0c9bab240000081565b3480156200059257600080fd5b50620003e460075481565b348015620005aa57600080fd5b506200041862001f8d565b348015620005c257600080fd5b5062000228620005d4366004620036ee565b62001fa4565b348015620005e757600080fd5b50620003e4620005f93660046200371b565b620023c3565b3480156200060c57600080fd5b5062000616601581565b60405161ffff909116815260200162000234565b3480156200063757600080fd5b506200027161f30081565b3480156200064f57600080fd5b50620003e462000661366004620034f3565b60036020526000908152604090205481565b3480156200068057600080fd5b50620002df6200069236600462003808565b6200247e565b336000818152600360205260408120805490829055909190801562000738576040516001600160a01b0383169082156108fc029083906000818181858888f19350505050158015620006ee573d6000803e3d6000fd5b50604080518281524260208201526001600160a01b0380871692908516917f51a69b4502f660774c9339825c7b5adbf0b8622289134647e29728ec5d9b3bb9910160405180910390a35b6001600160a01b038481166000908152600a602052604090819020549051630c00007b60e41b81528483166004820152911690819063c00007b090602401600060405180830381600087803b1580156200079157600080fd5b505af1158015620007a6573d6000803e3d6000fd5b50600198975050505050505050565b6000805460ff16620007e45760405162461bcd60e51b8152600401620007db9062003861565b60405180910390fd5b336000818152600b60205260409020543490620008029082620025ed565b6001600160a01b038084166000908152600b60205260408082209390935560095483516325dff9d160e01b815284519294859492909216926325dff9d192600480840193919291829003018186803b1580156200085e57600080fd5b505afa15801562000873573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019062000899919062003887565b9150915081431015620008dc5760405162461bcd60e51b815260206004820152600a6024820152697374617274426c6f636b60b01b6044820152606401620007db565b80431115620009195760405162461bcd60e51b8152602060048201526008602482015267656e64426c6f636b60c01b6044820152606401620007db565b6001600160a01b03808716600081815260016020526040902091861614801562000973575060016001600160a01b03881660009081526001602052604090205460ff16600381111562000970576200097062003753565b14155b15620009e657600181015469021e19e0c9bab240000090620009969086620025ed565b1015620009e65760405162461bcd60e51b815260206004820152601860248201527f5374616b696e6720636f696e73206e6f7420656e6f75676800000000000000006044820152606401620007db565b6001600160a01b038086166000908152600260209081526040808320938b168352929052205462000a62576003810180546001600160a01b038088166000818152600260209081526040808320948e16835293815292812060019081018590558401855593845292200180546001600160a01b03191690911790555b600181015462000ab157866001600160a01b03167fbc822c457926e0706c445f2b613394c8a2bf34b3b4335915e3865b90829ce38b600160405162000aa89190620038ac565b60405180910390a25b600181015462000ac29085620025ed565b600180830191909155815460ff16600381111562000ae45762000ae462003753565b1462000af657805460ff191660011781555b62000b0687826001015462002657565b6001600160a01b038086166000908152600260209081526040808320938b168352929052205462000b389085620025ed565b6001600160a01b038087166000908152600260209081526040808320938c168352929052205560065462000b6d9085620025ed565b6006556001600160a01b038781166000908152600a602052604090819020549051630991d88160e21b81528783166004820152911690819063264762049087906024016000604051808303818588803b15801562000bca57600080fd5b505af115801562000bdf573d6000803e3d6000fd5b5050604080518981524260208201526001600160a01b03808e1695508b1693507fb9ba725934532316cffe10975da6eb25ad49c2d1c294d982c46c9f8d684ee07592500160405180910390a3600196505050505050505b919050565b33411462000c795760405162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b6044820152606401620007db565b436000908152600c6020908152604080832083805290915290205460ff161562000ce65760405162461bcd60e51b815260206004820152601960248201527f426c6f636b20697320616c7265616479207265776172646564000000000000006044820152606401620007db565b60005460ff1662000d0b5760405162461bcd60e51b8152600401620007db9062003861565b436000908152600c602090815260408083208380529091528120805460ff19166001179055339062000d3f34600262002a6c565b905060006001600160a01b03831660009081526001602052604090205460ff16600381111562000d735762000d7362003753565b141562000d7f57505050565b600854604051631e88772760e01b81526001600160a01b03848116600483015290911690631e88772790602401600060405180830381600087803b15801562000dc757600080fd5b505af115801562000ddc573d6000803e3d6000fd5b5050505062000dec818462002ab0565b604080518281524260208201526001600160a01b038416917f7dc4e5df59513708dca355b8706273a5df7b810a4cec8019f2a4b9bb166a1a04910160405180910390a250505b50565b6060818067ffffffffffffffff81111562000e545762000e54620035ff565b60405190808252806020026020018201604052801562000e7e578160200160208202803683370190505b50915060005b8181101562000fbf57600085858381811062000ea45762000ea4620038c9565b905060200201602081019062000ebb9190620034f3565b6001600160a01b038082166000908152600a6020526040812054929350911690811562000f60576040516246613160e11b81526001600160a01b038481166004830152831690628cc2629060240160206040518083038186803b15801562000f2257600080fd5b505afa15801562000f37573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019062000f5d9190620038df565b90505b6001600160a01b03831660009081526003602052604090205462000f8590826200390f565b86858151811062000f9a5762000f9a620038c9565b602002602001018181525050505050808062000fb6906200392a565b91505062000e84565b505092915050565b6000805b6004548110156200103057826001600160a01b03166004828154811062000ff65762000ff6620038c9565b6000918252602090912001546001600160a01b031614156200101b5750600192915050565b8062001027816200392a565b91505062000fcb565b50600092915050565b3361f20014620010835760405162461bcd60e51b815260206004820152601460248201527350756e69736820636f6e7472616374206f6e6c7960601b6044820152606401620007db565b6005546001101562000e325762000e328162003067565b60058181548110620010ab57600080fd5b6000918252602090912001546001600160a01b0316905081565b334114620011035760405162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b6044820152606401620007db565b436000908152600c602090815260408083206001845290915290205460ff1615620011715760405162461bcd60e51b815260206004820152601a60248201527f56616c696461746f727320616c726561647920757064617465640000000000006044820152606401620007db565b60005460ff16620011965760405162461bcd60e51b8152600401620007db9062003861565b80620011a381436200395e565b15620011e55760405162461bcd60e51b815260206004820152601060248201526f426c6f636b2065706f6368206f6e6c7960801b6044820152606401620007db565b436000908152600c6020908152604080832060018085529252909120805460ff191690911790558251620012535760405162461bcd60e51b815260206004820152601460248201527356616c696461746f722073657420656d7074792160601b6044820152606401620007db565b600954604080516325dff9d160e01b815281516000936001600160a01b0316926325dff9d19260048082019391829003018186803b1580156200129557600080fd5b505afa158015620012aa573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620012d0919062003887565b915050600081118015620012e45750804310155b156200133a578351620012ff9060049060208701906200344c565b507feacea8f3c22f06c0b18306bdb04d0a967255129e8ce0094debb0a0ff89d006b584604051620013319190620037f3565b60405180910390a15b50505050565b60048181548110620010ab57600080fd5b6001600160a01b038281166000908152600a602052604080822054905163fa9ada5b60e01b815260048101859052919216908290829063fa9ada5b9060240160206040518083038186803b158015620013a957600080fd5b505afa158015620013be573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620013e49190620038df565b6001600160a01b0386166000908152600d60209081526040808320888452909152902054909150620014189082906200390f565b925050505b92915050565b6001600160a01b03828116600090815260026020908152604080832093851683529290522080546001909101545b9250929050565b3361f20014620014a25760405162461bcd60e51b815260206004820152601460248201527350756e69736820636f6e7472616374206f6e6c7960601b6044820152606401620007db565b8160006001600160a01b03841660009081526001602052604090205460ff166003811115620014d557620014d562003753565b14156200151b5760405162461bcd60e51b815260206004820152601360248201527215985b1a59185d1bdc881b9bdd08195e1a5cdd606a1b6044820152606401620007db565b6001600160a01b0380821660009081526002602090815260408083209387168352928152828220600190915291902081548085111562001559578094505b846200156757505050505050565b84811415620016bc576003820154620015839060019062003975565b8360010154146200167b57600382018054620015a29060019062003975565b81548110620015b557620015b5620038c9565b9060005260206000200160009054906101000a90046001600160a01b031682600301846001015481548110620015ef57620015ef620038c9565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b0316021790555082600101546002600084600301866001015481548110620016425762001642620038c9565b60009182526020808320909101546001600160a01b0390811684528382019490945260409283018220938b168252929092529020600101555b816003018054806200169157620016916200398f565b600082815260208120820160001990810180546001600160a01b031916905590910190915560018401555b8254620016ca9086620030ac565b83556001820154620016dd9086620030ac565b6001830155600654620016f19086620030ac565b6006556001600160a01b0384166000908152600b6020526040902054620017199086620030ac565b6001600160a01b038581166000818152600b60209081526040808320959095558a84168252600a905283902054925163f3fef3a360e01b8152600481019190915260248101889052911690819063f3fef3a390604401600060405180830381600087803b1580156200178a57600080fd5b505af11580156200179f573d6000803e3d6000fd5b5050604080518981524260208201526001600160a01b03808c169450891692507f449002ae18e748d69a55f38514400d64f966492e593e32d6e9b8b24db98a0bc1910160405180910390a350505050505b5050565b6001600160a01b03811660009081526001602052604080822081516080810190925280548392839260609284929190829060ff1660038111156200183c576200183c62003753565b600381111562001850576200185062003753565b8152602001600182015481526020016002820154815260200160038201805480602002602001604051908101604052809291908181526020018280548015620018c357602002820191906000526020600020905b81546001600160a01b03168152600190910190602001808311620018a4575b505050919092525050815160208301516040840151606090940151919a9099509297509550909350505050565b6000805b6005548110156200103057826001600160a01b0316600582815481106200191f576200191f620038c9565b6000918252602090912001546001600160a01b03161415620019445750600192915050565b8062001950816200392a565b915050620018f4565b60606004805480602002602001604051908101604052809291908181526020018280548015620019b357602002820191906000526020600020905b81546001600160a01b0316815260019091019060200180831162001994575b5050505050905090565b60005460ff161562001a085760405162461bcd60e51b8152602060048201526013602482015272105b1c9958591e481a5b9a5d1a585b1a5e9959606a1b6044820152606401620007db565b600880546001600160a01b031990811661f200179091556009805490911661f30017905560005b8181101562001edf57600083838381811062001a4f5762001a4f620038c9565b905060200201602081019062001a669190620034f3565b6001600160a01b0316141562001abf5760405162461bcd60e51b815260206004820152601960248201527f496e76616c69642076616c696461746f722061646472657373000000000000006044820152606401620007db565b62001aef83838381811062001ad85762001ad8620038c9565b9050602002016020810190620003259190620034f3565b62001b5557600483838381811062001b0b5762001b0b620038c9565b905060200201602081019062001b229190620034f3565b81546001810183556000928352602090922090910180546001600160a01b0319166001600160a01b039092169190911790555b62001b8583838381811062001b6e5762001b6e620038c9565b9050602002016020810190620004c19190620034f3565b62001beb57600583838381811062001ba15762001ba1620038c9565b905060200201602081019062001bb89190620034f3565b81546001810183556000928352602090922090910180546001600160a01b0319166001600160a01b039092169190911790555b60006001600085858581811062001c065762001c06620038c9565b905060200201602081019062001c1d9190620034f3565b6001600160a01b0316815260208101919091526040016000205460ff16600381111562001c4e5762001c4e62003753565b141562001cc257600180600085858581811062001c6f5762001c6f620038c9565b905060200201602081019062001c869190620034f3565b6001600160a01b031681526020810191909152604001600020805460ff1916600183600381111562001cbc5762001cbc62003753565b02179055505b6000600a8185858581811062001cdc5762001cdc620038c9565b905060200201602081019062001cf39190620034f3565b6001600160a01b03908116825260208201929092526040016000205416141562001eca57600083838381811062001d2e5762001d2e620038c9565b905060200201602081019062001d459190620034f3565b60405160200162001d69919060609190911b6001600160601b031916815260140190565b60405160208183030381529060405280519060200120905060008185858581811062001d995762001d99620038c9565b905060200201602081019062001db09190620034f3565b60405162001dbe90620034b6565b6001600160a01b0390911681526020018190604051809103906000f590508015801562001def573d6000803e3d6000fd5b50905080600a600087878781811062001e0c5762001e0c620038c9565b905060200201602081019062001e239190620034f3565b6001600160a01b039081168252602082019290925260400160002080546001600160a01b0319169290911691909117905584848481811062001e695762001e69620038c9565b905060200201602081019062001e809190620034f3565b604080516001600160a01b03848116825242602083015292909216917f5e5b474625449a92e2b1a6f9f183435f09402d6897ae7f8779c72142ed11170b910160405180910390a250505b8062001ed6816200392a565b91505062001a2f565b507feacea8f3c22f06c0b18306bdb04d0a967255129e8ce0094debb0a0ff89d006b5600460405162001f129190620039a5565b60405180910390a150506000805460ff19166001179055565b60606005805480602002602001604051908101604052809291908181526020018280548015620019b3576020028201919060005260206000209081546001600160a01b0316815260019091019060200180831162001994575050505050905090565b60008062001f9c6000620030f0565b915091509091565b6000805460ff1662001fca5760405162461bcd60e51b8152600401620007db9062003861565b3360006001600160a01b03851660009081526001602052604090205460ff16600381111562001ffd5762001ffd62003753565b1415620020435760405162461bcd60e51b815260206004820152601360248201527215985b1a59185d1bdc881b9bdd08195e1a5cdd606a1b6044820152606401620007db565b6001600160a01b03808216600090815260026020908152604080832093881683529281528282206001909152919020815480861115620020c65760405162461bcd60e51b815260206004820152601860248201527f596f7520646f6e2774206861766520616e79207374616b6500000000000000006044820152606401620007db565b858114156200221b576003820154620020e29060019062003975565b836001015414620021da57600382018054620021019060019062003975565b81548110620021145762002114620038c9565b9060005260206000200160009054906101000a90046001600160a01b0316826003018460010154815481106200214e576200214e620038c9565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b0316021790555082600101546002600084600301866001015481548110620021a157620021a1620038c9565b60009182526020808320909101546001600160a01b0390811684528382019490945260409283018220938c168252929092529020600101555b81600301805480620021f057620021f06200398f565b600082815260208120820160001990810180546001600160a01b031916905590910190915560018401555b8254620022299087620030ac565b835560018201546200223c9087620030ac565b6001830155600654620022509087620030ac565b6006556001600160a01b0384166000908152600b6020526040902054620022789087620030ac565b6001600160a01b038086166000818152600b602052604090209290925588161415620022f557620022a987620018f0565b15620022f557825469021e19e0c9bab24000001115620022f55760405162461bcd60e51b8152600401620007db906020808252600490820152630333030360e41b604082015260600190565b6001600160a01b038781166000908152600a60205260409081902054905163f3fef3a360e01b8152868316600482015260248101899052911690819063f3fef3a390604401600060405180830381600087803b1580156200235557600080fd5b505af11580156200236a573d6000803e3d6000fd5b5050604080518a81524260208201526001600160a01b03808d169450891692507f449002ae18e748d69a55f38514400d64f966492e593e32d6e9b8b24db98a0bc1910160405180910390a3506001979650505050505050565b6001600160a01b038181166000908152600a60205260408082205490516246613160e11b815285841660048201529192169082908290628cc2629060240160206040518083038186803b1580156200241a57600080fd5b505afa1580156200242f573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620024559190620038df565b6001600160a01b038616600090815260036020526040902054909150620014189082906200390f565b6060818067ffffffffffffffff8111156200249d576200249d620035ff565b604051908082528060200260200182016040528015620024c7578160200160208202803683370190505b50915060005b83811015620025e4576000858583818110620024ed57620024ed620038c9565b9050602002016020810190620025049190620034f3565b6001600160a01b038082166000908152600a60205260408120549293509116908115620025a9576040516246613160e11b81526001600160a01b038a81166004830152831690628cc2629060240160206040518083038186803b1580156200256b57600080fd5b505afa15801562002580573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620025a69190620038df565b90505b80868581518110620025bf57620025bf620038c9565b6020026020010181815250505050508080620025db906200392a565b915050620024cd565b50509392505050565b600080620025fc83856200390f565b905083811015620026505760405162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f7700000000006044820152606401620007db565b9392505050565b60005b600554811015620026bb57826001600160a01b031660058281548110620026855762002685620038c9565b6000918252602090912001546001600160a01b03161415620026a657505050565b80620026b2816200392a565b9150506200265a565b5060055460151115620028105760058054600181019091557f036b6384b5eca791c62761152d0c79bb0604c104a5fb6f4eb0703f3154bb3db00180546001600160a01b0319166001600160a01b038481169182179092556000908152600a602052604090205416620017f0576040516001600160601b0319606084901b166020820152600090603401604051602081830303815290604052805190602001209050600081846040516200276e90620034b6565b6001600160a01b0390911681526020018190604051809103906000f59050801580156200279f573d6000803e3d6000fd5b506001600160a01b038581166000818152600a602090815260409182902080546001600160a01b031916948616948517905581519384524290840152929350917f5e5b474625449a92e2b1a6f9f183435f09402d6897ae7f8779c72142ed11170b910160405180910390a250505050565b60006001600060056000815481106200282d576200282d620038c9565b60009182526020808320909101546001600160a01b03168352820192909252604001812060019081015492505b6005548110156200290c57826001600060058481548110620028805762002880620038c9565b60009182526020808320909101546001600160a01b031683528201929092526040019020600101541015620028f7576001600060058381548110620028c957620028c9620038c9565b60009182526020808320909101546001600160a01b0316835282019290925260400190206001015492509050805b8062002903816200392a565b9150506200285a565b508183116200291b5750505050565b6001600160a01b038481166000908152600a60205260409020541662002a21576040516001600160601b0319606086901b166020820152600090603401604051602081830303815290604052805190602001209050600081866040516200298290620034b6565b6001600160a01b0390911681526020018190604051809103906000f5905080158015620029b3573d6000803e3d6000fd5b506001600160a01b038781166000818152600a602090815260409182902080546001600160a01b031916948616948517905581519384524290840152929350917f5e5b474625449a92e2b1a6f9f183435f09402d6897ae7f8779c72142ed11170b910160405180910390a250505b836005828154811062002a385762002a38620038c9565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b0316021790555050505050565b60006200265083836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f00000000000081525062003216565b8162002aba575050565b60008062002ac883620030f0565b90925090508062002ad95750505050565b6000808362002d255762002aef86600262003252565b9550600062002aff878562002a6c565b905062002b1962002b11828662003252565b8890620030ac565b925060005b60045481101562002c645760006004828154811062002b415762002b41620038c9565b6000918252602090912001546001600160a01b0316905060036001600160a01b03821660009081526001602052604090205460ff16600381111562002b8a5762002b8a62003753565b1415801562002bab5750876001600160a01b0316816001600160a01b031614155b1562002c4e576001600160a01b03811660009081526003602052604090205462002bd69084620025ed565b6001600160a01b038216600090815260036020908152604080832093909355600d815282822043835290529081208054929550859285929062002c1b9084906200390f565b90915550506040518381526001600160a01b0382169060008051602062004a1b8339815191529060200160405180910390a25b508062002c5b816200392a565b91505062002b1e565b5060008311801562002c7e57506001600160a01b03821615155b1562002d1c576001600160a01b03821660009081526003602052604090205462002ca99084620025ed565b6001600160a01b038316600090815260036020908152604080832093909355600d81528282204383529052908120805485929062002ce99084906200390f565b90915550506040518381526001600160a01b0383169060008051602062004a1b8339815191529060200160405180910390a25b50505050505050565b6000805b60045481101562002f285760006004828154811062002d4c5762002d4c620038c9565b6000918252602090912001546001600160a01b0316905060036001600160a01b03821660009081526001602052604090205460ff16600381111562002d955762002d9562003753565b1415801562002db65750876001600160a01b0316816001600160a01b031614155b1562002f12576001600160a01b03811660009081526001602081905260408220015462002df390899062002dec908d9062003252565b9062002a6c565b905062002e018482620025ed565b6001600160a01b0383166000908152600360205260409020549295509350849162002e2d9082620025ed565b6001600160a01b03808416600090815260036020908152604080832094909455600a90528281205483516355d54c8b60e11b81529351921692839263abaa99169286926004808201939182900301818588803b15801562002e8d57600080fd5b505af115801562002ea2573d6000803e3d6000fd5b5050506001600160a01b0385166000908152600d602090815260408083204384529091528120805486945090925062002edd9084906200390f565b90915550506040518281526001600160a01b0384169060008051602062004a1b8339815191529060200160405180910390a250505b508062002f1f816200392a565b91505062002d29565b5062002f358782620030ac565b925060008311801562002f5057506001600160a01b03821615155b1562002d1c576001600160a01b03821660009081526003602052604090205462002f7b9084620025ed565b6001600160a01b03808416600090815260036020908152604080832094909455600a90528281205483516355d54c8b60e11b81529351921692839263abaa99169288926004808201939182900301818588803b15801562002fdb57600080fd5b505af115801562002ff0573d6000803e3d6000fd5b5050506001600160a01b0385166000908152600d60209081526040808320438452909152812080548894509092506200302b9084906200390f565b90915550506040518481526001600160a01b0384169060008051602062004a1b8339815191529060200160405180910390a25050505050505050565b6001600160a01b03811660009081526001602052604081205460ff16600381111562003097576200309762003753565b1415620030a15750565b62000e3281620032d9565b60006200265083836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f77000081525062003416565b60008060005b6004548110156200321057600360016000600484815481106200311d576200311d620038c9565b60009182526020808320909101546001600160a01b0316835282019290925260400190205460ff16600381111562003159576200315962003753565b1415801562003195575060048181548110620031795762003179620038c9565b6000918252602090912001546001600160a01b03858116911614155b15620031fb57620031e96001600060048481548110620031b957620031b9620038c9565b60009182526020808320909101546001600160a01b031683528201929092526040019020600101548490620025ed565b925081620031f7816200392a565b9250505b8062003207816200392a565b915050620030f6565b50915091565b600081836200323a5760405162461bcd60e51b8152600401620007db9190620039eb565b50600062003249848662003a43565b95945050505050565b60008262003263575060006200141d565b600062003271838562003a5a565b90508262003280858362003a43565b14620026505760405162461bcd60e51b815260206004820152602160248201527f536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f6044820152607760f81b6064820152608401620007db565b60005b60055481108015620032f057506005546001105b15620017f057600581815481106200330c576200330c620038c9565b6000918252602090912001546001600160a01b038381169116141562003401576005546200333d9060019062003975565b8114620033c75760058054620033569060019062003975565b81548110620033695762003369620038c9565b600091825260209091200154600580546001600160a01b039092169183908110620033985762003398620038c9565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b031602179055505b6005805480620033db57620033db6200398f565b600082815260209020810160001990810180546001600160a01b03191690550190555050565b806200340d816200392a565b915050620032dc565b600081848411156200343d5760405162461bcd60e51b8152600401620007db9190620039eb565b50600062003249848662003975565b828054828255906000526020600020908101928215620034a4579160200282015b82811115620034a457825182546001600160a01b0319166001600160a01b039091161782556020909201916001909101906200346d565b50620034b2929150620034c4565b5090565b610f9e8062003a7d83390190565b5b80821115620034b25760008155600101620034c5565b80356001600160a01b038116811462000c3657600080fd5b6000602082840312156200350657600080fd5b6200265082620034db565b60008083601f8401126200352457600080fd5b50813567ffffffffffffffff8111156200353d57600080fd5b6020830191508360208260051b85010111156200145157600080fd5b600080602083850312156200356d57600080fd5b823567ffffffffffffffff8111156200358557600080fd5b620035938582860162003511565b90969095509350505050565b6020808252825182820181905260009190848201906040850190845b81811015620035d957835183529284019291840191600101620035bb565b50909695505050505050565b600060208284031215620035f857600080fd5b5035919050565b634e487b7160e01b600052604160045260246000fd5b600080604083850312156200362957600080fd5b823567ffffffffffffffff808211156200364257600080fd5b818501915085601f8301126200365757600080fd5b81356020828211156200366e576200366e620035ff565b8160051b604051601f19603f83011681018181108682111715620036965762003696620035ff565b604052928352818301935084810182019289841115620036b557600080fd5b948201945b83861015620036de57620036ce86620034db565b85529482019493820193620036ba565b9997909101359750505050505050565b600080604083850312156200370257600080fd5b6200370d83620034db565b946020939093013593505050565b600080604083850312156200372f57600080fd5b6200373a83620034db565b91506200374a60208401620034db565b90509250929050565b634e487b7160e01b600052602160045260246000fd5b600081518084526020808501945080840160005b83811015620037a45781516001600160a01b0316875295820195908201906001016200377d565b509495945050505050565b600060048610620037c457620037c462003753565b85825284602083015283604083015260806060830152620037e9608083018462003769565b9695505050505050565b60208152600062002650602083018462003769565b6000806000604084860312156200381e57600080fd5b6200382984620034db565b9250602084013567ffffffffffffffff8111156200384657600080fd5b620038548682870162003511565b9497909650939450505050565b6020808252600c908201526b139bdd081a5b9a5d081e595d60a21b604082015260600190565b600080604083850312156200389b57600080fd5b505080516020909101519092909150565b6020810160038310620038c357620038c362003753565b91905290565b634e487b7160e01b600052603260045260246000fd5b600060208284031215620038f257600080fd5b5051919050565b634e487b7160e01b600052601160045260246000fd5b60008219821115620039255762003925620038f9565b500190565b6000600019821415620039415762003941620038f9565b5060010190565b634e487b7160e01b600052601260045260246000fd5b60008262003970576200397062003948565b500690565b6000828210156200398a576200398a620038f9565b500390565b634e487b7160e01b600052603160045260246000fd5b6020808252825482820181905260008481528281209092916040850190845b81811015620035d95783546001600160a01b031683526001938401939285019201620039c4565b600060208083528351808285015260005b8181101562003a1a57858101830151858201604001528201620039fc565b8181111562003a2d576000604083870101525b50601f01601f1916929092016040019392505050565b60008262003a555762003a5562003948565b500490565b600081600019048311821515161562003a775762003a77620038f9565b50029056fe608060405234801561001057600080fd5b50604051610f9e380380610f9e83398101604081905261002f91610102565b60028054336001600160a01b031991821617909155600580549091166001600160a01b03929092169190911790556040805160608101825243815260006020820181815292820181815260048054600181018255925291517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b60039092029182015591517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19c830155517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19d90910155610132565b60006020828403121561011457600080fd5b81516001600160a01b038116811461012b57600080fd5b9392505050565b610e5d806101416000396000f3fe6080604052600436106100c15760003560e01c806370a082311161007f578063c00007b011610059578063c00007b0146101f9578063e673df8a14610219578063f3fef3a314610239578063fa9ada5b1461025957600080fd5b806370a0823114610185578063714b4658146101bb578063abaa9916146101f157600080fd5b80628cc262146100c657806318160ddd146100f9578063264762041461010e5780633a5381b5146101235780633f9e3f041461015b578063446a2ec814610170575b600080fd5b3480156100d257600080fd5b506100e66100e1366004610c9d565b61029c565b6040519081526020015b60405180910390f35b34801561010557600080fd5b506000546100e6565b61012161011c366004610c9d565b61032d565b005b34801561012f57600080fd5b50600554610143906001600160a01b031681565b6040516001600160a01b0390911681526020016100f0565b34801561016757600080fd5b506100e6610472565b34801561017c57600080fd5b506100e6610488565b34801561019157600080fd5b506100e66101a0366004610c9d565b6001600160a01b031660009081526001602052604090205490565b3480156101c757600080fd5b506100e66101d6366004610c9d565b6001600160a01b031660009081526003602052604090205490565b61012161049b565b34801561020557600080fd5b50610121610214366004610c9d565b610557565b34801561022557600080fd5b50600254610143906001600160a01b031681565b34801561024557600080fd5b50610121610254366004610cba565b6106bc565b34801561026557600080fd5b506100e6610274366004610ce6565b6005546001600160a01b03166000908152600660209081526040808320938352929052205490565b6000806102a76107f0565b60400151905060006102b88461086a565b6040908101516001600160a01b03861660009081526003602052918220600101549092506103249061031e670de0b6b3a76400006103186102f988886108fd565b6001600160a01b038b1660009081526001602052604090205490610948565b906109c7565b90610a09565b95945050505050565b6002546001600160a01b031633146103605760405162461bcd60e51b815260040161035790610cff565b60405180910390fd5b806001600160a01b038116156103e1576001600160a01b03811660009081526003602090815260409182902082518084019093528054835260010154908201526103a98261029c565b60208201526103b6610472565b81526001600160a01b0382166000908152600360209081526040909120825181559101516001909101555b34806104205760405162461bcd60e51b815260206004820152600e60248201526d043616e6e6f74207374616b6520360941b6044820152606401610357565b61042a8382610a68565b826001600160a01b03167f9e71bc8eea02a63969f509818f2dafb9254532904319f9dbda79b67bd34a5f3d8260405161046591815260200190565b60405180910390a2505050565b6004546000906104839060016108fd565b905090565b60006104926107f0565b60400151905090565b6002546001600160a01b031633146104c55760405162461bcd60e51b815260040161035790610cff565b34806104ce5750565b6005546001600160a01b0316600090815260066020908152604080832043845290915281208054839290610503908490610d4c565b90915550610512905081610aba565b6005546040518281526001600160a01b03909116907f7d8f3d9291db7e540ea10a43e300f1330c3e9148157349babe42ac2601a2a3e99060200160405180910390a250565b6002546001600160a01b031633146105815760405162461bcd60e51b815260040161035790610cff565b806001600160a01b03811615610602576001600160a01b03811660009081526003602090815260409182902082518084019093528054835260010154908201526105ca8261029c565b60208201526105d7610472565b81526001600160a01b0382166000908152600360209081526040909120825181559101516001909101555b6001600160a01b03821660009081526003602052604090206001015480156106b7576001600160a01b0383166000818152600360205260408082206001018290555183156108fc0291849190818181858888f1935050505015801561066b573d6000803e3d6000fd5b50600554604080518381524260208201526001600160a01b03928316928616917f51a69b4502f660774c9339825c7b5adbf0b8622289134647e29728ec5d9b3bb9910160405180910390a35b505050565b6002546001600160a01b031633146106e65760405162461bcd60e51b815260040161035790610cff565b816001600160a01b03811615610767576001600160a01b038116600090815260036020908152604091829020825180840190935280548352600101549082015261072f8261029c565b602082015261073c610472565b81526001600160a01b0382166000908152600360209081526040909120825181559101516001909101555b600082116107ab5760405162461bcd60e51b8152602060048201526011602482015270043616e6e6f74207769746864726177203607c1b6044820152606401610357565b6107b58383610bad565b826001600160a01b03167f7084f5476618d8e60b11ef0d7d3f06914655adb8793e28ff7f018d4c76d505d58360405161046591815260200190565b61081460405180606001604052806000815260200160008152602001600081525090565b600461081e610472565b8154811061082e5761082e610d64565b90600052602060002090600302016040518060600160405290816000820154815260200160018201548152602001600282015481525050905090565b61088e60405180606001604052806000815260200160008152602001600081525090565b60046108af836001600160a01b031660009081526003602052604090205490565b815481106108bf576108bf610d64565b906000526020600020906003020160405180606001604052908160008201548152602001600182015481526020016002820154815250509050919050565b600061093f83836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f770000815250610c26565b90505b92915050565b60008261095757506000610942565b60006109638385610d7a565b9050826109708583610d99565b1461093f5760405162461bcd60e51b815260206004820152602160248201527f536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f6044820152607760f81b6064820152608401610357565b600061093f83836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f000000000000815250610c57565b600080610a168385610d4c565b90508381101561093f5760405162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f7700000000006044820152606401610357565b600054610a759082610a09565b60009081556001600160a01b038316815260016020526040902054610a9a9082610a09565b6001600160a01b0390921660009081526001602052604090209190915550565b6000610ac46107f0565b6040015190506000610ad560005490565b905080610ae157505050565b6000610b03610afc8361031887670de0b6b3a7640000610948565b8490610a09565b60408051606081018252438152602081019687529081019182526004805460018101825560009190915290517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b60039092029182015594517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19c860155517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19d90940193909355505050565b600054610bba90826108fd565b60009081556001600160a01b038316815260016020526040902054610bdf90826108fd565b6001600160a01b038316600081815260016020526040808220939093559151909183156108fc02918491818181858888f193505050501580156106b7573d6000803e3d6000fd5b60008184841115610c4a5760405162461bcd60e51b81526004016103579190610dbb565b5060006103248486610e10565b60008183610c785760405162461bcd60e51b81526004016103579190610dbb565b5060006103248486610d99565b6001600160a01b0381168114610c9a57600080fd5b50565b600060208284031215610caf57600080fd5b813561093f81610c85565b60008060408385031215610ccd57600080fd5b8235610cd881610c85565b946020939093013593505050565b600060208284031215610cf857600080fd5b5035919050565b6020808252601a908201527f43616c6c6572206973206e6f7420746865206f70657261746f72000000000000604082015260600190565b634e487b7160e01b600052601160045260246000fd5b60008219821115610d5f57610d5f610d36565b500190565b634e487b7160e01b600052603260045260246000fd5b6000816000190483118215151615610d9457610d94610d36565b500290565b600082610db657634e487b7160e01b600052601260045260246000fd5b500490565b600060208083528351808285015260005b81811015610de857858101830151858201604001528201610dcc565b81811115610dfa576000604083870101525b50601f01601f1916929092016040019392505050565b600082821015610e2257610e22610d36565b50039056fea2646970667358221220092ff02654aefd0a4e804c1722e86dc3109bc72cf5430ed579fa0cf60e40626064736f6c634300080800337d8f3d9291db7e540ea10a43e300f1330c3e9148157349babe42ac2601a2a3e9a26469706673582212202fda4c2d2fbdd10fdc32e48b91647f9facdb80a4ffed37148c37958492b2cb4364736f6c63430008080033"
)

type hardForkValidatorsV3 struct {
}

func (s *hardForkValidatorsV3) GetName() string {
	return ValidatorsV2ContractName
}

func (s *hardForkValidatorsV3) Update(config *params.ChainConfig, height *big.Int, state *state.StateDB) (err error) {
	contractCode := common.FromHex(validatorV3Code)

	//write code to sys contract
	state.SetCode(ValidatorsV2ContractAddr, contractCode)
	log.Debug("Write code to system contract account", "addr", ValidatorsV2ContractAddr.String(), "code", validatorV3Code)

	return
}

func (s *hardForkValidatorsV3) Execute(state *state.StateDB, header *types.Header, chainContext core.ChainContext, config *params.ChainConfig) (err error) {
	//First, get top validators from the old contract
	v0 := NewValidatorV0()
	topVals, err := v0.GetTopValidators(state, header, chainContext, config)
	if err != nil {
		log.Error("getTopValidators from V0 failed", "err", err)
		return err
	}

	// initialize v1 contract
	method := "initialize"
	data, err := GetInteractiveABI()[ValidatorsV2ContractName].Pack(method, topVals)
	if err != nil {
		log.Error("Can't pack data for initialize", "error", err)
		return err
	}

	msg := vmcaller.NewLegacyMessage(header.Coinbase, &ValidatorsV2ContractAddr, 0, new(big.Int), math.MaxUint64, new(big.Int), data, false)
	_, err = vmcaller.ExecuteMsg(msg, state, header, chainContext, config)

	return
}
