package systemcontract

import (
	"math"
	"math/big"

	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/consensus/congress/vmcaller"
	"github.com/ethereum/go-ethereum/core"
	"github.com/ethereum/go-ethereum/core/state"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/log"
	"github.com/ethereum/go-ethereum/params"
)

const (
	validatorV3Code = "0x6080604052600436106200020a5760003560e01c806393a5b1b61162000117578063c1d7dd7811620000a1578063c967f90f116200006c578063c967f90f1462000632578063d6eb3de1146200065d578063e7c9d4b51462000675578063e8363f6c146200069a57600080fd5b8063c1d7dd7814620005b8578063c253c38414620005d0578063c2a672e014620005e8578063c4e2f07a146200060d57600080fd5b8063a224cee711620000e2578063a224cee71462000514578063a22b0f6e1462000539578063bbe4f6db146200055e578063be645692146200059857600080fd5b806393a5b1b6146200047e57806398e3b62614620004b25780639de7025814620004d7578063a097724214620004ef57600080fd5b806340a141ff11620001995780637f4f95fa11620001645780637f4f95fa14620003cf57806380d2dde1146200040a5780638a11d7c9146200042f5780638b0e9f3f146200046657600080fd5b806340a141ff146200033957806348cd4cb1146200035e5780634b3d500b14620003855780636969a25c14620003aa57600080fd5b806330fcb67c11620001da57806330fcb67c14620002ad57806338b67b8b14620002c65780633a061bd314620002fc57806340550a1c146200031457600080fd5b8062362a77146200020f578063158ef93e14620002495780631b5e358c1462000265578063264762041462000296575b600080fd5b3480156200021c57600080fd5b50620002346200022e3660046200383e565b620006cb565b60405190151581526020015b60405180910390f35b3480156200025657600080fd5b50600054620002349060ff1681565b3480156200027257600080fd5b506200027d61f20081565b6040516001600160a01b03909116815260200162000240565b62000234620002a73660046200383e565b620007f6565b620002c4620002be3660046200383e565b62000c7f565b005b348015620002d357600080fd5b50620002eb620002e5366004620038a4565b62000eaf565b604051620002409392919062003927565b3480156200030957600080fd5b506200027d61f10081565b3480156200032157600080fd5b5062000234620003333660046200383e565b62001160565b3480156200034657600080fd5b50620002c4620003583660046200383e565b620011d2565b3480156200036b57600080fd5b506200037660015481565b60405190815260200162000240565b3480156200039257600080fd5b506200027d620003a436600462003970565b62001233565b348015620003b757600080fd5b506200027d620003c936600462003970565b6200125e565b348015620003dc57600080fd5b50620003f4620003ee3660046200398a565b6200126f565b6040805192835260208301919091520162000240565b3480156200041757600080fd5b50620002c462000429366004620039c2565b620012a4565b3480156200043c57600080fd5b50620004546200044e3660046200383e565b62001640565b60405162000240949392919062003a40565b3480156200047357600080fd5b506200037660085481565b3480156200048b57600080fd5b50620004a36200049d36600462003970565b6200173c565b60405162000240919062003a7a565b348015620004bf57600080fd5b5062000234620004d13660046200383e565b620018a0565b348015620004e457600080fd5b50620004a362001909565b348015620004fc57600080fd5b50620002eb6200050e36600462003a8f565b6200196d565b3480156200052157600080fd5b50620002c462000533366004620038a4565b62001b7e565b3480156200054657600080fd5b506200027d6200055836600462003970565b6200214d565b3480156200056b57600080fd5b506200027d6200057d3660046200383e565b600c602052600090815260409020546001600160a01b031681565b348015620005a557600080fd5b506200037669021e19e0c9bab240000081565b348015620005c557600080fd5b506200037660095481565b348015620005dd57600080fd5b50620003f46200215e565b348015620005f557600080fd5b506200023462000607366004620039c2565b62002175565b3480156200061a57600080fd5b50620003766200062c3660046200398a565b62002596565b3480156200063f57600080fd5b5062000649601581565b60405161ffff909116815260200162000240565b3480156200066a57600080fd5b506200027d61f30081565b3480156200068257600080fd5b50620002c46200069436600462003af5565b62002659565b348015620006a757600080fd5b5062000376620006b93660046200383e565b60046020526000908152604090205481565b33600081815260046020526040812080549082905590919080156200076b576040516001600160a01b0383169082156108fc029083906000818181858888f1935050505015801562000721573d6000803e3d6000fd5b50604080518281524260208201526001600160a01b0380871692908516917f51a69b4502f660774c9339825c7b5adbf0b8622289134647e29728ec5d9b3bb9910160405180910390a35b6001600160a01b038085166000908152600c6020526040902054168015620007eb57604051630c00007b60e41b81526001600160a01b03848116600483015282169063c00007b090602401600060405180830381600087803b158015620007d157600080fd5b505af1158015620007e6573d6000803e3d6000fd5b505050505b506001949350505050565b6000805460ff16620008255760405162461bcd60e51b81526004016200081c9062003bd8565b60405180910390fd5b336000818152600d60205260409020543490620008439082620028e7565b6001600160a01b038084166000908152600d602052604080822093909355600b5483516325dff9d160e01b815284519294859492909216926325dff9d192600480840193919291829003018186803b1580156200089f57600080fd5b505afa158015620008b4573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620008da919062003bfe565b91509150814310156200091d5760405162461bcd60e51b815260206004820152600a6024820152697374617274426c6f636b60b01b60448201526064016200081c565b804311156200095a5760405162461bcd60e51b8152602060048201526008602482015267656e64426c6f636b60c01b60448201526064016200081c565b6001600160a01b038087166000818152600260205260409020918616148015620009b4575060016001600160a01b03881660009081526002602052604090205460ff166003811115620009b157620009b1620039ef565b14155b1562000a2757600181015469021e19e0c9bab240000090620009d79086620028e7565b101562000a275760405162461bcd60e51b815260206004820152601860248201527f5374616b696e6720636f696e73206e6f7420656e6f756768000000000000000060448201526064016200081c565b6001600160a01b038086166000908152600360209081526040808320938b168352929052205462000aa657600380820180546001600160a01b03808916600081815260209586526040808220938e1682529286529182206001908101849055830184559281529290922090910180546001600160a01b03191690911790555b600181015462000af557866001600160a01b03167fbc822c457926e0706c445f2b613394c8a2bf34b3b4335915e3865b90829ce38b600160405162000aec919062003c23565b60405180910390a25b600181015462000b069085620028e7565b600180830191909155815460ff16600381111562000b285762000b28620039ef565b1462000b3a57805460ff191660011781555b62000b4a87826001015462002951565b6001600160a01b038086166000908152600360209081526040808320938b168352929052205462000b7c9085620028e7565b6001600160a01b038087166000908152600360209081526040808320938c168352929052205560085462000bb19085620028e7565b6008556001600160a01b038781166000908152600c602052604090819020549051630991d88160e21b81528783166004820152911690819063264762049087906024016000604051808303818588803b15801562000c0e57600080fd5b505af115801562000c23573d6000803e3d6000fd5b5050604080518981524260208201526001600160a01b03808e1695508b1693507fb9ba725934532316cffe10975da6eb25ad49c2d1c294d982c46c9f8d684ee07592500160405180910390a3600196505050505050505b919050565b33411462000cbd5760405162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b60448201526064016200081c565b436000908152600e6020908152604080832083805290915290205460ff161562000d2a5760405162461bcd60e51b815260206004820152601960248201527f426c6f636b20697320616c72656164792072657761726465640000000000000060448201526064016200081c565b60005460ff1662000d4f5760405162461bcd60e51b81526004016200081c9062003bd8565b436000818152600e602090815260408083208380529091529020805460ff191660019081179091555433913491101562000e10576001600160a01b0382166000908152600f6020526040812080549162000da98362003c56565b9091555050600a54604051631e88772760e01b81526001600160a01b03848116600483015290911690631e88772790602401600060405180830381600087803b15801562000df657600080fd5b505af115801562000e0b573d6000803e3d6000fd5b505050505b6000811162000e1e57505050565b6001600160a01b03821660009081526002602052604081205460ff16600381111562000e4e5762000e4e620039ef565b141562000e5a57505050565b62000e66818462002d66565b604080518281524260208201526001600160a01b038416917f7dc4e5df59513708dca355b8706273a5df7b810a4cec8019f2a4b9bb166a1a04910160405180910390a250505b50565b60608080838067ffffffffffffffff81111562000ed05762000ed062003adf565b60405190808252806020026020018201604052801562000efa578160200160208202803683370190505b5093508067ffffffffffffffff81111562000f195762000f1962003adf565b60405190808252806020026020018201604052801562000f43578160200160208202803683370190505b5092508067ffffffffffffffff81111562000f625762000f6262003adf565b60405190808252806020026020018201604052801562000f8c578160200160208202803683370190505b50915060005b818110156200115757600087878381811062000fb25762000fb262003c74565b905060200201602081019062000fc991906200383e565b6001600160a01b038082166000908152600c602052604081205492935091169081156200106e576040516246613160e11b81526001600160a01b038481166004830152831690628cc2629060240160206040518083038186803b1580156200103057600080fd5b505afa15801562001045573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906200106b919062003c8a565b90505b8086858151811062001084576200108462003c74565b60200260200101818152505060046000846001600160a01b03166001600160a01b0316815260200190815260200160002054878581518110620010cb57620010cb62003c74565b602002602001018181525050868481518110620010ec57620010ec62003c74565b602002602001015186858151811062001109576200110962003c74565b60200260200101516200111d919062003ca4565b88858151811062001132576200113262003c74565b60200260200101818152505050505080806200114e9062003c56565b91505062000f92565b50509250925092565b6000805b600554811015620011c957826001600160a01b0316600582815481106200118f576200118f62003c74565b6000918252602090912001546001600160a01b03161415620011b45750600192915050565b80620011c08162003c56565b91505062001164565b50600092915050565b3361f200146200121c5760405162461bcd60e51b815260206004820152601460248201527350756e69736820636f6e7472616374206f6e6c7960601b60448201526064016200081c565b6006546001101562000eac5762000eac8162003334565b600681815481106200124457600080fd5b6000918252602090912001546001600160a01b0316905081565b600581815481106200124457600080fd5b6001600160a01b03828116600090815260036020908152604080832093851683529290522080546001909101545b9250929050565b3361f20014620012ee5760405162461bcd60e51b815260206004820152601460248201527350756e69736820636f6e7472616374206f6e6c7960601b60448201526064016200081c565b8160006001600160a01b03841660009081526002602052604090205460ff166003811115620013215762001321620039ef565b1415620013675760405162461bcd60e51b815260206004820152601360248201527215985b1a59185d1bdc881b9bdd08195e1a5cdd606a1b60448201526064016200081c565b6001600160a01b03808216600090815260036020908152604080832093871683529281528282206002909152919020815480851115620013a5578094505b84620013b357505050505050565b8481141562001508576003820154620013cf9060019062003cbf565b836001015414620014c757600382018054620013ee9060019062003cbf565b8154811062001401576200140162003c74565b9060005260206000200160009054906101000a90046001600160a01b0316826003018460010154815481106200143b576200143b62003c74565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b03160217905550826001015460036000846003018660010154815481106200148e576200148e62003c74565b60009182526020808320909101546001600160a01b0390811684528382019490945260409283018220938b168252929092529020600101555b81600301805480620014dd57620014dd62003cd9565b600082815260208120820160001990810180546001600160a01b031916905590910190915560018401555b825462001516908662003379565b8355600182015462001529908662003379565b60018301556008546200153d908662003379565b6008556001600160a01b0384166000908152600d602052604090205462001565908662003379565b6001600160a01b038581166000818152600d60209081526040808320959095558a84168252600c905283902054925163f3fef3a360e01b8152600481019190915260248101889052911690819063f3fef3a390604401600060405180830381600087803b158015620015d657600080fd5b505af1158015620015eb573d6000803e3d6000fd5b5050604080518981524260208201526001600160a01b03808c169450891692507f449002ae18e748d69a55f38514400d64f966492e593e32d6e9b8b24db98a0bc1910160405180910390a350505050505b5050565b6001600160a01b03811660009081526002602052604080822081516080810190925280548392839260609284929190829060ff166003811115620016885762001688620039ef565b60038111156200169c576200169c620039ef565b81526020016001820154815260200160028201548152602001600382018054806020026020016040519081016040528092919081815260200182805480156200170f57602002820191906000526020600020905b81546001600160a01b03168152600190910190602001808311620016f0575b505050919092525050815160208301516040840151606090940151919a9099509297509550909350505050565b600b54604080516325dff9d160e01b815281516060936000936001600160a01b03909116926325dff9d19260048083019392829003018186803b1580156200178357600080fd5b505afa15801562001798573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620017be919062003bfe565b915050600081118015620017d25750808310155b156200183d5760068054806020026020016040519081016040528092919081815260200182805480156200183057602002820191906000526020600020905b81546001600160a01b0316815260019091019060200180831162001811575b5050505050915050919050565b600780548060200260200160405190810160405280929190818152602001828054801562001830576020028201919060005260206000209081546001600160a01b0316815260019091019060200180831162001811575050505050915050919050565b6000805b600654811015620011c957826001600160a01b031660068281548110620018cf57620018cf62003c74565b6000918252602090912001546001600160a01b03161415620018f45750600192915050565b80620019008162003c56565b915050620018a4565b606060058054806020026020016040519081016040528092919081815260200182805480156200196357602002820191906000526020600020905b81546001600160a01b0316815260019091019060200180831162001944575b5050505050905090565b60608080848067ffffffffffffffff8111156200198e576200198e62003adf565b604051908082528060200260200182016040528015620019b8578160200160208202803683370190505b5093508067ffffffffffffffff811115620019d757620019d762003adf565b60405190808252806020026020018201604052801562001a01578160200160208202803683370190505b5092508067ffffffffffffffff81111562001a205762001a2062003adf565b60405190808252806020026020018201604052801562001a4a578160200160208202803683370190505b50915060005b8181101562001b7357600088888381811062001a705762001a7062003c74565b905060200201602081019062001a8791906200383e565b6001600160a01b03811660009081526010602090815260408083208b845290915290205487519192509087908490811062001ac65762001ac662003c74565b6020908102919091018101919091526001600160a01b03821660009081526011825260408082208a83529092522054855186908490811062001b0c5762001b0c62003c74565b6020908102919091018101919091526001600160a01b03821660009081526012825260408082208a83529092522054845185908490811062001b525762001b5262003c74565b6020908102919091010152508062001b6a8162003c56565b91505062001a50565b505093509350939050565b60005460ff161562001bc95760405162461bcd60e51b8152602060048201526013602482015272105b1c9958591e481a5b9a5d1a585b1a5e9959606a1b60448201526064016200081c565b600a80546001600160a01b031990811661f20017909155600b805490911661f30017905560005b818110156200210157600083838381811062001c105762001c1062003c74565b905060200201602081019062001c2791906200383e565b6001600160a01b0316141562001c805760405162461bcd60e51b815260206004820152601960248201527f496e76616c69642076616c696461746f7220616464726573730000000000000060448201526064016200081c565b62001cb083838381811062001c995762001c9962003c74565b90506020020160208101906200033391906200383e565b62001d1657600583838381811062001ccc5762001ccc62003c74565b905060200201602081019062001ce391906200383e565b81546001810183556000928352602090922090910180546001600160a01b0319166001600160a01b039092169190911790555b62001d4683838381811062001d2f5762001d2f62003c74565b9050602002016020810190620004d191906200383e565b62001e0c57600683838381811062001d625762001d6262003c74565b905060200201602081019062001d7991906200383e565b81546001810183556000928352602090922090910180546001600160a01b0319166001600160a01b03909216919091179055600783838381811062001dc25762001dc262003c74565b905060200201602081019062001dd991906200383e565b81546001810183556000928352602090922090910180546001600160a01b0319166001600160a01b039092169190911790555b60006002600085858581811062001e275762001e2762003c74565b905060200201602081019062001e3e91906200383e565b6001600160a01b0316815260208101919091526040016000205460ff16600381111562001e6f5762001e6f620039ef565b141562001ee45760016002600085858581811062001e915762001e9162003c74565b905060200201602081019062001ea891906200383e565b6001600160a01b031681526020810191909152604001600020805460ff1916600183600381111562001ede5762001ede620039ef565b02179055505b6000600c8185858581811062001efe5762001efe62003c74565b905060200201602081019062001f1591906200383e565b6001600160a01b039081168252602082019290925260400160002054161415620020ec57600083838381811062001f505762001f5062003c74565b905060200201602081019062001f6791906200383e565b60405160200162001f8b919060609190911b6001600160601b031916815260140190565b60405160208183030381529060405280519060200120905060008185858581811062001fbb5762001fbb62003c74565b905060200201602081019062001fd291906200383e565b60405162001fe09062003754565b6001600160a01b0390911681526020018190604051809103906000f590508015801562002011573d6000803e3d6000fd5b50905080600c60008787878181106200202e576200202e62003c74565b90506020020160208101906200204591906200383e565b6001600160a01b039081168252602082019290925260400160002080546001600160a01b031916929091169190911790558484848181106200208b576200208b62003c74565b9050602002016020810190620020a291906200383e565b604080516001600160a01b03848116825242602083015292909216917f5e5b474625449a92e2b1a6f9f183435f09402d6897ae7f8779c72142ed11170b910160405180910390a250505b80620020f88162003c56565b91505062001bf0565b507feacea8f3c22f06c0b18306bdb04d0a967255129e8ce0094debb0a0ff89d006b5600560405162002134919062003cef565b60405180910390a150506000805460ff19166001179055565b600781815481106200124457600080fd5b6000806200216d6000620033bd565b915091509091565b6000805460ff166200219b5760405162461bcd60e51b81526004016200081c9062003bd8565b3360006001600160a01b03851660009081526002602052604090205460ff166003811115620021ce57620021ce620039ef565b1415620022145760405162461bcd60e51b815260206004820152601360248201527215985b1a59185d1bdc881b9bdd08195e1a5cdd606a1b60448201526064016200081c565b6001600160a01b03808216600090815260036020908152604080832093881683529281528282206002909152919020815480861115620022975760405162461bcd60e51b815260206004820152601860248201527f596f7520646f6e2774206861766520616e79207374616b65000000000000000060448201526064016200081c565b85811415620023ec576003820154620022b39060019062003cbf565b836001015414620023ab57600382018054620022d29060019062003cbf565b81548110620022e557620022e562003c74565b9060005260206000200160009054906101000a90046001600160a01b0316826003018460010154815481106200231f576200231f62003c74565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b031602179055508260010154600360008460030186600101548154811062002372576200237262003c74565b60009182526020808320909101546001600160a01b0390811684528382019490945260409283018220938c168252929092529020600101555b81600301805480620023c157620023c162003cd9565b600082815260208120820160001990810180546001600160a01b031916905590910190915560018401555b8254620023fa908762003379565b835560018201546200240d908762003379565b600183015560085462002421908762003379565b6008556001600160a01b0384166000908152600d602052604090205462002449908762003379565b6001600160a01b038086166000818152600d602052604090209290925588161415620024c6576200247a87620018a0565b15620024c657825469021e19e0c9bab24000001115620024c65760405162461bcd60e51b81526004016200081c906020808252600490820152630333030360e41b604082015260600190565b6001600160a01b038781166000908152600c60205260409081902054905163f3fef3a360e01b8152868316600482015260248101899052911690819063f3fef3a390604401600060405180830381600087803b1580156200252657600080fd5b505af11580156200253b573d6000803e3d6000fd5b5050604080518a81524260208201526001600160a01b03808d169450891692507f449002ae18e748d69a55f38514400d64f966492e593e32d6e9b8b24db98a0bc1910160405180910390a36001955050505050505b92915050565b6001600160a01b038181166000908152600c60205260408082205490516246613160e11b815285841660048201529192169082908290628cc2629060240160206040518083038186803b158015620025ed57600080fd5b505afa15801562002602573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019062002628919062003c8a565b6001600160a01b038616600090815260046020526040902054909150620026509082620028e7565b95945050505050565b334114620026975760405162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b60448201526064016200081c565b436000908152600e602090815260408083206001845290915290205460ff1615620027055760405162461bcd60e51b815260206004820152601a60248201527f56616c696461746f727320616c7265616479207570646174656400000000000060448201526064016200081c565b60005460ff166200272a5760405162461bcd60e51b81526004016200081c9062003bd8565b8162002737814362003d57565b15620027795760405162461bcd60e51b815260206004820152601060248201526f426c6f636b2065706f6368206f6e6c7960801b60448201526064016200081c565b6000828152600e6020908152604080832060018085529252909120805460ff191690911790558351620027e65760405162461bcd60e51b815260206004820152601460248201527356616c696461746f722073657420656d7074792160601b60448201526064016200081c565b600b54604080516325dff9d160e01b815281516000936001600160a01b0316926325dff9d19260048082019391829003018186803b1580156200282857600080fd5b505afa1580156200283d573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019062002863919062003bfe565b915050600081118015620028775750808310155b15620028e057600580546200288f9160079162003762565b508451620028a5906005906020880190620037b7565b507feacea8f3c22f06c0b18306bdb04d0a967255129e8ce0094debb0a0ff89d006b585604051620028d7919062003a7a565b60405180910390a15b5050505050565b600080620028f6838562003ca4565b9050838110156200294a5760405162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f77000000000060448201526064016200081c565b9392505050565b60005b600654811015620029b557826001600160a01b0316600682815481106200297f576200297f62003c74565b6000918252602090912001546001600160a01b03161415620029a057505050565b80620029ac8162003c56565b91505062002954565b506006546015111562002b0a5760068054600181019091557ff652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d3f0180546001600160a01b0319166001600160a01b038481169182179092556000908152600c6020526040902054166200163c576040516001600160601b0319606084901b1660208201526000906034016040516020818303038152906040528051906020012090506000818460405162002a689062003754565b6001600160a01b0390911681526020018190604051809103906000f590508015801562002a99573d6000803e3d6000fd5b506001600160a01b038581166000818152600c602090815260409182902080546001600160a01b031916948616948517905581519384524290840152929350917f5e5b474625449a92e2b1a6f9f183435f09402d6897ae7f8779c72142ed11170b910160405180910390a250505050565b600060026000600660008154811062002b275762002b2762003c74565b60009182526020808320909101546001600160a01b03168352820192909252604001812060019081015492505b60065481101562002c065782600260006006848154811062002b7a5762002b7a62003c74565b60009182526020808320909101546001600160a01b03168352820192909252604001902060010154101562002bf157600260006006838154811062002bc35762002bc362003c74565b60009182526020808320909101546001600160a01b0316835282019290925260400190206001015492509050805b8062002bfd8162003c56565b91505062002b54565b5081831162002c155750505050565b6001600160a01b038481166000908152600c60205260409020541662002d1b576040516001600160601b0319606086901b1660208201526000906034016040516020818303038152906040528051906020012090506000818660405162002c7c9062003754565b6001600160a01b0390911681526020018190604051809103906000f590508015801562002cad573d6000803e3d6000fd5b506001600160a01b038781166000818152600c602090815260409182902080546001600160a01b031916948616948517905581519384524290840152929350917f5e5b474625449a92e2b1a6f9f183435f09402d6897ae7f8779c72142ed11170b910160405180910390a250505b836006828154811062002d325762002d3262003c74565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b0316021790555050505050565b8162002d70575050565b60008062002d7e83620033bd565b90925090508062002d8f5750505050565b600080836200309e57600062002da68785620034e3565b905062002dc062002db8828662003527565b889062003379565b925060005b60055481101562002f745760006005828154811062002de85762002de862003c74565b6000918252602090912001546001600160a01b0316905060036001600160a01b03821660009081526002602052604090205460ff16600381111562002e315762002e31620039ef565b1415801562002e525750876001600160a01b0316816001600160a01b031614155b1562002f5e576001600160a01b03811660009081526004602052604090205462002e7d9084620028e7565b6001600160a01b0382166000908152600460209081526040808320939093556010815282822043835290522054909350839062002ebb9084620028e7565b6001600160a01b03821660008181526010602090815260408083204380855290835281842095909555928252601181528282209382529290925290205462002f049084620028e7565b6001600160a01b0382166000818152601160209081526040808320438452825291829020939093555185815290917f7d8f3d9291db7e540ea10a43e300f1330c3e9148157349babe42ac2601a2a3e9910160405180910390a25b508062002f6b8162003c56565b91505062002dc5565b5060008311801562002f8e57506001600160a01b03821615155b1562003095576001600160a01b03821660009081526004602052604090205462002fb99084620028e7565b6001600160a01b038316600090815260046020908152604080832093909355601081528282204383529052205462002ff29084620028e7565b6001600160a01b0383166000818152601060209081526040808320438085529083528184209590955592825260118152828220938252929092529020546200303b9084620028e7565b6001600160a01b0383166000818152601160209081526040808320438452825291829020939093555185815290917f7d8f3d9291db7e540ea10a43e300f1330c3e9148157349babe42ac2601a2a3e9910160405180910390a25b50505050505050565b6000805b600554811015620032a857600060058281548110620030c557620030c562003c74565b6000918252602090912001546001600160a01b0316905060036001600160a01b03821660009081526002602052604090205460ff1660038111156200310e576200310e620039ef565b141580156200312f5750876001600160a01b0316816001600160a01b031614155b1562003291576001600160a01b0381166000908152600260205260408120600101546200316c90899062003165908d9062003527565b90620034e3565b9050806200317c57505062003293565b6001600160a01b0382166000908152600460205260409020549194508491620031a69082620028e7565b6001600160a01b0383166000908152600460209081526040808320939093556011815282822043835290522054620031df9082620028e7565b6001600160a01b038316600081815260116020908152604080832043808552908352818420959095559282526010815282822093825292909252902054620032289082620028e7565b6001600160a01b0383166000818152601060209081526040808320438452825291829020939093555183815290917f7d8f3d9291db7e540ea10a43e300f1330c3e9148157349babe42ac2601a2a3e9910160405180910390a26200328d8482620028e7565b9350505b505b806200329f8162003c56565b915050620030a2565b50620032b5878262003379565b9250600083118015620032d057506001600160a01b03821615155b1562003095576001600160a01b038216600090815260046020526040902054620032fb9084620028e7565b6001600160a01b03831660009081526004602090815260408083209390935560118152828220438352905220546200303b9084620028e7565b6001600160a01b03811660009081526002602052604081205460ff166003811115620033645762003364620039ef565b14156200336e5750565b62000eac81620035ae565b60006200294a83836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f770000815250620036eb565b60008060005b600554811015620034dd5760036002600060058481548110620033ea57620033ea62003c74565b60009182526020808320909101546001600160a01b0316835282019290925260400190205460ff166003811115620034265762003426620039ef565b141580156200346257506005818154811062003446576200344662003c74565b6000918252602090912001546001600160a01b03858116911614155b15620034c857620034b6600260006005848154811062003486576200348662003c74565b60009182526020808320909101546001600160a01b031683528201929092526040019020600101548490620028e7565b925081620034c48162003c56565b9250505b80620034d48162003c56565b915050620033c3565b50915091565b60006200294a83836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f00000000000081525062003721565b600082620035385750600062002590565b600062003546838562003d6e565b90508262003555858362003d90565b146200294a5760405162461bcd60e51b815260206004820152602160248201527f536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f6044820152607760f81b60648201526084016200081c565b60005b60065481108015620035c557506006546001105b156200163c5760068181548110620035e157620035e162003c74565b6000918252602090912001546001600160a01b0383811691161415620036d657600654620036129060019062003cbf565b81146200369c57600680546200362b9060019062003cbf565b815481106200363e576200363e62003c74565b600091825260209091200154600680546001600160a01b0390921691839081106200366d576200366d62003c74565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b031602179055505b6006805480620036b057620036b062003cd9565b600082815260209020810160001990810180546001600160a01b03191690550190555050565b80620036e28162003c56565b915050620035b1565b60008184841115620037125760405162461bcd60e51b81526004016200081c919062003da7565b50600062002650848662003cbf565b60008183620037455760405162461bcd60e51b81526004016200081c919062003da7565b50600062002650848662003d90565b610edc8062003e0083390190565b828054828255906000526020600020908101928215620037a55760005260206000209182015b82811115620037a557825482559160010191906001019062003788565b50620037b39291506200380f565b5090565b828054828255906000526020600020908101928215620037a5579160200282015b82811115620037a557825182546001600160a01b0319166001600160a01b03909116178255602090920191600190910190620037d8565b5b80821115620037b3576000815560010162003810565b80356001600160a01b038116811462000c7a57600080fd5b6000602082840312156200385157600080fd5b6200294a8262003826565b60008083601f8401126200386f57600080fd5b50813567ffffffffffffffff8111156200388857600080fd5b6020830191508360208260051b85010111156200129d57600080fd5b60008060208385031215620038b857600080fd5b823567ffffffffffffffff811115620038d057600080fd5b620038de858286016200385c565b90969095509350505050565b600081518084526020808501945080840160005b838110156200391c57815187529582019590820190600101620038fe565b509495945050505050565b6060815260006200393c6060830186620038ea565b8281036020840152620039508186620038ea565b90508281036040840152620039668185620038ea565b9695505050505050565b6000602082840312156200398357600080fd5b5035919050565b600080604083850312156200399e57600080fd5b620039a98362003826565b9150620039b96020840162003826565b90509250929050565b60008060408385031215620039d657600080fd5b620039e18362003826565b946020939093013593505050565b634e487b7160e01b600052602160045260246000fd5b600081518084526020808501945080840160005b838110156200391c5781516001600160a01b03168752958201959082019060010162003a19565b60006004861062003a555762003a55620039ef565b8582528460208301528360408301526080606083015262003966608083018462003a05565b6020815260006200294a602083018462003a05565b60008060006040848603121562003aa557600080fd5b833567ffffffffffffffff81111562003abd57600080fd5b62003acb868287016200385c565b909790965060209590950135949350505050565b634e487b7160e01b600052604160045260246000fd5b60008060006060848603121562003b0b57600080fd5b833567ffffffffffffffff8082111562003b2457600080fd5b818601915086601f83011262003b3957600080fd5b813560208282111562003b505762003b5062003adf565b8160051b604051601f19603f8301168101818110868211171562003b785762003b7862003adf565b60405292835281830193508481018201928a84111562003b9757600080fd5b948201945b8386101562003bc05762003bb08662003826565b8552948201949382019362003b9c565b9a918901359950506040909701359695505050505050565b6020808252600c908201526b139bdd081a5b9a5d081e595d60a21b604082015260600190565b6000806040838503121562003c1257600080fd5b505080516020909101519092909150565b602081016003831062003c3a5762003c3a620039ef565b91905290565b634e487b7160e01b600052601160045260246000fd5b600060001982141562003c6d5762003c6d62003c40565b5060010190565b634e487b7160e01b600052603260045260246000fd5b60006020828403121562003c9d57600080fd5b5051919050565b6000821982111562003cba5762003cba62003c40565b500190565b60008282101562003cd45762003cd462003c40565b500390565b634e487b7160e01b600052603160045260246000fd5b6020808252825482820181905260008481528281209092916040850190845b8181101562003d355783546001600160a01b03168352600193840193928501920162003d0e565b50909695505050505050565b634e487b7160e01b600052601260045260246000fd5b60008262003d695762003d6962003d41565b500690565b600081600019048311821515161562003d8b5762003d8b62003c40565b500290565b60008262003da25762003da262003d41565b500490565b600060208083528351808285015260005b8181101562003dd65785810183015185820160400152820162003db8565b8181111562003de9576000604083870101525b50601f01601f191692909201604001939250505056fe608060405234801561001057600080fd5b50604051610edc380380610edc83398101604081905261002f91610102565b60028054336001600160a01b031991821617909155600580549091166001600160a01b03929092169190911790556040805160608101825243815260006020820181815292820181815260048054600181018255925291517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b60039092029182015591517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19c830155517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19d90910155610132565b60006020828403121561011457600080fd5b81516001600160a01b038116811461012b57600080fd5b9392505050565b610d9b806101416000396000f3fe6080604052600436106100a65760003560e01c806370a082311161006457806370a082311461016a578063714b4658146101a0578063abaa9916146101d6578063c00007b0146101de578063e673df8a146101fe578063f3fef3a31461021e57600080fd5b80628cc262146100ab57806318160ddd146100de57806326476204146100f35780633a5381b5146101085780633f9e3f0414610140578063446a2ec814610155575b600080fd5b3480156100b757600080fd5b506100cb6100c6366004610bf4565b61023e565b6040519081526020015b60405180910390f35b3480156100ea57600080fd5b506000546100cb565b610106610101366004610bf4565b6102cf565b005b34801561011457600080fd5b50600554610128906001600160a01b031681565b6040516001600160a01b0390911681526020016100d5565b34801561014c57600080fd5b506100cb610414565b34801561016157600080fd5b506100cb61042a565b34801561017657600080fd5b506100cb610185366004610bf4565b6001600160a01b031660009081526001602052604090205490565b3480156101ac57600080fd5b506100cb6101bb366004610bf4565b6001600160a01b031660009081526003602052604090205490565b61010661043d565b3480156101ea57600080fd5b506101066101f9366004610bf4565b6104be565b34801561020a57600080fd5b50600254610128906001600160a01b031681565b34801561022a57600080fd5b50610106610239366004610c11565b610623565b600080610249610757565b604001519050600061025a846107d1565b6040908101516001600160a01b03861660009081526003602052918220600101549092506102c6906102c0670de0b6b3a76400006102ba61029b8888610864565b6001600160a01b038b16600090815260016020526040902054906108af565b9061092e565b90610970565b95945050505050565b6002546001600160a01b031633146103025760405162461bcd60e51b81526004016102f990610c3d565b60405180910390fd5b806001600160a01b03811615610383576001600160a01b038116600090815260036020908152604091829020825180840190935280548352600101549082015261034b8261023e565b6020820152610358610414565b81526001600160a01b0382166000908152600360209081526040909120825181559101516001909101555b34806103c25760405162461bcd60e51b815260206004820152600e60248201526d043616e6e6f74207374616b6520360941b60448201526064016102f9565b6103cc83826109cf565b826001600160a01b03167f9e71bc8eea02a63969f509818f2dafb9254532904319f9dbda79b67bd34a5f3d8260405161040791815260200190565b60405180910390a2505050565b600454600090610425906001610864565b905090565b6000610434610757565b60400151905090565b6002546001600160a01b031633146104675760405162461bcd60e51b81526004016102f990610c3d565b34806104705750565b61047981610a21565b6005546040518281526001600160a01b03909116907f7d8f3d9291db7e540ea10a43e300f1330c3e9148157349babe42ac2601a2a3e99060200160405180910390a250565b6002546001600160a01b031633146104e85760405162461bcd60e51b81526004016102f990610c3d565b806001600160a01b03811615610569576001600160a01b03811660009081526003602090815260409182902082518084019093528054835260010154908201526105318261023e565b602082015261053e610414565b81526001600160a01b0382166000908152600360209081526040909120825181559101516001909101555b6001600160a01b038216600090815260036020526040902060010154801561061e576001600160a01b0383166000818152600360205260408082206001018290555183156108fc0291849190818181858888f193505050501580156105d2573d6000803e3d6000fd5b50600554604080518381524260208201526001600160a01b03928316928616917f51a69b4502f660774c9339825c7b5adbf0b8622289134647e29728ec5d9b3bb9910160405180910390a35b505050565b6002546001600160a01b0316331461064d5760405162461bcd60e51b81526004016102f990610c3d565b816001600160a01b038116156106ce576001600160a01b03811660009081526003602090815260409182902082518084019093528054835260010154908201526106968261023e565b60208201526106a3610414565b81526001600160a01b0382166000908152600360209081526040909120825181559101516001909101555b600082116107125760405162461bcd60e51b8152602060048201526011602482015270043616e6e6f74207769746864726177203607c1b60448201526064016102f9565b61071c8383610b04565b826001600160a01b03167f7084f5476618d8e60b11ef0d7d3f06914655adb8793e28ff7f018d4c76d505d58360405161040791815260200190565b61077b60405180606001604052806000815260200160008152602001600081525090565b6004610785610414565b8154811061079557610795610c74565b90600052602060002090600302016040518060600160405290816000820154815260200160018201548152602001600282015481525050905090565b6107f560405180606001604052806000815260200160008152602001600081525090565b6004610816836001600160a01b031660009081526003602052604090205490565b8154811061082657610826610c74565b906000526020600020906003020160405180606001604052908160008201548152602001600182015481526020016002820154815250509050919050565b60006108a683836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f770000815250610b7d565b90505b92915050565b6000826108be575060006108a9565b60006108ca8385610ca0565b9050826108d78583610cbf565b146108a65760405162461bcd60e51b815260206004820152602160248201527f536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f6044820152607760f81b60648201526084016102f9565b60006108a683836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f000000000000815250610bae565b60008061097d8385610ce1565b9050838110156108a65760405162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f77000000000060448201526064016102f9565b6000546109dc9082610970565b60009081556001600160a01b038316815260016020526040902054610a019082610970565b6001600160a01b0390921660009081526001602052604090209190915550565b6000610a2b610757565b6040015190506000610a5b610a54610a4260005490565b6102ba86670de0b6b3a76400006108af565b8390610970565b60408051606081018252438152602081019586529081019182526004805460018101825560009190915290517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b60039092029182015593517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19c850155517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19d909301929092555050565b600054610b119082610864565b60009081556001600160a01b038316815260016020526040902054610b369082610864565b6001600160a01b038316600081815260016020526040808220939093559151909183156108fc02918491818181858888f1935050505015801561061e573d6000803e3d6000fd5b60008184841115610ba15760405162461bcd60e51b81526004016102f99190610cf9565b5060006102c68486610d4e565b60008183610bcf5760405162461bcd60e51b81526004016102f99190610cf9565b5060006102c68486610cbf565b6001600160a01b0381168114610bf157600080fd5b50565b600060208284031215610c0657600080fd5b81356108a681610bdc565b60008060408385031215610c2457600080fd5b8235610c2f81610bdc565b946020939093013593505050565b6020808252601a908201527f43616c6c6572206973206e6f7420746865206f70657261746f72000000000000604082015260600190565b634e487b7160e01b600052603260045260246000fd5b634e487b7160e01b600052601160045260246000fd5b6000816000190483118215151615610cba57610cba610c8a565b500290565b600082610cdc57634e487b7160e01b600052601260045260246000fd5b500490565b60008219821115610cf457610cf4610c8a565b500190565b600060208083528351808285015260005b81811015610d2657858101830151858201604001528201610d0a565b81811115610d38576000604083870101525b50601f01601f1916929092016040019392505050565b600082821015610d6057610d60610c8a565b50039056fea26469706673582212209d5d1aaddef089e48bab9216a6960641a0f40869b4b9368c7faab70a3add8f8564736f6c63430008080033a26469706673582212208a433425a75fc6bb4c7128e40c58d3a8ef941d274b66e8fd452a91db4057036764736f6c63430008080033"
)

type hardForkValidatorsV3 struct {
}

func (s *hardForkValidatorsV3) GetName() string {
	return ValidatorsV2ContractName
}

func (s *hardForkValidatorsV3) Update(config *params.ChainConfig, height *big.Int, state *state.StateDB) (err error) {
	contractCode := common.FromHex(validatorV3Code)

	//write code to sys contract
	state.SetCode(ValidatorsV2ContractAddr, contractCode)
	log.Debug("Write code to system contract account", "addr", ValidatorsV2ContractAddr.String(), "code", validatorV3Code)

	return
}

func (s *hardForkValidatorsV3) Execute(state *state.StateDB, header *types.Header, chainContext core.ChainContext, config *params.ChainConfig) (err error) {
	//First, get top validators from the old contract
	v0 := NewValidatorV0()
	topVals, err := v0.GetTopValidators(state, header, chainContext, config)
	if err != nil {
		log.Error("getTopValidators from V0 failed", "err", err)
		return err
	}

	// initialize v1 contract
	method := "initialize"
	data, err := GetInteractiveABI()[ValidatorsV2ContractName].Pack(method, topVals)
	if err != nil {
		log.Error("Can't pack data for initialize", "error", err)
		return err
	}

	msg := vmcaller.NewLegacyMessage(header.Coinbase, &ValidatorsV2ContractAddr, 0, new(big.Int), math.MaxUint64, new(big.Int), data, false)
	_, err = vmcaller.ExecuteMsg(msg, state, header, chainContext, config)

	return
}
