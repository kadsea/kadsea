package systemcontract

import (
	"math"
	"math/big"

	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/consensus/congress/vmcaller"
	"github.com/ethereum/go-ethereum/core"
	"github.com/ethereum/go-ethereum/core/state"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/log"
	"github.com/ethereum/go-ethereum/params"
)

const (
	validatorV3Code = "0x608060405260043610620002165760003560e01c806380d2dde11162000123578063be64569211620000ad578063c4e2f07a1162000078578063c4e2f07a1462000644578063c967f90f1462000669578063d6eb3de11462000694578063e8363f6c14620006ac578063ea10f8ad14620006dd57600080fd5b8063be64569214620005cf578063c1d7dd7814620005ef578063c253c3841462000607578063c2a672e0146200061f57600080fd5b80639de7025811620000ee5780639de702581462000531578063a224cee71462000558578063afeea115146200057d578063bbe4f6db146200059557600080fd5b806380d2dde114620004985780638a11d7c914620004bd5780638b0e9f3f14620004f457806398e3b626146200050c57600080fd5b806340a141ff11620001a55780636846992a11620001705780636846992a14620003ee5780636969a25c14620004135780637ad229da14620004385780637f4f95fa146200045d57600080fd5b806340a141ff146200034357806348cd4cb114620003685780634b3d500b146200038f57806363fc5e7114620003b457600080fd5b806330fcb67c11620001e657806330fcb67c14620002b957806338b67b8b14620002d25780633a061bd3146200030657806340550a1c146200031e57600080fd5b8062362a77146200021b578063158ef93e14620002555780631b5e358c14620002715780632647620414620002a2575b600080fd5b3480156200022857600080fd5b50620002406200023a36600462003596565b62000702565b60405190151581526020015b60405180910390f35b3480156200026257600080fd5b50600054620002409060ff1681565b3480156200027e57600080fd5b506200028961f20081565b6040516001600160a01b0390911681526020016200024c565b62000240620002b336600462003596565b6200081f565b620002d0620002ca36600462003596565b62000ca8565b005b348015620002df57600080fd5b50620002f7620002f1366004620035fc565b62000ed7565b6040516200024c919062003642565b3480156200031357600080fd5b506200028961f10081565b3480156200032b57600080fd5b50620002406200033d36600462003596565b62001069565b3480156200035057600080fd5b50620002d06200036236600462003596565b620010db565b3480156200037557600080fd5b506200038060015481565b6040519081526020016200024c565b3480156200039c57600080fd5b5062000289620003ae36600462003688565b6200113c565b348015620003c157600080fd5b5062000380620003d336600462003596565b6001600160a01b03166000908152600f602052604090205490565b348015620003fb57600080fd5b50620002d06200040d366004620036b8565b62001167565b3480156200042057600080fd5b50620002896200043236600462003688565b620013e2565b3480156200044557600080fd5b50620003806200045736600462003791565b620013f3565b3480156200046a57600080fd5b50620004826200047c366004620037be565b620014c5565b604080519283526020830191909152016200024c565b348015620004a557600080fd5b50620002d0620004b736600462003791565b620014fa565b348015620004ca57600080fd5b50620004e2620004dc36600462003596565b62001896565b6040516200024c949392919062003852565b3480156200050157600080fd5b506200038060075481565b3480156200051957600080fd5b50620002406200052b36600462003596565b62001992565b3480156200053e57600080fd5b5062000549620019fb565b6040516200024c919062003896565b3480156200056557600080fd5b50620002d062000577366004620035fc565b62001a5f565b3480156200058a57600080fd5b506200054962001fce565b348015620005a257600080fd5b5062000289620005b436600462003596565b600b602052600090815260409020546001600160a01b031681565b348015620005dc57600080fd5b506200038069021e19e0c9bab240000081565b348015620005fc57600080fd5b506200038060085481565b3480156200061457600080fd5b506200048262002030565b3480156200062c57600080fd5b50620002406200063e36600462003791565b62002047565b3480156200065157600080fd5b506200038062000663366004620037be565b62002466565b3480156200067657600080fd5b5062000680601581565b60405161ffff90911681526020016200024c565b348015620006a157600080fd5b506200028961f30081565b348015620006b957600080fd5b5062000380620006cb36600462003596565b60046020526000908152604090205481565b348015620006ea57600080fd5b50620002f7620006fc366004620038ab565b62002521565b3360008181526004602052604081208054908290559091908015620007a2576040516001600160a01b0383169082156108fc029083906000818181858888f1935050505015801562000758573d6000803e3d6000fd5b50604080518281524260208201526001600160a01b0380871692908516917f51a69b4502f660774c9339825c7b5adbf0b8622289134647e29728ec5d9b3bb9910160405180910390a35b6001600160a01b038481166000908152600b602052604090819020549051630c00007b60e41b81528483166004820152911690819063c00007b090602401600060405180830381600087803b158015620007fb57600080fd5b505af115801562000810573d6000803e3d6000fd5b50600198975050505050505050565b6000805460ff166200084e5760405162461bcd60e51b8152600401620008459062003904565b60405180910390fd5b336000818152600c602052604090205434906200086c908262002690565b6001600160a01b038084166000908152600c602052604080822093909355600a5483516325dff9d160e01b815284519294859492909216926325dff9d192600480840193919291829003018186803b158015620008c857600080fd5b505afa158015620008dd573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906200090391906200392a565b9150915081431015620009465760405162461bcd60e51b815260206004820152600a6024820152697374617274426c6f636b60b01b604482015260640162000845565b80431115620009835760405162461bcd60e51b8152602060048201526008602482015267656e64426c6f636b60c01b604482015260640162000845565b6001600160a01b038087166000818152600260205260409020918616148015620009dd575060016001600160a01b03881660009081526002602052604090205460ff166003811115620009da57620009da620037f6565b14155b1562000a5057600181015469021e19e0c9bab24000009062000a00908662002690565b101562000a505760405162461bcd60e51b815260206004820152601860248201527f5374616b696e6720636f696e73206e6f7420656e6f7567680000000000000000604482015260640162000845565b6001600160a01b038086166000908152600360209081526040808320938b168352929052205462000acf57600380820180546001600160a01b03808916600081815260209586526040808220938e1682529286529182206001908101849055830184559281529290922090910180546001600160a01b03191690911790555b600181015462000b1e57866001600160a01b03167fbc822c457926e0706c445f2b613394c8a2bf34b3b4335915e3865b90829ce38b600160405162000b1591906200394f565b60405180910390a25b600181015462000b2f908562002690565b600180830191909155815460ff16600381111562000b515762000b51620037f6565b1462000b6357805460ff191660011781555b62000b73878260010154620026fa565b6001600160a01b038086166000908152600360209081526040808320938b168352929052205462000ba5908562002690565b6001600160a01b038087166000908152600360209081526040808320938c168352929052205560075462000bda908562002690565b6007556001600160a01b038781166000908152600b602052604090819020549051630991d88160e21b81528783166004820152911690819063264762049087906024016000604051808303818588803b15801562000c3757600080fd5b505af115801562000c4c573d6000803e3d6000fd5b5050604080518981524260208201526001600160a01b03808e1695508b1693507fb9ba725934532316cffe10975da6eb25ad49c2d1c294d982c46c9f8d684ee07592500160405180910390a3600196505050505050505b919050565b33411462000ce65760405162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b604482015260640162000845565b436000908152600d6020908152604080832083805290915290205460ff161562000d535760405162461bcd60e51b815260206004820152601960248201527f426c6f636b20697320616c726561647920726577617264656400000000000000604482015260640162000845565b60005460ff1662000d785760405162461bcd60e51b8152600401620008459062003904565b436000908152600d602090815260408083208380529091528120805460ff19166001179055339062000dac34600262002b0f565b905060015443111562000de5576001600160a01b0382166000908152600f6020526040812080549162000ddf8362003982565b91905055505b6001600160a01b03821660009081526002602052604081205460ff16600381111562000e155762000e15620037f6565b141562000e2157505050565b600954604051631e88772760e01b81526001600160a01b03848116600483015290911690631e88772790602401600060405180830381600087803b15801562000e6957600080fd5b505af115801562000e7e573d6000803e3d6000fd5b5050505062000e8e818462002b53565b604080518281524260208201526001600160a01b038416917f7dc4e5df59513708dca355b8706273a5df7b810a4cec8019f2a4b9bb166a1a04910160405180910390a250505b50565b6060818067ffffffffffffffff81111562000ef65762000ef6620036a2565b60405190808252806020026020018201604052801562000f20578160200160208202803683370190505b50915060005b818110156200106157600085858381811062000f465762000f46620039a0565b905060200201602081019062000f5d919062003596565b6001600160a01b038082166000908152600b6020526040812054929350911690811562001002576040516246613160e11b81526001600160a01b038481166004830152831690628cc2629060240160206040518083038186803b15801562000fc457600080fd5b505afa15801562000fd9573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019062000fff9190620039b6565b90505b6001600160a01b038316600090815260046020526040902054620010279082620039d0565b8685815181106200103c576200103c620039a0565b6020026020010181815250505050508080620010589062003982565b91505062000f26565b505092915050565b6000805b600554811015620010d257826001600160a01b031660058281548110620010985762001098620039a0565b6000918252602090912001546001600160a01b03161415620010bd5750600192915050565b80620010c98162003982565b9150506200106d565b50600092915050565b3361f20014620011255760405162461bcd60e51b815260206004820152601460248201527350756e69736820636f6e7472616374206f6e6c7960601b604482015260640162000845565b6006546001101562000ed45762000ed4816200310a565b600681815481106200114d57600080fd5b6000918252602090912001546001600160a01b0316905081565b334114620011a55760405162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b604482015260640162000845565b436000908152600d602090815260408083206001845290915290205460ff1615620012135760405162461bcd60e51b815260206004820152601a60248201527f56616c696461746f727320616c72656164792075706461746564000000000000604482015260640162000845565b60005460ff16620012385760405162461bcd60e51b8152600401620008459062003904565b8062001245814362003a01565b15620012875760405162461bcd60e51b815260206004820152601060248201526f426c6f636b2065706f6368206f6e6c7960801b604482015260640162000845565b436000908152600d6020908152604080832060018085529252909120805460ff191690911790558251620012f55760405162461bcd60e51b815260206004820152601460248201527356616c696461746f722073657420656d7074792160601b604482015260640162000845565b600a54604080516325dff9d160e01b815281516000936001600160a01b0316926325dff9d19260048082019391829003018186803b1580156200133757600080fd5b505afa1580156200134c573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906200137291906200392a565b915050600081118015620013865750804310155b15620013dc578351620013a1906005906020870190620034ef565b507feacea8f3c22f06c0b18306bdb04d0a967255129e8ce0094debb0a0ff89d006b584604051620013d3919062003896565b60405180910390a15b50505050565b600581815481106200114d57600080fd5b6001600160a01b038281166000908152600b602052604080822054905163fa9ada5b60e01b815260048101859052919216908290829063fa9ada5b9060240160206040518083038186803b1580156200144b57600080fd5b505afa15801562001460573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620014869190620039b6565b6001600160a01b0386166000908152600e60209081526040808320888452909152902054909150620014ba908290620039d0565b925050505b92915050565b6001600160a01b03828116600090815260036020908152604080832093851683529290522080546001909101545b9250929050565b3361f20014620015445760405162461bcd60e51b815260206004820152601460248201527350756e69736820636f6e7472616374206f6e6c7960601b604482015260640162000845565b8160006001600160a01b03841660009081526002602052604090205460ff166003811115620015775762001577620037f6565b1415620015bd5760405162461bcd60e51b815260206004820152601360248201527215985b1a59185d1bdc881b9bdd08195e1a5cdd606a1b604482015260640162000845565b6001600160a01b03808216600090815260036020908152604080832093871683529281528282206002909152919020815480851115620015fb578094505b846200160957505050505050565b848114156200175e576003820154620016259060019062003a18565b8360010154146200171d57600382018054620016449060019062003a18565b81548110620016575762001657620039a0565b9060005260206000200160009054906101000a90046001600160a01b031682600301846001015481548110620016915762001691620039a0565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b0316021790555082600101546003600084600301866001015481548110620016e457620016e4620039a0565b60009182526020808320909101546001600160a01b0390811684528382019490945260409283018220938b168252929092529020600101555b8160030180548062001733576200173362003a32565b600082815260208120820160001990810180546001600160a01b031916905590910190915560018401555b82546200176c90866200314f565b835560018201546200177f90866200314f565b60018301556007546200179390866200314f565b6007556001600160a01b0384166000908152600c6020526040902054620017bb90866200314f565b6001600160a01b038581166000818152600c60209081526040808320959095558a84168252600b905283902054925163f3fef3a360e01b8152600481019190915260248101889052911690819063f3fef3a390604401600060405180830381600087803b1580156200182c57600080fd5b505af115801562001841573d6000803e3d6000fd5b5050604080518981524260208201526001600160a01b03808c169450891692507f449002ae18e748d69a55f38514400d64f966492e593e32d6e9b8b24db98a0bc1910160405180910390a350505050505b5050565b6001600160a01b03811660009081526002602052604080822081516080810190925280548392839260609284929190829060ff166003811115620018de57620018de620037f6565b6003811115620018f257620018f2620037f6565b81526020016001820154815260200160028201548152602001600382018054806020026020016040519081016040528092919081815260200182805480156200196557602002820191906000526020600020905b81546001600160a01b0316815260019091019060200180831162001946575b505050919092525050815160208301516040840151606090940151919a9099509297509550909350505050565b6000805b600654811015620010d257826001600160a01b031660068281548110620019c157620019c1620039a0565b6000918252602090912001546001600160a01b03161415620019e65750600192915050565b80620019f28162003982565b91505062001996565b6060600580548060200260200160405190810160405280929190818152602001828054801562001a5557602002820191906000526020600020905b81546001600160a01b0316815260019091019060200180831162001a36575b5050505050905090565b60005460ff161562001aaa5760405162461bcd60e51b8152602060048201526013602482015272105b1c9958591e481a5b9a5d1a585b1a5e9959606a1b604482015260640162000845565b600980546001600160a01b031990811661f20017909155600a805490911661f30017905560005b8181101562001f8257600083838381811062001af15762001af1620039a0565b905060200201602081019062001b08919062003596565b6001600160a01b0316141562001b615760405162461bcd60e51b815260206004820152601960248201527f496e76616c69642076616c696461746f72206164647265737300000000000000604482015260640162000845565b62001b9183838381811062001b7a5762001b7a620039a0565b90506020020160208101906200033d919062003596565b62001bf757600583838381811062001bad5762001bad620039a0565b905060200201602081019062001bc4919062003596565b81546001810183556000928352602090922090910180546001600160a01b0319166001600160a01b039092169190911790555b62001c2783838381811062001c105762001c10620039a0565b90506020020160208101906200052b919062003596565b62001c8d57600683838381811062001c435762001c43620039a0565b905060200201602081019062001c5a919062003596565b81546001810183556000928352602090922090910180546001600160a01b0319166001600160a01b039092169190911790555b60006002600085858581811062001ca85762001ca8620039a0565b905060200201602081019062001cbf919062003596565b6001600160a01b0316815260208101919091526040016000205460ff16600381111562001cf05762001cf0620037f6565b141562001d655760016002600085858581811062001d125762001d12620039a0565b905060200201602081019062001d29919062003596565b6001600160a01b031681526020810191909152604001600020805460ff1916600183600381111562001d5f5762001d5f620037f6565b02179055505b6000600b8185858581811062001d7f5762001d7f620039a0565b905060200201602081019062001d96919062003596565b6001600160a01b03908116825260208201929092526040016000205416141562001f6d57600083838381811062001dd15762001dd1620039a0565b905060200201602081019062001de8919062003596565b60405160200162001e0c919060609190911b6001600160601b031916815260140190565b60405160208183030381529060405280519060200120905060008185858581811062001e3c5762001e3c620039a0565b905060200201602081019062001e53919062003596565b60405162001e619062003559565b6001600160a01b0390911681526020018190604051809103906000f590508015801562001e92573d6000803e3d6000fd5b50905080600b600087878781811062001eaf5762001eaf620039a0565b905060200201602081019062001ec6919062003596565b6001600160a01b039081168252602082019290925260400160002080546001600160a01b0319169290911691909117905584848481811062001f0c5762001f0c620039a0565b905060200201602081019062001f23919062003596565b604080516001600160a01b03848116825242602083015292909216917f5e5b474625449a92e2b1a6f9f183435f09402d6897ae7f8779c72142ed11170b910160405180910390a250505b8062001f798162003982565b91505062001ad1565b507feacea8f3c22f06c0b18306bdb04d0a967255129e8ce0094debb0a0ff89d006b5600560405162001fb5919062003a48565b60405180910390a150506000805460ff19166001179055565b6060600680548060200260200160405190810160405280929190818152602001828054801562001a55576020028201919060005260206000209081546001600160a01b0316815260019091019060200180831162001a36575050505050905090565b6000806200203f600062003193565b915091509091565b6000805460ff166200206d5760405162461bcd60e51b8152600401620008459062003904565b3360006001600160a01b03851660009081526002602052604090205460ff166003811115620020a057620020a0620037f6565b1415620020e65760405162461bcd60e51b815260206004820152601360248201527215985b1a59185d1bdc881b9bdd08195e1a5cdd606a1b604482015260640162000845565b6001600160a01b03808216600090815260036020908152604080832093881683529281528282206002909152919020815480861115620021695760405162461bcd60e51b815260206004820152601860248201527f596f7520646f6e2774206861766520616e79207374616b650000000000000000604482015260640162000845565b85811415620022be576003820154620021859060019062003a18565b8360010154146200227d57600382018054620021a49060019062003a18565b81548110620021b757620021b7620039a0565b9060005260206000200160009054906101000a90046001600160a01b031682600301846001015481548110620021f157620021f1620039a0565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b0316021790555082600101546003600084600301866001015481548110620022445762002244620039a0565b60009182526020808320909101546001600160a01b0390811684528382019490945260409283018220938c168252929092529020600101555b8160030180548062002293576200229362003a32565b600082815260208120820160001990810180546001600160a01b031916905590910190915560018401555b8254620022cc90876200314f565b83556001820154620022df90876200314f565b6001830155600754620022f390876200314f565b6007556001600160a01b0384166000908152600c60205260409020546200231b90876200314f565b6001600160a01b038086166000818152600c60205260409020929092558816141562002398576200234c8762001992565b156200239857825469021e19e0c9bab24000001115620023985760405162461bcd60e51b815260040162000845906020808252600490820152630333030360e41b604082015260600190565b6001600160a01b038781166000908152600b60205260409081902054905163f3fef3a360e01b8152868316600482015260248101899052911690819063f3fef3a390604401600060405180830381600087803b158015620023f857600080fd5b505af11580156200240d573d6000803e3d6000fd5b5050604080518a81524260208201526001600160a01b03808d169450891692507f449002ae18e748d69a55f38514400d64f966492e593e32d6e9b8b24db98a0bc1910160405180910390a3506001979650505050505050565b6001600160a01b038181166000908152600b60205260408082205490516246613160e11b815285841660048201529192169082908290628cc2629060240160206040518083038186803b158015620024bd57600080fd5b505afa158015620024d2573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620024f89190620039b6565b6001600160a01b038616600090815260046020526040902054909150620014ba908290620039d0565b6060818067ffffffffffffffff811115620025405762002540620036a2565b6040519080825280602002602001820160405280156200256a578160200160208202803683370190505b50915060005b8381101562002687576000858583818110620025905762002590620039a0565b9050602002016020810190620025a7919062003596565b6001600160a01b038082166000908152600b602052604081205492935091169081156200264c576040516246613160e11b81526001600160a01b038a81166004830152831690628cc2629060240160206040518083038186803b1580156200260e57600080fd5b505afa15801562002623573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620026499190620039b6565b90505b80868581518110620026625762002662620039a0565b60200260200101818152505050505080806200267e9062003982565b91505062002570565b50509392505050565b6000806200269f8385620039d0565b905083811015620026f35760405162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f770000000000604482015260640162000845565b9392505050565b60005b6006548110156200275e57826001600160a01b031660068281548110620027285762002728620039a0565b6000918252602090912001546001600160a01b031614156200274957505050565b80620027558162003982565b915050620026fd565b5060065460151115620028b35760068054600181019091557ff652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d3f0180546001600160a01b0319166001600160a01b038481169182179092556000908152600b60205260409020541662001892576040516001600160601b0319606084901b16602082015260009060340160405160208183030381529060405280519060200120905060008184604051620028119062003559565b6001600160a01b0390911681526020018190604051809103906000f590508015801562002842573d6000803e3d6000fd5b506001600160a01b038581166000818152600b602090815260409182902080546001600160a01b031916948616948517905581519384524290840152929350917f5e5b474625449a92e2b1a6f9f183435f09402d6897ae7f8779c72142ed11170b910160405180910390a250505050565b6000600260006006600081548110620028d057620028d0620039a0565b60009182526020808320909101546001600160a01b03168352820192909252604001812060019081015492505b600654811015620029af57826002600060068481548110620029235762002923620039a0565b60009182526020808320909101546001600160a01b0316835282019290925260400190206001015410156200299a5760026000600683815481106200296c576200296c620039a0565b60009182526020808320909101546001600160a01b0316835282019290925260400190206001015492509050805b80620029a68162003982565b915050620028fd565b50818311620029be5750505050565b6001600160a01b038481166000908152600b60205260409020541662002ac4576040516001600160601b0319606086901b1660208201526000906034016040516020818303038152906040528051906020012090506000818660405162002a259062003559565b6001600160a01b0390911681526020018190604051809103906000f590508015801562002a56573d6000803e3d6000fd5b506001600160a01b038781166000818152600b602090815260409182902080546001600160a01b031916948616948517905581519384524290840152929350917f5e5b474625449a92e2b1a6f9f183435f09402d6897ae7f8779c72142ed11170b910160405180910390a250505b836006828154811062002adb5762002adb620039a0565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b0316021790555050505050565b6000620026f383836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f000000000000815250620032b9565b8162002b5d575050565b60008062002b6b8362003193565b90925090508062002b7c5750505050565b6000808362002dc85762002b92866002620032f5565b9550600062002ba2878562002b0f565b905062002bbc62002bb48286620032f5565b88906200314f565b925060005b60055481101562002d075760006005828154811062002be45762002be4620039a0565b6000918252602090912001546001600160a01b0316905060036001600160a01b03821660009081526002602052604090205460ff16600381111562002c2d5762002c2d620037f6565b1415801562002c4e5750876001600160a01b0316816001600160a01b031614155b1562002cf1576001600160a01b03811660009081526004602052604090205462002c79908462002690565b6001600160a01b038216600090815260046020908152604080832093909355600e815282822043835290529081208054929550859285929062002cbe908490620039d0565b90915550506040518381526001600160a01b0382169060008051602062004abe8339815191529060200160405180910390a25b508062002cfe8162003982565b91505062002bc1565b5060008311801562002d2157506001600160a01b03821615155b1562002dbf576001600160a01b03821660009081526004602052604090205462002d4c908462002690565b6001600160a01b038316600090815260046020908152604080832093909355600e81528282204383529052908120805485929062002d8c908490620039d0565b90915550506040518381526001600160a01b0383169060008051602062004abe8339815191529060200160405180910390a25b50505050505050565b6000805b60055481101562002fcb5760006005828154811062002def5762002def620039a0565b6000918252602090912001546001600160a01b0316905060036001600160a01b03821660009081526002602052604090205460ff16600381111562002e385762002e38620037f6565b1415801562002e595750876001600160a01b0316816001600160a01b031614155b1562002fb5576001600160a01b03811660009081526002602052604081206001015462002e9690899062002e8f908d90620032f5565b9062002b0f565b905062002ea4848262002690565b6001600160a01b0383166000908152600460205260409020549295509350849162002ed0908262002690565b6001600160a01b03808416600090815260046020818152604080842095909555600b90528382205484516355d54c8b60e11b81529451931693849363abaa99169387938381019391929182900301818588803b15801562002f3057600080fd5b505af115801562002f45573d6000803e3d6000fd5b5050506001600160a01b0385166000908152600e602090815260408083204384529091528120805486945090925062002f80908490620039d0565b90915550506040518281526001600160a01b0384169060008051602062004abe8339815191529060200160405180910390a250505b508062002fc28162003982565b91505062002dcc565b5062002fd887826200314f565b925060008311801562002ff357506001600160a01b03821615155b1562002dbf576001600160a01b0382166000908152600460205260409020546200301e908462002690565b6001600160a01b03808416600090815260046020818152604080842095909555600b90528382205484516355d54c8b60e11b81529451931693849363abaa99169389938381019391929182900301818588803b1580156200307e57600080fd5b505af115801562003093573d6000803e3d6000fd5b5050506001600160a01b0385166000908152600e6020908152604080832043845290915281208054889450909250620030ce908490620039d0565b90915550506040518481526001600160a01b0384169060008051602062004abe8339815191529060200160405180910390a25050505050505050565b6001600160a01b03811660009081526002602052604081205460ff1660038111156200313a576200313a620037f6565b1415620031445750565b62000ed4816200337c565b6000620026f383836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f770000815250620034b9565b60008060005b600554811015620032b35760036002600060058481548110620031c057620031c0620039a0565b60009182526020808320909101546001600160a01b0316835282019290925260400190205460ff166003811115620031fc57620031fc620037f6565b14158015620032385750600581815481106200321c576200321c620039a0565b6000918252602090912001546001600160a01b03858116911614155b156200329e576200328c60026000600584815481106200325c576200325c620039a0565b60009182526020808320909101546001600160a01b03168352820192909252604001902060010154849062002690565b9250816200329a8162003982565b9250505b80620032aa8162003982565b91505062003199565b50915091565b60008183620032dd5760405162461bcd60e51b815260040162000845919062003a8e565b506000620032ec848662003ae6565b95945050505050565b6000826200330657506000620014bf565b600062003314838562003afd565b90508262003323858362003ae6565b14620026f35760405162461bcd60e51b815260206004820152602160248201527f536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f6044820152607760f81b606482015260840162000845565b60005b600654811080156200339357506006546001105b15620018925760068181548110620033af57620033af620039a0565b6000918252602090912001546001600160a01b0383811691161415620034a457600654620033e09060019062003a18565b81146200346a5760068054620033f99060019062003a18565b815481106200340c576200340c620039a0565b600091825260209091200154600680546001600160a01b0390921691839081106200343b576200343b620039a0565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b031602179055505b60068054806200347e576200347e62003a32565b600082815260209020810160001990810180546001600160a01b03191690550190555050565b80620034b08162003982565b9150506200337f565b60008184841115620034e05760405162461bcd60e51b815260040162000845919062003a8e565b506000620032ec848662003a18565b82805482825590600052602060002090810192821562003547579160200282015b828111156200354757825182546001600160a01b0319166001600160a01b0390911617825560209092019160019091019062003510565b506200355592915062003567565b5090565b610f9e8062003b2083390190565b5b8082111562003555576000815560010162003568565b80356001600160a01b038116811462000ca357600080fd5b600060208284031215620035a957600080fd5b620026f3826200357e565b60008083601f840112620035c757600080fd5b50813567ffffffffffffffff811115620035e057600080fd5b6020830191508360208260051b8501011115620014f357600080fd5b600080602083850312156200361057600080fd5b823567ffffffffffffffff8111156200362857600080fd5b6200363685828601620035b4565b90969095509350505050565b6020808252825182820181905260009190848201906040850190845b818110156200367c578351835292840192918401916001016200365e565b50909695505050505050565b6000602082840312156200369b57600080fd5b5035919050565b634e487b7160e01b600052604160045260246000fd5b60008060408385031215620036cc57600080fd5b823567ffffffffffffffff80821115620036e557600080fd5b818501915085601f830112620036fa57600080fd5b8135602082821115620037115762003711620036a2565b8160051b604051601f19603f83011681018181108682111715620037395762003739620036a2565b6040529283528183019350848101820192898411156200375857600080fd5b948201945b83861015620037815762003771866200357e565b855294820194938201936200375d565b9997909101359750505050505050565b60008060408385031215620037a557600080fd5b620037b0836200357e565b946020939093013593505050565b60008060408385031215620037d257600080fd5b620037dd836200357e565b9150620037ed602084016200357e565b90509250929050565b634e487b7160e01b600052602160045260246000fd5b600081518084526020808501945080840160005b83811015620038475781516001600160a01b03168752958201959082019060010162003820565b509495945050505050565b600060048610620038675762003867620037f6565b858252846020830152836040830152608060608301526200388c60808301846200380c565b9695505050505050565b602081526000620026f360208301846200380c565b600080600060408486031215620038c157600080fd5b620038cc846200357e565b9250602084013567ffffffffffffffff811115620038e957600080fd5b620038f786828701620035b4565b9497909650939450505050565b6020808252600c908201526b139bdd081a5b9a5d081e595d60a21b604082015260600190565b600080604083850312156200393e57600080fd5b505080516020909101519092909150565b6020810160038310620039665762003966620037f6565b91905290565b634e487b7160e01b600052601160045260246000fd5b60006000198214156200399957620039996200396c565b5060010190565b634e487b7160e01b600052603260045260246000fd5b600060208284031215620039c957600080fd5b5051919050565b60008219821115620039e657620039e66200396c565b500190565b634e487b7160e01b600052601260045260246000fd5b60008262003a135762003a13620039eb565b500690565b60008282101562003a2d5762003a2d6200396c565b500390565b634e487b7160e01b600052603160045260246000fd5b6020808252825482820181905260008481528281209092916040850190845b818110156200367c5783546001600160a01b03168352600193840193928501920162003a67565b600060208083528351808285015260005b8181101562003abd5785810183015185820160400152820162003a9f565b8181111562003ad0576000604083870101525b50601f01601f1916929092016040019392505050565b60008262003af85762003af8620039eb565b500490565b600081600019048311821515161562003b1a5762003b1a6200396c565b50029056fe608060405234801561001057600080fd5b50604051610f9e380380610f9e83398101604081905261002f91610102565b60028054336001600160a01b031991821617909155600580549091166001600160a01b03929092169190911790556040805160608101825243815260006020820181815292820181815260048054600181018255925291517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b60039092029182015591517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19c830155517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19d90910155610132565b60006020828403121561011457600080fd5b81516001600160a01b038116811461012b57600080fd5b9392505050565b610e5d806101416000396000f3fe6080604052600436106100c15760003560e01c806370a082311161007f578063c00007b011610059578063c00007b0146101f9578063e673df8a14610219578063f3fef3a314610239578063fa9ada5b1461025957600080fd5b806370a0823114610185578063714b4658146101bb578063abaa9916146101f157600080fd5b80628cc262146100c657806318160ddd146100f9578063264762041461010e5780633a5381b5146101235780633f9e3f041461015b578063446a2ec814610170575b600080fd5b3480156100d257600080fd5b506100e66100e1366004610c9d565b61029c565b6040519081526020015b60405180910390f35b34801561010557600080fd5b506000546100e6565b61012161011c366004610c9d565b61032d565b005b34801561012f57600080fd5b50600554610143906001600160a01b031681565b6040516001600160a01b0390911681526020016100f0565b34801561016757600080fd5b506100e6610472565b34801561017c57600080fd5b506100e6610488565b34801561019157600080fd5b506100e66101a0366004610c9d565b6001600160a01b031660009081526001602052604090205490565b3480156101c757600080fd5b506100e66101d6366004610c9d565b6001600160a01b031660009081526003602052604090205490565b61012161049b565b34801561020557600080fd5b50610121610214366004610c9d565b610557565b34801561022557600080fd5b50600254610143906001600160a01b031681565b34801561024557600080fd5b50610121610254366004610cba565b6106bc565b34801561026557600080fd5b506100e6610274366004610ce6565b6005546001600160a01b03166000908152600660209081526040808320938352929052205490565b6000806102a76107f0565b60400151905060006102b88461086a565b6040908101516001600160a01b03861660009081526003602052918220600101549092506103249061031e670de0b6b3a76400006103186102f988886108fd565b6001600160a01b038b1660009081526001602052604090205490610948565b906109c7565b90610a09565b95945050505050565b6002546001600160a01b031633146103605760405162461bcd60e51b815260040161035790610cff565b60405180910390fd5b806001600160a01b038116156103e1576001600160a01b03811660009081526003602090815260409182902082518084019093528054835260010154908201526103a98261029c565b60208201526103b6610472565b81526001600160a01b0382166000908152600360209081526040909120825181559101516001909101555b34806104205760405162461bcd60e51b815260206004820152600e60248201526d043616e6e6f74207374616b6520360941b6044820152606401610357565b61042a8382610a68565b826001600160a01b03167f9e71bc8eea02a63969f509818f2dafb9254532904319f9dbda79b67bd34a5f3d8260405161046591815260200190565b60405180910390a2505050565b6004546000906104839060016108fd565b905090565b60006104926107f0565b60400151905090565b6002546001600160a01b031633146104c55760405162461bcd60e51b815260040161035790610cff565b34806104ce5750565b6005546001600160a01b0316600090815260066020908152604080832043845290915281208054839290610503908490610d4c565b90915550610512905081610aba565b6005546040518281526001600160a01b03909116907f7d8f3d9291db7e540ea10a43e300f1330c3e9148157349babe42ac2601a2a3e99060200160405180910390a250565b6002546001600160a01b031633146105815760405162461bcd60e51b815260040161035790610cff565b806001600160a01b03811615610602576001600160a01b03811660009081526003602090815260409182902082518084019093528054835260010154908201526105ca8261029c565b60208201526105d7610472565b81526001600160a01b0382166000908152600360209081526040909120825181559101516001909101555b6001600160a01b03821660009081526003602052604090206001015480156106b7576001600160a01b0383166000818152600360205260408082206001018290555183156108fc0291849190818181858888f1935050505015801561066b573d6000803e3d6000fd5b50600554604080518381524260208201526001600160a01b03928316928616917f51a69b4502f660774c9339825c7b5adbf0b8622289134647e29728ec5d9b3bb9910160405180910390a35b505050565b6002546001600160a01b031633146106e65760405162461bcd60e51b815260040161035790610cff565b816001600160a01b03811615610767576001600160a01b038116600090815260036020908152604091829020825180840190935280548352600101549082015261072f8261029c565b602082015261073c610472565b81526001600160a01b0382166000908152600360209081526040909120825181559101516001909101555b600082116107ab5760405162461bcd60e51b8152602060048201526011602482015270043616e6e6f74207769746864726177203607c1b6044820152606401610357565b6107b58383610bad565b826001600160a01b03167f7084f5476618d8e60b11ef0d7d3f06914655adb8793e28ff7f018d4c76d505d58360405161046591815260200190565b61081460405180606001604052806000815260200160008152602001600081525090565b600461081e610472565b8154811061082e5761082e610d64565b90600052602060002090600302016040518060600160405290816000820154815260200160018201548152602001600282015481525050905090565b61088e60405180606001604052806000815260200160008152602001600081525090565b60046108af836001600160a01b031660009081526003602052604090205490565b815481106108bf576108bf610d64565b906000526020600020906003020160405180606001604052908160008201548152602001600182015481526020016002820154815250509050919050565b600061093f83836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f770000815250610c26565b90505b92915050565b60008261095757506000610942565b60006109638385610d7a565b9050826109708583610d99565b1461093f5760405162461bcd60e51b815260206004820152602160248201527f536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f6044820152607760f81b6064820152608401610357565b600061093f83836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f000000000000815250610c57565b600080610a168385610d4c565b90508381101561093f5760405162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f7700000000006044820152606401610357565b600054610a759082610a09565b60009081556001600160a01b038316815260016020526040902054610a9a9082610a09565b6001600160a01b0390921660009081526001602052604090209190915550565b6000610ac46107f0565b6040015190506000610ad560005490565b905080610ae157505050565b6000610b03610afc8361031887670de0b6b3a7640000610948565b8490610a09565b60408051606081018252438152602081019687529081019182526004805460018101825560009190915290517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b60039092029182015594517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19c860155517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19d90940193909355505050565b600054610bba90826108fd565b60009081556001600160a01b038316815260016020526040902054610bdf90826108fd565b6001600160a01b038316600081815260016020526040808220939093559151909183156108fc02918491818181858888f193505050501580156106b7573d6000803e3d6000fd5b60008184841115610c4a5760405162461bcd60e51b81526004016103579190610dbb565b5060006103248486610e10565b60008183610c785760405162461bcd60e51b81526004016103579190610dbb565b5060006103248486610d99565b6001600160a01b0381168114610c9a57600080fd5b50565b600060208284031215610caf57600080fd5b813561093f81610c85565b60008060408385031215610ccd57600080fd5b8235610cd881610c85565b946020939093013593505050565b600060208284031215610cf857600080fd5b5035919050565b6020808252601a908201527f43616c6c6572206973206e6f7420746865206f70657261746f72000000000000604082015260600190565b634e487b7160e01b600052601160045260246000fd5b60008219821115610d5f57610d5f610d36565b500190565b634e487b7160e01b600052603260045260246000fd5b6000816000190483118215151615610d9457610d94610d36565b500290565b600082610db657634e487b7160e01b600052601260045260246000fd5b500490565b600060208083528351808285015260005b81811015610de857858101830151858201604001528201610dcc565b81811115610dfa576000604083870101525b50601f01601f1916929092016040019392505050565b600082821015610e2257610e22610d36565b50039056fea2646970667358221220092ff02654aefd0a4e804c1722e86dc3109bc72cf5430ed579fa0cf60e40626064736f6c634300080800337d8f3d9291db7e540ea10a43e300f1330c3e9148157349babe42ac2601a2a3e9a2646970667358221220327ed2c99d2c314a92867284806163ccb0237ee8c120f4a8a9138cb43c59697464736f6c63430008080033"
)

type hardForkValidatorsV3 struct {
}

func (s *hardForkValidatorsV3) GetName() string {
	return ValidatorsV2ContractName
}

func (s *hardForkValidatorsV3) Update(config *params.ChainConfig, height *big.Int, state *state.StateDB) (err error) {
	contractCode := common.FromHex(validatorV3Code)

	//write code to sys contract
	state.SetCode(ValidatorsV2ContractAddr, contractCode)
	log.Debug("Write code to system contract account", "addr", ValidatorsV2ContractAddr.String(), "code", validatorV3Code)

	return
}

func (s *hardForkValidatorsV3) Execute(state *state.StateDB, header *types.Header, chainContext core.ChainContext, config *params.ChainConfig) (err error) {
	//First, get top validators from the old contract
	v0 := NewValidatorV0()
	topVals, err := v0.GetTopValidators(state, header, chainContext, config)
	if err != nil {
		log.Error("getTopValidators from V0 failed", "err", err)
		return err
	}

	// initialize v1 contract
	method := "initialize"
	data, err := GetInteractiveABI()[ValidatorsV2ContractName].Pack(method, topVals)
	if err != nil {
		log.Error("Can't pack data for initialize", "error", err)
		return err
	}

	msg := vmcaller.NewLegacyMessage(header.Coinbase, &ValidatorsV2ContractAddr, 0, new(big.Int), math.MaxUint64, new(big.Int), data, false)
	_, err = vmcaller.ExecuteMsg(msg, state, header, chainContext, config)

	return
}
