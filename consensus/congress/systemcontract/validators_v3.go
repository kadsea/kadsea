package systemcontract

import (
	"math"
	"math/big"

	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/consensus/congress/vmcaller"
	"github.com/ethereum/go-ethereum/core"
	"github.com/ethereum/go-ethereum/core/state"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/log"
	"github.com/ethereum/go-ethereum/params"
)

const (
	validatorV3Code = "0x608060405260043610620002165760003560e01c806380d2dde11162000123578063be64569211620000ad578063c4e2f07a1162000078578063c4e2f07a1462000644578063c967f90f1462000669578063d6eb3de11462000694578063e8363f6c14620006ac578063ea10f8ad14620006dd57600080fd5b8063be64569214620005cf578063c1d7dd7814620005ef578063c253c3841462000607578063c2a672e0146200061f57600080fd5b80639de7025811620000ee5780639de702581462000531578063a224cee71462000558578063afeea115146200057d578063bbe4f6db146200059557600080fd5b806380d2dde114620004985780638a11d7c914620004bd5780638b0e9f3f14620004f457806398e3b626146200050c57600080fd5b806340a141ff11620001a55780636846992a11620001705780636846992a14620003ee5780636969a25c14620004135780637ad229da14620004385780637f4f95fa146200045d57600080fd5b806340a141ff146200034357806348cd4cb114620003685780634b3d500b146200038f57806363fc5e7114620003b457600080fd5b806330fcb67c11620001e657806330fcb67c14620002b957806338b67b8b14620002d25780633a061bd3146200030657806340550a1c146200031e57600080fd5b8062362a77146200021b578063158ef93e14620002555780631b5e358c14620002715780632647620414620002a2575b600080fd5b3480156200022857600080fd5b50620002406200023a366004620035ce565b62000702565b60405190151581526020015b60405180910390f35b3480156200026257600080fd5b50600054620002409060ff1681565b3480156200027e57600080fd5b506200028961f20081565b6040516001600160a01b0390911681526020016200024c565b62000240620002b3366004620035ce565b6200081f565b620002d0620002ca366004620035ce565b62000ca8565b005b348015620002df57600080fd5b50620002f7620002f136600462003634565b62000eca565b6040516200024c91906200367a565b3480156200031357600080fd5b506200028961f10081565b3480156200032b57600080fd5b50620002406200033d366004620035ce565b6200105c565b3480156200035057600080fd5b50620002d062000362366004620035ce565b620010ce565b3480156200037557600080fd5b506200038060015481565b6040519081526020016200024c565b3480156200039c57600080fd5b5062000289620003ae366004620036c0565b6200112f565b348015620003c157600080fd5b5062000380620003d3366004620035ce565b6001600160a01b03166000908152600f602052604090205490565b348015620003fb57600080fd5b50620002d06200040d366004620036f0565b6200115a565b3480156200042057600080fd5b506200028962000432366004620036c0565b620013d5565b3480156200044557600080fd5b506200038062000457366004620037c9565b620013e6565b3480156200046a57600080fd5b50620004826200047c366004620037f6565b620014b8565b604080519283526020830191909152016200024c565b348015620004a557600080fd5b50620002d0620004b7366004620037c9565b620014ed565b348015620004ca57600080fd5b50620004e2620004dc366004620035ce565b62001889565b6040516200024c94939291906200388a565b3480156200050157600080fd5b506200038060075481565b3480156200051957600080fd5b50620002406200052b366004620035ce565b62001985565b3480156200053e57600080fd5b5062000549620019ee565b6040516200024c9190620038ce565b3480156200056557600080fd5b50620002d06200057736600462003634565b62001a52565b3480156200058a57600080fd5b506200054962001fc1565b348015620005a257600080fd5b5062000289620005b4366004620035ce565b600b602052600090815260409020546001600160a01b031681565b348015620005dc57600080fd5b506200038069021e19e0c9bab240000081565b348015620005fc57600080fd5b506200038060085481565b3480156200061457600080fd5b506200048262002023565b3480156200062c57600080fd5b50620002406200063e366004620037c9565b6200203a565b3480156200065157600080fd5b506200038062000663366004620037f6565b62002459565b3480156200067657600080fd5b5062000680601581565b60405161ffff90911681526020016200024c565b348015620006a157600080fd5b506200028961f30081565b348015620006b957600080fd5b5062000380620006cb366004620035ce565b60046020526000908152604090205481565b348015620006ea57600080fd5b50620002f7620006fc366004620038e3565b62002514565b3360008181526004602052604081208054908290559091908015620007a2576040516001600160a01b0383169082156108fc029083906000818181858888f1935050505015801562000758573d6000803e3d6000fd5b50604080518281524260208201526001600160a01b0380871692908516917f51a69b4502f660774c9339825c7b5adbf0b8622289134647e29728ec5d9b3bb9910160405180910390a35b6001600160a01b038481166000908152600b602052604090819020549051630c00007b60e41b81528483166004820152911690819063c00007b090602401600060405180830381600087803b158015620007fb57600080fd5b505af115801562000810573d6000803e3d6000fd5b50600198975050505050505050565b6000805460ff166200084e5760405162461bcd60e51b815260040162000845906200393c565b60405180910390fd5b336000818152600c602052604090205434906200086c908262002683565b6001600160a01b038084166000908152600c602052604080822093909355600a5483516325dff9d160e01b815284519294859492909216926325dff9d192600480840193919291829003018186803b158015620008c857600080fd5b505afa158015620008dd573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019062000903919062003962565b9150915081431015620009465760405162461bcd60e51b815260206004820152600a6024820152697374617274426c6f636b60b01b604482015260640162000845565b80431115620009835760405162461bcd60e51b8152602060048201526008602482015267656e64426c6f636b60c01b604482015260640162000845565b6001600160a01b038087166000818152600260205260409020918616148015620009dd575060016001600160a01b03881660009081526002602052604090205460ff166003811115620009da57620009da6200382e565b14155b1562000a5057600181015469021e19e0c9bab24000009062000a00908662002683565b101562000a505760405162461bcd60e51b815260206004820152601860248201527f5374616b696e6720636f696e73206e6f7420656e6f7567680000000000000000604482015260640162000845565b6001600160a01b038086166000908152600360209081526040808320938b168352929052205462000acf57600380820180546001600160a01b03808916600081815260209586526040808220938e1682529286529182206001908101849055830184559281529290922090910180546001600160a01b03191690911790555b600181015462000b1e57866001600160a01b03167fbc822c457926e0706c445f2b613394c8a2bf34b3b4335915e3865b90829ce38b600160405162000b15919062003987565b60405180910390a25b600181015462000b2f908562002683565b600180830191909155815460ff16600381111562000b515762000b516200382e565b1462000b6357805460ff191660011781555b62000b73878260010154620026ed565b6001600160a01b038086166000908152600360209081526040808320938b168352929052205462000ba5908562002683565b6001600160a01b038087166000908152600360209081526040808320938c168352929052205560075462000bda908562002683565b6007556001600160a01b038781166000908152600b602052604090819020549051630991d88160e21b81528783166004820152911690819063264762049087906024016000604051808303818588803b15801562000c3757600080fd5b505af115801562000c4c573d6000803e3d6000fd5b5050604080518981524260208201526001600160a01b03808e1695508b1693507fb9ba725934532316cffe10975da6eb25ad49c2d1c294d982c46c9f8d684ee07592500160405180910390a3600196505050505050505b919050565b33411462000ce65760405162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b604482015260640162000845565b436000908152600d6020908152604080832083805290915290205460ff161562000d535760405162461bcd60e51b815260206004820152601960248201527f426c6f636b20697320616c726561647920726577617264656400000000000000604482015260640162000845565b60005460ff1662000d785760405162461bcd60e51b815260040162000845906200393c565b436000818152600d602090815260408083208380529091529020805460ff191660019081179091555433913491101562000dd8576001600160a01b0382166000908152600f6020526040812080549162000dd283620039ba565b91905055505b6001600160a01b03821660009081526002602052604081205460ff16600381111562000e085762000e086200382e565b141562000e1457505050565b600954604051631e88772760e01b81526001600160a01b03848116600483015290911690631e88772790602401600060405180830381600087803b15801562000e5c57600080fd5b505af115801562000e71573d6000803e3d6000fd5b5050505062000e81818462002b02565b604080518281524260208201526001600160a01b038416917f7dc4e5df59513708dca355b8706273a5df7b810a4cec8019f2a4b9bb166a1a04910160405180910390a250505b50565b6060818067ffffffffffffffff81111562000ee95762000ee9620036da565b60405190808252806020026020018201604052801562000f13578160200160208202803683370190505b50915060005b818110156200105457600085858381811062000f395762000f39620039d8565b905060200201602081019062000f509190620035ce565b6001600160a01b038082166000908152600b6020526040812054929350911690811562000ff5576040516246613160e11b81526001600160a01b038481166004830152831690628cc2629060240160206040518083038186803b15801562000fb757600080fd5b505afa15801562000fcc573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019062000ff29190620039ee565b90505b6001600160a01b0383166000908152600460205260409020546200101a908262003a08565b8685815181106200102f576200102f620039d8565b60200260200101818152505050505080806200104b90620039ba565b91505062000f19565b505092915050565b6000805b600554811015620010c557826001600160a01b0316600582815481106200108b576200108b620039d8565b6000918252602090912001546001600160a01b03161415620010b05750600192915050565b80620010bc81620039ba565b91505062001060565b50600092915050565b3361f20014620011185760405162461bcd60e51b815260206004820152601460248201527350756e69736820636f6e7472616374206f6e6c7960601b604482015260640162000845565b6006546001101562000ec75762000ec781620030fe565b600681815481106200114057600080fd5b6000918252602090912001546001600160a01b0316905081565b334114620011985760405162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b604482015260640162000845565b436000908152600d602090815260408083206001845290915290205460ff1615620012065760405162461bcd60e51b815260206004820152601a60248201527f56616c696461746f727320616c72656164792075706461746564000000000000604482015260640162000845565b60005460ff166200122b5760405162461bcd60e51b815260040162000845906200393c565b8062001238814362003a39565b156200127a5760405162461bcd60e51b815260206004820152601060248201526f426c6f636b2065706f6368206f6e6c7960801b604482015260640162000845565b436000908152600d6020908152604080832060018085529252909120805460ff191690911790558251620012e85760405162461bcd60e51b815260206004820152601460248201527356616c696461746f722073657420656d7074792160601b604482015260640162000845565b600a54604080516325dff9d160e01b815281516000936001600160a01b0316926325dff9d19260048082019391829003018186803b1580156200132a57600080fd5b505afa1580156200133f573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019062001365919062003962565b915050600081118015620013795750804310155b15620013cf5783516200139490600590602087019062003527565b507feacea8f3c22f06c0b18306bdb04d0a967255129e8ce0094debb0a0ff89d006b584604051620013c69190620038ce565b60405180910390a15b50505050565b600581815481106200114057600080fd5b6001600160a01b038281166000908152600b602052604080822054905163fa9ada5b60e01b815260048101859052919216908290829063fa9ada5b9060240160206040518083038186803b1580156200143e57600080fd5b505afa15801562001453573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620014799190620039ee565b6001600160a01b0386166000908152600e60209081526040808320888452909152902054909150620014ad90829062003a08565b925050505b92915050565b6001600160a01b03828116600090815260036020908152604080832093851683529290522080546001909101545b9250929050565b3361f20014620015375760405162461bcd60e51b815260206004820152601460248201527350756e69736820636f6e7472616374206f6e6c7960601b604482015260640162000845565b8160006001600160a01b03841660009081526002602052604090205460ff1660038111156200156a576200156a6200382e565b1415620015b05760405162461bcd60e51b815260206004820152601360248201527215985b1a59185d1bdc881b9bdd08195e1a5cdd606a1b604482015260640162000845565b6001600160a01b03808216600090815260036020908152604080832093871683529281528282206002909152919020815480851115620015ee578094505b84620015fc57505050505050565b8481141562001751576003820154620016189060019062003a50565b8360010154146200171057600382018054620016379060019062003a50565b815481106200164a576200164a620039d8565b9060005260206000200160009054906101000a90046001600160a01b031682600301846001015481548110620016845762001684620039d8565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b0316021790555082600101546003600084600301866001015481548110620016d757620016d7620039d8565b60009182526020808320909101546001600160a01b0390811684528382019490945260409283018220938b168252929092529020600101555b8160030180548062001726576200172662003a6a565b600082815260208120820160001990810180546001600160a01b031916905590910190915560018401555b82546200175f908662003143565b8355600182015462001772908662003143565b600183015560075462001786908662003143565b6007556001600160a01b0384166000908152600c6020526040902054620017ae908662003143565b6001600160a01b038581166000818152600c60209081526040808320959095558a84168252600b905283902054925163f3fef3a360e01b8152600481019190915260248101889052911690819063f3fef3a390604401600060405180830381600087803b1580156200181f57600080fd5b505af115801562001834573d6000803e3d6000fd5b5050604080518981524260208201526001600160a01b03808c169450891692507f449002ae18e748d69a55f38514400d64f966492e593e32d6e9b8b24db98a0bc1910160405180910390a350505050505b5050565b6001600160a01b03811660009081526002602052604080822081516080810190925280548392839260609284929190829060ff166003811115620018d157620018d16200382e565b6003811115620018e557620018e56200382e565b81526020016001820154815260200160028201548152602001600382018054806020026020016040519081016040528092919081815260200182805480156200195857602002820191906000526020600020905b81546001600160a01b0316815260019091019060200180831162001939575b505050919092525050815160208301516040840151606090940151919a9099509297509550909350505050565b6000805b600654811015620010c557826001600160a01b031660068281548110620019b457620019b4620039d8565b6000918252602090912001546001600160a01b03161415620019d95750600192915050565b80620019e581620039ba565b91505062001989565b6060600580548060200260200160405190810160405280929190818152602001828054801562001a4857602002820191906000526020600020905b81546001600160a01b0316815260019091019060200180831162001a29575b5050505050905090565b60005460ff161562001a9d5760405162461bcd60e51b8152602060048201526013602482015272105b1c9958591e481a5b9a5d1a585b1a5e9959606a1b604482015260640162000845565b600980546001600160a01b031990811661f20017909155600a805490911661f30017905560005b8181101562001f7557600083838381811062001ae45762001ae4620039d8565b905060200201602081019062001afb9190620035ce565b6001600160a01b0316141562001b545760405162461bcd60e51b815260206004820152601960248201527f496e76616c69642076616c696461746f72206164647265737300000000000000604482015260640162000845565b62001b8483838381811062001b6d5762001b6d620039d8565b90506020020160208101906200033d9190620035ce565b62001bea57600583838381811062001ba05762001ba0620039d8565b905060200201602081019062001bb79190620035ce565b81546001810183556000928352602090922090910180546001600160a01b0319166001600160a01b039092169190911790555b62001c1a83838381811062001c035762001c03620039d8565b90506020020160208101906200052b9190620035ce565b62001c8057600683838381811062001c365762001c36620039d8565b905060200201602081019062001c4d9190620035ce565b81546001810183556000928352602090922090910180546001600160a01b0319166001600160a01b039092169190911790555b60006002600085858581811062001c9b5762001c9b620039d8565b905060200201602081019062001cb29190620035ce565b6001600160a01b0316815260208101919091526040016000205460ff16600381111562001ce35762001ce36200382e565b141562001d585760016002600085858581811062001d055762001d05620039d8565b905060200201602081019062001d1c9190620035ce565b6001600160a01b031681526020810191909152604001600020805460ff1916600183600381111562001d525762001d526200382e565b02179055505b6000600b8185858581811062001d725762001d72620039d8565b905060200201602081019062001d899190620035ce565b6001600160a01b03908116825260208201929092526040016000205416141562001f6057600083838381811062001dc45762001dc4620039d8565b905060200201602081019062001ddb9190620035ce565b60405160200162001dff919060609190911b6001600160601b031916815260140190565b60405160208183030381529060405280519060200120905060008185858581811062001e2f5762001e2f620039d8565b905060200201602081019062001e469190620035ce565b60405162001e549062003591565b6001600160a01b0390911681526020018190604051809103906000f590508015801562001e85573d6000803e3d6000fd5b50905080600b600087878781811062001ea25762001ea2620039d8565b905060200201602081019062001eb99190620035ce565b6001600160a01b039081168252602082019290925260400160002080546001600160a01b0319169290911691909117905584848481811062001eff5762001eff620039d8565b905060200201602081019062001f169190620035ce565b604080516001600160a01b03848116825242602083015292909216917f5e5b474625449a92e2b1a6f9f183435f09402d6897ae7f8779c72142ed11170b910160405180910390a250505b8062001f6c81620039ba565b91505062001ac4565b507feacea8f3c22f06c0b18306bdb04d0a967255129e8ce0094debb0a0ff89d006b5600560405162001fa8919062003a80565b60405180910390a150506000805460ff19166001179055565b6060600680548060200260200160405190810160405280929190818152602001828054801562001a48576020028201919060005260206000209081546001600160a01b0316815260019091019060200180831162001a29575050505050905090565b60008062002032600062003187565b915091509091565b6000805460ff16620020605760405162461bcd60e51b815260040162000845906200393c565b3360006001600160a01b03851660009081526002602052604090205460ff1660038111156200209357620020936200382e565b1415620020d95760405162461bcd60e51b815260206004820152601360248201527215985b1a59185d1bdc881b9bdd08195e1a5cdd606a1b604482015260640162000845565b6001600160a01b038082166000908152600360209081526040808320938816835292815282822060029091529190208154808611156200215c5760405162461bcd60e51b815260206004820152601860248201527f596f7520646f6e2774206861766520616e79207374616b650000000000000000604482015260640162000845565b85811415620022b1576003820154620021789060019062003a50565b8360010154146200227057600382018054620021979060019062003a50565b81548110620021aa57620021aa620039d8565b9060005260206000200160009054906101000a90046001600160a01b031682600301846001015481548110620021e457620021e4620039d8565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b0316021790555082600101546003600084600301866001015481548110620022375762002237620039d8565b60009182526020808320909101546001600160a01b0390811684528382019490945260409283018220938c168252929092529020600101555b8160030180548062002286576200228662003a6a565b600082815260208120820160001990810180546001600160a01b031916905590910190915560018401555b8254620022bf908762003143565b83556001820154620022d2908762003143565b6001830155600754620022e6908762003143565b6007556001600160a01b0384166000908152600c60205260409020546200230e908762003143565b6001600160a01b038086166000818152600c6020526040902092909255881614156200238b576200233f8762001985565b156200238b57825469021e19e0c9bab240000011156200238b5760405162461bcd60e51b815260040162000845906020808252600490820152630333030360e41b604082015260600190565b6001600160a01b038781166000908152600b60205260409081902054905163f3fef3a360e01b8152868316600482015260248101899052911690819063f3fef3a390604401600060405180830381600087803b158015620023eb57600080fd5b505af115801562002400573d6000803e3d6000fd5b5050604080518a81524260208201526001600160a01b03808d169450891692507f449002ae18e748d69a55f38514400d64f966492e593e32d6e9b8b24db98a0bc1910160405180910390a3506001979650505050505050565b6001600160a01b038181166000908152600b60205260408082205490516246613160e11b815285841660048201529192169082908290628cc2629060240160206040518083038186803b158015620024b057600080fd5b505afa158015620024c5573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620024eb9190620039ee565b6001600160a01b038616600090815260046020526040902054909150620014ad90829062003a08565b6060818067ffffffffffffffff811115620025335762002533620036da565b6040519080825280602002602001820160405280156200255d578160200160208202803683370190505b50915060005b838110156200267a576000858583818110620025835762002583620039d8565b90506020020160208101906200259a9190620035ce565b6001600160a01b038082166000908152600b602052604081205492935091169081156200263f576040516246613160e11b81526001600160a01b038a81166004830152831690628cc2629060240160206040518083038186803b1580156200260157600080fd5b505afa15801562002616573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906200263c9190620039ee565b90505b80868581518110620026555762002655620039d8565b60200260200101818152505050505080806200267190620039ba565b91505062002563565b50509392505050565b60008062002692838562003a08565b905083811015620026e65760405162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f770000000000604482015260640162000845565b9392505050565b60005b6006548110156200275157826001600160a01b0316600682815481106200271b576200271b620039d8565b6000918252602090912001546001600160a01b031614156200273c57505050565b806200274881620039ba565b915050620026f0565b5060065460151115620028a65760068054600181019091557ff652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d3f0180546001600160a01b0319166001600160a01b038481169182179092556000908152600b60205260409020541662001885576040516001600160601b0319606084901b16602082015260009060340160405160208183030381529060405280519060200120905060008184604051620028049062003591565b6001600160a01b0390911681526020018190604051809103906000f590508015801562002835573d6000803e3d6000fd5b506001600160a01b038581166000818152600b602090815260409182902080546001600160a01b031916948616948517905581519384524290840152929350917f5e5b474625449a92e2b1a6f9f183435f09402d6897ae7f8779c72142ed11170b910160405180910390a250505050565b6000600260006006600081548110620028c357620028c3620039d8565b60009182526020808320909101546001600160a01b03168352820192909252604001812060019081015492505b600654811015620029a257826002600060068481548110620029165762002916620039d8565b60009182526020808320909101546001600160a01b0316835282019290925260400190206001015410156200298d5760026000600683815481106200295f576200295f620039d8565b60009182526020808320909101546001600160a01b0316835282019290925260400190206001015492509050805b806200299981620039ba565b915050620028f0565b50818311620029b15750505050565b6001600160a01b038481166000908152600b60205260409020541662002ab7576040516001600160601b0319606086901b1660208201526000906034016040516020818303038152906040528051906020012090506000818660405162002a189062003591565b6001600160a01b0390911681526020018190604051809103906000f590508015801562002a49573d6000803e3d6000fd5b506001600160a01b038781166000818152600b602090815260409182902080546001600160a01b031916948616948517905581519384524290840152929350917f5e5b474625449a92e2b1a6f9f183435f09402d6897ae7f8779c72142ed11170b910160405180910390a250505b836006828154811062002ace5762002ace620039d8565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b0316021790555050505050565b8162002b0c575050565b60008062002b1a8362003187565b90925090508062002b2b5750505050565b6000808362002d6857600062002b428785620032ad565b905062002b5c62002b548286620032f1565b889062003143565b925060005b60055481101562002ca75760006005828154811062002b845762002b84620039d8565b6000918252602090912001546001600160a01b0316905060036001600160a01b03821660009081526002602052604090205460ff16600381111562002bcd5762002bcd6200382e565b1415801562002bee5750876001600160a01b0316816001600160a01b031614155b1562002c91576001600160a01b03811660009081526004602052604090205462002c19908462002683565b6001600160a01b038216600090815260046020908152604080832093909355600e815282822043835290529081208054929550859285929062002c5e90849062003a08565b90915550506040518381526001600160a01b0382169060008051602062004af68339815191529060200160405180910390a25b508062002c9e81620039ba565b91505062002b61565b5060008311801562002cc157506001600160a01b03821615155b1562002d5f576001600160a01b03821660009081526004602052604090205462002cec908462002683565b6001600160a01b038316600090815260046020908152604080832093909355600e81528282204383529052908120805485929062002d2c90849062003a08565b90915550506040518381526001600160a01b0383169060008051602062004af68339815191529060200160405180910390a25b50505050505050565b6000805b60055481101562002faa5760006005828154811062002d8f5762002d8f620039d8565b6000918252602090912001546001600160a01b0316905060036001600160a01b03821660009081526002602052604090205460ff16600381111562002dd85762002dd86200382e565b1415801562002df95750876001600160a01b0316816001600160a01b031614155b1562002f9457600062002e4262002e12896002620032f1565b6001600160a01b03841660009081526002602052604090206001015462002e3b908d90620032f1565b90620032ad565b6001600160a01b038316600090815260046020526040902054929550859290915062002e6f908262002683565b6001600160a01b03808416600090815260046020818152604080842095909555600b90528382205484516355d54c8b60e11b81529451931693849363abaa99169387938381019391929182900301818588803b15801562002ecf57600080fd5b505af115801562002ee4573d6000803e3d6000fd5b505050505062002f2e62002f03600284620032f190919063ffffffff16565b6001600160a01b0385166000908152600e602090815260408083204384529091529020549062002683565b6001600160a01b0384166000818152600e602090815260408083204384528252918290209390935551848152909160008051602062004af6833981519152910160405180910390a262002f8f62002f87836002620032f1565b869062002683565b945050505b508062002fa181620039ba565b91505062002d6c565b5062002fb7878262003143565b925060008311801562002fd257506001600160a01b03821615155b1562002d5f576200300962002fe9846002620032ad565b6001600160a01b0384166000908152600460205260409020549062002683565b6001600160a01b03808416600090815260046020908152604080832094909455600b90529190912054168063abaa991662003046866002620032ad565b6040518263ffffffff1660e01b81526004016000604051808303818588803b1580156200307257600080fd5b505af115801562003087573d6000803e3d6000fd5b5050506001600160a01b0385166000908152600e6020908152604080832043845290915281208054889450909250620030c290849062003a08565b90915550506040518481526001600160a01b0384169060008051602062004af68339815191529060200160405180910390a25050505050505050565b6001600160a01b03811660009081526002602052604081205460ff1660038111156200312e576200312e6200382e565b1415620031385750565b62000ec78162003378565b6000620026e683836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f770000815250620034b5565b60008060005b600554811015620032a75760036002600060058481548110620031b457620031b4620039d8565b60009182526020808320909101546001600160a01b0316835282019290925260400190205460ff166003811115620031f057620031f06200382e565b141580156200322c575060058181548110620032105762003210620039d8565b6000918252602090912001546001600160a01b03858116911614155b156200329257620032806002600060058481548110620032505762003250620039d8565b60009182526020808320909101546001600160a01b03168352820192909252604001902060010154849062002683565b9250816200328e81620039ba565b9250505b806200329e81620039ba565b9150506200318d565b50915091565b6000620026e683836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f000000000000815250620034f4565b6000826200330257506000620014b2565b600062003310838562003ac6565b9050826200331f858362003ae8565b14620026e65760405162461bcd60e51b815260206004820152602160248201527f536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f6044820152607760f81b606482015260840162000845565b60005b600654811080156200338f57506006546001105b15620018855760068181548110620033ab57620033ab620039d8565b6000918252602090912001546001600160a01b0383811691161415620034a057600654620033dc9060019062003a50565b8114620034665760068054620033f59060019062003a50565b81548110620034085762003408620039d8565b600091825260209091200154600680546001600160a01b039092169183908110620034375762003437620039d8565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b031602179055505b60068054806200347a576200347a62003a6a565b600082815260209020810160001990810180546001600160a01b03191690550190555050565b80620034ac81620039ba565b9150506200337b565b60008184841115620034dc5760405162461bcd60e51b815260040162000845919062003aff565b506000620034eb848662003a50565b95945050505050565b60008183620035185760405162461bcd60e51b815260040162000845919062003aff565b506000620034eb848662003ae8565b8280548282559060005260206000209081019282156200357f579160200282015b828111156200357f57825182546001600160a01b0319166001600160a01b0390911617825560209092019160019091019062003548565b506200358d9291506200359f565b5090565b610f9e8062003b5883390190565b5b808211156200358d5760008155600101620035a0565b80356001600160a01b038116811462000ca357600080fd5b600060208284031215620035e157600080fd5b620026e682620035b6565b60008083601f840112620035ff57600080fd5b50813567ffffffffffffffff8111156200361857600080fd5b6020830191508360208260051b8501011115620014e657600080fd5b600080602083850312156200364857600080fd5b823567ffffffffffffffff8111156200366057600080fd5b6200366e85828601620035ec565b90969095509350505050565b6020808252825182820181905260009190848201906040850190845b81811015620036b45783518352928401929184019160010162003696565b50909695505050505050565b600060208284031215620036d357600080fd5b5035919050565b634e487b7160e01b600052604160045260246000fd5b600080604083850312156200370457600080fd5b823567ffffffffffffffff808211156200371d57600080fd5b818501915085601f8301126200373257600080fd5b8135602082821115620037495762003749620036da565b8160051b604051601f19603f83011681018181108682111715620037715762003771620036da565b6040529283528183019350848101820192898411156200379057600080fd5b948201945b83861015620037b957620037a986620035b6565b8552948201949382019362003795565b9997909101359750505050505050565b60008060408385031215620037dd57600080fd5b620037e883620035b6565b946020939093013593505050565b600080604083850312156200380a57600080fd5b6200381583620035b6565b91506200382560208401620035b6565b90509250929050565b634e487b7160e01b600052602160045260246000fd5b600081518084526020808501945080840160005b838110156200387f5781516001600160a01b03168752958201959082019060010162003858565b509495945050505050565b6000600486106200389f576200389f6200382e565b85825284602083015283604083015260806060830152620038c4608083018462003844565b9695505050505050565b602081526000620026e6602083018462003844565b600080600060408486031215620038f957600080fd5b6200390484620035b6565b9250602084013567ffffffffffffffff8111156200392157600080fd5b6200392f86828701620035ec565b9497909650939450505050565b6020808252600c908201526b139bdd081a5b9a5d081e595d60a21b604082015260600190565b600080604083850312156200397657600080fd5b505080516020909101519092909150565b60208101600383106200399e576200399e6200382e565b91905290565b634e487b7160e01b600052601160045260246000fd5b6000600019821415620039d157620039d1620039a4565b5060010190565b634e487b7160e01b600052603260045260246000fd5b60006020828403121562003a0157600080fd5b5051919050565b6000821982111562003a1e5762003a1e620039a4565b500190565b634e487b7160e01b600052601260045260246000fd5b60008262003a4b5762003a4b62003a23565b500690565b60008282101562003a655762003a65620039a4565b500390565b634e487b7160e01b600052603160045260246000fd5b6020808252825482820181905260008481528281209092916040850190845b81811015620036b45783546001600160a01b03168352600193840193928501920162003a9f565b600081600019048311821515161562003ae35762003ae3620039a4565b500290565b60008262003afa5762003afa62003a23565b500490565b600060208083528351808285015260005b8181101562003b2e5785810183015185820160400152820162003b10565b8181111562003b41576000604083870101525b50601f01601f191692909201604001939250505056fe608060405234801561001057600080fd5b50604051610f9e380380610f9e83398101604081905261002f91610102565b60028054336001600160a01b031991821617909155600580549091166001600160a01b03929092169190911790556040805160608101825243815260006020820181815292820181815260048054600181018255925291517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b60039092029182015591517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19c830155517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19d90910155610132565b60006020828403121561011457600080fd5b81516001600160a01b038116811461012b57600080fd5b9392505050565b610e5d806101416000396000f3fe6080604052600436106100c15760003560e01c806370a082311161007f578063c00007b011610059578063c00007b0146101f9578063e673df8a14610219578063f3fef3a314610239578063fa9ada5b1461025957600080fd5b806370a0823114610185578063714b4658146101bb578063abaa9916146101f157600080fd5b80628cc262146100c657806318160ddd146100f9578063264762041461010e5780633a5381b5146101235780633f9e3f041461015b578063446a2ec814610170575b600080fd5b3480156100d257600080fd5b506100e66100e1366004610c9d565b61029c565b6040519081526020015b60405180910390f35b34801561010557600080fd5b506000546100e6565b61012161011c366004610c9d565b61032d565b005b34801561012f57600080fd5b50600554610143906001600160a01b031681565b6040516001600160a01b0390911681526020016100f0565b34801561016757600080fd5b506100e6610472565b34801561017c57600080fd5b506100e6610488565b34801561019157600080fd5b506100e66101a0366004610c9d565b6001600160a01b031660009081526001602052604090205490565b3480156101c757600080fd5b506100e66101d6366004610c9d565b6001600160a01b031660009081526003602052604090205490565b61012161049b565b34801561020557600080fd5b50610121610214366004610c9d565b610557565b34801561022557600080fd5b50600254610143906001600160a01b031681565b34801561024557600080fd5b50610121610254366004610cba565b6106bc565b34801561026557600080fd5b506100e6610274366004610ce6565b6005546001600160a01b03166000908152600660209081526040808320938352929052205490565b6000806102a76107f0565b60400151905060006102b88461086a565b6040908101516001600160a01b03861660009081526003602052918220600101549092506103249061031e670de0b6b3a76400006103186102f988886108fd565b6001600160a01b038b1660009081526001602052604090205490610948565b906109c7565b90610a09565b95945050505050565b6002546001600160a01b031633146103605760405162461bcd60e51b815260040161035790610cff565b60405180910390fd5b806001600160a01b038116156103e1576001600160a01b03811660009081526003602090815260409182902082518084019093528054835260010154908201526103a98261029c565b60208201526103b6610472565b81526001600160a01b0382166000908152600360209081526040909120825181559101516001909101555b34806104205760405162461bcd60e51b815260206004820152600e60248201526d043616e6e6f74207374616b6520360941b6044820152606401610357565b61042a8382610a68565b826001600160a01b03167f9e71bc8eea02a63969f509818f2dafb9254532904319f9dbda79b67bd34a5f3d8260405161046591815260200190565b60405180910390a2505050565b6004546000906104839060016108fd565b905090565b60006104926107f0565b60400151905090565b6002546001600160a01b031633146104c55760405162461bcd60e51b815260040161035790610cff565b34806104ce5750565b6005546001600160a01b0316600090815260066020908152604080832043845290915281208054839290610503908490610d4c565b90915550610512905081610aba565b6005546040518281526001600160a01b03909116907f7d8f3d9291db7e540ea10a43e300f1330c3e9148157349babe42ac2601a2a3e99060200160405180910390a250565b6002546001600160a01b031633146105815760405162461bcd60e51b815260040161035790610cff565b806001600160a01b03811615610602576001600160a01b03811660009081526003602090815260409182902082518084019093528054835260010154908201526105ca8261029c565b60208201526105d7610472565b81526001600160a01b0382166000908152600360209081526040909120825181559101516001909101555b6001600160a01b03821660009081526003602052604090206001015480156106b7576001600160a01b0383166000818152600360205260408082206001018290555183156108fc0291849190818181858888f1935050505015801561066b573d6000803e3d6000fd5b50600554604080518381524260208201526001600160a01b03928316928616917f51a69b4502f660774c9339825c7b5adbf0b8622289134647e29728ec5d9b3bb9910160405180910390a35b505050565b6002546001600160a01b031633146106e65760405162461bcd60e51b815260040161035790610cff565b816001600160a01b03811615610767576001600160a01b038116600090815260036020908152604091829020825180840190935280548352600101549082015261072f8261029c565b602082015261073c610472565b81526001600160a01b0382166000908152600360209081526040909120825181559101516001909101555b600082116107ab5760405162461bcd60e51b8152602060048201526011602482015270043616e6e6f74207769746864726177203607c1b6044820152606401610357565b6107b58383610bad565b826001600160a01b03167f7084f5476618d8e60b11ef0d7d3f06914655adb8793e28ff7f018d4c76d505d58360405161046591815260200190565b61081460405180606001604052806000815260200160008152602001600081525090565b600461081e610472565b8154811061082e5761082e610d64565b90600052602060002090600302016040518060600160405290816000820154815260200160018201548152602001600282015481525050905090565b61088e60405180606001604052806000815260200160008152602001600081525090565b60046108af836001600160a01b031660009081526003602052604090205490565b815481106108bf576108bf610d64565b906000526020600020906003020160405180606001604052908160008201548152602001600182015481526020016002820154815250509050919050565b600061093f83836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f770000815250610c26565b90505b92915050565b60008261095757506000610942565b60006109638385610d7a565b9050826109708583610d99565b1461093f5760405162461bcd60e51b815260206004820152602160248201527f536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f6044820152607760f81b6064820152608401610357565b600061093f83836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f000000000000815250610c57565b600080610a168385610d4c565b90508381101561093f5760405162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f7700000000006044820152606401610357565b600054610a759082610a09565b60009081556001600160a01b038316815260016020526040902054610a9a9082610a09565b6001600160a01b0390921660009081526001602052604090209190915550565b6000610ac46107f0565b6040015190506000610ad560005490565b905080610ae157505050565b6000610b03610afc8361031887670de0b6b3a7640000610948565b8490610a09565b60408051606081018252438152602081019687529081019182526004805460018101825560009190915290517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b60039092029182015594517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19c860155517f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19d90940193909355505050565b600054610bba90826108fd565b60009081556001600160a01b038316815260016020526040902054610bdf90826108fd565b6001600160a01b038316600081815260016020526040808220939093559151909183156108fc02918491818181858888f193505050501580156106b7573d6000803e3d6000fd5b60008184841115610c4a5760405162461bcd60e51b81526004016103579190610dbb565b5060006103248486610e10565b60008183610c785760405162461bcd60e51b81526004016103579190610dbb565b5060006103248486610d99565b6001600160a01b0381168114610c9a57600080fd5b50565b600060208284031215610caf57600080fd5b813561093f81610c85565b60008060408385031215610ccd57600080fd5b8235610cd881610c85565b946020939093013593505050565b600060208284031215610cf857600080fd5b5035919050565b6020808252601a908201527f43616c6c6572206973206e6f7420746865206f70657261746f72000000000000604082015260600190565b634e487b7160e01b600052601160045260246000fd5b60008219821115610d5f57610d5f610d36565b500190565b634e487b7160e01b600052603260045260246000fd5b6000816000190483118215151615610d9457610d94610d36565b500290565b600082610db657634e487b7160e01b600052601260045260246000fd5b500490565b600060208083528351808285015260005b81811015610de857858101830151858201604001528201610dcc565b81811115610dfa576000604083870101525b50601f01601f1916929092016040019392505050565b600082821015610e2257610e22610d36565b50039056fea2646970667358221220092ff02654aefd0a4e804c1722e86dc3109bc72cf5430ed579fa0cf60e40626064736f6c634300080800337d8f3d9291db7e540ea10a43e300f1330c3e9148157349babe42ac2601a2a3e9a2646970667358221220087b1e9fcb91528e060cde02f4e2e310ec1a47a06063b22585e26f6d8cfa27eb64736f6c63430008080033"
)

type hardForkValidatorsV3 struct {
}

func (s *hardForkValidatorsV3) GetName() string {
	return ValidatorsV2ContractName
}

func (s *hardForkValidatorsV3) Update(config *params.ChainConfig, height *big.Int, state *state.StateDB) (err error) {
	contractCode := common.FromHex(validatorV3Code)

	//write code to sys contract
	state.SetCode(ValidatorsV2ContractAddr, contractCode)
	log.Debug("Write code to system contract account", "addr", ValidatorsV2ContractAddr.String(), "code", validatorV3Code)

	return
}

func (s *hardForkValidatorsV3) Execute(state *state.StateDB, header *types.Header, chainContext core.ChainContext, config *params.ChainConfig) (err error) {
	//First, get top validators from the old contract
	v0 := NewValidatorV0()
	topVals, err := v0.GetTopValidators(state, header, chainContext, config)
	if err != nil {
		log.Error("getTopValidators from V0 failed", "err", err)
		return err
	}

	// initialize v1 contract
	method := "initialize"
	data, err := GetInteractiveABI()[ValidatorsV2ContractName].Pack(method, topVals)
	if err != nil {
		log.Error("Can't pack data for initialize", "error", err)
		return err
	}

	msg := vmcaller.NewLegacyMessage(header.Coinbase, &ValidatorsV2ContractAddr, 0, new(big.Int), math.MaxUint64, new(big.Int), data, false)
	_, err = vmcaller.ExecuteMsg(msg, state, header, chainContext, config)

	return
}
